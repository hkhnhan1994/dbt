{% set period_time = period_calculate(time = "semesterly", selection_date="today", prefix="", suffix="S" ) -%}
{% set time_zone = "Etc/UTC" -%}
{% set country_code = "BE" -%}

WITH ALB AS (
SELECT
    '73f02cef-1f20-446a-b66f-5368c222a58e' AS companyid_tobeexcluded,
    'VigorPlus Holding B.V.' AS legal_name,
    'COLLECTOR_NL_FULL' AS product_name,
    'NL' AS to_be_reported_in_country
UNION ALL
SELECT '46d24da8-952f-44e3-b880-f1edd2a7e5a2', 'SIA EZ', 'COLLECTOR_LV_FULL', 'LV' UNION ALL
SELECT '0df4ade3-3e72-48d9-8897-e7439551a8ca', 'BLOX USINAGE PLASTIQUES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0f8c4fd2-72b2-4261-8599-223bcb67c711', 'LOTHESA', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '12144ea2-9a8a-49dd-b01f-0bdbb8189db5', 'MPG CONSEIL EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1840ea14-f726-448b-a716-e92f5009d322', 'FID SUD AGEN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1b12d30c-1820-400a-86eb-15601492979e', 'QUENETTE STEVE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1c72dfa2-b07e-455f-a00c-2fd64784f9c2', 'CIE EUROP GESTION EXPERTISES COMPTABLES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '23e4432f-43ed-4bf6-ab30-29f9d5a6f102', 'D.B.D.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '26801b29-16ed-4330-b180-3d4fb997aa6d', 'BAT EVENT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '38c5e0bc-d122-4783-872c-e2cdbbef0ece', 'LAMY EXPERTS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '497c6deb-a48b-464a-9318-02cf543ba323', 'FID SUD MONTAUBAN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5c5225a4-08a4-4052-b712-74bfe7a99da8', 'SDRD', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5e05cabb-e5bd-42e7-a50c-df17fb04f3c7', 'KOMO MARCHE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '634b1ae4-8dca-46f4-ae17-ef28f87e91af', 'CABINET CONCEPT EXPERT - CCE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '698f1c97-3d15-4a42-9914-e9513a8fe723', 'EXPERTS TEAM', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '6f216187-3566-4097-92e8-9de30f59bb19', 'ABAQUE CONSULTING', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '01dd8d49-de77-4311-bac3-c7a8c74b4275', 'EN SA MEMOIRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '768e77cd-7de9-4369-a7ba-b0b04db3ab67', 'OLIVER AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '791f2d5e-338f-4f82-9519-85a28c163884', 'MVT CONSEILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '99053b0d-3e81-4972-a491-bd34beb026a6', 'N.D.EX.CO.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'a9feb33b-db68-4020-a5f3-279123565354', 'SALAS-GORDO & COELHO', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'c45758bd-85b4-4f61-accc-ee180364a60b', 'NICOL & ASSOCIES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'cd8e4416-da0c-4a12-9934-78618f0694b3', 'IN FINE EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e196486d-0014-4931-b183-f32c190897d8', 'MALHERBE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e2a66866-98c4-4ef0-a67d-637e58273603', 'BENAUW HUBERT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e7f0ba81-6c3f-4b3d-9bf5-4d42dc88d56f', 'F2AB AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e9708122-4491-4930-bdd7-d70e50415d2f', 'BEY MANUTENTION', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'f10e6a0f-67e4-4662-83b7-7faba187e157', 'GARDILLE JEAN-PIERRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fb77318d-18f5-43d2-a202-512943c4f92b', 'SOGAREX', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fbe51ec9-8cb7-4825-be45-594886d67fac', 'CHESNEAU CHRISTIAN ET FILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fcb01b27-09c9-42c3-befa-3950b3150b1f', 'LOZANGE IT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '733045f3-c626-49a3-aad6-a514f19ad0e0', 'QINTENS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0567d2fa-6eca-4422-8570-ff714ccd8aa4', 'D-DALE', 'COLLECTOR_FR_FULL', 'FR'
),
CMD as (
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM {{ source('source_dwh_strp', 'D_LEGAL_ENTITY_CURRENT') }} C
LEFT JOIN {{ source('source_dwh_strp', 'D_LEGAL_ENTITY_DECRYPTED') }} D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_OCS_ACTIVE = true
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '{{period_time['begin_date']}}', '{{time_zone}}'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '{{period_time['end_date']}}', '{{time_zone}}'))

UNION ALL
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM {{ source('source_dwh_strp', 'D_LEGAL_ENTITY_CURRENT') }} C
LEFT JOIN  {{ source('source_dwh_strp', 'D_LEGAL_ENTITY_DECRYPTED') }} D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_SOURCE = 'ALBATROS'
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '{{period_time['begin_date']}}', '{{time_zone}}'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '{{period_time['end_date']}}', '{{time_zone}}'))

ORDER BY 2
),
souce_table as(
SELECT  CMD.* FROM CMD
UNION ALL
SELECT
    ALB.companyid_tobeexcluded,
    ALB.legal_name,
    ALB.to_be_reported_in_country
FROM ALB
ORDER BY 2
)
SELECT
*,
"{{period_time['period']}}"  AS Period,
TIMESTAMP(DATETIME( '{{period_time['begin_date']}}', '{{time_zone}}'))  AS Period_begin_date,
TIMESTAMP(DATETIME( '{{period_time['end_date']}}', '{{time_zone}}'))  AS Period_end_date,
CURRENT_TIMESTAMP AS load_timestamp,
FROM souce_table
