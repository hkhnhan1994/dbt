-- back compat for old kwarg name
  
  
        
            
            
        
    

    

    merge into `pj-bu-dw-data-sbx`.`dev_dwh_view_cmd`.`D_LEGAL_ENTITY` as DBT_INTERNAL_DEST
        using (with surrogate_key as(
    select
		
    
to_hex(md5(cast(coalesce(cast(T_BUS_KEY as string), '_dbt_utils_surrogate_key_null_') || '-' || coalesce(cast(T_ROW_HASH as string), '_dbt_utils_surrogate_key_null_') as string))) as T_UNIQUE_KEY, 
		*
	FROM `pj-bu-dw-data-sbx`.`dev_staging_view_cmd`.`D_LEGAL_ENTITY`

)
SELECT 
    
        (SELECT COALESCE(MAX(T_DIM_KEY), 1) FROM `pj-bu-dw-data-sbx`.`dev_dwh_view_cmd`.`D_LEGAL_ENTITY` ) + ROW_NUMBER() over (Order by surrogate_key.T_INGESTION_TIMESTAMP ASC) as T_DIM_KEY,
    
    *
FROM surrogate_key
        ) as DBT_INTERNAL_SOURCE
        on (
                DBT_INTERNAL_SOURCE.T_UNIQUE_KEY = DBT_INTERNAL_DEST.T_UNIQUE_KEY
            )

    
    when matched then update set
        `T_DIM_KEY` = DBT_INTERNAL_SOURCE.`T_DIM_KEY`,`T_UNIQUE_KEY` = DBT_INTERNAL_SOURCE.`T_UNIQUE_KEY`,`T_BATCH_ID` = DBT_INTERNAL_SOURCE.`T_BATCH_ID`,`T_LOAD_TIMESTAMP` = DBT_INTERNAL_SOURCE.`T_LOAD_TIMESTAMP`,`T_BUS_KEY` = DBT_INTERNAL_SOURCE.`T_BUS_KEY`,`T_SOURCE` = DBT_INTERNAL_SOURCE.`T_SOURCE`,`T_SOURCE_PK_ID` = DBT_INTERNAL_SOURCE.`T_SOURCE_PK_ID`,`T_INGESTION_TIMESTAMP` = DBT_INTERNAL_SOURCE.`T_INGESTION_TIMESTAMP`,`T_DML_TYPE` = DBT_INTERNAL_SOURCE.`T_DML_TYPE`,`LEGAL_ENTITY_NAME` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_NAME`,`LEGAL_ENTITY_IDENTIFIER` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_IDENTIFIER`,`LEGAL_ENTITY_IDENTIFIER_TYPE` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_IDENTIFIER_TYPE`,`LEGAL_ENTITY_UPDATED_AT` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_UPDATED_AT`,`LEGAL_ENTITY_ENDED_AT` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_ENDED_AT`,`LEGAL_ENTITY_INCORPORATION_DATE` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_INCORPORATION_DATE`,`LEGAL_ENTITY_JURIDICAL_FORM` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_JURIDICAL_FORM`,`LEGAL_ENTITY_ACTIVITY_CODE` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_ACTIVITY_CODE`,`LEGAL_ENTITY_ACTIVITY` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_ACTIVITY`,`LEGAL_ENTITY_NUMBER_OF_EMPLOYEES` = DBT_INTERNAL_SOURCE.`LEGAL_ENTITY_NUMBER_OF_EMPLOYEES`,`T_ROW_HASH` = DBT_INTERNAL_SOURCE.`T_ROW_HASH`
    

    when not matched then insert
        (`T_DIM_KEY`, `T_UNIQUE_KEY`, `T_BATCH_ID`, `T_LOAD_TIMESTAMP`, `T_BUS_KEY`, `T_SOURCE`, `T_SOURCE_PK_ID`, `T_INGESTION_TIMESTAMP`, `T_DML_TYPE`, `LEGAL_ENTITY_NAME`, `LEGAL_ENTITY_IDENTIFIER`, `LEGAL_ENTITY_IDENTIFIER_TYPE`, `LEGAL_ENTITY_UPDATED_AT`, `LEGAL_ENTITY_ENDED_AT`, `LEGAL_ENTITY_INCORPORATION_DATE`, `LEGAL_ENTITY_JURIDICAL_FORM`, `LEGAL_ENTITY_ACTIVITY_CODE`, `LEGAL_ENTITY_ACTIVITY`, `LEGAL_ENTITY_NUMBER_OF_EMPLOYEES`, `T_ROW_HASH`)
    values
        (`T_DIM_KEY`, `T_UNIQUE_KEY`, `T_BATCH_ID`, `T_LOAD_TIMESTAMP`, `T_BUS_KEY`, `T_SOURCE`, `T_SOURCE_PK_ID`, `T_INGESTION_TIMESTAMP`, `T_DML_TYPE`, `LEGAL_ENTITY_NAME`, `LEGAL_ENTITY_IDENTIFIER`, `LEGAL_ENTITY_IDENTIFIER_TYPE`, `LEGAL_ENTITY_UPDATED_AT`, `LEGAL_ENTITY_ENDED_AT`, `LEGAL_ENTITY_INCORPORATION_DATE`, `LEGAL_ENTITY_JURIDICAL_FORM`, `LEGAL_ENTITY_ACTIVITY_CODE`, `LEGAL_ENTITY_ACTIVITY`, `LEGAL_ENTITY_NUMBER_OF_EMPLOYEES`, `T_ROW_HASH`)


    