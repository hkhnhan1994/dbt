-- back compat for old kwarg name
  
  
        
            
            
        
    

    

    merge into `pj-bu-dw-data-sbx`.`dev_dwh_view_cmd`.`D_ENTERPRISE` as DBT_INTERNAL_DEST
        using (with surrogate_key as(
    select
		
    
to_hex(md5(cast(coalesce(cast(T_BUS_KEY as string), '_dbt_utils_surrogate_key_null_') || '-' || coalesce(cast(T_ROW_HASH as string), '_dbt_utils_surrogate_key_null_') as string))) as T_UNIQUE_KEY, 
		*
	FROM `pj-bu-dw-data-sbx`.`dev_staging_view_cmd`.`D_ENTERPRISE`

)
SELECT 
    
        (SELECT COALESCE(MAX(T_DIM_KEY), 1) FROM `pj-bu-dw-data-sbx`.`dev_dwh_view_cmd`.`D_ENTERPRISE` ) + ROW_NUMBER() over (Order by surrogate_key.T_INGESTION_TIMESTAMP ASC) as T_DIM_KEY,
    
    *
FROM surrogate_key
        ) as DBT_INTERNAL_SOURCE
        on (
                DBT_INTERNAL_SOURCE.T_UNIQUE_KEY = DBT_INTERNAL_DEST.T_UNIQUE_KEY
            )

    
    when matched then update set
        `T_DIM_KEY` = DBT_INTERNAL_SOURCE.`T_DIM_KEY`,`T_UNIQUE_KEY` = DBT_INTERNAL_SOURCE.`T_UNIQUE_KEY`,`T_BATCH_ID` = DBT_INTERNAL_SOURCE.`T_BATCH_ID`,`T_LOAD_TIMESTAMP` = DBT_INTERNAL_SOURCE.`T_LOAD_TIMESTAMP`,`T_BUS_KEY` = DBT_INTERNAL_SOURCE.`T_BUS_KEY`,`T_SOURCE` = DBT_INTERNAL_SOURCE.`T_SOURCE`,`T_SOURCE_PK_ID` = DBT_INTERNAL_SOURCE.`T_SOURCE_PK_ID`,`T_INGESTION_TIMESTAMP` = DBT_INTERNAL_SOURCE.`T_INGESTION_TIMESTAMP`,`T_DML_TYPE` = DBT_INTERNAL_SOURCE.`T_DML_TYPE`,`ENTERPRISE_CREATED_AT` = DBT_INTERNAL_SOURCE.`ENTERPRISE_CREATED_AT`,`ENTERPRISE_UPDATED_AT` = DBT_INTERNAL_SOURCE.`ENTERPRISE_UPDATED_AT`,`T_D_LEGAL_ENTITY_DIM_KEY` = DBT_INTERNAL_SOURCE.`T_D_LEGAL_ENTITY_DIM_KEY`,`BRAND` = DBT_INTERNAL_SOURCE.`BRAND`,`ENTERPRISE_NAME` = DBT_INTERNAL_SOURCE.`ENTERPRISE_NAME`,`ENTERPRISE_CONTACT` = DBT_INTERNAL_SOURCE.`ENTERPRISE_CONTACT`,`ENTERPRISE_PHONE_NUMBER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_PHONE_NUMBER`,`ENTERPRISE_MOBILE_NUMBER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_MOBILE_NUMBER`,`ENTERPRISE_STREET` = DBT_INTERNAL_SOURCE.`ENTERPRISE_STREET`,`ENTERPRISE_HOUSE_NBR` = DBT_INTERNAL_SOURCE.`ENTERPRISE_HOUSE_NBR`,`ENTERPRISE_ZIP_CODE` = DBT_INTERNAL_SOURCE.`ENTERPRISE_ZIP_CODE`,`ENTERPRISE_CITY` = DBT_INTERNAL_SOURCE.`ENTERPRISE_CITY`,`ENTERPRISE_COUNTRY` = DBT_INTERNAL_SOURCE.`ENTERPRISE_COUNTRY`,`ENTERPRISE_EMAIL` = DBT_INTERNAL_SOURCE.`ENTERPRISE_EMAIL`,`ENTERPRISE_JURIDICAL_FORM` = DBT_INTERNAL_SOURCE.`ENTERPRISE_JURIDICAL_FORM`,`ENTERPRISE_VAT_NUMBER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_VAT_NUMBER`,`ENTERPRISE_IDENTIFIER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_IDENTIFIER`,`ENTERPRISE_IDENTIFIER_TYPE` = DBT_INTERNAL_SOURCE.`ENTERPRISE_IDENTIFIER_TYPE`,`ENTERPRISE_LOCATION_IDENTIFIER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_LOCATION_IDENTIFIER`,`ENTERPRISE_EH_AUTHENTICATION_LEVEL` = DBT_INTERNAL_SOURCE.`ENTERPRISE_EH_AUTHENTICATION_LEVEL`,`ENTERPRISE_CUSTOMER_NUMBER` = DBT_INTERNAL_SOURCE.`ENTERPRISE_CUSTOMER_NUMBER`,`ENTERPRISE_AGRO_SWITH_ID` = DBT_INTERNAL_SOURCE.`ENTERPRISE_AGRO_SWITH_ID`,`T_ROW_HASH` = DBT_INTERNAL_SOURCE.`T_ROW_HASH`
    

    when not matched then insert
        (`T_DIM_KEY`, `T_UNIQUE_KEY`, `T_BATCH_ID`, `T_LOAD_TIMESTAMP`, `T_BUS_KEY`, `T_SOURCE`, `T_SOURCE_PK_ID`, `T_INGESTION_TIMESTAMP`, `T_DML_TYPE`, `ENTERPRISE_CREATED_AT`, `ENTERPRISE_UPDATED_AT`, `T_D_LEGAL_ENTITY_DIM_KEY`, `BRAND`, `ENTERPRISE_NAME`, `ENTERPRISE_CONTACT`, `ENTERPRISE_PHONE_NUMBER`, `ENTERPRISE_MOBILE_NUMBER`, `ENTERPRISE_STREET`, `ENTERPRISE_HOUSE_NBR`, `ENTERPRISE_ZIP_CODE`, `ENTERPRISE_CITY`, `ENTERPRISE_COUNTRY`, `ENTERPRISE_EMAIL`, `ENTERPRISE_JURIDICAL_FORM`, `ENTERPRISE_VAT_NUMBER`, `ENTERPRISE_IDENTIFIER`, `ENTERPRISE_IDENTIFIER_TYPE`, `ENTERPRISE_LOCATION_IDENTIFIER`, `ENTERPRISE_EH_AUTHENTICATION_LEVEL`, `ENTERPRISE_CUSTOMER_NUMBER`, `ENTERPRISE_AGRO_SWITH_ID`, `T_ROW_HASH`)
    values
        (`T_DIM_KEY`, `T_UNIQUE_KEY`, `T_BATCH_ID`, `T_LOAD_TIMESTAMP`, `T_BUS_KEY`, `T_SOURCE`, `T_SOURCE_PK_ID`, `T_INGESTION_TIMESTAMP`, `T_DML_TYPE`, `ENTERPRISE_CREATED_AT`, `ENTERPRISE_UPDATED_AT`, `T_D_LEGAL_ENTITY_DIM_KEY`, `BRAND`, `ENTERPRISE_NAME`, `ENTERPRISE_CONTACT`, `ENTERPRISE_PHONE_NUMBER`, `ENTERPRISE_MOBILE_NUMBER`, `ENTERPRISE_STREET`, `ENTERPRISE_HOUSE_NBR`, `ENTERPRISE_ZIP_CODE`, `ENTERPRISE_CITY`, `ENTERPRISE_COUNTRY`, `ENTERPRISE_EMAIL`, `ENTERPRISE_JURIDICAL_FORM`, `ENTERPRISE_VAT_NUMBER`, `ENTERPRISE_IDENTIFIER`, `ENTERPRISE_IDENTIFIER_TYPE`, `ENTERPRISE_LOCATION_IDENTIFIER`, `ENTERPRISE_EH_AUTHENTICATION_LEVEL`, `ENTERPRISE_CUSTOMER_NUMBER`, `ENTERPRISE_AGRO_SWITH_ID`, `T_ROW_HASH`)


    