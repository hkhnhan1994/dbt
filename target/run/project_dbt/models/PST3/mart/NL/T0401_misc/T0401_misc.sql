
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_misc`
      
    
    

    OPTIONS()
    as (
      SELECT
  FAM.MOVEMENT_FAMILY as bank_family,
  FAM.MOVEMENT_SUBFAMILY as bank_subfamily,
  count(*) as count,
  COALESCE(SUM(FAM.MOVEMENT_AMOUNT), 0) as amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS_DECRYPTED` AS FAM
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
  ON FAM.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
  ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
  ON DCA.T_DIM_KEY = FAM.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE DIAT.ACCOUNT_TYPE = 'PAYMENT'
  AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND FAM.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND FAM.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  