[0m15:53:51.862517 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:53:51.863944 [debug] [Thread-1 (]: On model.project_dbt.V121_customer_credit_transfers_received: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V121_customer_credit_transfers_received`
  OPTIONS()
  as SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedamount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.786719', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:51.786719', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4

UNION ALL

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.786719', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:51.786719', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4;


[0m15:53:51.865239 [debug] [Thread-13 ]: On model.project_dbt.V1220_stock_of_accounts: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1220_stock_of_accounts`
  OPTIONS()
  as SELECT
  'PMAC' as AccountType,
  case
    when ACCOUNT_USAGE in ('CARE','CARE_EXPENSE','ESTATE') then 'HSNP' -- Households and NPISHs
    when ACCOUNT_USAGE is null then 'CORP' -- Non-financial corporations
    else 'check the query'
  end as Customer_Category,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
and BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
and IACC.ACCOUNT_STATUS = 'OPEN'
or (
  IACC.ACCOUNT_STATUS = 'CLOSED'
  and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-10-01 15:53:51.796061', 'Etc/UTC'))
  )
and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:53:51.796061', 'Etc/UTC'))
group by 1,2;


[0m15:53:51.866147 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:53:51.867322 [debug] [Thread-16 ]: On model.project_dbt.V1222_stock_of_accessed_accounts: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1222_stock_of_accessed_accounts`
  OPTIONS()
  as WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'AISP' as PSPType,
    fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
    'VOLU' as Metric,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
      AND (
            ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.803808', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:53:51.803808', 'Etc/UTC'))
          )
          OR (
            ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.803808', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 15:53:51.803808', 'Etc/UTC'))
              )
  GROUP BY
  1,2,3,4
  )
  SELECT
    'AISP' as PSPType,
    Countryofcustomerresidence as  countryOfASPSP,
    'LU' as countryOfAISP,
    'VOLU' as Metric,
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  group by 1,2,3
union all


SELECT
  'APSP' as PSPType,
  'LU' countryOfASPSP,
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  'VOLU' as Metric,
  COUNT(*) AS Numberofaccounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='LU'
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  and  c.CONSENT_CREATED_AT <  TIMESTAMP(DATETIME( '2024-10-31 15:53:51.803808', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.803808', 'Etc/UTC'))
group by 1,2,3;


[0m15:53:51.870810 [debug] [Thread-3 (]: On model.project_dbt.V1230_number_of_accounts: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1230_number_of_accounts`
  OPTIONS()
  as WITH obsolete_and_active_consents_count_in_reporting_period AS (
   SELECT
     'AISP' as PSPType,
     fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
     'VOLU' as Metric,
     ac.USER_TOKEN,
     COUNT(*) AS number_of_consents,
   FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
     ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
    inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
     ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
   ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
     ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
     ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
     ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
   WHERE
       a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
       AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
       AND (
           (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.812125', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:53:51.812125', 'Etc/UTC'))
           )
           OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.812125', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 15:53:51.812125', 'Etc/UTC'))
               )
       )
   GROUP BY
   1,2,3,4
   )
   SELECT
     'AISP' as PSPType,
     Countryofcustomerresidence,
     'VOLU' as Metric,
     COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
   FROM obsolete_and_active_consents_count_in_reporting_period
   group by 1,2,3;


[0m15:53:51.877305 [debug] [Thread-2 (]: On model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V130_direct_debits_reporting_as_creditors_PSP`
  OPTIONS()
  as SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.819308', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:51.819308', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8

union all

SELECT
  'CORP' as customerCategory,
   IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:51.819308', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:51.819308', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8;


[0m15:53:52.333778 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea213e73880>]}
[0m15:53:52.335433 [info ] [Thread-9 (]: 51 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ........ [[32mCREATE TABLE (23.0 rows, 1.6 GiB processed)[0m in 6.82s]
[0m15:53:52.337058 [debug] [Thread-9 (]: Finished running node model.project_dbt.PCP_POS_ONLINE
[0m15:53:52.338274 [debug] [Thread-9 (]: Began running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:53:52.339704 [info ] [Thread-9 (]: 74 of 88 START sql view model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [RUN]
[0m15:53:52.341238 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_POS_ONLINE, now model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP)
[0m15:53:52.342558 [debug] [Thread-9 (]: Began compiling node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:53:52.353475 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m15:53:52.354172 [debug] [Thread-9 (]: Began executing node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:53:52.357547 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m15:53:52.358662 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:53:52.359169 [debug] [Thread-9 (]: On model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V131_direct_debits_reporting_as_debtors_PSP`
  OPTIONS()
  as SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:52.352681', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:52.352681', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    'SEPA' as paymentScheme,
    "Electronic file/batch" AS initiationChannel ,
    '' as consent,
    '' as fraudType,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:52.352681', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:52.352681', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8;


[0m15:53:52.583036 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:db1736e3-fa1e-4a96-a64f-2e433532a012&page=queryresults
[0m15:53:52.623954 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3d8a1382-c5b2-4b8a-9cf3-37cc1f829325&page=queryresults
[0m15:53:52.951888 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:92d5d4d0-4180-41f7-873d-94ef38c3b4e5&page=queryresults
[0m15:53:52.954582 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:820c5c7b-890a-4766-a1dc-eb218a0a9215&page=queryresults
[0m15:53:52.955897 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4a5642f5-6333-454b-a087-305fd3b4ed7a&page=queryresults
[0m15:53:52.959494 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b80d5342-2cad-406e-b46f-b4be3aa209ce&page=queryresults
[0m15:53:52.963843 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:dfc1e5a7-665f-4336-8c30-b991471bb6dd&page=queryresults
[0m15:53:52.993366 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:129fe059-31bc-482c-bced-0c2a9798686d&page=queryresults
[0m15:53:53.376545 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea211fd9300>]}
[0m15:53:53.377799 [info ] [Thread-3 (]: 72 of 88 OK created sql view model dev_dm_pst3_LU.V1230_number_of_accounts ..... [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m15:53:53.378902 [debug] [Thread-3 (]: Finished running node model.project_dbt.V1230_number_of_accounts
[0m15:53:53.379520 [debug] [Thread-3 (]: Began running node model.project_dbt.V140_SEPA_R_transactions
[0m15:53:53.380212 [info ] [Thread-3 (]: 75 of 88 START sql view model dev_dm_pst3_LU.V140_SEPA_R_transactions .......... [RUN]
[0m15:53:53.380795 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1230_number_of_accounts, now model.project_dbt.V140_SEPA_R_transactions)
[0m15:53:53.381396 [debug] [Thread-3 (]: Began compiling node model.project_dbt.V140_SEPA_R_transactions
[0m15:53:53.388085 [debug] [Thread-3 (]: Writing injected SQL for node "model.project_dbt.V140_SEPA_R_transactions"
[0m15:53:53.388639 [debug] [Thread-3 (]: Began executing node model.project_dbt.V140_SEPA_R_transactions
[0m15:53:53.393117 [debug] [Thread-3 (]: Writing runtime sql for node "model.project_dbt.V140_SEPA_R_transactions"
[0m15:53:53.393657 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:53:53.394159 [debug] [Thread-3 (]: On model.project_dbt.V140_SEPA_R_transactions: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V140_SEPA_R_transactions`
  OPTIONS()
  as SELECT
     'SEPA' as paymentScheme,
   case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
        when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
        end RoleofReporting,
   'CORP' as customerCategory,
   case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
        or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
              else 'PSPN'
         end settlementChannel,
  'SEPA Credit Transfer' as R_TransactionType,
     case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end creditorPspCountry,
     case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end debtorPspCountry,
     ftr.transaction_currency as currency,
     'VOLU' as metric,
     count(*) as reportedAmount,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.387549', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.387549', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8

  union all

  SELECT
        'SEPA' as paymentScheme,
      case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
            when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
            end RoleofReporting,
      'CORP' as customerCategory,
      case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
            or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
                  else 'PSPN'
            end settlementChannel,
      'SEPA Credit Transfer' as R_TransactionType,
        case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end creditorPspCountry,
        case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end debtorPspCountry,
        ftr.transaction_currency as currency,
        'VALE' as metric,
        SUM(ftr.TRANSACTION_AMOUNT) as reportedAmount,
        CURRENT_TIMESTAMP AS Load_timestamp,
        ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.387549', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.387549', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8
  order by 1,2,3,4,5,6,7,8;


[0m15:53:53.467167 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea210612170>]}
[0m15:53:53.468954 [info ] [Thread-13 ]: 70 of 88 OK created sql view model dev_dm_pst3_LU.V1220_stock_of_accounts ...... [[32mCREATE VIEW (0 processed)[0m in 1.70s]
[0m15:53:53.470527 [debug] [Thread-13 ]: Finished running node model.project_dbt.V1220_stock_of_accounts
[0m15:53:53.471720 [debug] [Thread-13 ]: Began running node model.project_dbt.V142_intermediated_payment_transactions
[0m15:53:53.473287 [info ] [Thread-13 ]: 76 of 88 START sql view model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [RUN]
[0m15:53:53.474539 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.V1220_stock_of_accounts, now model.project_dbt.V142_intermediated_payment_transactions)
[0m15:53:53.475679 [debug] [Thread-13 ]: Began compiling node model.project_dbt.V142_intermediated_payment_transactions
[0m15:53:53.492089 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m15:53:53.492724 [debug] [Thread-13 ]: Began executing node model.project_dbt.V142_intermediated_payment_transactions
[0m15:53:53.495245 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m15:53:53.495736 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:53:53.496307 [debug] [Thread-13 ]: On model.project_dbt.V142_intermediated_payment_transactions: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V142_intermediated_payment_transactions`
  OPTIONS()
  as SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  'CPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  d_payment_transaction_info.payment_transaction_payer_country   as debtorPSPs,
  'LU' as CreditorPSPs,
  d_payment_transaction_info.payment_transaction_currency_code as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE != 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.490295', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.490295', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  group by 1,2,3,4,5,6,7,8
union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as RoleofReporting,
  'PSPN' as Settlementchannel,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'LU', d_payment_transaction_info.payment_transaction_payer_country)   as debtorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_payer_country, 'LU') as CreditorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_currency_code,  d_payment_transaction_info.payment_transaction_currency_code) as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.490295', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.490295', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT

  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
    REFUND.payment_transaction_payer_country as CreditorPSPs,
    REFUND.payment_transaction_currency_code as currency,
    'Volu' as Metric,
    count(*) as ReportedAmount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
      AS d_payment_item_info
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
  T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
  WHERE
      f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
      AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
      AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.490295', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.490295', 'Etc/UTC')) -- like timez
    group by 1,2,3,4,5,6,7,8
    union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
  REFUND.payment_transaction_payer_country as CreditorPSPs,
  REFUND.payment_transaction_currency_code as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.490295', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.490295', 'Etc/UTC')) -- like timez
  group by 1,2,3,4,5,6,7,8;


[0m15:53:53.936604 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea210742500>]}
[0m15:53:53.940038 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2107300d0>]}
[0m15:53:53.941842 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea210740610>]}
[0m15:53:53.942255 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea213a68820>]}
[0m15:53:53.943522 [info ] [Thread-8 (]: 67 of 88 OK created sql view model dev_dm_pst3_LU.V1110_payment_initiation_services  [[32mCREATE VIEW (0 processed)[0m in 2.19s]
[0m15:53:53.944545 [info ] [Thread-2 (]: 73 of 88 OK created sql view model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [[32mCREATE VIEW (0 processed)[0m in 2.17s]
[0m15:53:53.948694 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cef325d-e245-4461-ad39-caf897a90e33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea213b5c730>]}
[0m15:53:53.951959 [info ] [Thread-5 (]: 68 of 88 OK created sql view model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [[32mCREATE VIEW (0 processed)[0m in 2.18s]
[0m15:53:53.952554 [info ] [Thread-16 ]: 71 of 88 OK created sql view model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [[32mCREATE VIEW (0 processed)[0m in 2.17s]
[0m15:53:53.953142 [debug] [Thread-8 (]: Finished running node model.project_dbt.V1110_payment_initiation_services
[0m15:53:53.953682 [debug] [Thread-2 (]: Finished running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m15:53:53.954271 [info ] [Thread-1 (]: 69 of 88 OK created sql view model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [[32mCREATE VIEW (0 processed)[0m in 2.18s]
[0m15:53:53.954799 [debug] [Thread-5 (]: Finished running node model.project_dbt.V120_customer_credit_transfers_sent
[0m15:53:53.955344 [debug] [Thread-16 ]: Finished running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m15:53:53.955852 [debug] [Thread-8 (]: Began running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:53:53.956779 [debug] [Thread-2 (]: Began running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:53:53.957521 [debug] [Thread-1 (]: Finished running node model.project_dbt.V121_customer_credit_transfers_received
[0m15:53:53.958036 [debug] [Thread-5 (]: Began running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:53:53.958565 [debug] [Thread-16 ]: Began running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:53:53.959140 [info ] [Thread-8 (]: 77 of 88 START sql view model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [RUN]
[0m15:53:53.959719 [info ] [Thread-2 (]: 78 of 88 START sql view model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [RUN]
[0m15:53:53.960152 [debug] [Thread-1 (]: Began running node model.project_dbt.ZVS9_PCT
[0m15:53:53.960648 [info ] [Thread-5 (]: 79 of 88 START sql view model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers .... [RUN]
[0m15:53:53.961223 [info ] [Thread-16 ]: 80 of 88 START sql view model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers ... [RUN]
[0m15:53:53.961641 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1110_payment_initiation_services, now model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs)
[0m15:53:53.962106 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP, now model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs)
[0m15:53:53.962736 [info ] [Thread-1 (]: 81 of 88 START sql view model dev_dm_pst3_DE.ZVS9_PCT .......................... [RUN]
[0m15:53:53.963112 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.V120_customer_credit_transfers_sent, now model.project_dbt.ZVS41_Inbound_credit_transfers)
[0m15:53:53.963499 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.V1222_stock_of_accessed_accounts, now model.project_dbt.ZVS41_Outbound_credit_transfers)
[0m15:53:53.964115 [debug] [Thread-8 (]: Began compiling node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:53:53.964616 [debug] [Thread-2 (]: Began compiling node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:53:53.964971 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.V121_customer_credit_transfers_received, now model.project_dbt.ZVS9_PCT)
[0m15:53:53.965299 [debug] [Thread-5 (]: Began compiling node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:53:53.965704 [debug] [Thread-16 ]: Began compiling node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:53:53.972542 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m15:53:53.977828 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m15:53:53.978271 [debug] [Thread-1 (]: Began compiling node model.project_dbt.ZVS9_PCT
[0m15:53:53.984627 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m15:53:53.988959 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m15:53:53.989795 [debug] [Thread-8 (]: Began executing node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:53:53.994653 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.ZVS9_PCT"
[0m15:53:53.995105 [debug] [Thread-2 (]: Began executing node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:53:53.995666 [debug] [Thread-5 (]: Began executing node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:53:53.998106 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m15:53:54.000794 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m15:53:54.001155 [debug] [Thread-1 (]: Began executing node model.project_dbt.ZVS9_PCT
[0m15:53:54.001589 [debug] [Thread-16 ]: Began executing node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:53:54.003730 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m15:53:54.006836 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.ZVS9_PCT"
[0m15:53:54.007402 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:53:54.009595 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m15:53:54.010247 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:53:54.010813 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:53:54.011290 [debug] [Thread-2 (]: On model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V152_card_transactions_acquired_by_resident_PSPs`
  OPTIONS()
  as SELECT
  'CRCA' as PaymentCardType,
  case when f_payment_transactions.card_network = 'MASTERCARD' then 'MSTR'
    when f_payment_transactions.card_network = 'VISA' then 'VISA'
    else 'OTHER' END PaymentCardScheme,
  'ECOM' as TerminalType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as OperationType,
  'RMTR' as InitiationChannel,
  'REM1' as InitiationsubChannel,
  'MITR' as SCA,
  'NOAP' as FraudType,
  d_merchants.MERCHANT_COUNTRY AS CountryofIssuer,
  d_merchants.MERCHANT_COUNTRY AS  CountryofTerminal,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED` AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items
  ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants
  ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions
  ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info
  ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products
  ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
  AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.977388', 'Etc/UTC'))
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:53:53.977388', 'Etc/UTC'))
  GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12;


[0m15:53:54.011792 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:53:54.012272 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:53:54.012990 [debug] [Thread-8 (]: On model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V150_card_transactions_with_cards_issued_by resident_PSPs`
  OPTIONS()
  as SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VOLU' as metric,
  count(*) AS ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND  CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.971923', 'Etc/UTC'))
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 15:53:53.971923', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

UNION ALL

SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VALE' as metric,
  sum (coalesce(FCT.CARD_TRANSACTION_CLEARED_AMOUNT ,0)) + sum(coalesce(CARD_TRANSACTION_REFUNDED_AMOUNT,0)) as total_sum,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND   CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 15:53:53.971923', 'Etc/UTC'))
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 15:53:53.971923', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11;


[0m15:53:54.013667 [debug] [Thread-5 (]: On model.project_dbt.ZVS41_Inbound_credit_transfers: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Inbound_credit_transfers`
  OPTIONS()
  as SELECT
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYER_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'INBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1
ORDER BY 1;


[0m15:53:54.015136 [debug] [Thread-1 (]: On model.project_dbt.ZVS9_PCT: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS9_PCT`
  OPTIONS()
  as SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE (FAT.TRANSACTION_DIRECTION = 'OUTBOUND')
  AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
  AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
  AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
  AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL not in ('DASHBOARD', 'OTHER','CARDS')
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1
ORDER BY 1 ASC;


[0m15:53:54.015821 [debug] [Thread-16 ]: On model.project_dbt.ZVS41_Outbound_credit_transfers: 

  create or replace view `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Outbound_credit_transfers`
  OPTIONS()
  as SELECT
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'PCT.4 Manual entry'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'PCT.2 Electronic entry'
  END EntryMode,
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS') THEN 'PCT.22 Single entry'
    WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'PCT.21 Batch entry'
  END Batchmode,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1, 2, 3;


[0m15:53:54.115193 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7b824934-87a6-473a-9e12-885ad9f9d7bf&page=queryresults
[0m15:54:06.971152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0167d094e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c016669b640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c016669b5e0>]}


============================== 15:54:06.974064 | b10f2185-c6b9-4e5b-98c8-032add8d1a7e ==============================
[0m15:54:06.974064 [info ] [MainThread]: Running with dbt=1.8.6
[0m15:54:06.974577 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/home/hkhnhan/Code/dbt/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/home/hkhnhan/Code/dbt/dbt/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --full-refresh --select PST3', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:54:07.462109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0148a2b490>]}
[0m15:54:07.499379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0148babbe0>]}
[0m15:54:07.499955 [info ] [MainThread]: Registered adapter: bigquery=1.8.2
[0m15:54:07.513849 [debug] [MainThread]: checksum: 2f2fb10c73cafe3e79aa104295a8244291492b32b5598ce46af770f7d0bd5194, vars: {}, profile: , target: , version: 1.8.6
[0m15:54:07.649212 [debug] [MainThread]: Failed to load parsed file from disk at /home/hkhnhan/Code/dbt/dbt/target/partial_parse.msgpack: Field "metadata" of type ManifestMetadata in Manifest has invalid value {'dbt_schema_version': 'https://schemas.getdbt.com/dbt/manifest/v12.json', 'dbt_version': '1.8.6', 'generated_at': '2024-10-04T08:53:33.983105Z', 'invocation_id': '9cef325d-e245-4461-ad39-caf897a90e33', 'env': {}, 'project_name': 'project_dbt', 'project_id': '24add0b5d3eb94b933e2edb35b83ec6d', 'user_id': 'ebd3139a-e9fa-4388-9204-db89aa4256c8', 'send_anonymous_usage_stats': True, 'adapter_type': 'bigquery'}
[0m15:54:07.651925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01438c8040>]}
[0m15:54:09.943237 [warn ] [MainThread]: [[33mWARNING[0m]: Found spaces in the name of
`model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs`
[0m15:54:09.943852 [warn ] [MainThread]: [[33mWARNING[0m]: Spaces found in 1 resource name(s). This is deprecated, and
may lead to errors when using dbt. For more information: https://docs.getdbt.com
/reference/global-configs/legacy-behaviors#require_resource_names_without_spaces
Run again with `--debug` to see them all.
[0m15:54:09.944366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01679b4850>]}
[0m15:54:09.950242 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.project_dbt.STRH.mart
[0m15:54:10.031349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ab9d80>]}
[0m15:54:10.185680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0167fa8250>]}
[0m15:54:10.186209 [info ] [MainThread]: Found 185 models, 126 sources, 610 macros
[0m15:54:10.186598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143d13f70>]}
[0m15:54:10.192695 [info ] [MainThread]: 
[0m15:54:10.193185 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:10.199976 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.200417 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.200745 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.201300 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.201708 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.202227 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.202651 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.203024 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.203477 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.203793 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.204835 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.205375 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.206059 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m15:54:10.206599 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.208131 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.209326 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.209899 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:10.210380 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.310640 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_FR)
[0m15:54:12.311070 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.311486 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_IT)
[0m15:54:12.313201 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_staging_view_cmd)
[0m15:54:12.314157 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_DE)
[0m15:54:12.314637 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.315294 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.315781 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_LV)
[0m15:54:12.316494 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.319726 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dwh_view_cmd)
[0m15:54:12.320622 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk)
[0m15:54:12.321199 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.321951 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_ES)
[0m15:54:12.322854 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_NL)
[0m15:54:12.324945 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.325503 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dl_h3_hehe'
[0m15:54:12.325977 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dl_h3_hklc'
[0m15:54:12.326333 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.326639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_LU'
[0m15:54:12.327539 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_PT'
[0m15:54:12.327936 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.328496 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_BE'
[0m15:54:12.328850 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:12.330363 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.331605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.332703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.333089 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.334072 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:12.945419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01438c82b0>]}
[0m15:54:12.945922 [info ] [MainThread]: Concurrency: 16 threads (target='dev')
[0m15:54:12.946271 [info ] [MainThread]: 
[0m15:54:12.949509 [debug] [Thread-1 (]: Began running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m15:54:12.950362 [debug] [Thread-2 (]: Began running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m15:54:12.950946 [debug] [Thread-3 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m15:54:12.951488 [info ] [Thread-1 (]: 1 of 88 START sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ........ [RUN]
[0m15:54:12.952007 [debug] [Thread-4 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m15:54:12.952432 [debug] [Thread-5 (]: Began running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m15:54:12.952839 [info ] [Thread-2 (]: 2 of 88 START sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS . [RUN]
[0m15:54:12.953209 [debug] [Thread-6 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m15:54:12.953583 [debug] [Thread-7 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m15:54:12.953946 [debug] [Thread-8 (]: Began running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m15:54:12.954315 [debug] [Thread-9 (]: Began running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m15:54:12.954700 [info ] [Thread-3 (]: 3 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS  [RUN]
[0m15:54:12.955178 [debug] [Thread-10 ]: Began running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m15:54:12.955569 [debug] [Thread-11 ]: Began running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m15:54:12.955993 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hklc, now model.project_dbt.52505_NR_OF_ACCOUNTS)
[0m15:54:12.956389 [debug] [Thread-12 ]: Began running node model.project_dbt.A1_Number_of_payment_accounts
[0m15:54:12.956908 [info ] [Thread-4 (]: 4 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [RUN]
[0m15:54:12.957496 [debug] [Thread-13 ]: Began running node model.project_dbt.Banque_en_ligne
[0m15:54:12.957990 [debug] [Thread-14 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m15:54:12.958379 [debug] [Thread-15 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m15:54:12.958788 [info ] [Thread-5 (]: 5 of 88 START sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [RUN]
[0m15:54:12.959201 [debug] [Thread-16 ]: Began running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m15:54:12.959540 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_staging_view_cmd, now model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS)
[0m15:54:12.959965 [info ] [Thread-6 (]: 6 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [RUN]
[0m15:54:12.960416 [info ] [Thread-7 (]: 7 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [RUN]
[0m15:54:12.960844 [info ] [Thread-8 (]: 8 of 88 START sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS ... [RUN]
[0m15:54:12.961279 [info ] [Thread-9 (]: 9 of 88 START sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT . [RUN]
[0m15:54:12.961628 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_ES, now model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS)
[0m15:54:12.962051 [info ] [Thread-10 ]: 10 of 88 START sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [RUN]
[0m15:54:12.962509 [info ] [Thread-11 ]: 11 of 88 START sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [RUN]
[0m15:54:12.962887 [debug] [Thread-1 (]: Began compiling node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m15:54:12.963412 [info ] [Thread-12 ]: 12 of 88 START sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [RUN]
[0m15:54:12.963750 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_BE, now model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS)
[0m15:54:12.964230 [info ] [Thread-13 ]: 13 of 88 START sql incremental model dev_dm_pst3_FR.Banque_en_ligne ............ [RUN]
[0m15:54:12.964721 [info ] [Thread-14 ]: 14 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [RUN]
[0m15:54:12.965168 [info ] [Thread-15 ]: 15 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [RUN]
[0m15:54:12.965578 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LV, now model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS)
[0m15:54:12.965968 [info ] [Thread-16 ]: 16 of 88 START sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [RUN]
[0m15:54:12.966349 [debug] [Thread-2 (]: Began compiling node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m15:54:12.966690 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_DE, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN)
[0m15:54:12.966980 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_IT, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK)
[0m15:54:12.967267 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dwh_view_cmd, now model.project_dbt.58746_PAYMENT_INITIATIONS)
[0m15:54:12.967554 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk, now model.project_dbt.58788_AIS_USERS_AND_ACCOUNT)
[0m15:54:12.967886 [debug] [Thread-3 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m15:54:12.968186 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_NL, now model.project_dbt.58789_AIS_USERS_AND_ACCOUNT)
[0m15:54:12.968529 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_FR, now model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs)
[0m15:54:12.977594 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m15:54:12.977983 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hehe, now model.project_dbt.A1_Number_of_payment_accounts)
[0m15:54:12.978371 [debug] [Thread-4 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m15:54:12.978748 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LU, now model.project_dbt.Banque_en_ligne)
[0m15:54:12.979075 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_PT, now model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI)
[0m15:54:12.979590 [debug] [Thread-15 ]: Acquiring new bigquery connection 'model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU'
[0m15:54:12.979998 [debug] [Thread-5 (]: Began compiling node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m15:54:12.980415 [debug] [Thread-16 ]: Acquiring new bigquery connection 'model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo'
[0m15:54:12.982361 [debug] [Thread-6 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m15:54:12.983277 [debug] [Thread-7 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m15:54:12.983843 [debug] [Thread-8 (]: Began compiling node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m15:54:13.054742 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m15:54:13.055250 [debug] [Thread-9 (]: Began compiling node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m15:54:13.060841 [debug] [Thread-3 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m15:54:13.061296 [debug] [Thread-10 ]: Began compiling node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m15:54:13.061771 [debug] [Thread-11 ]: Began compiling node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m15:54:13.062218 [debug] [Thread-12 ]: Began compiling node model.project_dbt.A1_Number_of_payment_accounts
[0m15:54:13.067749 [debug] [Thread-1 (]: Began executing node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m15:54:13.067451 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m15:54:13.068436 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Banque_en_ligne
[0m15:54:13.068846 [debug] [Thread-14 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m15:54:13.069253 [debug] [Thread-15 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m15:54:13.073264 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m15:54:13.073699 [debug] [Thread-16 ]: Began compiling node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m15:54:13.077903 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m15:54:13.081057 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m15:54:13.086653 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m15:54:13.093232 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m15:54:13.093841 [debug] [Thread-3 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m15:54:13.098990 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m15:54:13.099521 [debug] [Thread-2 (]: Began executing node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m15:54:13.103695 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m15:54:13.107473 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m15:54:13.134431 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:54:13.138542 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Banque_en_ligne"
[0m15:54:13.142854 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m15:54:13.143249 [debug] [Thread-4 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m15:54:13.147620 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m15:54:13.151924 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m15:54:13.152447 [debug] [Thread-5 (]: Began executing node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m15:54:13.152997 [debug] [Thread-6 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m15:54:13.153323 [debug] [Thread-7 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m15:54:13.153812 [debug] [Thread-8 (]: Began executing node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m15:54:13.156399 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:54:13.156797 [debug] [Thread-9 (]: Began executing node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m15:54:13.160257 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:54:13.160682 [debug] [Thread-10 ]: Began executing node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m15:54:13.161164 [debug] [Thread-11 ]: Began executing node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m15:54:13.161555 [debug] [Thread-12 ]: Began executing node model.project_dbt.A1_Number_of_payment_accounts
[0m15:54:13.163054 [debug] [Thread-13 ]: Began executing node model.project_dbt.Banque_en_ligne
[0m15:54:13.165606 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:54:13.166072 [debug] [Thread-14 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m15:54:13.166558 [debug] [Thread-15 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m15:54:13.168981 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:54:13.171453 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m15:54:13.173653 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:54:13.173984 [debug] [Thread-16 ]: Began executing node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m15:54:13.176660 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:54:13.180076 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:54:13.183809 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m15:54:13.186580 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:54:13.189184 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:54:13.192099 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:13.195219 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m15:54:13.197820 [debug] [Thread-15 ]: Opening a new connection, currently in state init
[0m15:54:13.203125 [debug] [Thread-16 ]: Opening a new connection, currently in state init
[0m15:54:13.782931 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m15:54:13.785604 [debug] [Thread-3 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m15:54:13.786531 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m15:54:13.787713 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m15:54:13.788562 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m15:54:13.789374 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m15:54:13.790397 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m15:54:13.791224 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m15:54:13.792612 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m15:54:13.793546 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m15:54:13.794335 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m15:54:13.795136 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m15:54:13.796427 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m15:54:13.797121 [debug] [Thread-11 ]: On model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A11_Number_of_payment_accounts_accessed_by_AISPs`
      
    
    

    OPTIONS()
    as (
      SELECT *,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` t
WHERE t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
AND SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
AND T_LOAD_TIMESTAMP is not null
    );
  
[0m15:54:13.797587 [debug] [Thread-12 ]: On model.project_dbt.A1_Number_of_payment_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A1_Number_of_payment_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) as Count,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      )
    )
  and IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m15:54:13.798161 [debug] [Thread-3 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as (
  SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
  case when FAB.BALANCE_AMOUNT < 12500 then '66'
        when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
        when FAB.BALANCE_AMOUNT > 50000 then '89'
  end balance_class,
  FAT.TRANSACTION_AMOUNT AS amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
    on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
      AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND  FAB.BALANCE_DATE = (
        SELECT max(max.BALANCE_DATE)
        FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
        JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
          ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
        )
  ),
cmd as (
  SELECT
        P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
        L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
        L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
        --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
    WHERE
            LPR.ROLE = 'ACCOUNT_HOLDER'
      -- AND  ba.main is true ==> to add by CMD team (dragos)
      and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
)
SELECT * FROM credit_transfers
inner join cmd
on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m15:54:13.798651 [debug] [Thread-5 (]: On model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58724_CREDIT_TRANSFERS_SINGLE_BASIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
    AND FAT.TRANSACTION_CHANNEL not in ('H2H')
    );
  
[0m15:54:13.799231 [debug] [Thread-6 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'report in 58726 02&04'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      ELSE 'check the query'
  END metricToBeReported,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'N/A'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then '413'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '415'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
  END SCAIndicator,
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  '396' as pisp,
  IF(SUBSTR(CBA.BANK_ACCOUNT_NUMBER,5,5) = '36330' and CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '398','396') AS scheme,
  count(*) AS count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as Amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  group by 1,2,3,4,5
    );
  
[0m15:54:13.800116 [debug] [Thread-9 (]: On model.project_dbt.58788_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58788_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
SELECT
  '86' as CountryOfAISP,
  ac.USER_TOKEN,
  COUNT(*) AS number_of_consents,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
 inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
        OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
GROUP BY
            CountryOfAISP,
            ac.USER_TOKEN
)
SELECT
CountryOfAISP,
COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
FROM obsolete_and_active_consents_count_in_reporting_period
GROUP BY CountryOfAISP
order by CountryOfAISP asc
    );
  
[0m15:54:13.800947 [debug] [Thread-2 (]: On model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52525_FLOW_OF_NEW_CONTRACTS`
      
    
    

    OPTIONS()
    as (
      select
  count(*) AS number_of_new_contracts,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
WHERE
  iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m15:54:13.801490 [debug] [Thread-16 ]: On model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  case WHEN ftr.TRANSACTION_CHANNEL IN ('TPP') THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN ftr.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
    END SCAIndicator,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m15:54:13.802034 [debug] [Thread-1 (]: On model.project_dbt.52505_NR_OF_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52505_NR_OF_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
    IF(FAB.BALANCE_AMOUNT <= 100,'small balance', 'big balance') AS balance_size,
    iacc.account_currency,
    count(*) AS amount,
    ceil(sum (FAB.BALANCE_AMOUNT)) as booked_balance,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
WHERE
      iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND  (
    iacc.ACCOUNT_STATUS = 'OPEN'
    OR (
      iacc.ACCOUNT_STATUS = 'CLOSED'
      AND iacc.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  )
  AND iacc.ACCOUNT_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND FAB.BALANCE_DATE = (
      SELECT max(BALANCE_DATE)
      FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
      JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT`  a
        ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  )
group by 1,2
    );
  
[0m15:54:13.802730 [debug] [Thread-14 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type  = 'REGULAR'
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
  ORDER BY payee_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m15:54:13.803200 [debug] [Thread-7 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK`
      
    
    

    OPTIONS()
    as (
      SELECT
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  ON C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
WHERE D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND D.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND D.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m15:54:13.803674 [debug] [Thread-4 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as
  (
  SELECT
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'WITH TRADITIONAL MODES'
        WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'WITH AUTOMATED MODES'
    END Entrymode,
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER', 'TPP','OCS') THEN 'Single entry'
        WHEN FAT.TRANSACTION_CHANNEL in ('H2H') THEN 'Batch entry'
    END BatchMode,
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    case when FAB.BALANCE_AMOUNT < 12500 then '66'
          when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
          when FAB.BALANCE_AMOUNT > 50000 then '89'
    end balance_class,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

    FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
      ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
      ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
      ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
      ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
      ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
      AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND  FAB.BALANCE_DATE =
      (
          SELECT max(max.BALANCE_DATE)
          FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
          JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
            ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
          WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  ),
  cmd as (
    SELECT
          P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
          L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
          L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
          --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
      FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR
      on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L
      on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
      WHERE
              LPR.ROLE = 'ACCOUNT_HOLDER'
        -- AND  ba.main is true ==> to add by CMD team (dragos)
        and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
  )
  SELECT * FROM credit_transfers
  inner join cmd
  on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m15:54:13.806390 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m15:54:13.806854 [debug] [Thread-8 (]: On model.project_dbt.58746_PAYMENT_INITIATIONS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58746_PAYMENT_INITIATIONS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IF(credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '1','2') as residency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE as counterparty_country,
  IF(IT.INBOUND_TRANSACTION_CURRENCY_CODE = 'EUR', '1','2') as currencyType,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
      APP.APPLICATION_NAME = 'PAY-PXG-BANQUPIT'
      OR (
          APP.APPLICATION_NAME = 'PAY-PXG-OCS'
          AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
          AND substr( credacc.BANK_ACCOUNT_NUMBER,5,5)= '36330'
         )
      )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m15:54:13.814488 [debug] [Thread-10 ]: On model.project_dbt.58789_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58789_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      SELECT
  '86' as CountryOfAISP,
  pa.T_SOURCE_PK_ID as account_id,
  COUNT(*) AS number_of_consents,
  COUNT(DISTINCT pa.T_SOURCE_PK_ID) AS unique_accounts_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
  AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
  AND (
    (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
    OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
  )
GROUP BY account_id
    );
  
[0m15:54:13.828509 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Banque_en_ligne"
[0m15:54:13.829601 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m15:54:13.830435 [debug] [Thread-13 ]: On model.project_dbt.Banque_en_ligne: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Banque_en_ligne`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT( distinct ibis.ACCOUNT_MASTER_DATA_ID) AS count,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON bank.T_DIM_KEY = ibis.T_D_BANK_ACCOUNT_DIM_KEY
WHERE ibis.ACCOUNT_TYPE = "PAYMENT"
AND (ibis.ACCOUNT_STATUS = 'OPEN'
  OR
    (
      ibis.ACCOUNT_STATUS = 'CLOSED'
      AND ibis.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
)
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')))
AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND ibis.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')
    );
  
[0m15:54:13.831600 [debug] [Thread-15 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  deb.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
  COUNT(*) AS inbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS inbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
  AND ftr.transaction_type  = 'REGULAR'
GROUP BY deb.FINANCIAL_INSTITUTION_COUNTRY_CODE
ORDER BY payer_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(inbound_ibis_payments_trx_count) FROM DM WHERE payer_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(inbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payer_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payer_psp_country
    );
  
[0m15:54:14.463100 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3f21b424-2b83-427b-a5d1-e04f504b76d7&page=queryresults
[0m15:54:14.488594 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c8addc11-8a06-4370-8c8e-3400597644db&page=queryresults
[0m15:54:14.761319 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:360663eb-0334-4e5e-8dc2-181a2dd34bc2&page=queryresults
[0m15:54:14.763367 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b7e549eb-4b7d-4a04-9743-33ae933cd355&page=queryresults
[0m15:54:14.763879 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d83b06c4-f04e-4495-94d3-1b8cb16671ef&page=queryresults
[0m15:54:14.764941 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c77fe204-00bc-4e18-a598-bf0b8be5c9c7&page=queryresults
[0m15:54:14.765482 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:63cbd3b3-f338-401b-8199-09f7d0a79dbe&page=queryresults
[0m15:54:14.765947 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b69173f8-b092-4ab9-95bf-6232d57d3288&page=queryresults
[0m15:54:14.766402 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:620c4913-cc18-493a-9a1e-2adb7084e626&page=queryresults
[0m15:54:14.767438 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:71c21e9f-05e9-465a-8b5a-7bcb14600769&page=queryresults
[0m15:54:14.767925 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:be87c486-1e39-4a77-9403-3c727be81f1b&page=queryresults
[0m15:54:14.790292 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8ce612bc-782d-438a-992f-5971c0cdf71f&page=queryresults
[0m15:54:14.908373 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e05174fc-7f7f-4a4c-9418-ee0063162c5d&page=queryresults
[0m15:54:14.935793 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:fbf83dd3-cb40-4c4e-9173-a074262d0b42&page=queryresults
[0m15:54:15.022334 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:fc115d27-ea4e-4946-bd72-b725e194751e&page=queryresults
[0m15:54:15.026601 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5d61c133-da7f-4e37-98e5-4085c7a846f2&page=queryresults
[0m15:54:16.906219 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143da73d0>]}
[0m15:54:16.906803 [info ] [Thread-2 (]: 2 of 88 OK created sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS  [[32mCREATE TABLE (1.0 rows, 87.3 KiB processed)[0m in 3.95s]
[0m15:54:16.907383 [debug] [Thread-2 (]: Finished running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m15:54:16.907791 [debug] [Thread-2 (]: Began running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m15:54:16.908350 [info ] [Thread-2 (]: 17 of 88 START sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [RUN]
[0m15:54:16.908709 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS, now model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo)
[0m15:54:16.909033 [debug] [Thread-2 (]: Began compiling node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m15:54:16.916587 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m15:54:16.917070 [debug] [Thread-2 (]: Began executing node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m15:54:16.919667 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:54:17.410847 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m15:54:17.417330 [debug] [Thread-2 (]: On model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
     'Banqup applications' as TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
     AND APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
     AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
          AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'
          )
     AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3

UNION ALL

SELECT
     'OCS application' AS TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
AND FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 4 DESC
    );
  
[0m15:54:17.842555 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143e8be50>]}
[0m15:54:17.844385 [info ] [Thread-7 (]: 7 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [[32mCREATE TABLE (0.0 rows, 1.0 GiB processed)[0m in 4.88s]
[0m15:54:17.846117 [debug] [Thread-7 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m15:54:17.847348 [debug] [Thread-7 (]: Began running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m15:54:17.849039 [info ] [Thread-7 (]: 18 of 88 START sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [RUN]
[0m15:54:17.850285 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK, now model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo)
[0m15:54:17.851378 [debug] [Thread-7 (]: Began compiling node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m15:54:17.861065 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m15:54:17.861722 [debug] [Thread-7 (]: Began executing node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m15:54:17.864930 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:54:17.866529 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143da4640>]}
[0m15:54:17.868004 [info ] [Thread-1 (]: 1 of 88 OK created sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ... [[32mCREATE TABLE (2.0 rows, 59.4 MiB processed)[0m in 4.91s]
[0m15:54:17.868665 [debug] [Thread-1 (]: Finished running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m15:54:17.869050 [debug] [Thread-1 (]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m15:54:17.869510 [info ] [Thread-1 (]: 19 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [RUN]
[0m15:54:17.869828 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.52505_NR_OF_ACCOUNTS, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE)
[0m15:54:17.870214 [debug] [Thread-1 (]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m15:54:17.876481 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m15:54:17.877002 [debug] [Thread-1 (]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m15:54:17.879782 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:54:18.349381 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m15:54:18.353228 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ab9de0>]}
[0m15:54:18.355287 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:19ee6bdf-eafc-49da-81de-ac362f0a712d&page=queryresults
[0m15:54:18.357016 [info ] [Thread-11 ]: 11 of 88 OK created sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [[32mCREATE TABLE (0.0 rows, 1.0 GiB processed)[0m in 5.38s]
[0m15:54:18.358634 [debug] [Thread-7 (]: On model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C7_agMoyPaiTypeOpeSystZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
  case WHEN  SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) = SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN 'ON-US'
    WHEN SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) <> SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN'OFF-US'
    ELSE 'not_mapped'
    END AS typeSysteme,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.transaction_type  = 'REGULAR'
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m15:54:18.362505 [debug] [Thread-11 ]: Finished running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m15:54:18.365985 [debug] [Thread-11 ]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m15:54:18.367315 [info ] [Thread-11 ]: 20 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [RUN]
[0m15:54:18.368229 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE)
[0m15:54:18.369050 [debug] [Thread-11 ]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m15:54:18.375760 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m15:54:18.377060 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m15:54:18.377704 [debug] [Thread-1 (]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
  DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m15:54:18.378392 [debug] [Thread-11 ]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m15:54:18.382231 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:54:18.850988 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m15:54:18.852804 [debug] [Thread-11 ]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'

  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m15:54:19.182224 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:730f2045-500e-4565-a6f3-f5cf882c8534&page=queryresults
[0m15:54:19.274702 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:0744dfba-9904-4c0d-91cd-36d68af9b169&page=queryresults
[0m15:54:19.438980 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:ff90a43a-118a-4064-ac29-a255b0bb8ab3&page=queryresults
[0m15:54:19.548036 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c9a2c0>]}
[0m15:54:19.549716 [info ] [Thread-12 ]: 12 of 88 OK created sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.57s]
[0m15:54:19.551690 [debug] [Thread-12 ]: Finished running node model.project_dbt.A1_Number_of_payment_accounts
[0m15:54:19.553603 [debug] [Thread-12 ]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m15:54:19.555828 [info ] [Thread-12 ]: 21 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [RUN]
[0m15:54:19.558611 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.A1_Number_of_payment_accounts, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG)
[0m15:54:19.559713 [debug] [Thread-12 ]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m15:54:19.575115 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143de2260>]}
[0m15:54:19.578000 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m15:54:19.580703 [info ] [Thread-10 ]: 10 of 88 OK created sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (2.0 rows, 5.2 GiB processed)[0m in 6.61s]
[0m15:54:19.582237 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ca86d0>]}
[0m15:54:19.582925 [debug] [Thread-10 ]: Finished running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m15:54:19.583343 [debug] [Thread-12 ]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m15:54:19.583924 [info ] [Thread-9 (]: 9 of 88 OK created sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (1.0 rows, 5.2 GiB processed)[0m in 6.61s]
[0m15:54:19.584492 [debug] [Thread-10 ]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m15:54:19.590094 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:54:19.590755 [debug] [Thread-9 (]: Finished running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m15:54:19.591375 [info ] [Thread-10 ]: 22 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [RUN]
[0m15:54:19.592877 [debug] [Thread-9 (]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m15:54:19.593347 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.58789_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP)
[0m15:54:19.593863 [info ] [Thread-9 (]: 23 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [RUN]
[0m15:54:19.594254 [debug] [Thread-10 ]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m15:54:19.594629 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.58788_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo)
[0m15:54:19.599504 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m15:54:19.599876 [debug] [Thread-9 (]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m15:54:19.604256 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m15:54:19.604811 [debug] [Thread-10 ]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m15:54:19.609057 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m15:54:19.610335 [debug] [Thread-9 (]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m15:54:19.613806 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:54:20.192989 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m15:54:20.196685 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m15:54:20.199981 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m15:54:20.203427 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143da6ce0>]}
[0m15:54:20.205317 [debug] [Thread-12 ]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG`
      
    
    

    OPTIONS()
    as (
      SELECT
     COUNT(distinct c.consent_iban) AS COUNT,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM
     `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
          ON c.T_DIM_KEY = cc.T_DIM_KEY
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
          ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
     c.CONSENT_STATUS = 'VALID'
     AND LEFT(c.consent_iban, 2) = 'FR'
     AND c.CONSENT_TRANSACTION_ACCESS_ALLOWED IS TRUE
     AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     --AND  t.T_SOURCE_PK_ID <> '1'
     AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m15:54:20.207229 [debug] [Thread-10 ]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
     d_access_consent_info.USER_EMAIL AS user_token,
     COUNT(DISTINCT(d_access_consent_info.USER_EMAIL)) OVER(PARTITION BY d_access_consent_info.USER_EMAIL) unique_users_count_in_period,
     COUNT(DISTINCT(d_access_consent_info.T_BUS_KEY)) OVER(PARTITION BY d_access_consent_info.T_BUS_KEY) number_of_consents,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS d_pxg_payment_account
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS d_financial_platforms
     ON d_pxg_payment_account.T_D_FINANCIAL_PLATFORM_DIM_KEY=d_financial_platforms.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS d_financial_institutions
     ON d_financial_institutions.T_DIM_KEY = d_financial_platforms.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` AS d_access_consent_info
     ON d_pxg_payment_account.T_DIM_KEY=d_access_consent_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS d_contract_info
     ON d_pxg_payment_account.T_DIM_KEY=d_contract_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS d_application_account_info
     ON d_contract_info.T_D_APPLICATION_ACCOUNT_DIM_KEY=d_application_account_info.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS d_applications
     ON d_application_account_info.T_D_APPLICATION_DIM_KEY = d_applications.T_DIM_KEY
WHERE  (
     d_applications.APPLICATION_NAME  = 'PAY-PXG-JEFACTURE'
     -- AND d_application_account_info.T_SOURCE_PK_ID not in ('8856', '4545', '4571', '5170', '5188', '5244', '5275', '5301',
     --                                                        '5343', '5411', '5422', '5443', '5495', '5511', '5560', '5593',
     --                                                        '5628', '5651', '5652', '5653', '5654', '5655', '5657', '5658',
     --                                                        '5659', '5660', '5661', '5662', '6315', '6354', '6745', '6922',
     --                                                        '6960', '7175', '7222', '7386', '7428', '7582', '7666', '7753', '7768'
     --                                                        )
     )
     AND d_financial_institutions.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND
     (
          (
          d_access_consent_info.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     OR
          (
          d_access_consent_info.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     )
    );
  
[0m15:54:20.209296 [info ] [Thread-13 ]: 13 of 88 OK created sql incremental model dev_dm_pst3_FR.Banque_en_ligne ....... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 7.22s]
[0m15:54:20.211367 [debug] [Thread-9 (]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    round(SUM(ftr.TRANSACTION_AMOUNT)) AS outbound_ibis_payments_amount_sum_in_EUR,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL not IN ('DASHBOARD', 'OTHER', 'CARDS')
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
group by cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
order by payee_psp_country ASC
    );
  
[0m15:54:20.218140 [debug] [Thread-13 ]: Finished running node model.project_dbt.Banque_en_ligne
[0m15:54:20.221691 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuadro1_accounts
[0m15:54:20.223754 [info ] [Thread-13 ]: 24 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ........... [RUN]
[0m15:54:20.224802 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Banque_en_ligne, now model.project_dbt.Cuadro1_accounts)
[0m15:54:20.225709 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuadro1_accounts
[0m15:54:20.234212 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_accounts"
[0m15:54:20.234879 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuadro1_accounts
[0m15:54:20.237881 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:20.730490 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_accounts"
[0m15:54:20.732081 [debug] [Thread-13 ]: On model.project_dbt.Cuadro1_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) AS number_of_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
 ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    )
    AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  )
    );
  
[0m15:54:21.807397 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:74ca60e6-ef61-4022-b43d-f5e5a9b74bbc&page=queryresults
[0m15:54:21.810788 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:67517e3d-141a-4b39-9261-74bc37ac85f9&page=queryresults
[0m15:54:21.923696 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:aa5485e9-1251-45c6-8db4-ef2f4a8bc5aa&page=queryresults
[0m15:54:22.032315 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5b924c3c-7dec-43a5-a3f2-7c782d346f33&page=queryresults
[0m15:54:25.711471 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142793f10>]}
[0m15:54:25.713201 [info ] [Thread-12 ]: 21 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [[32mCREATE TABLE (1.0 rows, 1.4 GiB processed)[0m in 6.15s]
[0m15:54:25.714346 [debug] [Thread-12 ]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m15:54:25.714743 [debug] [Thread-12 ]: Began running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m15:54:25.715169 [info ] [Thread-12 ]: 25 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs . [RUN]
[0m15:54:25.716224 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG, now model.project_dbt.Cuadro1_number_of_AIS_PSUs)
[0m15:54:25.716677 [debug] [Thread-12 ]: Began compiling node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m15:54:25.730643 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m15:54:25.734025 [debug] [Thread-12 ]: Began executing node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m15:54:25.738878 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:54:26.237076 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m15:54:26.238949 [debug] [Thread-12 ]: On model.project_dbt.Cuadro1_number_of_AIS_PSUs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_number_of_AIS_PSUs`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPES')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        OR (
          ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  WHERE USER_TOKEN <>'NA'
    );
  
[0m15:54:26.815762 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143f55870>]}
[0m15:54:26.817455 [info ] [Thread-13 ]: 24 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ...... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.59s]
[0m15:54:26.819044 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuadro1_accounts
[0m15:54:26.820222 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m15:54:26.821536 [info ] [Thread-13 ]: 26 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [RUN]
[0m15:54:26.822700 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_accounts, now model.project_dbt.Cuadro9_Credit_transfers_sent)
[0m15:54:26.823795 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m15:54:26.833368 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m15:54:26.834022 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m15:54:26.837123 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:26.930923 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143bbcd30>]}
[0m15:54:26.932728 [info ] [Thread-5 (]: 5 of 88 OK created sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [[32mCREATE TABLE (27.0 rows, 11.1 GiB processed)[0m in 13.97s]
[0m15:54:26.934488 [debug] [Thread-5 (]: Finished running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m15:54:26.935785 [debug] [Thread-5 (]: Began running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m15:54:26.937511 [info ] [Thread-5 (]: 27 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [RUN]
[0m15:54:26.939332 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS, now model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts)
[0m15:54:26.940977 [debug] [Thread-5 (]: Began compiling node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m15:54:26.949380 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m15:54:26.952607 [debug] [Thread-5 (]: Began executing node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m15:54:26.958497 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:54:27.087506 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a48f923e-6ab3-4f9a-804c-06578b36599b&page=queryresults
[0m15:54:27.299532 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m15:54:27.301269 [debug] [Thread-13 ]: On model.project_dbt.Cuadro9_Credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro9_Credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
  ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
  ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >=  TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <  TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    );
  
[0m15:54:27.432055 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m15:54:27.433750 [debug] [Thread-5 (]: On model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro1_number_of_AISPs_accessing_UPP_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
c.consent_iban,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  on c.T_DIM_KEY = cc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='ES'
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  and c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m15:54:27.771221 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143de0ca0>]}
[0m15:54:27.773051 [info ] [Thread-4 (]: 4 of 88 OK created sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [[32mCREATE TABLE (27.0 rows, 11.6 GiB processed)[0m in 14.81s]
[0m15:54:27.774813 [debug] [Thread-4 (]: Finished running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m15:54:27.776016 [debug] [Thread-4 (]: Began running node model.project_dbt.Cuardro4_PIS
[0m15:54:27.777542 [info ] [Thread-4 (]: 28 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_PIS ............... [RUN]
[0m15:54:27.778435 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS, now model.project_dbt.Cuardro4_PIS)
[0m15:54:27.779397 [debug] [Thread-4 (]: Began compiling node model.project_dbt.Cuardro4_PIS
[0m15:54:27.787538 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.Cuardro4_PIS"
[0m15:54:27.788009 [debug] [Thread-4 (]: Began executing node model.project_dbt.Cuardro4_PIS
[0m15:54:27.790630 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:54:27.930907 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:56b19a4b-514a-4a97-af0b-0f508bd832b8&page=queryresults
[0m15:54:28.362596 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.Cuardro4_PIS"
[0m15:54:28.364179 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:75e1f009-a2a2-49c8-a1d7-c098e542158b&page=queryresults
[0m15:54:28.370913 [debug] [Thread-4 (]: On model.project_dbt.Cuardro4_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IT.INBOUND_TRANSACTION_CURRENCY_CODE as trx_currency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  as counterparty_country,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
      ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
      ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
      ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
      ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
      ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
      ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
      ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
      ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE  FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND ( APP.APPLICATION_NAME = 'PAY-PXG-BANQUPES'
          OR (
            APP.APPLICATION_NAME = 'PAY-PXG-OCS'
            AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  = 'ES'
            AND substr( credacc.BANK_ACCOUNT_NUMBER,5,4)= '6918'
            )
        )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1,2
    );
  
[0m15:54:29.347265 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142b67ee0>]}
[0m15:54:29.349132 [info ] [Thread-15 ]: 15 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [[32mCREATE TABLE (31.0 rows, 33.1 GiB processed)[0m in 16.37s]
[0m15:54:29.350851 [debug] [Thread-15 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m15:54:29.352100 [debug] [Thread-15 ]: Began running node model.project_dbt.Cuardro4_credit_transers_received
[0m15:54:29.353826 [info ] [Thread-15 ]: 29 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [RUN]
[0m15:54:29.355547 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5d8165fa-76a4-4e17-ac54-3f1a47634d44&page=queryresults
[0m15:54:29.357061 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU, now model.project_dbt.Cuardro4_credit_transers_received)
[0m15:54:29.360216 [debug] [Thread-15 ]: Began compiling node model.project_dbt.Cuardro4_credit_transers_received
[0m15:54:29.372614 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m15:54:29.374216 [debug] [Thread-15 ]: Began executing node model.project_dbt.Cuardro4_credit_transers_received
[0m15:54:29.377983 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m15:54:29.896724 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m15:54:29.898609 [debug] [Thread-15 ]: On model.project_dbt.Cuardro4_credit_transers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  count(*)  as inbound_ibis_payments_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS inbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE (FAT.TRANSACTION_DIRECTION = "INBOUND")
    AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
    AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
    AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1
  ORDER BY 1
    );
  
[0m15:54:30.805626 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5f4400e6-0449-444b-ba93-dd4024d101b2&page=queryresults
[0m15:54:31.861823 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a6bd90>]}
[0m15:54:31.863668 [info ] [Thread-12 ]: 25 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs  [[32mCREATE TABLE (1.0 rows, 6.1 GiB processed)[0m in 6.15s]
[0m15:54:31.865287 [debug] [Thread-12 ]: Finished running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m15:54:31.866572 [debug] [Thread-12 ]: Began running node model.project_dbt.Cuardro4_credit_transers_sent
[0m15:54:31.867953 [info ] [Thread-12 ]: 30 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [RUN]
[0m15:54:31.869269 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_number_of_AIS_PSUs, now model.project_dbt.Cuardro4_credit_transers_sent)
[0m15:54:31.870226 [debug] [Thread-12 ]: Began compiling node model.project_dbt.Cuardro4_credit_transers_sent
[0m15:54:31.957828 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m15:54:31.958395 [debug] [Thread-12 ]: Began executing node model.project_dbt.Cuardro4_credit_transers_sent
[0m15:54:31.960900 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:54:32.491257 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m15:54:32.495111 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142fd9060>]}
[0m15:54:32.497739 [info ] [Thread-9 (]: 23 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [[32mCREATE TABLE (8.0 rows, 11.1 GiB processed)[0m in 12.90s]
[0m15:54:32.499428 [debug] [Thread-12 ]: On model.project_dbt.Cuardro4_credit_transers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN '211 Manual entry'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP','OCS','H2H' ) THEN '212 Electronic entry'
  END EntryMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS') THEN '2122 single '
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '2121 Batch entry'
  END BatchMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'NoSCA - 212333 Trusted Beneficiaries'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'NoSCA - 212335 secure processes'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      else 'check the query'
  END SCAIndicator,
  count (*) as outbound_ibis_payments_trx_count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE(FAT.TRANSACTION_DIRECTION = "OUTBOUND")
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m15:54:32.501202 [debug] [Thread-9 (]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m15:54:32.509453 [debug] [Thread-9 (]: Began running node model.project_dbt.KMS_C
[0m15:54:32.511057 [info ] [Thread-9 (]: 31 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C ...................... [RUN]
[0m15:54:32.512385 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo, now model.project_dbt.KMS_C)
[0m15:54:32.513571 [debug] [Thread-9 (]: Began compiling node model.project_dbt.KMS_C
[0m15:54:32.523981 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.KMS_C"
[0m15:54:32.524552 [debug] [Thread-9 (]: Began executing node model.project_dbt.KMS_C
[0m15:54:32.527464 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:54:32.920751 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0141f743a0>]}
[0m15:54:32.922503 [info ] [Thread-5 (]: 27 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [[32mCREATE TABLE (0.0 rows, 1.4 GiB processed)[0m in 5.98s]
[0m15:54:32.924088 [debug] [Thread-5 (]: Finished running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m15:54:32.925309 [debug] [Thread-5 (]: Began running node model.project_dbt.KMS_C_non_euro_transactions
[0m15:54:32.926674 [info ] [Thread-5 (]: 32 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [RUN]
[0m15:54:32.928069 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts, now model.project_dbt.KMS_C_non_euro_transactions)
[0m15:54:32.929334 [debug] [Thread-5 (]: Began compiling node model.project_dbt.KMS_C_non_euro_transactions
[0m15:54:32.935527 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m15:54:32.936013 [debug] [Thread-5 (]: Began executing node model.project_dbt.KMS_C_non_euro_transactions
[0m15:54:32.939505 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:54:33.031848 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.KMS_C"
[0m15:54:33.033582 [debug] [Thread-9 (]: On model.project_dbt.KMS_C: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
group by 1
    );
  
[0m15:54:33.394551 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:80d4ab97-a60c-4ab8-8b9a-6dab8f8e3f25&page=queryresults
[0m15:54:33.492246 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m15:54:33.493908 [debug] [Thread-5 (]: On model.project_dbt.KMS_C_non_euro_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C_non_euro_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_non_EUR_transactions,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_CURRENCY <> 'EUR'
AND TRANSACTION_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND TRANSACTION_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m15:54:33.894223 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:0abec86d-40e2-47a9-ad33-c161713564c3&page=queryresults
[0m15:54:34.162782 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a5f858f9-b1bc-43a7-ac8d-b8f16f8c5115&page=queryresults
[0m15:54:34.642452 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a696c0>]}
[0m15:54:34.644400 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143f1dff0>]}
[0m15:54:34.645904 [info ] [Thread-11 ]: 20 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [[32mCREATE TABLE (30.0 rows, 33.2 GiB processed)[0m in 16.27s]
[0m15:54:34.650508 [info ] [Thread-16 ]: 16 of 88 OK created sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [[32mCREATE TABLE (31.0 rows, 47.2 GiB processed)[0m in 21.66s]
[0m15:54:34.652649 [debug] [Thread-11 ]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m15:54:34.654455 [debug] [Thread-16 ]: Finished running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m15:54:34.656160 [debug] [Thread-11 ]: Began running node model.project_dbt.KMS_MRA
[0m15:54:34.657700 [debug] [Thread-16 ]: Began running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m15:54:34.659424 [info ] [Thread-11 ]: 33 of 88 START sql incremental model dev_dm_pst3_LV.KMS_MRA .................... [RUN]
[0m15:54:34.661011 [info ] [Thread-16 ]: 34 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [RUN]
[0m15:54:34.662286 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE, now model.project_dbt.KMS_MRA)
[0m15:54:34.663554 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo, now model.project_dbt.KMS_P11_Outgoing_transactions)
[0m15:54:34.664948 [debug] [Thread-11 ]: Began compiling node model.project_dbt.KMS_MRA
[0m15:54:34.666466 [debug] [Thread-16 ]: Began compiling node model.project_dbt.KMS_P11_Outgoing_transactions
[0m15:54:34.676337 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.KMS_MRA"
[0m15:54:34.683548 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m15:54:34.684278 [debug] [Thread-16 ]: Began executing node model.project_dbt.KMS_P11_Outgoing_transactions
[0m15:54:34.689327 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:54:34.689757 [debug] [Thread-11 ]: Began executing node model.project_dbt.KMS_MRA
[0m15:54:34.694038 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:54:35.121141 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0141f74eb0>]}
[0m15:54:35.122826 [info ] [Thread-14 ]: 14 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [[32mCREATE TABLE (31.0 rows, 33.2 GiB processed)[0m in 22.14s]
[0m15:54:35.124469 [debug] [Thread-14 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m15:54:35.125662 [debug] [Thread-14 ]: Began running node model.project_dbt.KMS_P17_PIS
[0m15:54:35.126934 [info ] [Thread-14 ]: 35 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ................ [RUN]
[0m15:54:35.128117 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI, now model.project_dbt.KMS_P17_PIS)
[0m15:54:35.129151 [debug] [Thread-14 ]: Began compiling node model.project_dbt.KMS_P17_PIS
[0m15:54:35.142585 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.KMS_P17_PIS"
[0m15:54:35.143155 [debug] [Thread-14 ]: Began executing node model.project_dbt.KMS_P17_PIS
[0m15:54:35.146028 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m15:54:35.159579 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143967280>]}
[0m15:54:35.160357 [info ] [Thread-6 (]: 6 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [[32mCREATE TABLE (1.0 rows, 22.0 GiB processed)[0m in 22.19s]
[0m15:54:35.161236 [debug] [Thread-6 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m15:54:35.162013 [debug] [Thread-6 (]: Began running node model.project_dbt.KMS_P21_Inbound_transactions
[0m15:54:35.162811 [info ] [Thread-6 (]: 36 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [RUN]
[0m15:54:35.163394 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN, now model.project_dbt.KMS_P21_Inbound_transactions)
[0m15:54:35.164062 [debug] [Thread-6 (]: Began compiling node model.project_dbt.KMS_P21_Inbound_transactions
[0m15:54:35.172089 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m15:54:35.173447 [debug] [Thread-6 (]: Began executing node model.project_dbt.KMS_P21_Inbound_transactions
[0m15:54:35.177122 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m15:54:35.245128 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.KMS_MRA"
[0m15:54:35.249102 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m15:54:35.252056 [debug] [Thread-11 ]: On model.project_dbt.KMS_MRA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_MRA`
      
    
    

    OPTIONS()
    as (
      SELECT
  BA.BANK_ACCOUNT_NUMBER as large_biller_account,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_CURRENT` AS M
left JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON M.T_D_MRA_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
WHERE M.T_D_MRA_BANK_ACCOUNT_DIM_KEY is not null
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND MERCHANT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND MERCHANT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m15:54:35.255539 [debug] [Thread-16 ]: On model.project_dbt.KMS_P11_Outgoing_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P11_Outgoing_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  group by 1
    );
  
[0m15:54:36.030716 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m15:54:36.032853 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.KMS_P17_PIS"
[0m15:54:36.034363 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ccbe50>]}
[0m15:54:36.040831 [debug] [Thread-6 (]: On model.project_dbt.KMS_P21_Inbound_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P21_Inbound_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
   d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
   COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS inbound_ibis_payments_trx_count,
   COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS inbound_ibis_payment_amount_sum_in_EUR,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   '2024S1' AS PERIOD,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
 INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
 WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
     AND FAT.TRANSACTION_TYPE = 'REGULAR'
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
     AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
     AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
     AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
 group by 1
 order by 1
    );
  
[0m15:54:36.042489 [debug] [Thread-14 ]: On model.project_dbt.KMS_P17_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P17_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLV'
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
 GROUP BY 1, 2, 3

UNION ALL

SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX72'
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 1,2 DESC
    );
  
[0m15:54:36.058251 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:128fb300-e609-43d8-9c33-3940d3c3021e&page=queryresults
[0m15:54:36.357032 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9953014a-71b7-401b-9c3d-3f4d0351a20e&page=queryresults
[0m15:54:36.925760 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:92030a0b-7552-4816-ab09-72a598e072be&page=queryresults
[0m15:54:37.002065 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:096bd779-5dab-4d7c-9e7c-a0fd3665c8a7&page=queryresults
[0m15:54:37.414094 [info ] [Thread-7 (]: 18 of 88 OK created sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [[32mCREATE TABLE (9.0 rows, 23.5 GiB processed)[0m in 18.18s]
[0m15:54:37.416115 [debug] [Thread-7 (]: Finished running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m15:54:37.417242 [debug] [Thread-7 (]: Began running node model.project_dbt.KMS_P6a_number_of_AIS
[0m15:54:37.419615 [info ] [Thread-7 (]: 37 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS ...... [RUN]
[0m15:54:37.420019 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo, now model.project_dbt.KMS_P6a_number_of_AIS)
[0m15:54:37.420346 [debug] [Thread-7 (]: Began compiling node model.project_dbt.KMS_P6a_number_of_AIS
[0m15:54:37.428196 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m15:54:37.428827 [debug] [Thread-7 (]: Began executing node model.project_dbt.KMS_P6a_number_of_AIS
[0m15:54:37.431805 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:54:37.884949 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd47f0>]}
[0m15:54:37.886651 [info ] [Thread-8 (]: 8 of 88 OK created sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS  [[32mCREATE TABLE (1.0 rows, 27.6 GiB processed)[0m in 24.92s]
[0m15:54:37.888276 [debug] [Thread-8 (]: Finished running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m15:54:37.889466 [debug] [Thread-8 (]: Began running node model.project_dbt.KMS_P7a_number_of_accounts
[0m15:54:37.891228 [info ] [Thread-8 (]: 38 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts . [RUN]
[0m15:54:37.892769 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.58746_PAYMENT_INITIATIONS, now model.project_dbt.KMS_P7a_number_of_accounts)
[0m15:54:37.894161 [debug] [Thread-8 (]: Began compiling node model.project_dbt.KMS_P7a_number_of_accounts
[0m15:54:37.902198 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m15:54:37.902808 [debug] [Thread-8 (]: Began executing node model.project_dbt.KMS_P7a_number_of_accounts
[0m15:54:37.907277 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:54:37.922396 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m15:54:37.923334 [debug] [Thread-7 (]: On model.project_dbt.KMS_P6a_number_of_AIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P6a_number_of_AIS`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPLV')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND ( ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    '2024S1' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m15:54:38.500126 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m15:54:38.501812 [debug] [Thread-8 (]: On model.project_dbt.KMS_P7a_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P7a_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND (
      IACC.ACCOUNT_STATUS = 'OPEN'
      OR (
        IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
      )
    )
  AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m15:54:38.909223 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:14324128-34be-47ea-9920-e190ae57f59f&page=queryresults
[0m15:54:38.950470 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01483a5c60>]}
[0m15:54:38.952134 [info ] [Thread-10 ]: 22 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [[32mCREATE TABLE (44.0k rows, 15.2 GiB processed)[0m in 19.36s]
[0m15:54:38.954189 [debug] [Thread-10 ]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m15:54:38.956010 [debug] [Thread-10 ]: Began running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m15:54:38.957987 [info ] [Thread-10 ]: 39 of 88 START sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [RUN]
[0m15:54:38.959076 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP, now model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP)
[0m15:54:38.960138 [debug] [Thread-10 ]: Began compiling node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m15:54:38.968434 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m15:54:38.968984 [debug] [Thread-10 ]: Began executing node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m15:54:38.972849 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m15:54:39.083285 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1f1e7ffa-29f1-4987-b9af-ee69a1d6c3dd&page=queryresults
[0m15:54:39.458145 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m15:54:39.459912 [debug] [Thread-10 ]: On model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`NC1_Number_of_payment_accounts_accessed_by_UPP`
      
    
    

    OPTIONS()
    as (
      WITH pre AS (
  SELECT
    'DE' AS country,
    ac.USER_TOKEN,
    count(*),
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS pa
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE a.APPLICATION_NAME = 'PAY-PXG-BANQUPDE'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
      TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      OR
      (
      TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      )
    )
  GROUP BY 1,2
)
SELECT
  country ,
  count(distinct USER_TOKEN) as unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM PRE
GROUP BY 1
    );
  
[0m15:54:39.729468 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01438c81c0>]}
[0m15:54:39.731227 [info ] [Thread-13 ]: 26 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [[32mCREATE TABLE (1.0 rows, 10.9 GiB processed)[0m in 12.91s]
[0m15:54:39.733265 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m15:54:39.735172 [debug] [Thread-13 ]: Began running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m15:54:39.737229 [info ] [Thread-13 ]: 40 of 88 START sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [RUN]
[0m15:54:39.738525 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro9_Credit_transfers_sent, now model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS)
[0m15:54:39.739622 [debug] [Thread-13 ]: Began compiling node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m15:54:39.747968 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m15:54:39.748565 [debug] [Thread-13 ]: Began executing node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m15:54:39.752009 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:40.343084 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m15:54:40.344824 [debug] [Thread-13 ]: On model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS`
      
    
    

    OPTIONS()
    as (
      SELECT
    LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
    c.consent_iban,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
    c.CONSENT_STATUS = 'VALID'
    AND left(c.consent_iban,2) = 'BE'
    AND c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m15:54:40.453795 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:0dc5413e-e770-4a01-9adf-c1d610474c54&page=queryresults
[0m15:54:41.177471 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a1c16467-7fe7-47d0-a684-0392d59eda4e&page=queryresults
[0m15:54:42.089627 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ccbac0>]}
[0m15:54:42.090627 [info ] [Thread-15 ]: 29 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [[32mCREATE TABLE (0.0 rows, 11.1 GiB processed)[0m in 12.73s]
[0m15:54:42.091204 [debug] [Thread-15 ]: Finished running node model.project_dbt.Cuardro4_credit_transers_received
[0m15:54:42.091602 [debug] [Thread-15 ]: Began running node model.project_dbt.PAY_CPCA
[0m15:54:42.092001 [info ] [Thread-15 ]: 41 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCA ................... [RUN]
[0m15:54:42.092376 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_received, now model.project_dbt.PAY_CPCA)
[0m15:54:42.092823 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PAY_CPCA
[0m15:54:42.104377 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PAY_CPCA"
[0m15:54:42.104905 [debug] [Thread-15 ]: Began executing node model.project_dbt.PAY_CPCA
[0m15:54:42.107527 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m15:54:42.607683 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PAY_CPCA"
[0m15:54:42.610160 [debug] [Thread-15 ]: On model.project_dbt.PAY_CPCA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCA`
      
    
    

    OPTIONS()
    as (
      WITH count_NContAISPS_last_six_months AS(
  SELECT
    row_number() over () as IDReg,
    'Y' as Ot,     -- PXG perspective
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasASPSP,
    'BE' as PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 as NContAISPM,                                             -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPS,       -- Number of accounts with consent in last 6 months
    0 as NPedInUt,                                               -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 as NPedSInUt,                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' --PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  AND fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -6 MONTH)
  )
  -- Created before the end of the reporting period AND still active or status last changed within 6 months before the reporting period
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM_previous_month AS(
  SELECT
    row_number() over () as IDReg,
   'Y' as Ot,     -- PXG perspective
   LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
   substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
   'PSDBE-NBB-0649860804' as AISP,
   'BE' as PasASPSP,
   'BE' as PasAISP,
   '' AS LEIASPSP,
   '5493000RZ2KSLKCYNN98' AS LEIAISP,
   '1' AS ModAc,
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPM,       -- Number of accounts with consent in month
    0 as NContAISPS,                                             -- Number of accounts with consent in last 6 months (numbers were in previous part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NPedInUt,         -- Assuming one access per day
    4 * count(distinct bad.BANK_ACCOUNT_NUMBER) * extract(DAY FROM LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)))  as NPedSInUt,     -- 4 * Number of days in month * number of accounts with consent in month
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' -- PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)
  )
  -- Created before the end of the reporting period and (is still active or status last changed before the start of the reporting period)
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    COUNT(*) AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    0 AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt,                                         -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    -- c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))
    -- AND (c.CONSENT_STATUS = 'VALID'
    --   OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >=  DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)
    --   ) -- ==> geen consent_status_at in DWH ook niet in DL
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
),
count_NContAISPS AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    COUNT(*) AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    --  c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))
    -- AND (acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    --   or DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:42.103465', 'Etc/UTC'))), INTERVAL -6 MONTH)
    --   ) ==> no consent status at?
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
)
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPS_last_six_months
  UNION ALL
  SELECT * FROM count_NContAISPM_previous_month
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPM
  UNION ALL
  SELECT * FROM count_NContAISPS
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m15:54:43.535643 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4d72b829-99bc-420a-9b40-741654c40c8f&page=queryresults
[0m15:54:44.159508 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a70a60>]}
[0m15:54:44.160988 [info ] [Thread-13 ]: 40 of 88 OK created sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [[32mCREATE TABLE (0.0 rows, 1.4 GiB processed)[0m in 4.42s]
[0m15:54:44.162416 [debug] [Thread-13 ]: Finished running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m15:54:44.163283 [debug] [Thread-13 ]: Began running node model.project_dbt.PAY_CPCL
[0m15:54:44.164270 [info ] [Thread-13 ]: 42 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCL ................... [RUN]
[0m15:54:44.165044 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS, now model.project_dbt.PAY_CPCL)
[0m15:54:44.165700 [debug] [Thread-13 ]: Began compiling node model.project_dbt.PAY_CPCL
[0m15:54:44.172317 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.PAY_CPCL"
[0m15:54:44.173607 [debug] [Thread-13 ]: Began executing node model.project_dbt.PAY_CPCL
[0m15:54:44.176559 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:44.395141 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a6bd90>]}
[0m15:54:44.396943 [info ] [Thread-12 ]: 30 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [[32mCREATE TABLE (0.0 rows, 15.7 GiB processed)[0m in 12.53s]
[0m15:54:44.398725 [debug] [Thread-12 ]: Finished running node model.project_dbt.Cuardro4_credit_transers_sent
[0m15:54:44.400019 [debug] [Thread-12 ]: Began running node model.project_dbt.PAY_CPMC
[0m15:54:44.401652 [info ] [Thread-12 ]: 43 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPMC ................... [RUN]
[0m15:54:44.402681 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_sent, now model.project_dbt.PAY_CPMC)
[0m15:54:44.403565 [debug] [Thread-12 ]: Began compiling node model.project_dbt.PAY_CPMC
[0m15:54:44.411491 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.PAY_CPMC"
[0m15:54:44.411995 [debug] [Thread-12 ]: Began executing node model.project_dbt.PAY_CPMC
[0m15:54:44.414769 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:54:44.847996 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.PAY_CPCL"
[0m15:54:44.849601 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142fda950>]}
[0m15:54:44.850147 [info ] [Thread-5 (]: 32 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [[32mCREATE TABLE (1.0 rows, 10.7 GiB processed)[0m in 11.92s]
[0m15:54:44.850575 [debug] [Thread-13 ]: On model.project_dbt.PAY_CPCL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCL`
      
    
    

    OPTIONS()
    as (
      SELECT
    "Y" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:44.171799', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasCl,
    COUNT(DISTINCT acic.USER_TOKEN) as NCl,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` as acic
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` AS pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` AS fp
        ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` AS aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
WHERE
    -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- Replace previous premise with thise for test with BE data
    and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
    AND acic.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:54:44.171799', 'Etc/UTC'))
    AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:54:44.171799', 'Etc/UTC'))
GROUP BY 1,3,4,5,7,8
    );
  
[0m15:54:44.851129 [debug] [Thread-5 (]: Finished running node model.project_dbt.KMS_C_non_euro_transactions
[0m15:54:44.852472 [debug] [Thread-5 (]: Began running node model.project_dbt.PAY_CPNC
[0m15:54:44.853098 [info ] [Thread-5 (]: 44 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPNC ................... [RUN]
[0m15:54:44.853514 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C_non_euro_transactions, now model.project_dbt.PAY_CPNC)
[0m15:54:44.853850 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PAY_CPNC
[0m15:54:44.860291 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PAY_CPNC"
[0m15:54:44.860836 [debug] [Thread-5 (]: Began executing node model.project_dbt.PAY_CPNC
[0m15:54:44.863549 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:54:44.888689 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.PAY_CPMC"
[0m15:54:44.890311 [debug] [Thread-12 ]: On model.project_dbt.PAY_CPMC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPMC`
      
    
    

    OPTIONS()
    as (
      WITH operation_types AS (
    (select 'ICDT' as family, 'ESCT' as subfamily, '22' as TipOper) union all
    (select 'MCOP' as family, 'OTHR' as subfamily, '27' as TipOper) union all
    (select 'MDOP' as family, 'OTHR' as subfamily, '28' as TipOper) union all
    (select 'RCDT' as family, 'ESCT' as subfamily, '21' as TipOper) union all
    (select 'RCDT' as family, 'RRTN' as subfamily, '21' as TipOper) union all
    (select 'RDDT' as family, 'ESDD' as subfamily, '22' as TipOper) union all
    (select 'RDDT' as family, 'OODD' as subfamily, '22' as TipOper)
)
SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:44.411140', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    ifnull(t.TipOper, 'NA') AS TipOper,
    count(1) as Quant,
    sum(am.MOVEMENT_AMOUNT) as Mont,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS` as am
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT` AS ia
    ON am.T_D_IBIS_ACCOUNT_DIM_KEY = ia.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bad
        ON ia.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
LEFT JOIN operation_types t
    ON t.family = am.MOVEMENT_FAMILY
    AND t.subfamily = am.MOVEMENT_SUBFAMILY
WHERE
    left(bad.BANK_ACCOUNT_NUMBER,2) = 'BE'
    AND am.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:54:44.411140', 'Etc/UTC'))
    AND am.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:54:44.411140', 'Etc/UTC'))
GROUP BY 1,3,4,5,8,9
    );
  
[0m15:54:44.960308 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142f78040>]}
[0m15:54:44.962012 [info ] [Thread-9 (]: 31 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C ................. [[32mCREATE TABLE (1.0 rows, 11.1 GiB processed)[0m in 12.45s]
[0m15:54:44.963648 [debug] [Thread-9 (]: Finished running node model.project_dbt.KMS_C
[0m15:54:44.964869 [debug] [Thread-9 (]: Began running node model.project_dbt.PAY_TROP_5845_CMD
[0m15:54:44.966350 [info ] [Thread-9 (]: 45 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD .......... [RUN]
[0m15:54:44.967373 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C, now model.project_dbt.PAY_TROP_5845_CMD)
[0m15:54:44.968448 [debug] [Thread-9 (]: Began compiling node model.project_dbt.PAY_TROP_5845_CMD
[0m15:54:44.977491 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m15:54:44.978162 [debug] [Thread-9 (]: Began executing node model.project_dbt.PAY_TROP_5845_CMD
[0m15:54:44.981007 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:54:45.424147 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PAY_CPNC"
[0m15:54:45.425783 [debug] [Thread-5 (]: On model.project_dbt.PAY_CPNC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPNC`
      
    
    

    OPTIONS()
    as (
      SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 15:54:44.859872', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    "5493000RZ2KSLKCYNN98" AS LEIASPSP,
    "N.E." AS `If`,
    "2" AS TipCont,
    "" AS DepOvTr,
    le.ENTERPRISE_ADDRESS_COUNTRY as PasTit,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS CPos,
    pa.PAYMENT_ACCOUNT_CURRENCY AS Div,
    "Y" AS ContrOB,
    count(1) as NCont,
    count(1) as NContAOn,
    0 AS NContAISPM,
    0 AS SaldoME,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` as iac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED` AS pa
    ON iac.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
    AND LEFT(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` AS lep
        ON lep.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` AS le
    ON le.T_DIM_KEY = lep.T_D_LEGAL_ENTITY_DIM_KEY
WHERE
    (
        pa.PAYMENT_ACCOUNT_STATUS = 'ACTIVE'
        OR(
            pa.PAYMENT_ACCOUNT_STATUS != 'ACTIVE'
            AND pa.PAYMENT_ACCOUNT_UPDATED_AT >= TIMESTAMP('2024-10-01 15:54:44.859872')
        )
    )
    AND left(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
    AND pa.PAYMENT_ACCOUNT_CREATED_AT <= TIMESTAMP('2024-10-31 15:54:44.859872')
GROUP BY 1,3,4,5,6,7,8,9,10,11,12,15,16,17,18
    );
  
[0m15:54:45.460258 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m15:54:45.462027 [debug] [Thread-9 (]: On model.project_dbt.PAY_TROP_5845_CMD: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD`
      
    
    

    OPTIONS()
    as (
      SELECT
    pa.PAYMENT_ACCOUNT_NUMBER AS identifier,
    le.ENTERPRISE_ADDRESS_NUMBER AS enterprise_number,
    le.ENTERPRISE_LEGAL_FORM AS legal_form,
    le.ENTERPRISE_ADDRESS_COUNTRY AS country,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS postal_code,
FROM(
  WITH current_table AS (
  SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
)  AS pa
LEFT JOIN(
select *,
row_number() over(partition by T_D_PAYMENT_ACCOUNT_DIM_KEY order by T_INGESTION_TIMESTAMP desc) as rn
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES_DECRYPTED`
)  lepar
    ON pa.T_DIM_KEY = lepar.T_D_PAYMENT_ACCOUNT_DIM_KEY AND lepar.T_FACT_KEY != 0
    and rn = 1
LEFT JOIN(
  WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED`
  )
  SELECT * EXCEPT(rn)
  FROM current_table
  WHERE rn = 1
)  AS le
    ON lepar.T_D_LEGAL_ENTITY_DIM_KEY = le.T_DIM_KEY AND le.T_DIM_KEY <> 0
WHERE pa.T_DIM_KEY <> 0 AND pa.PAYMENT_ACCOUNT_COUNTRY = 'BE'
    AND pa.T_SOURCE = 'P1_PCMD'
    );
  
[0m15:54:45.480002 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:23e0f103-a81c-498c-b1a2-96d666efe02a&page=queryresults
[0m15:54:45.769724 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c1ebae3a-625e-4613-b8f3-3ac7df2b6972&page=queryresults
[0m15:54:46.272794 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:514a4eed-5be1-41ff-b661-ede7380a9cef&page=queryresults
[0m15:54:46.358729 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:04374bc6-770a-4db0-a749-2b101b407931&page=queryresults
[0m15:54:47.669284 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0141f767a0>]}
[0m15:54:47.671026 [info ] [Thread-10 ]: 39 of 88 OK created sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [[32mCREATE TABLE (1.0 rows, 6.1 GiB processed)[0m in 8.71s]
[0m15:54:47.672679 [debug] [Thread-10 ]: Finished running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m15:54:47.674878 [debug] [Thread-10 ]: Began running node model.project_dbt.PAY_TROP_5845_IBIS
[0m15:54:47.679807 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143e6b8e0>]}
[0m15:54:47.681272 [info ] [Thread-10 ]: 46 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS ......... [RUN]
[0m15:54:47.683305 [info ] [Thread-6 (]: 36 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [[32mCREATE TABLE (1.0 rows, 11.1 GiB processed)[0m in 12.52s]
[0m15:54:47.684519 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP, now model.project_dbt.PAY_TROP_5845_IBIS)
[0m15:54:47.686253 [debug] [Thread-6 (]: Finished running node model.project_dbt.KMS_P21_Inbound_transactions
[0m15:54:47.687674 [debug] [Thread-10 ]: Began compiling node model.project_dbt.PAY_TROP_5845_IBIS
[0m15:54:47.689208 [debug] [Thread-6 (]: Began running node model.project_dbt.PAY_TROP_5845_PIS
[0m15:54:47.707403 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m15:54:47.708313 [info ] [Thread-6 (]: 47 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS .......... [RUN]
[0m15:54:47.709023 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P21_Inbound_transactions, now model.project_dbt.PAY_TROP_5845_PIS)
[0m15:54:47.709606 [debug] [Thread-6 (]: Began compiling node model.project_dbt.PAY_TROP_5845_PIS
[0m15:54:47.715302 [debug] [Thread-10 ]: Began executing node model.project_dbt.PAY_TROP_5845_IBIS
[0m15:54:47.719866 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m15:54:47.726505 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m15:54:47.728484 [debug] [Thread-6 (]: Began executing node model.project_dbt.PAY_TROP_5845_PIS
[0m15:54:47.731542 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m15:54:48.063918 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a6b4c0>]}
[0m15:54:48.065676 [info ] [Thread-4 (]: 28 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_PIS .......... [[32mCREATE TABLE (0.0 rows, 27.8 GiB processed)[0m in 20.29s]
[0m15:54:48.067522 [debug] [Thread-4 (]: Finished running node model.project_dbt.Cuardro4_PIS
[0m15:54:48.068759 [debug] [Thread-4 (]: Began running node model.project_dbt.PAY_TRRT_5845
[0m15:54:48.070221 [info ] [Thread-4 (]: 48 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 .............. [RUN]
[0m15:54:48.071268 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_PIS, now model.project_dbt.PAY_TRRT_5845)
[0m15:54:48.072354 [debug] [Thread-4 (]: Began compiling node model.project_dbt.PAY_TRRT_5845
[0m15:54:48.087246 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.PAY_TRRT_5845"
[0m15:54:48.087883 [debug] [Thread-4 (]: Began executing node model.project_dbt.PAY_TRRT_5845
[0m15:54:48.091578 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:54:48.205809 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m15:54:48.208023 [debug] [Thread-10 ]: On model.project_dbt.PAY_TROP_5845_IBIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS`
      
    
    

    OPTIONS()
    as (
      WITH outbound as (
  SELECT
  'O' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ord,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
  '' AS PayID,
  baBA.BANK_ACCOUNT_BIC AS BICOrd,
  baCB.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '5493000RZ2KSLKCYNN98' AS LEIOrd,
  '' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  CASE
    WHEN fat.TRANSACTION_CHANNEL = 'OTHER' THEN'8'
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS') THEN'4'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'6'
    ELSE 'check the query'
  END AS TipCan,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER','TPP','OCS') THEN'2'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'1'
    ELSE 'check the query'
  END AS FormEnv,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','H2H') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER') THEN'N'
    ELSE 'check the query'
  END AS OperElet,

  'Y' AS OperRem,
  'Y' AS OperECom,
  'N' AS IniPISP,
  '1' AS ModAc,
  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') THEN'N'
    ELSE 'check the query'
  END AS SCA,

  case
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') then ''
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') then '5'
    ELSE 'check the query'
  END AS MnonSCA,

  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "OUTBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND fat.TRANSACTION_CHANNEL <> 'CARDS'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))  --pt winter time
),
inbound as (
  SELECT
  'B' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ord,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ben,
  '' AS PayID,
  baCB.BANK_ACCOUNT_BIC AS BICOrd,
  baBA.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '' AS LEIOrd,
  '5493000RZ2KSLKCYNN98' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  '' AS TipCan,
  '' AS FormEnv,
  '' AS OperElet,
  '' AS OperRem,
  'N' AS OperECom,
  '' AS IniPISP,
  '' AS ModAc,
  '' AS SCA,
  '' AS MnonSCA,
  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "INBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))  --pt winter time
)
SELECT * FROM outbound
UNION ALL
SELECT * FROM inbound
    );
  
[0m15:54:48.237840 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m15:54:48.239735 [debug] [Thread-6 (]: On model.project_dbt.PAY_TROP_5845_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    'I' AS Ot,
    '' AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE ='BE', substr(deb.BANK_ACCOUNT_NUMBER, 5,4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE  ='BE', substr(cred.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
    pi.T_SOURCE_PK_ID  AS PayID,
    deb.BANK_ACCOUNT_NUMBER  as debtor_account_identifier,
    cred.BANK_ACCOUNT_NUMBER as creditor_account_identifier ,
    '' AS BICOrd,
    '' AS BICBen,
    '' AS BICSen,
    '' AS BICRec,
    fi.FINANCIAL_INSTITUTION_COUNTRY AS PasOrd,
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
    '' as LEIOrd,
    '' as LEIBen,
    '28' as Sch,
    '' as Pro,
    cast(null as DATE) as DatLiq,
    date(pi.PAYMENT_INITIATION_CREATED_AT) as DtPISP,
    '' AS TsOrd,
    '' AS TsBen,
    '1' AS TipTR,
    it.INBOUND_TRANSACTION_CURRENCY_CODE as Div,
    it.INBOUND_TRANSACTION_AMOUNT as Mont,
    it.INBOUND_TRANSACTION_AMOUNT as MontOrg,
    '4' as TipCan,
    '2' as FormEnv,
    'Y' as OperElet,
    'Y' as OperRem,
    'Y' as OperECom,
    'N' as IniPISP,
    '1' as ModAc,
    'N' as SCA,
    '10' as MnonSCA,
    'N.E.' as SI,
    '' as PasmC,
    '' as PasnC,
    '' as CPosm,
    '' AS TipDoc,
    '' AS NumDoc,
    '' AS LEIC,
    '' AS ENI,
    '' AS InfUltBen,
    '' AS InfUltOrd,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` AS ip
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON ip.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED`
    AS it ON ip.T_DIM_KEY=it.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO_DECRYPTED`
    AS dit ON dit.T_DIM_KEY=it.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS`
    AS pi ON ip.T_DIM_KEY=pi.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
    AS app ON ip.T_D_APPLICATION_DIM_KEY = app.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS deb ON deb.T_DIM_KEY=ip.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS cred ON cred.T_DIM_KEY=it.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY

WHERE pi.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
        app.APPLICATION_NAME IN ('PAY-PXG-COMMUNITY')
        OR
            (
                app.APPLICATION_NAME IN ('PAY-PXG-OCS')
                AND (cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
                AND substr(cred.BANK_ACCOUNT_NUMBER,5,3) = '504'    )
            )
        )
    --  AND (
    --     app.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    --     OR (
    --         app.APPLICATION_NAME = 'PAY-PXG-OCS'
    --         AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    --         AND substr(cred.BANK_ACCOUNT_NUMBER,5,4) = '5845'
    --         )
    --     )-- creditor account is a PANX PT account
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))  --pt winter time
    );
  
[0m15:54:48.762768 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.PAY_TRRT_5845"
[0m15:54:48.767936 [debug] [Thread-4 (]: On model.project_dbt.PAY_TRRT_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TRRT_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
    'O' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    AND ftr.transaction_type = 'RETURN'
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
    AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type IN ('RETURN')
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))   --pt winter time
--UNMATCHED TRANSACTIONS
UNION ALL
SELECT
    'O' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND DEB.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND utr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` CRED
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = CRED.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` DEB
    ON DEB.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'INBOUND'
    AND CRED.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-03', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-04', 'Etc/UTC'))   --pt winter time
    );
  
[0m15:54:49.203965 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4fcea967-272b-4195-8c3b-7a59b0cf55f1&page=queryresults
[0m15:54:49.221315 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e5affdce-7438-476b-94cf-110cc38d659b&page=queryresults
[0m15:54:49.278194 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c709a0>]}
[0m15:54:49.279960 [info ] [Thread-8 (]: 38 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 11.39s]
[0m15:54:49.282039 [debug] [Thread-8 (]: Finished running node model.project_dbt.KMS_P7a_number_of_accounts
[0m15:54:49.283909 [debug] [Thread-8 (]: Began running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m15:54:49.285769 [info ] [Thread-8 (]: 49 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS ....... [RUN]
[0m15:54:49.286893 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P7a_number_of_accounts, now model.project_dbt.PCP_ALBATROS_CMD_OCS)
[0m15:54:49.288017 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m15:54:49.298926 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m15:54:49.299671 [debug] [Thread-8 (]: Began executing node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m15:54:49.302739 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:54:49.615486 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a76b30>]}
[0m15:54:49.617185 [info ] [Thread-16 ]: 34 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [[32mCREATE TABLE (1.0 rows, 11.1 GiB processed)[0m in 14.95s]
[0m15:54:49.618781 [debug] [Thread-16 ]: Finished running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m15:54:49.619968 [debug] [Thread-16 ]: Began running node model.project_dbt.PCP_ATM
[0m15:54:49.621380 [info ] [Thread-16 ]: 50 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ATM .................... [RUN]
[0m15:54:49.622397 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P11_Outgoing_transactions, now model.project_dbt.PCP_ATM)
[0m15:54:49.623385 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PCP_ATM
[0m15:54:49.632265 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PCP_ATM"
[0m15:54:49.632750 [debug] [Thread-16 ]: Began executing node model.project_dbt.PCP_ATM
[0m15:54:49.635171 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:54:49.683315 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5638783c-b121-4a29-b1d3-714bedd66017&page=queryresults
[0m15:54:49.814674 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m15:54:49.816745 [debug] [Thread-8 (]: On model.project_dbt.PCP_ALBATROS_CMD_OCS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS`
      
    
    

    OPTIONS()
    as (
      WITH ALB AS (
SELECT
    '73f02cef-1f20-446a-b66f-5368c222a58e' AS companyid_tobeexcluded,
    'VigorPlus Holding B.V.' AS legal_name,
    'COLLECTOR_NL_FULL' AS product_name,
    'NL' AS to_be_reported_in_country
UNION ALL
SELECT '46d24da8-952f-44e3-b880-f1edd2a7e5a2', 'SIA EZ', 'COLLECTOR_LV_FULL', 'LV' UNION ALL
SELECT '0df4ade3-3e72-48d9-8897-e7439551a8ca', 'BLOX USINAGE PLASTIQUES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0f8c4fd2-72b2-4261-8599-223bcb67c711', 'LOTHESA', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '12144ea2-9a8a-49dd-b01f-0bdbb8189db5', 'MPG CONSEIL EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1840ea14-f726-448b-a716-e92f5009d322', 'FID SUD AGEN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1b12d30c-1820-400a-86eb-15601492979e', 'QUENETTE STEVE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1c72dfa2-b07e-455f-a00c-2fd64784f9c2', 'CIE EUROP GESTION EXPERTISES COMPTABLES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '23e4432f-43ed-4bf6-ab30-29f9d5a6f102', 'D.B.D.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '26801b29-16ed-4330-b180-3d4fb997aa6d', 'BAT EVENT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '38c5e0bc-d122-4783-872c-e2cdbbef0ece', 'LAMY EXPERTS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '497c6deb-a48b-464a-9318-02cf543ba323', 'FID SUD MONTAUBAN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5c5225a4-08a4-4052-b712-74bfe7a99da8', 'SDRD', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5e05cabb-e5bd-42e7-a50c-df17fb04f3c7', 'KOMO MARCHE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '634b1ae4-8dca-46f4-ae17-ef28f87e91af', 'CABINET CONCEPT EXPERT - CCE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '698f1c97-3d15-4a42-9914-e9513a8fe723', 'EXPERTS TEAM', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '6f216187-3566-4097-92e8-9de30f59bb19', 'ABAQUE CONSULTING', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '01dd8d49-de77-4311-bac3-c7a8c74b4275', 'EN SA MEMOIRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '768e77cd-7de9-4369-a7ba-b0b04db3ab67', 'OLIVER AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '791f2d5e-338f-4f82-9519-85a28c163884', 'MVT CONSEILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '99053b0d-3e81-4972-a491-bd34beb026a6', 'N.D.EX.CO.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'a9feb33b-db68-4020-a5f3-279123565354', 'SALAS-GORDO & COELHO', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'c45758bd-85b4-4f61-accc-ee180364a60b', 'NICOL & ASSOCIES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'cd8e4416-da0c-4a12-9934-78618f0694b3', 'IN FINE EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e196486d-0014-4931-b183-f32c190897d8', 'MALHERBE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e2a66866-98c4-4ef0-a67d-637e58273603', 'BENAUW HUBERT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e7f0ba81-6c3f-4b3d-9bf5-4d42dc88d56f', 'F2AB AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e9708122-4491-4930-bdd7-d70e50415d2f', 'BEY MANUTENTION', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'f10e6a0f-67e4-4662-83b7-7faba187e157', 'GARDILLE JEAN-PIERRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fb77318d-18f5-43d2-a202-512943c4f92b', 'SOGAREX', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fbe51ec9-8cb7-4825-be45-594886d67fac', 'CHESNEAU CHRISTIAN ET FILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fcb01b27-09c9-42c3-befa-3950b3150b1f', 'LOZANGE IT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '733045f3-c626-49a3-aad6-a514f19ad0e0', 'QINTENS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0567d2fa-6eca-4422-8570-ff714ccd8aa4', 'D-DALE', 'COLLECTOR_FR_FULL', 'FR'
),
CMD as (
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_OCS_ACTIVE = true
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

UNION ALL
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_SOURCE = 'ALBATROS'
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

ORDER BY 2
),
souce_table as(
SELECT  CMD.* FROM CMD
UNION ALL
SELECT
    ALB.companyid_tobeexcluded,
    ALB.legal_name,
    ALB.to_be_reported_in_country
FROM ALB
ORDER BY 2
)
SELECT
*,
""  AS Period,
TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
CURRENT_TIMESTAMP AS load_timestamp,
FROM souce_table
    );
  
[0m15:54:49.912717 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c014232ab00>]}
[0m15:54:49.914331 [info ] [Thread-13 ]: 42 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCL .............. [[32mCREATE TABLE (1.0 rows, 3.5 GiB processed)[0m in 5.75s]
[0m15:54:49.916213 [debug] [Thread-13 ]: Finished running node model.project_dbt.PAY_CPCL
[0m15:54:49.918059 [debug] [Thread-13 ]: Began running node model.project_dbt.PCP_POS_ONLINE
[0m15:54:49.919972 [info ] [Thread-13 ]: 51 of 88 START sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ............. [RUN]
[0m15:54:49.921118 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCL, now model.project_dbt.PCP_POS_ONLINE)
[0m15:54:49.922105 [debug] [Thread-13 ]: Began compiling node model.project_dbt.PCP_POS_ONLINE
[0m15:54:49.931434 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.PCP_POS_ONLINE"
[0m15:54:49.933171 [debug] [Thread-13 ]: Began executing node model.project_dbt.PCP_POS_ONLINE
[0m15:54:49.937993 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:50.129041 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PCP_ATM"
[0m15:54:50.130958 [debug] [Thread-16 ]: On model.project_dbt.PCP_ATM: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ATM`
      
    
    

    OPTIONS()
    as (
      SELECT
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS Counterpart_area,
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS POS_location,
  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL AS remote_non_remote_initiation,
  COUNT(*) AS number_of_transactions,
  SUM(FCT.card_transaction_cleared_amount) + SUM(FCT.card_transaction_refunded_amount) AS total_sum,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
WHERE
FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM'
AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
-- AND FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
-- AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m15:54:50.216483 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143e24cd0>]}
[0m15:54:50.218298 [info ] [Thread-9 (]: 45 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD ..... [[32mCREATE TABLE (516.0 rows, 1.8 GiB processed)[0m in 5.25s]
[0m15:54:50.220070 [debug] [Thread-9 (]: Finished running node model.project_dbt.PAY_TROP_5845_CMD
[0m15:54:50.221319 [debug] [Thread-9 (]: Began running node model.project_dbt.PCT_IDEAL
[0m15:54:50.222859 [info ] [Thread-9 (]: 52 of 88 START sql incremental model dev_dm_pst3_BE.PCT_IDEAL .................. [RUN]
[0m15:54:50.224063 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_CMD, now model.project_dbt.PCT_IDEAL)
[0m15:54:50.225163 [debug] [Thread-9 (]: Began compiling node model.project_dbt.PCT_IDEAL
[0m15:54:50.235067 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.PCT_IDEAL"
[0m15:54:50.235672 [debug] [Thread-9 (]: Began executing node model.project_dbt.PCT_IDEAL
[0m15:54:50.238514 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:54:50.483825 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.PCP_POS_ONLINE"
[0m15:54:50.485974 [debug] [Thread-13 ]: On model.project_dbt.PCP_POS_ONLINE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_POS_ONLINE`
      
    
    

    OPTIONS()
    as (
      with pre as (
 SELECT
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as Counterpart_area,
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as POS_location,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'non-remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'non-remote'
     ELSE 'check the query' end as remote_non_remote_initiation,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESSFUL'
           then 'SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS  in('UNAVAILABLE', 'THREEDS_REQUESTER_SCA_EXEMPTION')
           or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
               AND FCT.CARD_TRANSACTION_PIN_PRESENT is true
               then 'SCA is used'
   END AS SCA_used,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESS'
           then 'N/A'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT'
           then  'Recurring payment'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'MERCHANT_INITIATED_TRANSACTION'
           then  'Merchant initiated transaction (MIT)'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'TRANSACTION_RISK_ANALYSIS'
           then  'Transaction risk analysis'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'SECURE_CORPORATE_PAYMENT'
           then  'Secure corporate payment processes AND protocols'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           then  'Others'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE =  'CHIP_CONTACTLESS'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'Contactless low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT  is true then 'N/A'
     END AS SCA_Exemption_reason,
     count(*) as number_of_transactions	,
     sum (FCT.card_transaction_cleared_amount) + sum(FCT.card_transaction_refunded_amount) as total_sum,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
 WHERE FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND FTE.TRANSACTION_EVENT_TYPE in ('authorization','refund.authorization')
     AND FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
     AND DTE.TRANSACTION_EVENT_STATUS = 'COMPLETED'
     AND FCT.CARD_TRANSACTION_PAYMENT_CHANNEL <> 'ATM'
     AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
     group by 1,2,3,4,5
 ),
 NBB_onegate as (
       SELECT 'low value' AS sca_reason, 201 AS sca_reason_code
       UNION ALL
       SELECT 'Contactless low value', 202
       UNION ALL
       SELECT 'Trusted beneficiaries', 204
       UNION ALL
       SELECT 'Recurring Payment', 205
       UNION ALL
       SELECT 'Unattended terminal for transport fares or parking fees', 206
       UNION ALL
       SELECT 'Secure corporate payment processes and protocols', 207
       UNION ALL
       SELECT 'Transaction risk analysis', 208
       UNION ALL
       SELECT 'Merchant initiated transaction (MIT)', 209
       UNION ALL
       SELECT 'Others', 210
       UNION ALL
       SELECT 'N/A', 100
 )
 SELECT
   IF(pre.Counterpart_area = 'BE','W2',
         IF(map_area.code is null,'G1', pre.Counterpart_area)) AS Counterpart_area_GEO3,
   IF(pre.POS_location = 'BE','W2',
         IF(map_location.code is null,'G1', pre.POS_location)) AS POS_location_GEO3,
   'CPO' as Transaction_type,
   '2000' as Initiation_channel,
   if (pre.remote_non_remote_initiation = 'non-remote', 'NR', 'R') AS remoteness,
   'PCS_ALL' as Scheme,
   '11' as Card_function,
   '_Z' as Card_function_irrelevant,
   NBB_onegate.sca_reason_code as SCA,
   '_X' as SCA_irrelevant,
   '_Z'as Fraud_type_irrelevant,
   pre.number_of_transactions,
   pre.total_sum,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   ""  AS Period,
 FROM pre
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_area
   ON map_area.code = pre.Counterpart_area
   AND map_area.type = 'Geographical area'
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_location
   ON map_location.code = pre.POS_location
   AND map_location.type = 'Geographical area'
 LEFT JOIN NBB_onegate on  NBB_onegate.sca_reason = pre.SCA_Exemption_reason
    );
  
[0m15:54:50.688261 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:04b3b95c-9a39-4abd-ac08-792c6fe7348b&page=queryresults
[0m15:54:50.830914 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143da6680>]}
[0m15:54:50.832649 [info ] [Thread-2 (]: 17 of 88 OK created sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [[32mCREATE TABLE (3.0 rows, 45.1 GiB processed)[0m in 33.92s]
[0m15:54:50.834321 [debug] [Thread-2 (]: Finished running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m15:54:50.835540 [debug] [Thread-2 (]: Began running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m15:54:50.838569 [info ] [Thread-2 (]: 53 of 88 START sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP ...... [RUN]
[0m15:54:50.841889 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.PCT_IDEAL"
[0m15:54:50.843001 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo, now model.project_dbt.PCT_INITIATED_BY_PISP)
[0m15:54:50.844548 [debug] [Thread-2 (]: Began compiling node model.project_dbt.PCT_INITIATED_BY_PISP
[0m15:54:50.851184 [debug] [Thread-9 (]: On model.project_dbt.PCT_IDEAL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_IDEAL`
      
    
    

    OPTIONS()
    as (
      SELECT
  COALESCE( nullif( d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY, 'NA'), left(dl_trans_pro.value,2))  AS PAYER_COUNTRY,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  COUNT(DISTINCT f_payment_items.T_FACT_KEY) AS VOLUME,
  ROUND(SUM(f_payment_items.PAYMENT_ITEM_AMOUNT)) AS AMOUNT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS`
    AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS`
    AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS`   AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED`
    AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED`
    AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN (
SELECT
  transaction_id,
  key,
  AEAD.DECRYPT_STRING(k0.KEYSET, value, TO_HEX(_flycs_metadata_keyset_0)) value,
  from `pj-bu-dw-dl-prod`.`prd_datalake_P1_PSTA`.`dwh_transaction_properties_current`
  left join `pj-bu-dw-ks-prod`.`prd_keysets`.`merged` k0
  on lower(k0.SOURCE) = "p1_psta_dwh_transaction_properties"
  and _flycs_metadata_keyset_0 = k0.HASH_ID
  WHERE key = "PAYER_ACCOUNT_ID"
) as dl_trans_pro
 on cast (dl_trans_pro.transaction_id as string) = d_payment_transaction_info.T_SOURCE_PK_ID
WHERE d_merchants.MERCHANT_COUNTRY  IS NOT NULL
    and d_payment_products.PRODUCT_CODE = "IDEAL_COLLECT"
    and d_payment_transaction_info.payment_transaction_cutoff_at >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))   -- start of reporting period
    and d_payment_transaction_info.payment_transaction_cutoff_at <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   -- end of reporting period
GROUP BY
    1,
    2
    );
  
[0m15:54:50.858832 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m15:54:50.859451 [debug] [Thread-2 (]: Began executing node model.project_dbt.PCT_INITIATED_BY_PISP
[0m15:54:50.863102 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:54:51.023986 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3f8d2347-f626-4071-b20f-0659897dc524&page=queryresults
[0m15:54:51.429761 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5ec49086-51f6-423f-b962-39d84f89a4fa&page=queryresults
[0m15:54:51.453618 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m15:54:51.455552 [debug] [Thread-2 (]: On model.project_dbt.PCT_INITIATED_BY_PISP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_INITIATED_BY_PISP`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS', 'H2H') THEN 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID = '1' then 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID <> '1' then 'PISP'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END INITIATIONCHANNEL,
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END SCAINDICATOR,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
    ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
    ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
    ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
    ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ASPSP_PAYMENT_INITIATION` PI
    ON PI.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` TPP
  ON TPP.T_DIM_KEY = PI.T_D_ASPSP_PAYMENT_INITIATIONS_INFO_DIM_KEY
  WHERE
    f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
     AND (
           d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
           AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
      AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
      AND  f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
group by 1,2,3
    );
  
[0m15:54:51.883487 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:82b90640-1721-43d6-95e7-bae9a966fef5&page=queryresults
[0m15:54:52.245296 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143a69ed0>]}
[0m15:54:52.246478 [info ] [Thread-1 (]: 19 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [[32mCREATE TABLE (31.0 rows, 33.2 GiB processed)[0m in 34.38s]
[0m15:54:52.247003 [debug] [Thread-1 (]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m15:54:52.247375 [debug] [Thread-1 (]: Began running node model.project_dbt.PCT_OUTBOUND
[0m15:54:52.247933 [info ] [Thread-1 (]: 54 of 88 START sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND ............... [RUN]
[0m15:54:52.248310 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE, now model.project_dbt.PCT_OUTBOUND)
[0m15:54:52.248680 [debug] [Thread-1 (]: Began compiling node model.project_dbt.PCT_OUTBOUND
[0m15:54:52.257514 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.PCT_OUTBOUND"
[0m15:54:52.259204 [debug] [Thread-1 (]: Began executing node model.project_dbt.PCT_OUTBOUND
[0m15:54:52.262416 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:54:52.273879 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5dc46b91-b0a7-4900-b920-99263ac81af2&page=queryresults
[0m15:54:52.763884 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.PCT_OUTBOUND"
[0m15:54:52.765681 [debug] [Thread-1 (]: On model.project_dbt.PCT_OUTBOUND: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_OUTBOUND`
      
    
    

    OPTIONS()
    as (
      SELECT
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'Electronic'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END INITIATIONCHANNEL,
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END SCAINDICATOR,
    d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
    COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
    COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
    AND f_account_transactions.TRANSACTION_CHANNEL <> 'CARDS'
    AND f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'BG', 'LT', 'PL', 'RO', 'HR')
GROUP BY 1, 2, 3
    );
  
[0m15:54:53.158552 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0141f743a0>]}
[0m15:54:53.160133 [info ] [Thread-5 (]: 44 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPNC .............. [[32mCREATE TABLE (273.0 rows, 1.8 GiB processed)[0m in 8.30s]
[0m15:54:53.161699 [debug] [Thread-5 (]: Finished running node model.project_dbt.PAY_CPNC
[0m15:54:53.162871 [debug] [Thread-5 (]: Began running node model.project_dbt.PIS
[0m15:54:53.164392 [info ] [Thread-5 (]: 55 of 88 START sql incremental model dev_dm_pst3_BE.PIS ........................ [RUN]
[0m15:54:53.165467 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPNC, now model.project_dbt.PIS)
[0m15:54:53.166378 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PIS
[0m15:54:53.177613 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PIS"
[0m15:54:53.178161 [debug] [Thread-5 (]: Began executing node model.project_dbt.PIS
[0m15:54:53.181320 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m15:54:53.385661 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:07cfe584-aba2-44a0-af56-d2ae8c0c079a&page=queryresults
[0m15:54:53.662725 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142b67580>]}
[0m15:54:53.664474 [info ] [Thread-11 ]: 33 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_MRA ............... [[32mCREATE TABLE (0.0 rows, 10.4 GiB processed)[0m in 19.00s]
[0m15:54:53.666218 [debug] [Thread-11 ]: Finished running node model.project_dbt.KMS_MRA
[0m15:54:53.667472 [debug] [Thread-11 ]: Began running node model.project_dbt.PI_FINAL_QUERY
[0m15:54:53.670112 [info ] [Thread-11 ]: 56 of 88 START sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ............. [RUN]
[0m15:54:53.675952 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_MRA, now model.project_dbt.PI_FINAL_QUERY)
[0m15:54:53.677113 [debug] [Thread-11 ]: Began compiling node model.project_dbt.PI_FINAL_QUERY
[0m15:54:53.692674 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.PI_FINAL_QUERY"
[0m15:54:53.694210 [debug] [Thread-11 ]: Began executing node model.project_dbt.PI_FINAL_QUERY
[0m15:54:53.696867 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:54:53.711080 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PIS"
[0m15:54:53.712390 [debug] [Thread-5 (]: On model.project_dbt.PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PIS`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = 'PAY-PXG-COMMUNITY'
        OR APP.APPLICATION_NAME = 'PAY-PXG-GOCOMPTA'
        OR (
            APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
            AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = "FR"
                AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'))
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLT'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPBG'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPHR'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPRO')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      ""  AS Period,
      TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,8) = '50339900')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'EE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,2) = '72')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '6918')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '36330')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '39816')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'PT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '5845')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'SK' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '9955')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'RO' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.* EXCEPT(PERIOD),
      country,
      PERIOD,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m15:54:54.172056 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142f7a3e0>]}
[0m15:54:54.172741 [info ] [Thread-7 (]: 37 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS . [[32mCREATE TABLE (1.0 rows, 6.1 GiB processed)[0m in 16.75s]
[0m15:54:54.175299 [debug] [Thread-7 (]: Finished running node model.project_dbt.KMS_P6a_number_of_AIS
[0m15:54:54.175868 [debug] [Thread-7 (]: Began running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m15:54:54.176850 [info ] [Thread-7 (]: 57 of 88 START sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [RUN]
[0m15:54:54.179053 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P6a_number_of_AIS, now model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS)
[0m15:54:54.179991 [debug] [Thread-7 (]: Began compiling node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m15:54:54.186913 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m15:54:54.188230 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.PI_FINAL_QUERY"
[0m15:54:54.188907 [debug] [Thread-11 ]: On model.project_dbt.PI_FINAL_QUERY: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_FINAL_QUERY`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  fi.FINANCIAL_INSTITUTION_COUNTRY as CountryOfAISP,
  count(*) AS number_of_consents,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd on acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
  fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND (
    (
    TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
    OR
    (
    TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
  )
GROUP BY 1,2
    );
  
[0m15:54:54.189326 [debug] [Thread-7 (]: Began executing node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m15:54:54.195486 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:54:54.679449 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:58c28867-aaaf-4405-80e5-b9dbbd971d3c&page=queryresults
[0m15:54:54.685245 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143de3cd0>]}
[0m15:54:54.686959 [info ] [Thread-8 (]: 49 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS .. [[32mCREATE TABLE (63.0 rows, 1.9 GiB processed)[0m in 5.40s]
[0m15:54:54.688595 [debug] [Thread-8 (]: Finished running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m15:54:54.689833 [debug] [Thread-8 (]: Began running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m15:54:54.690491 [info ] [Thread-8 (]: 58 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [RUN]
[0m15:54:54.691143 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ALBATROS_CMD_OCS, now model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN)
[0m15:54:54.691586 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m15:54:54.699040 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m15:54:54.700027 [debug] [Thread-8 (]: Began executing node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m15:54:54.702561 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:54:54.704441 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m15:54:54.705127 [debug] [Thread-7 (]: On model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_NUMBER_OF_PAYMENT_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) AS d_ibis_account_count_ibis_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  CAST(NULL AS TIMESTAMP) AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC')) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
    ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
WHERE
    ibis.ACCOUNT_TYPE  in ('PAYMENT')
    AND ibis.ACCOUNT_IS_CUSTOMER_ACCOUNT IS TRUE
    AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'LT', 'RO', 'HR', 'BG')
    AND (
        ibis.ACCOUNT_STATUS = 'OPEN'
        OR ( ibis.ACCOUNT_STATUS = 'CLOSED'
           AND TIMESTAMP(ibis.ACCOUNT_UPDATED_AT) > TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
         )
        )
    -- Anca & Kris noticed that the for 269 accounts, the account_update_timestamp does not reflect the last_update_date of IBISv2 accounts table. Mail sent to Kathleen 25/08/23
    -- the v2 query gave 67 accounts less for 2023 S1 due to this difference
    AND TIMESTAMP(ibis.ACCOUNT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m15:54:55.064546 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a3a4ea5e-fcd8-40ac-b9aa-43c4e052d805&page=queryresults
[0m15:54:55.397254 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m15:54:55.407047 [debug] [Thread-8 (]: On model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_AIS_JeF_with_BE_IBIS_IBAN`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  aa.APPLICATION_ACCOUNT_NAME Application_account_name,
  aa.T_SOURCE_PK_ID as Application_account_id ,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) AS Period_begin_date,
  CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd
  ON acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
    a.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
AND fi.FINANCIAL_INSTITUTION_COUNTRY = 'BE'
AND fi.FINANCIAL_INSTITUTION_CODE = 'IBIS'
AND (
  ac.ACCESS_CONSENT_STATUS = 'ACTIVE'
  OR (
    ac.ACCESS_CONSENT_STATUS = 'OBSOLETE'
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  ) --==> always start of the period
)
    );
  
[0m15:54:55.701246 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:08165a3a-b54f-4579-849d-8cd920e443ec&page=queryresults
[0m15:54:55.834240 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143e70c70>]}
[0m15:54:55.835994 [info ] [Thread-16 ]: 50 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ATM ............... [[32mCREATE TABLE (7.0 rows, 1.6 GiB processed)[0m in 6.21s]
[0m15:54:55.839476 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143d6de40>]}
[0m15:54:55.843430 [debug] [Thread-16 ]: Finished running node model.project_dbt.PCP_ATM
[0m15:54:55.845157 [info ] [Thread-13 ]: 51 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ........ [[32mCREATE TABLE (23.0 rows, 1.6 GiB processed)[0m in 5.92s]
[0m15:54:55.846642 [debug] [Thread-16 ]: Began running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m15:54:55.848579 [debug] [Thread-13 ]: Finished running node model.project_dbt.PCP_POS_ONLINE
[0m15:54:55.850125 [info ] [Thread-16 ]: 59 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING . [RUN]
[0m15:54:55.851663 [debug] [Thread-13 ]: Began running node model.project_dbt.SCA_MAPPING_TABLE
[0m15:54:55.852819 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ATM, now model.project_dbt.PI_PXG_APPLICATION_MAPPING)
[0m15:54:55.854392 [info ] [Thread-13 ]: 60 of 88 START sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE .......... [RUN]
[0m15:54:55.855734 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m15:54:55.856971 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_POS_ONLINE, now model.project_dbt.SCA_MAPPING_TABLE)
[0m15:54:55.868659 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m15:54:55.869283 [debug] [Thread-13 ]: Began compiling node model.project_dbt.SCA_MAPPING_TABLE
[0m15:54:55.872971 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m15:54:55.874263 [debug] [Thread-16 ]: Began executing node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m15:54:55.877854 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:54:55.879248 [debug] [Thread-13 ]: Began executing node model.project_dbt.SCA_MAPPING_TABLE
[0m15:54:55.972087 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:54:56.516254 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3dadeaa9-9e0d-44b2-a963-9c25b2baa53d&page=queryresults
[0m15:54:56.518952 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m15:54:56.519694 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m15:54:56.520414 [debug] [Thread-13 ]: On model.project_dbt.SCA_MAPPING_TABLE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE`
      
    
    

    OPTIONS()
    as (
      SELECT
  "full-auth" AS SCA_RESULT,
  "SCA used" AS SCA_REASON,
UNION ALL
SELECT
  "attempt" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  "non-authenticated" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  NULL AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
    );
  
[0m15:54:56.520843 [debug] [Thread-16 ]: On model.project_dbt.PI_PXG_APPLICATION_MAPPING: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_APPLICATION_MAPPING`
      
    
    

    OPTIONS()
    as (
      SELECT
    distinct ap.APPLICATION_NAME AS APPLICATION_NAME,
    -- ap.APPLICATION_CREATED_AT AS CREATION_DATETIME,
    -- ao.APPLICATION_OWNER_NAME AS APPLICATION_OWNER_NAME,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    CAST(NULL AS TIMESTAMP) AS Period_begin_date,
    CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM (
    WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
) AS ap
LEFT  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED` AS ao
    ON ap.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON ap.t_dim_key = aa.T_D_APPLICATION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT` AS ci
    ON aa.T_DIM_KEY= ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
    AS pa on pa.T_DIM_KEY= ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
-- WHERE ap.APPLICATION_NAME <>"NA"
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) --pt winter time
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m15:54:57.155664 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:62e4a630-d79d-48f8-8ba0-ac895e82085b&page=queryresults
[0m15:54:57.444489 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2fe27432-3b99-4773-80ca-ce599f277768&page=queryresults
[0m15:54:59.996068 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0148a56fb0>]}
[0m15:54:59.997922 [info ] [Thread-13 ]: 60 of 88 OK created sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE ..... [[32mCREATE TABLE (4.0 rows, 0 processed)[0m in 4.14s]
[0m15:55:00.003988 [debug] [Thread-13 ]: Finished running node model.project_dbt.SCA_MAPPING_TABLE
[0m15:55:00.007770 [debug] [Thread-13 ]: Began running node model.project_dbt.T0202_credit_transfers
[0m15:55:00.009787 [info ] [Thread-13 ]: 61 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers ..... [RUN]
[0m15:55:00.010952 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.SCA_MAPPING_TABLE, now model.project_dbt.T0202_credit_transfers)
[0m15:55:00.011996 [debug] [Thread-13 ]: Began compiling node model.project_dbt.T0202_credit_transfers
[0m15:55:00.018549 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers"
[0m15:55:00.019102 [debug] [Thread-13 ]: Began executing node model.project_dbt.T0202_credit_transfers
[0m15:55:00.021969 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:55:00.780538 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers"
[0m15:55:00.782528 [debug] [Thread-13 ]: On model.project_dbt.T0202_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'GB' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'CH' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' THEN 'Domestic'
      ELSE DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE
  END AS payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
      WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'Electronically'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS initiationChannel,
  'remote' as remoteness,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
      WHEN FAT.TRANSACTION_CHANNEL = 'TPP' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS SCAIndicator,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,

FROM
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
    ON DCA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE
    FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND DIAT.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m15:55:02.064699 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:15bb36e2-fc95-4b41-a29a-fb0669ab4116&page=queryresults
[0m15:55:03.822421 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0140617430>]}
[0m15:55:03.824230 [info ] [Thread-16 ]: 59 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING  [[32mCREATE TABLE (62.0 rows, 6.3 GiB processed)[0m in 7.97s]
[0m15:55:03.826057 [debug] [Thread-16 ]: Finished running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m15:55:03.827309 [debug] [Thread-16 ]: Began running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m15:55:03.828785 [info ] [Thread-16 ]: 62 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [RUN]
[0m15:55:03.830063 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_APPLICATION_MAPPING, now model.project_dbt.T0202_credit_transfers_TPP_check)
[0m15:55:03.831189 [debug] [Thread-16 ]: Began compiling node model.project_dbt.T0202_credit_transfers_TPP_check
[0m15:55:03.839234 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m15:55:03.840017 [debug] [Thread-16 ]: Began executing node model.project_dbt.T0202_credit_transfers_TPP_check
[0m15:55:03.844353 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:55:04.644176 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01485d70d0>]}
[0m15:55:04.645061 [info ] [Thread-8 (]: 58 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [[32mCREATE TABLE (37.0 rows, 12.9 GiB processed)[0m in 9.95s]
[0m15:55:04.645623 [debug] [Thread-8 (]: Finished running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m15:55:04.645996 [debug] [Thread-8 (]: Began running node model.project_dbt.T0401_misc
[0m15:55:04.646556 [info ] [Thread-8 (]: 63 of 88 START sql incremental model dev_dm_pst3_NL.T0401_misc ................. [RUN]
[0m15:55:04.646897 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN, now model.project_dbt.T0401_misc)
[0m15:55:04.647208 [debug] [Thread-8 (]: Began compiling node model.project_dbt.T0401_misc
[0m15:55:04.652202 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.T0401_misc"
[0m15:55:04.653004 [debug] [Thread-8 (]: Began executing node model.project_dbt.T0401_misc
[0m15:55:04.657260 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:55:04.699791 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m15:55:04.702138 [debug] [Thread-16 ]: On model.project_dbt.T0202_credit_transfers_TPP_check: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers_TPP_check`
      
    
    

    OPTIONS()
    as (
      select
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
inner join  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  on C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
where D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND C.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND C.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m15:55:05.548147 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.T0401_misc"
[0m15:55:05.549886 [debug] [Thread-8 (]: On model.project_dbt.T0401_misc: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_misc`
      
    
    

    OPTIONS()
    as (
      SELECT
  FAM.MOVEMENT_FAMILY as bank_family,
  FAM.MOVEMENT_SUBFAMILY as bank_subfamily,
  count(*) as count,
  COALESCE(SUM(FAM.MOVEMENT_AMOUNT), 0) as amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS_DECRYPTED` AS FAM
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
  ON FAM.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
  ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
  ON DCA.T_DIM_KEY = FAM.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE DIAT.ACCOUNT_TYPE = 'PAYMENT'
  AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND FAM.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND FAM.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m15:55:05.597568 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7669b57c-98c9-4d6a-abcf-8a8b533d49d6&page=queryresults
[0m15:55:06.069966 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143b85cc0>]}
[0m15:55:06.071779 [info ] [Thread-11 ]: 56 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ........ [[32mCREATE TABLE (62.0 rows, 9.9 GiB processed)[0m in 12.39s]
[0m15:55:06.073431 [debug] [Thread-11 ]: Finished running node model.project_dbt.PI_FINAL_QUERY
[0m15:55:06.074682 [debug] [Thread-11 ]: Began running node model.project_dbt.T0401_nr_of_accounts
[0m15:55:06.076184 [info ] [Thread-11 ]: 64 of 88 START sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts ....... [RUN]
[0m15:55:06.077267 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.PI_FINAL_QUERY, now model.project_dbt.T0401_nr_of_accounts)
[0m15:55:06.078429 [debug] [Thread-11 ]: Began compiling node model.project_dbt.T0401_nr_of_accounts
[0m15:55:06.087242 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.T0401_nr_of_accounts"
[0m15:55:06.087949 [debug] [Thread-11 ]: Began executing node model.project_dbt.T0401_nr_of_accounts
[0m15:55:06.091303 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:55:06.374879 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01405dbc10>]}
[0m15:55:06.376737 [info ] [Thread-7 (]: 57 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 12.20s]
[0m15:55:06.378371 [debug] [Thread-7 (]: Finished running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m15:55:06.379572 [debug] [Thread-7 (]: Began running node model.project_dbt.T0402_AIS_ASPSP_API
[0m15:55:06.381269 [info ] [Thread-7 (]: 65 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ........ [RUN]
[0m15:55:06.382483 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS, now model.project_dbt.T0402_AIS_ASPSP_API)
[0m15:55:06.383287 [debug] [Thread-7 (]: Began compiling node model.project_dbt.T0402_AIS_ASPSP_API
[0m15:55:06.390598 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m15:55:06.391189 [debug] [Thread-7 (]: Began executing node model.project_dbt.T0402_AIS_ASPSP_API
[0m15:55:06.393998 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:55:06.438924 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:90b41a61-0bba-4e92-b698-4153eb38a58b&page=queryresults
[0m15:55:06.569691 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.T0401_nr_of_accounts"
[0m15:55:06.571361 [debug] [Thread-11 ]: On model.project_dbt.T0401_nr_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_nr_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) nr_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2023Y' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
      )
  )
  and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    );
  
[0m15:55:06.966650 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m15:55:06.968516 [debug] [Thread-7 (]: On model.project_dbt.T0402_AIS_ASPSP_API: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_ASPSP_API`
      
    
    

    OPTIONS()
    as (
      select
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  c.consent_iban,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) = 'NL'
  and c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m15:55:07.015271 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142b67ca0>]}
[0m15:55:07.016927 [info ] [Thread-12 ]: 43 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPMC .............. [[32mCREATE TABLE (3.0 rows, 10.3 GiB processed)[0m in 22.61s]
[0m15:55:07.017868 [debug] [Thread-12 ]: Finished running node model.project_dbt.PAY_CPMC
[0m15:55:07.018248 [debug] [Thread-12 ]: Began running node model.project_dbt.T0402_AIS_PXG
[0m15:55:07.018770 [info ] [Thread-12 ]: 66 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG .............. [RUN]
[0m15:55:07.019228 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPMC, now model.project_dbt.T0402_AIS_PXG)
[0m15:55:07.019583 [debug] [Thread-12 ]: Began compiling node model.project_dbt.T0402_AIS_PXG
[0m15:55:07.026218 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.T0402_AIS_PXG"
[0m15:55:07.026738 [debug] [Thread-12 ]: Began executing node model.project_dbt.T0402_AIS_PXG
[0m15:55:07.029412 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:55:07.150648 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b2165e10-19cf-4105-9845-6a08a301793a&page=queryresults
[0m15:55:07.581320 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.T0402_AIS_PXG"
[0m15:55:07.586394 [debug] [Thread-12 ]: On model.project_dbt.T0402_AIS_PXG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_PXG`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'NL' as CountryofAISP,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPNL')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
      AND (
          (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
          )
          OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
              )
      )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m15:55:07.787668 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d7b77218-e6e9-4c73-bc88-07e0bbbac955&page=queryresults
[0m15:55:08.099043 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0140511750>]}
[0m15:55:08.607097 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143d205e0>]}
[0m15:55:08.607597 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d9a9b456-920a-40f7-b0c6-7cdc20301705&page=queryresults
[0m15:55:08.609656 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0140507eb0>]}
[0m15:55:10.445729 [info ] [Thread-2 (]: 53 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP . [[32mCREATE TABLE (10.0 rows, 15.7 GiB processed)[0m in 17.26s]
[0m15:55:10.448920 [debug] [Thread-2 (]: Finished running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m15:55:10.447533 [info ] [Thread-16 ]: 62 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [[32mCREATE TABLE (0.0 rows, 1.0 GiB processed)[0m in 4.78s]
[0m15:55:10.451895 [debug] [Thread-2 (]: Began running node model.project_dbt.V1110_payment_initiation_services
[0m15:55:10.450819 [info ] [Thread-1 (]: 54 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND .......... [[32mCREATE TABLE (26.0 rows, 15.7 GiB processed)[0m in 16.36s]
[0m15:55:10.454218 [debug] [Thread-16 ]: Finished running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m15:55:10.455821 [info ] [Thread-2 (]: 67 of 88 START sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [RUN]
[0m15:55:10.457500 [debug] [Thread-1 (]: Finished running node model.project_dbt.PCT_OUTBOUND
[0m15:55:10.459001 [debug] [Thread-16 ]: Began running node model.project_dbt.V120_customer_credit_transfers_sent
[0m15:55:10.460257 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_INITIATED_BY_PISP, now model.project_dbt.V1110_payment_initiation_services)
[0m15:55:10.461615 [debug] [Thread-1 (]: Began running node model.project_dbt.V121_customer_credit_transfers_received
[0m15:55:10.463216 [info ] [Thread-16 ]: 68 of 88 START sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [RUN]
[0m15:55:10.464465 [debug] [Thread-2 (]: Began compiling node model.project_dbt.V1110_payment_initiation_services
[0m15:55:10.465918 [info ] [Thread-1 (]: 69 of 88 START sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [RUN]
[0m15:55:10.467184 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers_TPP_check, now model.project_dbt.V120_customer_credit_transfers_sent)
[0m15:55:10.481144 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.V1110_payment_initiation_services"
[0m15:55:10.481645 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_OUTBOUND, now model.project_dbt.V121_customer_credit_transfers_received)
[0m15:55:10.482137 [debug] [Thread-16 ]: Began compiling node model.project_dbt.V120_customer_credit_transfers_sent
[0m15:55:10.482593 [debug] [Thread-1 (]: Began compiling node model.project_dbt.V121_customer_credit_transfers_received
[0m15:55:10.489866 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m15:55:10.496323 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m15:55:10.496781 [debug] [Thread-2 (]: Began executing node model.project_dbt.V1110_payment_initiation_services
[0m15:55:10.499518 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:55:10.499948 [debug] [Thread-16 ]: Began executing node model.project_dbt.V120_customer_credit_transfers_sent
[0m15:55:10.501232 [debug] [Thread-1 (]: Began executing node model.project_dbt.V121_customer_credit_transfers_received
[0m15:55:10.505010 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:55:10.507387 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:55:11.064170 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m15:55:11.067950 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m15:55:11.070831 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.V1110_payment_initiation_services"
[0m15:55:11.075784 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01405dbc10>]}
[0m15:55:11.082496 [debug] [Thread-16 ]: On model.project_dbt.V120_customer_credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V120_customer_credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
  else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  COUNT(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.489024', 'Etc/UTC'))  -- +01 for winter time, +02 for summer time
  -- AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.489024', 'Etc/UTC')) -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.489024', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time

GROUP BY 1,2,3,4,5,6,7,8,9,10

UNION ALL

SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
    else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.489024', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.489024', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
GROUP BY 1,2,3,4,5,6,7,8,9,10
ORDER BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m15:55:11.083232 [debug] [Thread-1 (]: On model.project_dbt.V121_customer_credit_transfers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V121_customer_credit_transfers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedamount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.495806', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.495806', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4

UNION ALL

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.495806', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.495806', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4
    );
  
[0m15:55:11.084064 [info ] [Thread-7 (]: 65 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ... [[32mCREATE TABLE (0.0 rows, 1.4 GiB processed)[0m in 4.69s]
[0m15:55:11.084753 [debug] [Thread-2 (]: On model.project_dbt.V1110_payment_initiation_services: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1110_payment_initiation_services`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = '	PAY-PXG-BANQUPLU')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.480262', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.480262', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 15:55:10.480262', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 15:55:10.480262', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.*,
      country,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      CAST ("" AS STRING) AS Period,
      TIMESTAMP(DATETIME( '2024-10-01 15:55:10.480262', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-10-31 15:55:10.480262', 'Etc/UTC'))  AS Period_end_date,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m15:55:11.087311 [debug] [Thread-7 (]: Finished running node model.project_dbt.T0402_AIS_ASPSP_API
[0m15:55:11.089549 [debug] [Thread-7 (]: Began running node model.project_dbt.V1220_stock_of_accounts
[0m15:55:11.090145 [info ] [Thread-7 (]: 70 of 88 START sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts .... [RUN]
[0m15:55:11.090529 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_ASPSP_API, now model.project_dbt.V1220_stock_of_accounts)
[0m15:55:11.090889 [debug] [Thread-7 (]: Began compiling node model.project_dbt.V1220_stock_of_accounts
[0m15:55:11.094722 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.V1220_stock_of_accounts"
[0m15:55:11.095191 [debug] [Thread-7 (]: Began executing node model.project_dbt.V1220_stock_of_accounts
[0m15:55:11.097827 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:55:11.553454 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.V1220_stock_of_accounts"
[0m15:55:11.555198 [debug] [Thread-7 (]: On model.project_dbt.V1220_stock_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1220_stock_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  'PMAC' as AccountType,
  case
    when ACCOUNT_USAGE in ('CARE','CARE_EXPENSE','ESTATE') then 'HSNP' -- Households and NPISHs
    when ACCOUNT_USAGE is null then 'CORP' -- Non-financial corporations
    else 'check the query'
  end as Customer_Category,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
and BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
and IACC.ACCOUNT_STATUS = 'OPEN'
or (
  IACC.ACCOUNT_STATUS = 'CLOSED'
  and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-10-01 15:55:11.094434', 'Etc/UTC'))
  )
and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:55:11.094434', 'Etc/UTC'))
group by 1,2
    );
  
[0m15:55:11.904606 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:060cb075-dc51-4b15-88ae-c2e33009f95c&page=queryresults
[0m15:55:11.908205 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:84c8bf53-4215-4175-9d2c-d1931817b66c&page=queryresults
[0m15:55:11.980501 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:21696619-8f9c-4f17-a3f8-f48733fd61e1&page=queryresults
[0m15:55:12.421214 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:da1cd937-ef80-4995-8eac-6aec3c39b3ee&page=queryresults
[0m15:55:12.554231 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01405d3700>]}
[0m15:55:12.555432 [info ] [Thread-11 ]: 64 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts .. [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.48s]
[0m15:55:12.555956 [debug] [Thread-11 ]: Finished running node model.project_dbt.T0401_nr_of_accounts
[0m15:55:12.556364 [debug] [Thread-11 ]: Began running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m15:55:12.556816 [info ] [Thread-11 ]: 71 of 88 START sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [RUN]
[0m15:55:12.557434 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_nr_of_accounts, now model.project_dbt.V1222_stock_of_accessed_accounts)
[0m15:55:12.557825 [debug] [Thread-11 ]: Began compiling node model.project_dbt.V1222_stock_of_accessed_accounts
[0m15:55:12.566512 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m15:55:12.567061 [debug] [Thread-11 ]: Began executing node model.project_dbt.V1222_stock_of_accessed_accounts
[0m15:55:12.569792 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m15:55:13.115151 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m15:55:13.117038 [debug] [Thread-11 ]: On model.project_dbt.V1222_stock_of_accessed_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1222_stock_of_accessed_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'AISP' as PSPType,
    fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
    'VOLU' as Metric,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
      AND (
            ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:12.565942', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:55:12.565942', 'Etc/UTC'))
          )
          OR (
            ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:12.565942', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 15:55:12.565942', 'Etc/UTC'))
              )
  GROUP BY
  1,2,3,4
  )
  SELECT
    'AISP' as PSPType,
    Countryofcustomerresidence as  countryOfASPSP,
    'LU' as countryOfAISP,
    'VOLU' as Metric,
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  group by 1,2,3
union all


SELECT
  'APSP' as PSPType,
  'LU' countryOfASPSP,
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  'VOLU' as Metric,
  COUNT(*) AS Numberofaccounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='LU'
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  and  c.CONSENT_CREATED_AT <  TIMESTAMP(DATETIME( '2024-10-31 15:55:12.565942', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:12.565942', 'Etc/UTC'))
group by 1,2,3
    );
  
[0m15:55:13.324638 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01423c6560>]}
[0m15:55:13.326347 [info ] [Thread-12 ]: 66 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG ......... [[32mCREATE TABLE (1.0 rows, 6.1 GiB processed)[0m in 6.31s]
[0m15:55:13.328012 [debug] [Thread-12 ]: Finished running node model.project_dbt.T0402_AIS_PXG
[0m15:55:13.329246 [debug] [Thread-12 ]: Began running node model.project_dbt.V1230_number_of_accounts
[0m15:55:13.330800 [info ] [Thread-12 ]: 72 of 88 START sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts ... [RUN]
[0m15:55:13.331930 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_PXG, now model.project_dbt.V1230_number_of_accounts)
[0m15:55:13.332987 [debug] [Thread-12 ]: Began compiling node model.project_dbt.V1230_number_of_accounts
[0m15:55:13.343831 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.V1230_number_of_accounts"
[0m15:55:13.344642 [debug] [Thread-12 ]: Began executing node model.project_dbt.V1230_number_of_accounts
[0m15:55:13.347584 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:55:13.615673 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01439b0f70>]}
[0m15:55:13.617522 [info ] [Thread-14 ]: 35 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ........... [[32mCREATE TABLE (2.0 rows, 39.0 GiB processed)[0m in 38.49s]
[0m15:55:13.625166 [debug] [Thread-14 ]: Finished running node model.project_dbt.KMS_P17_PIS
[0m15:55:13.626507 [debug] [Thread-14 ]: Began running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m15:55:13.628059 [info ] [Thread-14 ]: 73 of 88 START sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [RUN]
[0m15:55:13.629177 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P17_PIS, now model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP)
[0m15:55:13.630221 [debug] [Thread-14 ]: Began compiling node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m15:55:13.641539 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m15:55:13.642122 [debug] [Thread-14 ]: Began executing node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m15:55:13.646057 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m15:55:13.841531 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.V1230_number_of_accounts"
[0m15:55:13.842956 [debug] [Thread-12 ]: On model.project_dbt.V1230_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1230_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
   SELECT
     'AISP' as PSPType,
     fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
     'VOLU' as Metric,
     ac.USER_TOKEN,
     COUNT(*) AS number_of_consents,
   FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
     ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
    inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
     ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
   ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
     ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
     ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
     ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
   WHERE
       a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
       AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
       AND (
           (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:13.343144', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 15:55:13.343144', 'Etc/UTC'))
           )
           OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:13.343144', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 15:55:13.343144', 'Etc/UTC'))
               )
       )
   GROUP BY
   1,2,3,4
   )
   SELECT
     'AISP' as PSPType,
     Countryofcustomerresidence,
     'VOLU' as Metric,
     COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
   FROM obsolete_and_active_consents_count_in_reporting_period
   group by 1,2,3
    );
  
[0m15:55:14.001558 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bad3e2e6-3396-421f-9e74-bc431e6809c1&page=queryresults
[0m15:55:14.240545 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m15:55:14.242303 [debug] [Thread-14 ]: On model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V130_direct_debits_reporting_as_creditors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:13.640932', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:13.640932', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8

union all

SELECT
  'CORP' as customerCategory,
   IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:13.640932', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:13.640932', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m15:55:14.766634 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bf332aa3-7a23-4a05-aa26-1ecb978ece1f&page=queryresults
[0m15:55:15.222061 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:84ca3e57-4cb3-40fd-a4de-627c9cccd28d&page=queryresults
[0m15:55:17.272426 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01438c81c0>]}
[0m15:55:17.274149 [info ] [Thread-13 ]: 61 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers  [[32mCREATE TABLE (12.0 rows, 15.7 GiB processed)[0m in 17.26s]
[0m15:55:17.275777 [debug] [Thread-13 ]: Finished running node model.project_dbt.T0202_credit_transfers
[0m15:55:17.276977 [debug] [Thread-13 ]: Began running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:55:17.278542 [info ] [Thread-13 ]: 74 of 88 START sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [RUN]
[0m15:55:17.279729 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers, now model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP)
[0m15:55:17.280761 [debug] [Thread-13 ]: Began compiling node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:55:17.290837 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m15:55:17.291391 [debug] [Thread-13 ]: Began executing node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:55:17.294360 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:55:17.825423 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m15:55:17.827456 [debug] [Thread-13 ]: On model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V131_direct_debits_reporting_as_debtors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:17.290231', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:17.290231', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    'SEPA' as paymentScheme,
    "Electronic file/batch" AS initiationChannel ,
    '' as consent,
    '' as fraudType,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:17.290231', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:17.290231', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m15:55:18.675653 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9562bf72-91c2-4ab0-9680-aabf2225a293&page=queryresults
[0m15:55:19.480897 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0140617310>]}
[0m15:55:19.482051 [info ] [Thread-8 (]: 63 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_misc ............ [[32mCREATE TABLE (11.0 rows, 11.0 GiB processed)[0m in 14.83s]
[0m15:55:19.482587 [debug] [Thread-8 (]: Finished running node model.project_dbt.T0401_misc
[0m15:55:19.482965 [debug] [Thread-8 (]: Began running node model.project_dbt.V140_SEPA_R_transactions
[0m15:55:19.483359 [info ] [Thread-8 (]: 75 of 88 START sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions ... [RUN]
[0m15:55:19.484163 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_misc, now model.project_dbt.V140_SEPA_R_transactions)
[0m15:55:19.484584 [debug] [Thread-8 (]: Began compiling node model.project_dbt.V140_SEPA_R_transactions
[0m15:55:19.498289 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.V140_SEPA_R_transactions"
[0m15:55:19.500445 [debug] [Thread-8 (]: Began executing node model.project_dbt.V140_SEPA_R_transactions
[0m15:55:19.506721 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m15:55:20.176042 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.V140_SEPA_R_transactions"
[0m15:55:20.178085 [debug] [Thread-8 (]: On model.project_dbt.V140_SEPA_R_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V140_SEPA_R_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
     'SEPA' as paymentScheme,
   case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
        when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
        end RoleofReporting,
   'CORP' as customerCategory,
   case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
        or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
              else 'PSPN'
         end settlementChannel,
  'SEPA Credit Transfer' as R_TransactionType,
     case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end creditorPspCountry,
     case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end debtorPspCountry,
     ftr.transaction_currency as currency,
     'VOLU' as metric,
     count(*) as reportedAmount,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:19.497364', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:19.497364', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8

  union all

  SELECT
        'SEPA' as paymentScheme,
      case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
            when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
            end RoleofReporting,
      'CORP' as customerCategory,
      case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
            or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
                  else 'PSPN'
            end settlementChannel,
      'SEPA Credit Transfer' as R_TransactionType,
        case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end creditorPspCountry,
        case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end debtorPspCountry,
        ftr.transaction_currency as currency,
        'VALE' as metric,
        SUM(ftr.TRANSACTION_AMOUNT) as reportedAmount,
        CURRENT_TIMESTAMP AS Load_timestamp,
        ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:19.497364', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:19.497364', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8
  order by 1,2,3,4,5,6,7,8
    );
  
[0m15:55:21.321682 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1c227546-113e-4e3a-a55f-7fb08650b74c&page=queryresults
[0m15:55:22.246205 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143e8c070>]}
[0m15:55:22.248047 [info ] [Thread-12 ]: 72 of 88 OK created sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts  [[32mCREATE TABLE (0.0 rows, 6.0 GiB processed)[0m in 8.91s]
[0m15:55:22.249759 [debug] [Thread-12 ]: Finished running node model.project_dbt.V1230_number_of_accounts
[0m15:55:22.251088 [debug] [Thread-12 ]: Began running node model.project_dbt.V142_intermediated_payment_transactions
[0m15:55:22.252798 [info ] [Thread-12 ]: 76 of 88 START sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [RUN]
[0m15:55:22.254127 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.V1230_number_of_accounts, now model.project_dbt.V142_intermediated_payment_transactions)
[0m15:55:22.255602 [debug] [Thread-12 ]: Began compiling node model.project_dbt.V142_intermediated_payment_transactions
[0m15:55:22.277525 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m15:55:22.278101 [debug] [Thread-12 ]: Began executing node model.project_dbt.V142_intermediated_payment_transactions
[0m15:55:22.280918 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m15:55:23.033534 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m15:55:23.040834 [debug] [Thread-12 ]: On model.project_dbt.V142_intermediated_payment_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V142_intermediated_payment_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  'CPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  d_payment_transaction_info.payment_transaction_payer_country   as debtorPSPs,
  'LU' as CreditorPSPs,
  d_payment_transaction_info.payment_transaction_currency_code as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE != 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:22.276383', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:22.276383', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  group by 1,2,3,4,5,6,7,8
union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as RoleofReporting,
  'PSPN' as Settlementchannel,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'LU', d_payment_transaction_info.payment_transaction_payer_country)   as debtorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_payer_country, 'LU') as CreditorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_currency_code,  d_payment_transaction_info.payment_transaction_currency_code) as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:22.276383', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:22.276383', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT

  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
    REFUND.payment_transaction_payer_country as CreditorPSPs,
    REFUND.payment_transaction_currency_code as currency,
    'Volu' as Metric,
    count(*) as ReportedAmount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
      AS d_payment_item_info
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
  T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
  WHERE
      f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
      AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
      AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:22.276383', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:22.276383', 'Etc/UTC')) -- like timez
    group by 1,2,3,4,5,6,7,8
    union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
  REFUND.payment_transaction_payer_country as CreditorPSPs,
  REFUND.payment_transaction_currency_code as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:22.276383', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:22.276383', 'Etc/UTC')) -- like timez
  group by 1,2,3,4,5,6,7,8
    );
  
[0m15:55:24.180985 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:75798369-742f-4dea-8cda-6baaa902de32&page=queryresults
[0m15:55:24.731434 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c1cbe0>]}
[0m15:55:24.732322 [info ] [Thread-7 (]: 70 of 88 OK created sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts  [[32mCREATE TABLE (2.0 rows, 4.1 GiB processed)[0m in 13.64s]
[0m15:55:24.733280 [debug] [Thread-7 (]: Finished running node model.project_dbt.V1220_stock_of_accounts
[0m15:55:24.733821 [debug] [Thread-7 (]: Began running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:55:24.734575 [info ] [Thread-7 (]: 77 of 88 START sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [RUN]
[0m15:55:24.735005 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1220_stock_of_accounts, now model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs)
[0m15:55:24.735347 [debug] [Thread-7 (]: Began compiling node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:55:24.745361 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m15:55:24.746130 [debug] [Thread-7 (]: Began executing node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:55:24.749423 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:55:25.235902 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m15:55:25.238318 [debug] [Thread-7 (]: On model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V150_card_transactions_with_cards_issued_by resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VOLU' as metric,
  count(*) AS ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND  CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 15:55:24.744650', 'Etc/UTC'))
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 15:55:24.744650', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

UNION ALL

SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VALE' as metric,
  sum (coalesce(FCT.CARD_TRANSACTION_CLEARED_AMOUNT ,0)) + sum(coalesce(CARD_TRANSACTION_REFUNDED_AMOUNT,0)) as total_sum,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND   CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 15:55:24.744650', 'Etc/UTC'))
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 15:55:24.744650', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
    );
  
[0m15:55:26.098054 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:58853d08-e780-4e18-8ed6-82f0654cc3c0&page=queryresults
[0m15:55:28.509608 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c3d8d0>]}
[0m15:55:28.511524 [info ] [Thread-10 ]: 46 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS .... [[32mCREATE TABLE (2.5k rows, 47.8 GiB processed)[0m in 40.82s]
[0m15:55:28.513364 [debug] [Thread-10 ]: Finished running node model.project_dbt.PAY_TROP_5845_IBIS
[0m15:55:28.514601 [debug] [Thread-10 ]: Began running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:55:28.516227 [info ] [Thread-10 ]: 78 of 88 START sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [RUN]
[0m15:55:28.517290 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_IBIS, now model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs)
[0m15:55:28.518327 [debug] [Thread-10 ]: Began compiling node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:55:28.525808 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m15:55:28.526315 [debug] [Thread-10 ]: Began executing node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:55:28.529201 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m15:55:29.191782 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m15:55:29.193725 [debug] [Thread-10 ]: On model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V152_card_transactions_acquired_by_resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CRCA' as PaymentCardType,
  case when f_payment_transactions.card_network = 'MASTERCARD' then 'MSTR'
    when f_payment_transactions.card_network = 'VISA' then 'VISA'
    else 'OTHER' END PaymentCardScheme,
  'ECOM' as TerminalType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as OperationType,
  'RMTR' as InitiationChannel,
  'REM1' as InitiationsubChannel,
  'MITR' as SCA,
  'NOAP' as FraudType,
  d_merchants.MERCHANT_COUNTRY AS CountryofIssuer,
  d_merchants.MERCHANT_COUNTRY AS  CountryofTerminal,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED` AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items
  ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants
  ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions
  ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info
  ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products
  ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
  AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 15:55:28.525346', 'Etc/UTC'))
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 15:55:28.525346', 'Etc/UTC'))
  GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
    );
  
[0m15:55:30.130951 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:723c1a54-03e1-4214-9998-4f1b656501e2&page=queryresults
[0m15:55:32.463617 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143efb970>]}
[0m15:55:32.465450 [info ] [Thread-7 (]: 77 of 88 OK created sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [[32mCREATE TABLE (0.0 rows, 3.3 GiB processed)[0m in 7.73s]
[0m15:55:32.467441 [debug] [Thread-7 (]: Finished running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m15:55:32.469206 [debug] [Thread-7 (]: Began running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:55:32.471039 [info ] [Thread-7 (]: 79 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [RUN]
[0m15:55:32.472335 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs, now model.project_dbt.ZVS41_Inbound_credit_transfers)
[0m15:55:32.473372 [debug] [Thread-7 (]: Began compiling node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:55:32.484804 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m15:55:32.485838 [debug] [Thread-7 (]: Began executing node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:55:32.491482 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:55:32.966495 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m15:55:32.968208 [debug] [Thread-7 (]: On model.project_dbt.ZVS41_Inbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Inbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYER_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'INBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1
ORDER BY 1
    );
  
[0m15:55:33.774158 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143ccbac0>]}
[0m15:55:33.775793 [info ] [Thread-15 ]: 41 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCA .............. [[32mCREATE TABLE (11.3k rows, 30.3 GiB processed)[0m in 51.68s]
[0m15:55:33.776757 [debug] [Thread-15 ]: Finished running node model.project_dbt.PAY_CPCA
[0m15:55:33.777137 [debug] [Thread-15 ]: Began running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:55:33.777603 [info ] [Thread-15 ]: 80 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [RUN]
[0m15:55:33.777969 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCA, now model.project_dbt.ZVS41_Outbound_credit_transfers)
[0m15:55:33.778388 [debug] [Thread-15 ]: Began compiling node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:55:33.783551 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m15:55:33.784035 [debug] [Thread-15 ]: Began executing node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:55:33.786833 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m15:55:33.795898 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:52824bfe-b78c-4883-93ec-e49b5dc39f56&page=queryresults
[0m15:55:34.268988 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m15:55:34.270711 [debug] [Thread-15 ]: On model.project_dbt.ZVS41_Outbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Outbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'PCT.4 Manual entry'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'PCT.2 Electronic entry'
  END EntryMode,
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS') THEN 'PCT.22 Single entry'
    WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'PCT.21 Batch entry'
  END Batchmode,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1, 2, 3
    );
  
[0m15:55:35.228048 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f337801d-9908-48bb-857d-44249d107401&page=queryresults
[0m15:55:42.623992 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0140633670>]}
[0m15:55:42.625270 [info ] [Thread-9 (]: 52 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_IDEAL ............. [[32mCREATE TABLE (6.0 rows, 1.4 TiB processed)[0m in 52.40s]
[0m15:55:42.625839 [debug] [Thread-9 (]: Finished running node model.project_dbt.PCT_IDEAL
[0m15:55:42.626232 [debug] [Thread-9 (]: Began running node model.project_dbt.ZVS9_PCT
[0m15:55:42.626802 [info ] [Thread-9 (]: 81 of 88 START sql incremental model dev_dm_pst3_DE.ZVS9_PCT ................... [RUN]
[0m15:55:42.627182 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_IDEAL, now model.project_dbt.ZVS9_PCT)
[0m15:55:42.627539 [debug] [Thread-9 (]: Began compiling node model.project_dbt.ZVS9_PCT
[0m15:55:42.637463 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.ZVS9_PCT"
[0m15:55:42.641807 [debug] [Thread-9 (]: Began executing node model.project_dbt.ZVS9_PCT
[0m15:55:42.645325 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m15:55:43.116147 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01423c7c70>]}
[0m15:55:43.117897 [info ] [Thread-1 (]: 69 of 88 OK created sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [[32mCREATE TABLE (0.0 rows, 47.0 GiB processed)[0m in 32.63s]
[0m15:55:43.120727 [debug] [Thread-1 (]: Finished running node model.project_dbt.V121_customer_credit_transfers_received
[0m15:55:43.124239 [debug] [Thread-1 (]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m15:55:43.126193 [info ] [Thread-1 (]: 82 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [RUN]
[0m15:55:43.128413 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.ZVS9_PCT"
[0m15:55:43.128954 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.V121_customer_credit_transfers_received, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals)
[0m15:55:43.129480 [debug] [Thread-1 (]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m15:55:43.132652 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m15:55:43.133134 [debug] [Thread-1 (]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m15:55:43.133522 [debug] [Thread-9 (]: On model.project_dbt.ZVS9_PCT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS9_PCT`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE (FAT.TRANSACTION_DIRECTION = 'OUTBOUND')
  AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
  AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
  AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
  AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL not in ('DASHBOARD', 'OTHER','CARDS')
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1
ORDER BY 1 ASC
    );
  
[0m15:55:43.138071 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:55:43.899800 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m15:55:43.901528 [debug] [Thread-1 (]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
      
    
    

    OPTIONS()
    as (
      SELECT
    payee_psp_country,
    outbound_ibis_payments_trx_count,
    outbound_ibis_payments_amount_sum_in_EUR,
    SUM(outbound_ibis_payments_trx_count) OVER(PARTITION BY period) AS total_outbound_ibis_payments_trx_count,
    SUM(outbound_ibis_payments_amount_sum_in_EUR) OVER(PARTITION BY period) AS total_outbound_ibis_payments_amount_sum_in_EUR,
    load_timestamp,
    period
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
    );
  
[0m15:55:43.979609 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2c9bf392-ec79-4299-ae68-1b4ae2f3fc36&page=queryresults
[0m15:55:44.441870 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7da9ffb6-4fa9-4ed8-9c90-b220bf7772f7&page=queryresults
[0m15:55:45.315963 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c1cee0>]}
[0m15:55:45.317667 [info ] [Thread-13 ]: 74 of 88 OK created sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [[32mCREATE TABLE (0.0 rows, 47.0 GiB processed)[0m in 28.04s]
[0m15:55:45.319318 [debug] [Thread-13 ]: Finished running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m15:55:45.320560 [debug] [Thread-13 ]: Began running node model.project_dbt.PCP
[0m15:55:45.321990 [info ] [Thread-13 ]: 83 of 88 START sql incremental model dev_dm_pst3_BE.PCP ........................ [RUN]
[0m15:55:45.323343 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP, now model.project_dbt.PCP)
[0m15:55:45.324614 [debug] [Thread-13 ]: Began compiling node model.project_dbt.PCP
[0m15:55:45.341355 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.PCP"
[0m15:55:45.342236 [debug] [Thread-13 ]: Began executing node model.project_dbt.PCP
[0m15:55:45.345632 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m15:55:45.727531 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c9bb20>]}
[0m15:55:45.729185 [info ] [Thread-7 (]: 79 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.1 GiB processed)[0m in 13.26s]
[0m15:55:45.730779 [debug] [Thread-7 (]: Finished running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m15:55:45.859866 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.PCP"
[0m15:55:45.862152 [debug] [Thread-13 ]: On model.project_dbt.PCP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP`
      
    
    

    OPTIONS()
    as (
      with source as(
SELECT
  d_payment_products.PRODUCT_CODE AS PRODUCT,
  d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY  AS PAYERCOUNTRY,
  d_merchants.MERCHANT_COUNTRY  AS MERCHANTCOUNTRY,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'VISA' THEN 'Visa'
    END AS PCP_TYPE,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
    END AS SINGLEWIP,
    d_payment_transaction_info.T_SOURCE_PK_UUID  AS  TRANSACTION_PUBLIC_IDENTIFIER,
    f_payment_transactions.CARD_COUNTRY  AS CARD_COUNTRY,
    f_payment_transactions.CARD_NETWORK_AUTHORIZATION_CODE  AS NETWORK_CODE,
    f_payment_transactions.SCA_RESULT  AS SCA_RESULT,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN
      IF(f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT','non-SCA used: reason is merchant initiated transaction (MIT)','SCA used')
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF (f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD', 'non-SCA used: reason is merchant initiated transaction (MIT)',map.SCA_REASON )
    END AS SCA_REASON,
  f_payment_transactions.MASTERCARD_PRODUCT_ID  AS LICENSEDPRODUCTID,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_CODE AS PRODUCTCATEGORYCODE,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION  AS  PRODUCTCATEGORYDESCRIPTION,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Debit'
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF(
        f_payment_transactions.CARD_NETWORK = 'MASTERCARD', --condition
        --true ('MASTERCARD')
        IF(f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION = 'Prepaid',
          'Debit',
          f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION
          ),
        --false (!='MASTERCARD')
        IF(
            f_payment_transactions.CARD_NETWORK = 'VISA',
            IF( f_payment_transactions.CARD_FUNDING_SOURCE = 'Prepaid',
              'Debit',
              F_Payment_transactions.CARD_FUNDING_SOURCE
            ),
            'NA'
          )
          )
    ELSE 'NA'
    END AS CARDFUNCTION,
  f_payment_transactions.CARD_FUNDING_SOURCE  AS ACCOUNTFUNDINGSOURCE,
  d_merchants.T_SOURCE_PK_UUID AS MERCHANT_PUBLIC_IDENTIFIER,
  f_payment_items.PAYMENT_ITEM_AMOUNT  AS AMOUNT,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  f_payment_transactions.CARD_NETWORK,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE` AS map  ON f_payment_transactions.SCA_RESULT = map.SCA_RESULT
WHERE (d_merchants.MERCHANT_COUNTRY ) IS NOT NULL
    AND d_payment_products.PRODUCT_CODE IN ('BANCONTACT_COLLECT', 'SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
),
exeption_records as(
SELECT
  PRODUCT,
  PAYERCOUNTRY,
  MERCHANTCOUNTRY,
  PCP_TYPE,
  SINGLEWIP,
  TRANSACTION_PUBLIC_IDENTIFIER,
  CARD_COUNTRY,
  NETWORK_CODE,
  SCA_RESULT,
  SCA_REASON,
  LICENSEDPRODUCTID,
  PRODUCTCATEGORYCODE,
  PRODUCTCATEGORYDESCRIPTION,
  "Credit" AS CARDFUNCTION,
  ACCOUNTFUNDINGSOURCE,
  MERCHANT_PUBLIC_IDENTIFIER,
  AMOUNT,
  CURRENCY,
  CARD_NETWORK,
  LOAD_TIMESTAMP,
  Period,
  Period_begin_date,
  Period_end_date,
FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
),
execpted_records as(
SELECT * FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER NOT IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
)
SELECT * FROM exeption_records
UNION ALL
SELECT * FROM execpted_records
    );
  
[0m15:55:46.727856 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:acb9e6ac-707b-4fa3-9e69-1921989540ec&page=queryresults
[0m15:55:47.009791 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01405700a0>]}
[0m15:55:47.011585 [info ] [Thread-15 ]: 80 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.1 GiB processed)[0m in 13.23s]
[0m15:55:47.013401 [debug] [Thread-15 ]: Finished running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m15:55:47.133512 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01423c7e50>]}
[0m15:55:47.135158 [info ] [Thread-16 ]: 68 of 88 OK created sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [[32mCREATE TABLE (0.0 rows, 56.4 GiB processed)[0m in 36.67s]
[0m15:55:47.136773 [debug] [Thread-16 ]: Finished running node model.project_dbt.V120_customer_credit_transfers_sent
[0m15:55:47.475094 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143efa050>]}
[0m15:55:47.476925 [info ] [Thread-1 (]: 82 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [[32mCREATE TABLE (8.0 rows, 304.0 Bytes processed)[0m in 4.35s]
[0m15:55:47.478664 [debug] [Thread-1 (]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m15:55:47.480464 [debug] [Thread-7 (]: Began running node model.project_dbt.Cross_join
[0m15:55:47.482032 [info ] [Thread-7 (]: 84 of 88 START sql incremental model dev_dm_pst3_FR.Cross_join ................. [RUN]
[0m15:55:47.483080 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.ZVS41_Inbound_credit_transfers, now model.project_dbt.Cross_join)
[0m15:55:47.484070 [debug] [Thread-7 (]: Began compiling node model.project_dbt.Cross_join
[0m15:55:47.496062 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.Cross_join"
[0m15:55:47.497201 [debug] [Thread-7 (]: Began executing node model.project_dbt.Cross_join
[0m15:55:47.501913 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m15:55:48.154512 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.Cross_join"
[0m15:55:48.160314 [debug] [Thread-7 (]: On model.project_dbt.Cross_join: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Cross_join`
      
    
    

    OPTIONS()
    as (
      WITH type AS (
  SELECT
    'agMoyPaiTypeOpeCanalTransactZoneGeo' AS axe,
    'VIREMENT' AS moyenPaiementtype,
    'VIR_EMIS' AS Operationtype,
    'ELECTRONIQUE' AS canaltype,
    'DISTANCE' AS typeTransaction,
    'axe1'  AS alias
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeo', 'VIREMENT', 'VIR_EMIS', 'ELECTRONIQUE', 'PROXIMITE', 'axe1'
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc', 'CARTE', 'CARTE_EMIS', 'ELECTRONIQUE', 'DISTANCE', 'axe2'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'PRELEVEM', 'PRELEVEM_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'MON_ELEC', 'PAIEMT_ME_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'CHEQ', 'CHEQ_RECU', 'NA', 'NA', 'axe3'
),
final as (
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    mcc.Coded as MCC_code
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe = 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc' and typeTransaction = 'DISTANCE'
  UNION ALL
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    NULL as MCC_code,
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe <> 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc'
)
SELECT
axe,
alias,
moyenPaiementtype,
Operationtype,
canaltype,
typeTransaction,
'5493004MX17L5E8MUB29' AS LEI,
payee_psp_country,
COALESCE(outbound_ibis_payments_trx_count, 0) AS outbound_ibis_payments_trx_count,
COALESCE(outbound_ibis_payments_amount_sum_in_EUR, 0) AS outbound_ibis_payments_amount_sum_in_EUR,
COALESCE(total_outbound_ibis_payments_trx_count, 0) AS total_outbound_ibis_payments_trx_count,
COALESCE(total_outbound_ibis_payments_amount_sum_in_EUR, 0) AS total_outbound_ibis_payments_amount_sum_in_EUR,
load_timestamp,
period,
FROM final
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
ON payee_psp_country = country_code
    );
  
[0m15:55:48.629987 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01407c3f40>]}
[0m15:55:48.631664 [info ] [Thread-6 (]: 47 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS ..... [[32mCREATE TABLE (61.0 rows, 35.0 GiB processed)[0m in 60.92s]
[0m15:55:48.632655 [debug] [Thread-6 (]: Finished running node model.project_dbt.PAY_TROP_5845_PIS
[0m15:55:48.633248 [debug] [Thread-16 ]: Began running node model.project_dbt.PAY_TROP_5845
[0m15:55:48.633685 [info ] [Thread-16 ]: 85 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 .............. [RUN]
[0m15:55:48.634004 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.V120_customer_credit_transfers_sent, now model.project_dbt.PAY_TROP_5845)
[0m15:55:48.634340 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PAY_TROP_5845
[0m15:55:48.639583 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845"
[0m15:55:48.640265 [debug] [Thread-16 ]: Began executing node model.project_dbt.PAY_TROP_5845
[0m15:55:48.643523 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m15:55:48.674368 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01407c1c00>]}
[0m15:55:48.676073 [info ] [Thread-2 (]: 67 of 88 OK created sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [[32mCREATE TABLE (7.0 rows, 39.0 GiB processed)[0m in 38.21s]
[0m15:55:48.677735 [debug] [Thread-2 (]: Finished running node model.project_dbt.V1110_payment_initiation_services
[0m15:55:48.793441 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f47253d6-6bc9-4c4d-81a6-d3d26c337630&page=queryresults
[0m15:55:49.151729 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845"
[0m15:55:49.153781 [debug] [Thread-16 ]: On model.project_dbt.PAY_TROP_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
  -- COALESCE(cmd_deb.identifier,cmd_cre.identifier) AS payment_account_number,
  -- COALESCE(cmd_deb.enterprise_number,cmd_cre.enterprise_number) AS enterprise_number,
  -- COALESCE(cmd_deb.legal_form,cmd_cre.legal_form) AS legal_form,
  -- COALESCE(cmd_deb.country,cmd_cre.country) AS country,
  -- COALESCE(cmd_deb.postal_code,cmd_cre.postal_code) AS postal_code,
  bis.Ot,
  bis.Ref,
  bis.ORef,
  bis.debtor_account_identifier,
  bis.creditor_account_identifier,
  bis.Ord,
  bis.Ben,
  bis.PayID,
  bis.BICOrd,
  bis.BICBen,
  bis.BICSen,
  bis.BICRec,
  bis.PasOrd,
  bis.PasBen,
  bis.LEIOrd,
  bis.LEIBen,
  bis.Sch,
  bis.Pro,
  bis.DtLiq,
  bis.DtPISP,
  bis.TsOrd,
  bis.TsBen,
  bis.TipTR,
  bis.Div,
  bis.Mont,
  bis.MontOrg,
  bis.TipCan,
  bis.FormEnv,
  bis.OperElet,
  bis.OperRem,
  bis.OperECom,
  bis.IniPISP,
  bis.ModAc,
  bis.SCA,
  bis.MnonSCA,
  bis.SI,
  bis.PasmC,
  bis.PasnC,
  bis.CPosm,
  bis.TipDoc,
  bis.NumDoc,
  bis.LEIC,
  bis.ENI,
  bis.InfUltBen,
  bis.InfUltOrd,
  bis.Period,
  bis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS` AS bis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_deb
--   ON bis.debtor_account_identifier = cmd_deb.identifier
--   AND bis.Ot = 'O'
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--   ON bis.creditor_account_identifier = cmd_cre.identifier
--   AND bis.Ot = 'B'
UNION ALL
SELECT
  -- cmd_cre.identifier as payment_account_number,
  -- cmd_cre.enterprise_number,
  -- cmd_cre.legal_form,
  -- cmd_cre.country,
  -- cmd_cre.postal_code,
  pis.Ot,
  pis.Ref,
  pis.ORef,
  pis.debtor_account_identifier,
  pis.creditor_account_identifier,
  pis.Ord,
  pis.Ben,
  pis.PayID,
  pis.BICOrd,
  pis.BICBen,
  pis.BICSen,
  pis.BICRec,
  pis.PasOrd,
  pis.PasBen,
  pis.LEIOrd,
  pis.LEIBen,
  pis.Sch,
  pis.Pro,
  NULL AS DtLiq,
  pis.DtPISP,
  pis.TsOrd,
  pis.TsBen,
  pis.TipTR,
  pis.Div,
  pis.Mont,
  pis.MontOrg,
  pis.TipCan,
  pis.FormEnv,
  pis.OperElet,
  pis.OperRem,
  pis.OperECom,
  pis.IniPISP,
  pis.ModAc,
  pis.SCA,
  pis.MnonSCA,
  pis.SI,
  pis.PasmC,
  pis.PasnC,
  pis.CPosm,
  pis.TipDoc,
  pis.NumDoc,
  pis.LEIC,
  pis.ENI,
  pis.InfUltBen,
  pis.InfUltOrd,
  pis.Period,
  pis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS` AS pis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--  ON pis.creditor_account_identifier = cmd_cre.identifier
    );
  
[0m15:55:50.208857 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1ec3f656-2c15-4edf-b19d-60b0472d9ed4&page=queryresults
[0m15:55:52.332712 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143cbe800>]}
[0m15:55:52.334471 [info ] [Thread-16 ]: 85 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 ......... [[32mCREATE TABLE (2.6k rows, 624.9 KiB processed)[0m in 3.70s]
[0m15:55:52.335527 [debug] [Thread-16 ]: Finished running node model.project_dbt.PAY_TROP_5845
[0m15:55:52.381937 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01407c3ee0>]}
[0m15:55:52.383820 [info ] [Thread-5 (]: 55 of 88 OK created sql incremental model dev_dm_pst3_BE.PIS ................... [[32mCREATE TABLE (20.0 rows, 45.2 GiB processed)[0m in 59.21s]
[0m15:55:52.385497 [debug] [Thread-5 (]: Finished running node model.project_dbt.PIS
[0m15:55:53.239458 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0141f61030>]}
[0m15:55:53.241208 [info ] [Thread-7 (]: 84 of 88 OK created sql incremental model dev_dm_pst3_FR.Cross_join ............ [[32mCREATE TABLE (489.0k rows, 1.4 KiB processed)[0m in 5.76s]
[0m15:55:53.243155 [debug] [Thread-7 (]: Finished running node model.project_dbt.Cross_join
[0m15:55:54.280619 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143d54c10>]}
[0m15:55:54.281814 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd70a0>]}
[0m15:55:54.284111 [info ] [Thread-14 ]: 73 of 88 OK created sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [[32mCREATE TABLE (0.0 rows, 47.0 GiB processed)[0m in 40.65s]
[0m15:55:54.287683 [info ] [Thread-8 (]: 75 of 88 OK created sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions  [[32mCREATE TABLE (0.0 rows, 47.0 GiB processed)[0m in 34.79s]
[0m15:55:54.289549 [debug] [Thread-14 ]: Finished running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m15:55:54.291117 [debug] [Thread-8 (]: Finished running node model.project_dbt.V140_SEPA_R_transactions
[0m15:55:55.611092 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd7880>]}
[0m15:55:55.611732 [info ] [Thread-9 (]: 81 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS9_PCT .............. [[32mCREATE TABLE (0.0 rows, 11.1 GiB processed)[0m in 12.98s]
[0m15:55:55.612304 [debug] [Thread-9 (]: Finished running node model.project_dbt.ZVS9_PCT
[0m15:55:57.774657 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd74c0>]}
[0m15:55:57.776466 [info ] [Thread-10 ]: 78 of 88 OK created sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [[32mCREATE TABLE (0.0 rows, 30.3 GiB processed)[0m in 29.26s]
[0m15:55:57.778110 [debug] [Thread-10 ]: Finished running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m15:55:58.124302 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd7310>]}
[0m15:56:00.012317 [info ] [Thread-11 ]: 71 of 88 OK created sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [[32mCREATE TABLE (7.0 rows, 7.5 GiB processed)[0m in 45.57s]
[0m15:56:00.014103 [debug] [Thread-11 ]: Finished running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m15:56:05.531246 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd7970>]}
[0m15:56:05.532953 [info ] [Thread-4 (]: 48 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 ......... [[32mCREATE TABLE (1.0 rows, 89.7 GiB processed)[0m in 77.46s]
[0m15:56:05.533516 [debug] [Thread-4 (]: Finished running node model.project_dbt.PAY_TRRT_5845
[0m15:56:23.387138 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd6680>]}
[0m15:56:23.388897 [info ] [Thread-12 ]: 76 of 88 OK created sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [[32mCREATE TABLE (0.0 rows, 172.5 GiB processed)[0m in 61.13s]
[0m15:56:23.390479 [debug] [Thread-12 ]: Finished running node model.project_dbt.V142_intermediated_payment_transactions
[0m15:56:28.664380 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c016796b5b0>]}
[0m15:56:28.666310 [info ] [Thread-13 ]: 83 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP ................... [[32mCREATE TABLE (998.3k rows, 85.6 GiB processed)[0m in 43.34s]
[0m15:56:28.668019 [debug] [Thread-13 ]: Finished running node model.project_dbt.PCP
[0m15:56:28.669730 [debug] [Thread-15 ]: Began running node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m15:56:28.671257 [info ] [Thread-15 ]: 86 of 88 START sql incremental model dev_dm_pst3_BE.PCP_MERCHANT_ACCT_TRX ...... [RUN]
[0m15:56:28.672544 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.ZVS41_Outbound_credit_transfers, now model.project_dbt.PCP_MERCHANT_ACCT_TRX)
[0m15:56:28.673784 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m15:56:28.686209 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m15:56:28.687807 [debug] [Thread-15 ]: Began executing node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m15:56:28.691724 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m15:56:29.296609 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m15:56:29.298396 [debug] [Thread-15 ]: On model.project_dbt.PCP_MERCHANT_ACCT_TRX: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX`
      
    
    

    OPTIONS()
    as (
      WITH pre AS(
  SELECT
      pcp.PRODUCT,
      pcp.TRANSACTION_PUBLIC_IDENTIFIER,
      pcp.PAYERCOUNTRY,
      pcp.MERCHANTCOUNTRY,
      pcp.AMOUNT,
      pcp.CURRENCY,
      pcp.MERCHANT_PUBLIC_IDENTIFIER,
      IF(ocs.companyid_tobeexcluded IS NULL, "BE", ocs.to_be_reported_in_country) AS TO_BE_REPORTED_IN_COUNTRY,
      CASE
          WHEN pcp.PRODUCT = 'BANCONTACT_COLLECT' THEN pcp.PAYERCOUNTRY
          WHEN pcp.CARD_NETWORK = 'MASTERCARD' THEN pcp.CARD_COUNTRY
          WHEN pcp.CARD_NETWORK = 'VISA' THEN pcp.CARD_COUNTRY
          ELSE "no match"
      END AS COUNTERPARTY_AREA,
      pcp.MERCHANTCOUNTRY AS POS_LOCATION,
      pcp.CARDFUNCTION,
      pcp.singleWIP AS WIP_TRANSACTION,
      Case
        WHEN PCP.PRODUCT = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND PCP.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND pcp.CARD_NETWORK = 'VISA' THEN 'Visa'
      END AS CARD_NETWORK,
      pcp.SCA_REASON,
      '2000' AS INTTN_CHNNL,
      'R' AS RMT_INTTN,
      'PCS_ALL' AS PYMNT_SCHM,
      '_Z' AS FRD_TYP,
      pcp.LOAD_TIMESTAMP,
      pcp.PERIOD,
      pcp.Period_begin_date,
      pcp.Period_end_date,
  FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP` AS pcp
  LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS` as ocs
    ON ocs.companyid_tobeexcluded = pcp.TRANSACTION_PUBLIC_IDENTIFIER
  ),
  code as(
  SELECT pre.*,
   IF(pre.TO_BE_REPORTED_IN_COUNTRY = pre.COUNTERPARTY_AREA,
        'W2',
        pre.COUNTERPARTY_AREA) AS AREA_CODE,
    IF( pre.TO_BE_REPORTED_IN_COUNTRY = pre.POS_LOCATION,
        'W2',
        pre.POS_LOCATION) AS LOCATION_CODE,
    CASE pre.CARDFUNCTION
      WHEN 'Debit' THEN '11'
      WHEN 'Credit' THEN '13'
      WHEN 'Deferred Debit' THEN '12'
      ELSE '_Z'
    END AS CRD_FNCTN,
  FROM pre
)
SELECT
   code.*EXCEPT(AREA_CODE,LOCATION_CODE,LOAD_TIMESTAMP,PERIOD),
  COALESCE(pst3_cp.CODE, 'Extra EEA')  AS COUNT_AREA,
  COALESCE(pst3_pos.CODE, 'Extra EEA') AS TRMNL_LCTN,
  pst3_sca.CODE AS SCA,
  LOAD_TIMESTAMP,
  PERIOD,
FROM code
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_cp
    ON code.AREA_CODE = pst3_cp.CODE
    AND pst3_cp.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_pos
    ON code.LOCATION_CODE = pst3_pos.CODE
    AND pst3_pos.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_sca
    ON code.SCA_REASON = pst3_sca.name
    AND pst3_sca.TYPE = 'Strong customer authentication (SCA)'
    );
  
[0m15:56:29.984903 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8cfd908a-0f30-4b09-b35c-d94cfa188c5b&page=queryresults
[0m15:56:41.290792 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0142b61000>]}
[0m15:56:41.292451 [info ] [Thread-15 ]: 86 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_MERCHANT_ACCT_TRX . [[32mCREATE TABLE (998.3k rows, 187.6 MiB processed)[0m in 12.62s]
[0m15:56:41.294041 [debug] [Thread-15 ]: Finished running node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m15:56:41.295719 [debug] [Thread-1 (]: Began running node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m15:56:41.297105 [debug] [Thread-2 (]: Began running node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m15:56:41.298713 [info ] [Thread-1 (]: 87 of 88 START sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_CARD ...... [RUN]
[0m15:56:41.300285 [info ] [Thread-2 (]: 88 of 88 START sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_SCA ....... [RUN]
[0m15:56:41.301538 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals, now model.project_dbt.PCP_BREAKDOWN_BY_CARD)
[0m15:56:41.302620 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1110_payment_initiation_services, now model.project_dbt.PCP_BREAKDOWN_BY_SCA)
[0m15:56:41.303679 [debug] [Thread-1 (]: Began compiling node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m15:56:41.304832 [debug] [Thread-2 (]: Began compiling node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m15:56:41.314014 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.PCP_BREAKDOWN_BY_CARD"
[0m15:56:41.319203 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.PCP_BREAKDOWN_BY_SCA"
[0m15:56:41.320880 [debug] [Thread-1 (]: Began executing node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m15:56:41.321741 [debug] [Thread-2 (]: Began executing node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m15:56:41.324450 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:56:41.327679 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:56:41.998365 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.PCP_BREAKDOWN_BY_SCA"
[0m15:56:42.001290 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.PCP_BREAKDOWN_BY_CARD"
[0m15:56:42.002959 [debug] [Thread-2 (]: On model.project_dbt.PCP_BREAKDOWN_BY_SCA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_BREAKDOWN_BY_SCA`
      
    
    

    OPTIONS()
    as (
      SELECT
    ma.COUNT_AREA,
    ma.TRMNL_LCTN,
    ma.INTTN_CHNNL,
    ma.RMT_INTTN,
    ma.PYMNT_SCHM,
    ma.SCA,
    ma.FRD_TYP,
    COUNT(ma.TRANSACTION_PUBLIC_IDENTIFIER) AS COUNT_OF_TRANSACTION_PUBLIC_IDENTIFIER,
    SUM(ma.AMOUNT) AS SUM_OF_AMOUNT,
    ma.Period,
    ma.Period_begin_date,
    ma.Period_end_date,
    ma.LOAD_TIMESTAMP,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX` as ma
GROUP BY 1,2,3,4,5,6,7,10,11,12,13
    );
  
[0m15:56:42.004297 [debug] [Thread-1 (]: On model.project_dbt.PCP_BREAKDOWN_BY_CARD: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_BREAKDOWN_BY_CARD`
      
    
    

    OPTIONS()
    as (
      SELECT
    ma.COUNT_AREA,
    ma.TRMNL_LCTN,
    ma.INTTN_CHNNL,
    ma.RMT_INTTN,
    ma.PYMNT_SCHM,
    ma.CRD_FNCTN AS CRD_FCTN,
    ma.FRD_TYP,
    COUNT(ma.TRANSACTION_PUBLIC_IDENTIFIER) AS COUNT_OF_TRANSACTION_PUBLIC_IDENTIFIER,
    SUM(ma.AMOUNT) AS SUM_OF_AMOUNT,
    ma.Period,
    ma.Period_begin_date,
    ma.Period_end_date,
    ma.LOAD_TIMESTAMP,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX` as ma
GROUP BY 1,2,3,4,5,6,7,10,11,12,13
    );
  
[0m15:56:42.614734 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:52677b64-5914-4e04-850a-27122ee95f16&page=queryresults
[0m15:56:42.731365 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8a521622-721f-4789-ad9e-1600fc5dafbb&page=queryresults
[0m15:56:45.642203 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c70610>]}
[0m15:56:45.644095 [info ] [Thread-2 (]: 88 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_SCA .. [[32mCREATE TABLE (73.0 rows, 116.1 MiB processed)[0m in 4.34s]
[0m15:56:45.645923 [debug] [Thread-2 (]: Finished running node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m15:56:45.812051 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143c701c0>]}
[0m15:56:45.813690 [info ] [Thread-1 (]: 87 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_CARD . [[32mCREATE TABLE (113.0 rows, 115.1 MiB processed)[0m in 4.51s]
[0m15:56:45.815242 [debug] [Thread-1 (]: Finished running node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m15:59:59.521488 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b10f2185-c6b9-4e5b-98c8-032add8d1a7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0143dd5f00>]}
[0m15:59:59.523287 [info ] [Thread-3 (]: 3 of 88 OK created sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS  [[32mCREATE TABLE (4.0 rows, 11.6 GiB processed)[0m in 346.56s]
[0m15:59:59.524914 [debug] [Thread-3 (]: Finished running node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m15:59:59.528591 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:59:59.529675 [debug] [MainThread]: Connection 'model.project_dbt.PIS' was properly closed.
[0m15:59:59.531059 [debug] [MainThread]: Connection 'model.project_dbt.PAY_TROP_5845_PIS' was properly closed.
[0m15:59:59.532292 [debug] [MainThread]: Connection 'model.project_dbt.Cross_join' was properly closed.
[0m15:59:59.532798 [debug] [MainThread]: Connection 'model.project_dbt.PCP_BREAKDOWN_BY_SCA' was properly closed.
[0m15:59:59.533030 [debug] [MainThread]: Connection 'model.project_dbt.V140_SEPA_R_transactions' was properly closed.
[0m15:59:59.533257 [debug] [MainThread]: Connection 'model.project_dbt.ZVS9_PCT' was properly closed.
[0m15:59:59.533491 [debug] [MainThread]: Connection 'model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS' was properly closed.
[0m15:59:59.533716 [debug] [MainThread]: Connection 'model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs' was properly closed.
[0m15:59:59.533939 [debug] [MainThread]: Connection 'model.project_dbt.V1222_stock_of_accessed_accounts' was properly closed.
[0m15:59:59.534159 [debug] [MainThread]: Connection 'model.project_dbt.V142_intermediated_payment_transactions' was properly closed.
[0m15:59:59.534377 [debug] [MainThread]: Connection 'model.project_dbt.PCP_BREAKDOWN_BY_CARD' was properly closed.
[0m15:59:59.534626 [debug] [MainThread]: Connection 'model.project_dbt.PCP' was properly closed.
[0m15:59:59.534866 [debug] [MainThread]: Connection 'model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP' was properly closed.
[0m15:59:59.535085 [debug] [MainThread]: Connection 'model.project_dbt.PAY_TRRT_5845' was properly closed.
[0m15:59:59.535302 [debug] [MainThread]: Connection 'model.project_dbt.PCP_MERCHANT_ACCT_TRX' was properly closed.
[0m15:59:59.535527 [debug] [MainThread]: Connection 'model.project_dbt.PAY_TROP_5845' was properly closed.
[0m15:59:59.536013 [info ] [MainThread]: 
[0m15:59:59.536318 [info ] [MainThread]: Finished running 88 incremental models in 0 hours 5 minutes and 49.34 seconds (349.34s).
[0m15:59:59.545634 [debug] [MainThread]: Command end result
[0m15:59:59.656075 [info ] [MainThread]: 
[0m15:59:59.656600 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:59:59.656978 [info ] [MainThread]: 
[0m15:59:59.657272 [info ] [MainThread]: Done. PASS=88 WARN=0 ERROR=0 SKIP=0 TOTAL=88
[0m15:59:59.658171 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 352.71957, "process_user_time": 11.142305, "process_kernel_time": 0.375617, "process_mem_max_rss": "237296", "process_out_blocks": "16888", "process_in_blocks": "0"}
[0m15:59:59.658666 [debug] [MainThread]: Command `dbt run` succeeded at 15:59:59.658594 after 352.72 seconds
[0m15:59:59.658984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0167d094e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c01439c83d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0167fa8610>]}
[0m15:59:59.659303 [debug] [MainThread]: Flushing usage events
[0m10:29:29.866510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728392358250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7283926ee110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7283926ef790>]}


============================== 10:29:29.868400 | 42fc2e2f-aad9-46b5-9ac6-71044a83c448 ==============================
[0m10:29:29.868400 [info ] [MainThread]: Running with dbt=1.8.7
[0m10:29:29.868836 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/home/hkhnhan/BTX/dbt/logs', 'profiles_dir': '/home/hkhnhan/BTX/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --full-refresh --select PST3', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:29:30.420607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728391d38460>]}
[0m10:29:30.456880 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728391d215a0>]}
[0m10:29:30.457384 [info ] [MainThread]: Registered adapter: bigquery=1.8.2
[0m10:29:30.477903 [debug] [MainThread]: checksum: 4af21dafb485259c48497ac86b711ddb1982f3d0f1c0ca4e09356de488b753c0, vars: {}, profile: , target: , version: 1.8.7
[0m10:29:30.566233 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m10:29:30.566662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728391698eb0>]}
[0m10:29:32.793598 [warn ] [MainThread]: [[33mWARNING[0m]: Found spaces in the name of
`model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs`
[0m10:29:32.794242 [warn ] [MainThread]: [[33mWARNING[0m]: Spaces found in 1 resource name(s). This is deprecated, and
may lead to errors when using dbt. For more information: https://docs.getdbt.com
/reference/global-configs/legacy-behaviors#require_resource_names_without_spaces
Run again with `--debug` to see them all.
[0m10:29:32.794589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836deeec80>]}
[0m10:29:32.800685 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.project_dbt.STRH.mart
[0m10:29:32.885812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e15a020>]}
[0m10:29:33.037821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e0d3b20>]}
[0m10:29:33.038370 [info ] [MainThread]: Found 185 models, 126 sources, 613 macros
[0m10:29:33.038750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e0d1a20>]}
[0m10:29:33.044781 [info ] [MainThread]: 
[0m10:29:33.045316 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:29:33.053445 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.053983 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.054319 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.054787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.055109 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.055820 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.056259 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.056547 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.057428 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.057794 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.059363 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.059690 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.060106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.060526 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:29:33.061022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.063109 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.064470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:33.065550 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:37.952910 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_ES)
[0m10:29:37.953500 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.954059 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_FR)
[0m10:29:37.955659 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.957009 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_staging_view_cmd)
[0m10:29:37.957457 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.958593 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_BE)
[0m10:29:37.959145 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.959496 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dwh_view_cmd)
[0m10:29:37.959963 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_IT)
[0m10:29:37.961133 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_PT)
[0m10:29:37.961517 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.961830 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_NL)
[0m10:29:37.962226 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.962572 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dl_h3_hklc)
[0m10:29:37.962971 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.963261 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk'
[0m10:29:37.964409 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dl_h3_hehe'
[0m10:29:37.964682 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.965077 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_LU'
[0m10:29:37.966093 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_DE'
[0m10:29:37.966392 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:29:37.966839 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_LV'
[0m10:29:37.967856 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:37.968189 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:37.969116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:37.969458 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:37.970450 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:29:38.658477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728390c63490>]}
[0m10:29:38.659025 [info ] [MainThread]: Concurrency: 16 threads (target='dev')
[0m10:29:38.659365 [info ] [MainThread]: 
[0m10:29:38.662615 [debug] [Thread-1 (]: Began running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:29:38.663102 [debug] [Thread-2 (]: Began running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:29:38.663574 [debug] [Thread-3 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:29:38.664218 [info ] [Thread-1 (]: 1 of 88 START sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ........ [RUN]
[0m10:29:38.664731 [debug] [Thread-4 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:29:38.665601 [debug] [Thread-5 (]: Began running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:29:38.666020 [debug] [Thread-6 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:29:38.668289 [debug] [Thread-7 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:29:38.667446 [info ] [Thread-2 (]: 2 of 88 START sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS . [RUN]
[0m10:29:38.669126 [debug] [Thread-8 (]: Began running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:29:38.669836 [debug] [Thread-9 (]: Began running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:29:38.670525 [debug] [Thread-10 ]: Began running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:29:38.671308 [debug] [Thread-11 ]: Began running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:29:38.672054 [info ] [Thread-3 (]: 3 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS  [RUN]
[0m10:29:38.672449 [debug] [Thread-12 ]: Began running node model.project_dbt.A1_Number_of_payment_accounts
[0m10:29:38.672783 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_PT, now model.project_dbt.52505_NR_OF_ACCOUNTS)
[0m10:29:38.673172 [debug] [Thread-13 ]: Began running node model.project_dbt.Banque_en_ligne
[0m10:29:38.673628 [debug] [Thread-14 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:29:38.674440 [debug] [Thread-15 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:29:38.674049 [info ] [Thread-4 (]: 4 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [RUN]
[0m10:29:38.675200 [debug] [Thread-16 ]: Began running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:29:38.675628 [info ] [Thread-5 (]: 5 of 88 START sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [RUN]
[0m10:29:38.676105 [info ] [Thread-6 (]: 6 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [RUN]
[0m10:29:38.676567 [info ] [Thread-7 (]: 7 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [RUN]
[0m10:29:38.676974 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_DE, now model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS)
[0m10:29:38.677679 [info ] [Thread-8 (]: 8 of 88 START sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS ... [RUN]
[0m10:29:38.678189 [info ] [Thread-9 (]: 9 of 88 START sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT . [RUN]
[0m10:29:38.678688 [info ] [Thread-10 ]: 10 of 88 START sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [RUN]
[0m10:29:38.679407 [info ] [Thread-11 ]: 11 of 88 START sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [RUN]
[0m10:29:38.679876 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_FR, now model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS)
[0m10:29:38.680471 [info ] [Thread-12 ]: 12 of 88 START sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [RUN]
[0m10:29:38.681020 [debug] [Thread-1 (]: Began compiling node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:29:38.681664 [info ] [Thread-13 ]: 13 of 88 START sql incremental model dev_dm_pst3_FR.Banque_en_ligne ............ [RUN]
[0m10:29:38.682412 [info ] [Thread-14 ]: 14 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [RUN]
[0m10:29:38.683227 [info ] [Thread-15 ]: 15 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [RUN]
[0m10:29:38.684031 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_NL, now model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS)
[0m10:29:38.684618 [info ] [Thread-16 ]: 16 of 88 START sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [RUN]
[0m10:29:38.685146 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dwh_view_cmd, now model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS)
[0m10:29:38.685595 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_ES, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN)
[0m10:29:38.685999 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_IT, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK)
[0m10:29:38.686393 [debug] [Thread-2 (]: Began compiling node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:29:38.686710 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_staging_view_cmd, now model.project_dbt.58746_PAYMENT_INITIATIONS)
[0m10:29:38.687002 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_BE, now model.project_dbt.58788_AIS_USERS_AND_ACCOUNT)
[0m10:29:38.687293 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hklc, now model.project_dbt.58789_AIS_USERS_AND_ACCOUNT)
[0m10:29:38.687616 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk, now model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs)
[0m10:29:38.687943 [debug] [Thread-3 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:29:38.688265 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hehe, now model.project_dbt.A1_Number_of_payment_accounts)
[0m10:29:38.698005 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m10:29:38.699414 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LU, now model.project_dbt.Banque_en_ligne)
[0m10:29:38.700393 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LV, now model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI)
[0m10:29:38.701254 [debug] [Thread-15 ]: Acquiring new bigquery connection 'model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU'
[0m10:29:38.702015 [debug] [Thread-4 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:29:38.702714 [debug] [Thread-16 ]: Acquiring new bigquery connection 'model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo'
[0m10:29:38.703176 [debug] [Thread-5 (]: Began compiling node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:29:38.703671 [debug] [Thread-6 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:29:38.704052 [debug] [Thread-7 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:29:38.707945 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m10:29:38.708388 [debug] [Thread-8 (]: Began compiling node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:29:38.708908 [debug] [Thread-9 (]: Began compiling node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:29:38.709363 [debug] [Thread-10 ]: Began compiling node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:29:38.709754 [debug] [Thread-11 ]: Began compiling node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:29:38.714823 [debug] [Thread-3 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m10:29:38.715267 [debug] [Thread-12 ]: Began compiling node model.project_dbt.A1_Number_of_payment_accounts
[0m10:29:38.715730 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Banque_en_ligne
[0m10:29:38.716127 [debug] [Thread-1 (]: Began executing node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:29:38.716487 [debug] [Thread-14 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:29:38.716839 [debug] [Thread-15 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:29:38.722772 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m10:29:38.723216 [debug] [Thread-16 ]: Began compiling node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:29:38.726944 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m10:29:38.731050 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m10:29:38.734324 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m10:29:38.739532 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m10:29:38.740006 [debug] [Thread-2 (]: Began executing node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:29:38.744539 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m10:29:38.749610 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m10:29:38.752679 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m10:29:38.756109 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m10:29:38.756530 [debug] [Thread-3 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:29:38.759715 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Banque_en_ligne"
[0m10:29:38.779652 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m10:29:38.787843 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:29:38.791830 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m10:29:38.795844 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m10:29:38.796399 [debug] [Thread-4 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:29:38.796989 [debug] [Thread-5 (]: Began executing node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:29:38.797492 [debug] [Thread-6 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:29:38.799919 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:29:38.800414 [debug] [Thread-8 (]: Began executing node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:29:38.800841 [debug] [Thread-7 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:29:38.801329 [debug] [Thread-9 (]: Began executing node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:29:38.801640 [debug] [Thread-10 ]: Began executing node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:29:38.803970 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m10:29:38.804444 [debug] [Thread-11 ]: Began executing node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:29:38.804952 [debug] [Thread-12 ]: Began executing node model.project_dbt.A1_Number_of_payment_accounts
[0m10:29:38.805996 [debug] [Thread-13 ]: Began executing node model.project_dbt.Banque_en_ligne
[0m10:29:38.806929 [debug] [Thread-14 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:29:38.807551 [debug] [Thread-15 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:29:38.810543 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:29:38.810988 [debug] [Thread-16 ]: Began executing node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:29:38.813376 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:29:38.815496 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:29:38.818529 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:29:38.820793 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:29:38.823422 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:29:38.825494 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:29:38.828416 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:29:38.830490 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:29:38.832574 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:29:38.835090 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:29:38.837284 [debug] [Thread-15 ]: Opening a new connection, currently in state init
[0m10:29:38.840979 [debug] [Thread-16 ]: Opening a new connection, currently in state init
[0m10:29:39.448695 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m10:29:39.451320 [debug] [Thread-3 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m10:29:39.452096 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m10:29:39.453101 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m10:29:39.453952 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m10:29:39.454808 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m10:29:39.455885 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m10:29:39.456983 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m10:29:39.457802 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m10:29:39.458214 [debug] [Thread-1 (]: On model.project_dbt.52505_NR_OF_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52505_NR_OF_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
    IF(FAB.BALANCE_AMOUNT <= 100,'small balance', 'big balance') AS balance_size,
    iacc.account_currency,
    count(*) AS amount,
    ceil(sum (FAB.BALANCE_AMOUNT)) as booked_balance,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
WHERE
      iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND  (
    iacc.ACCOUNT_STATUS = 'OPEN'
    OR (
      iacc.ACCOUNT_STATUS = 'CLOSED'
      AND iacc.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  )
  AND iacc.ACCOUNT_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND FAB.BALANCE_DATE = (
      SELECT max(BALANCE_DATE)
      FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
      JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT`  a
        ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  )
group by 1,2
    );
  
[0m10:29:39.459128 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m10:29:39.460039 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m10:29:39.460862 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m10:29:39.461242 [debug] [Thread-2 (]: On model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52525_FLOW_OF_NEW_CONTRACTS`
      
    
    

    OPTIONS()
    as (
      select
  count(*) AS number_of_new_contracts,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
WHERE
  iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m10:29:39.461856 [debug] [Thread-3 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as (
  SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
  case when FAB.BALANCE_AMOUNT < 12500 then '66'
        when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
        when FAB.BALANCE_AMOUNT > 50000 then '89'
  end balance_class,
  FAT.TRANSACTION_AMOUNT AS amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
    on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
      AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND  FAB.BALANCE_DATE = (
        SELECT max(max.BALANCE_DATE)
        FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
        JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
          ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
        )
  ),
cmd as (
  SELECT
        P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
        L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
        L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
        --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
    WHERE
            LPR.ROLE = 'ACCOUNT_HOLDER'
      -- AND  ba.main is true ==> to add by CMD team (dragos)
      and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
)
SELECT * FROM credit_transfers
inner join cmd
on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m10:29:39.462501 [debug] [Thread-8 (]: On model.project_dbt.58746_PAYMENT_INITIATIONS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58746_PAYMENT_INITIATIONS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IF(credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '1','2') as residency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE as counterparty_country,
  IF(IT.INBOUND_TRANSACTION_CURRENCY_CODE = 'EUR', '1','2') as currencyType,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
      APP.APPLICATION_NAME = 'PAY-PXG-BANQUPIT'
      OR (
          APP.APPLICATION_NAME = 'PAY-PXG-OCS'
          AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
          AND substr( credacc.BANK_ACCOUNT_NUMBER,5,5)= '36330'
         )
      )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m10:29:39.463030 [debug] [Thread-4 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as
  (
  SELECT
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'WITH TRADITIONAL MODES'
        WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'WITH AUTOMATED MODES'
    END Entrymode,
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER', 'TPP','OCS') THEN 'Single entry'
        WHEN FAT.TRANSACTION_CHANNEL in ('H2H') THEN 'Batch entry'
    END BatchMode,
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    case when FAB.BALANCE_AMOUNT < 12500 then '66'
          when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
          when FAB.BALANCE_AMOUNT > 50000 then '89'
    end balance_class,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

    FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
      ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
      ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
      ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
      ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
      ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
      AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND  FAB.BALANCE_DATE =
      (
          SELECT max(max.BALANCE_DATE)
          FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
          JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
            ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
          WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  ),
  cmd as (
    SELECT
          P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
          L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
          L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
          --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
      FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR
      on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L
      on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
      WHERE
              LPR.ROLE = 'ACCOUNT_HOLDER'
        -- AND  ba.main is true ==> to add by CMD team (dragos)
        and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
  )
  SELECT * FROM credit_transfers
  inner join cmd
  on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m10:29:39.463644 [debug] [Thread-11 ]: On model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A11_Number_of_payment_accounts_accessed_by_AISPs`
      
    
    

    OPTIONS()
    as (
      SELECT *,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` t
WHERE t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
AND SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
AND T_LOAD_TIMESTAMP is not null
    );
  
[0m10:29:39.464143 [debug] [Thread-5 (]: On model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58724_CREDIT_TRANSFERS_SINGLE_BASIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
    AND FAT.TRANSACTION_CHANNEL not in ('H2H')
    );
  
[0m10:29:39.464607 [debug] [Thread-7 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK`
      
    
    

    OPTIONS()
    as (
      SELECT
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  ON C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
WHERE D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND D.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND D.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m10:29:39.465948 [debug] [Thread-9 (]: On model.project_dbt.58788_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58788_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
SELECT
  '86' as CountryOfAISP,
  ac.USER_TOKEN,
  COUNT(*) AS number_of_consents,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
 inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
        OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
GROUP BY
            CountryOfAISP,
            ac.USER_TOKEN
)
SELECT
CountryOfAISP,
COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
FROM obsolete_and_active_consents_count_in_reporting_period
GROUP BY CountryOfAISP
order by CountryOfAISP asc
    );
  
[0m10:29:39.466645 [debug] [Thread-6 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'report in 58726 02&04'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      ELSE 'check the query'
  END metricToBeReported,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'N/A'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then '413'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '415'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
  END SCAIndicator,
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  '396' as pisp,
  IF(SUBSTR(CBA.BANK_ACCOUNT_NUMBER,5,5) = '36330' and CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '398','396') AS scheme,
  count(*) AS count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as Amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  group by 1,2,3,4,5
    );
  
[0m10:29:39.467177 [debug] [Thread-10 ]: On model.project_dbt.58789_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58789_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      SELECT
  '86' as CountryOfAISP,
  pa.T_SOURCE_PK_ID as account_id,
  COUNT(*) AS number_of_consents,
  COUNT(DISTINCT pa.T_SOURCE_PK_ID) AS unique_accounts_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
  AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
  AND (
    (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
    OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
  )
GROUP BY account_id
    );
  
[0m10:29:39.468903 [debug] [Thread-12 ]: On model.project_dbt.A1_Number_of_payment_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A1_Number_of_payment_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) as Count,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      )
    )
  and IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:29:39.480928 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m10:29:39.481458 [debug] [Thread-15 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  deb.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
  COUNT(*) AS inbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS inbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
  AND ftr.transaction_type  = 'REGULAR'
GROUP BY deb.FINANCIAL_INSTITUTION_COUNTRY_CODE
ORDER BY payer_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(inbound_ibis_payments_trx_count) FROM DM WHERE payer_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(inbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payer_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payer_psp_country
    );
  
[0m10:29:39.487939 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Banque_en_ligne"
[0m10:29:39.488430 [debug] [Thread-13 ]: On model.project_dbt.Banque_en_ligne: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Banque_en_ligne`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT( distinct ibis.ACCOUNT_MASTER_DATA_ID) AS count,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON bank.T_DIM_KEY = ibis.T_D_BANK_ACCOUNT_DIM_KEY
WHERE ibis.ACCOUNT_TYPE = "PAYMENT"
AND (ibis.ACCOUNT_STATUS = 'OPEN'
  OR
    (
      ibis.ACCOUNT_STATUS = 'CLOSED'
      AND ibis.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
)
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')))
AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND ibis.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')
    );
  
[0m10:29:39.509654 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m10:29:39.511342 [debug] [Thread-16 ]: On model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  case WHEN ftr.TRANSACTION_CHANNEL IN ('TPP') THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN ftr.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
    END SCAIndicator,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:29:39.528035 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m10:29:39.529772 [debug] [Thread-14 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type  = 'REGULAR'
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
  ORDER BY payee_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:29:40.116736 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e1766476-277d-4256-99ad-b6467166a162&page=queryresults
[0m10:29:40.219450 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3e3e39ac-b272-4e74-bc22-82fee56a59c0&page=queryresults
[0m10:29:40.386049 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:39a13276-e59b-490e-aaa9-b461e956ca82&page=queryresults
[0m10:29:40.390705 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:6fc85538-32a9-42eb-8670-8a168e0094e1&page=queryresults
[0m10:29:40.396792 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2776cf34-9080-4022-a106-53dc8b075b22&page=queryresults
[0m10:29:40.399190 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:20fc2814-54c4-42c9-82ee-7982f75148ba&page=queryresults
[0m10:29:40.400591 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:46aca6c8-971d-4179-bc16-8ddab459df25&page=queryresults
[0m10:29:40.408128 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:be86ea09-fba6-42c0-bb27-8b7b3a02dafe&page=queryresults
[0m10:29:40.409252 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d0ce8760-0cde-4161-b6b6-634816049111&page=queryresults
[0m10:29:40.409743 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:999eed13-a2be-41e1-a681-a4496f016cbf&page=queryresults
[0m10:29:40.410727 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:370419be-cc82-4a98-861c-3edc7229e3e7&page=queryresults
[0m10:29:40.411224 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:437258ae-9850-4b12-bef7-64e1e1d4e527&page=queryresults
[0m10:29:40.411687 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:55cf885d-46c4-4a8d-8a27-5d251fb45f0b&page=queryresults
[0m10:29:40.416720 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7c1568f6-4b69-46e4-9cc8-d5c7a067484f&page=queryresults
[0m10:29:40.426006 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7275629b-934d-45ec-b3a6-057b2d497109&page=queryresults
[0m10:29:40.430033 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c8071138-a95e-439b-a130-4b58b0b8d22c&page=queryresults
[0m10:29:42.600627 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836eebe7a0>]}
[0m10:29:42.601247 [info ] [Thread-2 (]: 2 of 88 OK created sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS  [[32mCREATE TABLE (1.0 rows, 87.2 KiB processed)[0m in 3.92s]
[0m10:29:42.601804 [debug] [Thread-2 (]: Finished running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:29:42.602214 [debug] [Thread-2 (]: Began running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:29:42.602777 [info ] [Thread-2 (]: 17 of 88 START sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [RUN]
[0m10:29:42.603223 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS, now model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo)
[0m10:29:42.603554 [debug] [Thread-2 (]: Began compiling node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:29:42.610434 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m10:29:42.610913 [debug] [Thread-2 (]: Began executing node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:29:42.617514 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:29:42.705556 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836df0b610>]}
[0m10:29:42.707294 [info ] [Thread-1 (]: 1 of 88 OK created sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ... [[32mCREATE TABLE (2.0 rows, 59.7 MiB processed)[0m in 4.03s]
[0m10:29:42.708967 [debug] [Thread-1 (]: Finished running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:29:42.710278 [debug] [Thread-1 (]: Began running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:29:42.711987 [info ] [Thread-1 (]: 18 of 88 START sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [RUN]
[0m10:29:42.713201 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.52505_NR_OF_ACCOUNTS, now model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo)
[0m10:29:42.714560 [debug] [Thread-1 (]: Began compiling node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:29:42.722205 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m10:29:42.722718 [debug] [Thread-1 (]: Began executing node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:29:42.725287 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:29:43.362116 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m10:29:43.364885 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m10:29:43.370369 [debug] [Thread-1 (]: On model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C7_agMoyPaiTypeOpeSystZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
  case WHEN  SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) = SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN 'ON-US'
    WHEN SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) <> SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN'OFF-US'
    ELSE 'not_mapped'
    END AS typeSysteme,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.transaction_type  = 'REGULAR'
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m10:29:43.373777 [debug] [Thread-2 (]: On model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
     'Banqup applications' as TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
     AND APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
     AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
          AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'
          )
     AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3

UNION ALL

SELECT
     'OCS application' AS TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
AND FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 4 DESC
    );
  
[0m10:29:43.417155 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836de5db40>]}
[0m10:29:43.418948 [info ] [Thread-7 (]: 7 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 4.73s]
[0m10:29:43.420619 [debug] [Thread-7 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:29:43.421821 [debug] [Thread-7 (]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:29:43.423135 [info ] [Thread-7 (]: 19 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [RUN]
[0m10:29:43.425372 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE)
[0m10:29:43.426596 [debug] [Thread-7 (]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:29:43.439711 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m10:29:43.440425 [debug] [Thread-7 (]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:29:43.443808 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:29:43.778344 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e0bc490>]}
[0m10:29:43.780226 [info ] [Thread-11 ]: 11 of 88 OK created sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 5.09s]
[0m10:29:43.780912 [debug] [Thread-11 ]: Finished running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:29:43.781297 [debug] [Thread-11 ]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:29:43.781672 [info ] [Thread-11 ]: 20 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [RUN]
[0m10:29:43.781977 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE)
[0m10:29:43.782344 [debug] [Thread-11 ]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:29:43.788005 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m10:29:43.788536 [debug] [Thread-11 ]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:29:43.791012 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:29:44.060036 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m10:29:44.061865 [debug] [Thread-7 (]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
  DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:29:44.386038 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:88297c8b-5155-4fb9-9ebb-887bb80e0059&page=queryresults
[0m10:29:44.390664 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f55581b2-385c-46a1-8814-5e6e61389566&page=queryresults
[0m10:29:44.397536 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e418f40>]}
[0m10:29:44.401288 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836df2a3b0>]}
[0m10:29:44.403660 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m10:29:44.405247 [info ] [Thread-10 ]: 10 of 88 OK created sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (2.0 rows, 5.0 GiB processed)[0m in 5.71s]
[0m10:29:44.407058 [info ] [Thread-9 (]: 9 of 88 OK created sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (1.0 rows, 5.0 GiB processed)[0m in 5.71s]
[0m10:29:44.408972 [debug] [Thread-10 ]: Finished running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:29:44.410662 [debug] [Thread-9 (]: Finished running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:29:44.412112 [debug] [Thread-11 ]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'

  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:29:44.413776 [debug] [Thread-10 ]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:29:44.415134 [debug] [Thread-9 (]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:29:44.418552 [info ] [Thread-10 ]: 21 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [RUN]
[0m10:29:44.420016 [info ] [Thread-9 (]: 22 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [RUN]
[0m10:29:44.421005 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.58789_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG)
[0m10:29:44.421833 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.58788_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP)
[0m10:29:44.422768 [debug] [Thread-10 ]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:29:44.423748 [debug] [Thread-9 (]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:29:44.433883 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m10:29:44.442336 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m10:29:44.443252 [debug] [Thread-9 (]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:29:44.443820 [debug] [Thread-10 ]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:29:44.448025 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:29:44.450477 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:29:44.966609 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:443af9a1-4180-48f4-af8c-68e119b8fa2d&page=queryresults
[0m10:29:45.051519 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7fa257b8-0869-4f67-801b-cd2ea00e10f1&page=queryresults
[0m10:29:45.091881 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m10:29:45.094107 [debug] [Thread-9 (]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
     d_access_consent_info.USER_EMAIL AS user_token,
     COUNT(DISTINCT(d_access_consent_info.USER_EMAIL)) OVER(PARTITION BY d_access_consent_info.USER_EMAIL) unique_users_count_in_period,
     COUNT(DISTINCT(d_access_consent_info.T_BUS_KEY)) OVER(PARTITION BY d_access_consent_info.T_BUS_KEY) number_of_consents,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS d_pxg_payment_account
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS d_financial_platforms
     ON d_pxg_payment_account.T_D_FINANCIAL_PLATFORM_DIM_KEY=d_financial_platforms.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS d_financial_institutions
     ON d_financial_institutions.T_DIM_KEY = d_financial_platforms.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` AS d_access_consent_info
     ON d_pxg_payment_account.T_DIM_KEY=d_access_consent_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS d_contract_info
     ON d_pxg_payment_account.T_DIM_KEY=d_contract_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS d_application_account_info
     ON d_contract_info.T_D_APPLICATION_ACCOUNT_DIM_KEY=d_application_account_info.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS d_applications
     ON d_application_account_info.T_D_APPLICATION_DIM_KEY = d_applications.T_DIM_KEY
WHERE  (
     d_applications.APPLICATION_NAME  = 'PAY-PXG-JEFACTURE'
     -- AND d_application_account_info.T_SOURCE_PK_ID not in ('8856', '4545', '4571', '5170', '5188', '5244', '5275', '5301',
     --                                                        '5343', '5411', '5422', '5443', '5495', '5511', '5560', '5593',
     --                                                        '5628', '5651', '5652', '5653', '5654', '5655', '5657', '5658',
     --                                                        '5659', '5660', '5661', '5662', '6315', '6354', '6745', '6922',
     --                                                        '6960', '7175', '7222', '7386', '7428', '7582', '7666', '7753', '7768'
     --                                                        )
     )
     AND d_financial_institutions.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND
     (
          (
          d_access_consent_info.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     OR
          (
          d_access_consent_info.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     )
    );
  
[0m10:29:45.139086 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dc23a30>]}
[0m10:29:45.140827 [info ] [Thread-12 ]: 12 of 88 OK created sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.45s]
[0m10:29:45.142518 [debug] [Thread-12 ]: Finished running node model.project_dbt.A1_Number_of_payment_accounts
[0m10:29:45.143808 [debug] [Thread-12 ]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:29:45.146555 [info ] [Thread-12 ]: 23 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [RUN]
[0m10:29:45.150300 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m10:29:45.151451 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.A1_Number_of_payment_accounts, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo)
[0m10:29:45.153061 [debug] [Thread-12 ]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:29:45.164697 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m10:29:45.165436 [debug] [Thread-10 ]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG`
      
    
    

    OPTIONS()
    as (
      SELECT
     COUNT(distinct c.consent_iban) AS COUNT,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM
     `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
          ON c.T_DIM_KEY = cc.T_DIM_KEY
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
          ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
     c.CONSENT_STATUS = 'VALID'
     AND LEFT(c.consent_iban, 2) = 'FR'
     AND c.CONSENT_TRANSACTION_ACCESS_ALLOWED IS TRUE
     AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     --AND  t.T_SOURCE_PK_ID <> '1'
     AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:29:45.166912 [debug] [Thread-12 ]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:29:45.169605 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:29:45.214819 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e2a4040>]}
[0m10:29:45.216531 [info ] [Thread-13 ]: 13 of 88 OK created sql incremental model dev_dm_pst3_FR.Banque_en_ligne ....... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.52s]
[0m10:29:45.218091 [debug] [Thread-13 ]: Finished running node model.project_dbt.Banque_en_ligne
[0m10:29:45.219301 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuadro1_accounts
[0m10:29:45.220814 [info ] [Thread-13 ]: 24 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ........... [RUN]
[0m10:29:45.222005 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Banque_en_ligne, now model.project_dbt.Cuadro1_accounts)
[0m10:29:45.222990 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuadro1_accounts
[0m10:29:45.230344 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_accounts"
[0m10:29:45.231242 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuadro1_accounts
[0m10:29:45.234608 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:29:45.816820 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m10:29:45.818960 [debug] [Thread-12 ]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    round(SUM(ftr.TRANSACTION_AMOUNT)) AS outbound_ibis_payments_amount_sum_in_EUR,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL not IN ('DASHBOARD', 'OTHER', 'CARDS')
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
group by cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
order by payee_psp_country ASC
    );
  
[0m10:29:45.844607 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_accounts"
[0m10:29:45.846674 [debug] [Thread-13 ]: On model.project_dbt.Cuadro1_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) AS number_of_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
 ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    )
    AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  )
    );
  
[0m10:29:45.949523 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3721009d-7cfc-412c-b63b-61b3c7269ad7&page=queryresults
[0m10:29:45.955573 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:412c3b1c-639c-40e6-9107-7e646a054b11&page=queryresults
[0m10:29:46.435203 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2f56d5f5-471b-4025-ad19-60e1093a7f4b&page=queryresults
[0m10:29:46.507043 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c6a9cf1a-ebbc-49b7-ae41-7c81fddff67c&page=queryresults
[0m10:29:48.897887 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dc9ebc0>]}
[0m10:29:48.899123 [info ] [Thread-10 ]: 21 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [[32mCREATE TABLE (1.0 rows, 1.2 GiB processed)[0m in 4.48s]
[0m10:29:48.899685 [debug] [Thread-10 ]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:29:48.900099 [debug] [Thread-10 ]: Began running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:29:48.900581 [info ] [Thread-10 ]: 25 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs . [RUN]
[0m10:29:48.900915 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG, now model.project_dbt.Cuadro1_number_of_AIS_PSUs)
[0m10:29:48.901286 [debug] [Thread-10 ]: Began compiling node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:29:48.906787 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m10:29:48.907266 [debug] [Thread-10 ]: Began executing node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:29:48.909582 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:29:49.380076 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dad7820>]}
[0m10:29:49.381944 [info ] [Thread-5 (]: 5 of 88 OK created sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [[32mCREATE TABLE (27.0 rows, 11.0 GiB processed)[0m in 10.69s]
[0m10:29:49.383584 [debug] [Thread-5 (]: Finished running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:29:49.384786 [debug] [Thread-5 (]: Began running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:29:49.386230 [info ] [Thread-5 (]: 26 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [RUN]
[0m10:29:49.387513 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS, now model.project_dbt.Cuadro9_Credit_transfers_sent)
[0m10:29:49.388680 [debug] [Thread-5 (]: Began compiling node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:29:49.399086 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m10:29:49.399662 [debug] [Thread-5 (]: Began executing node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:29:49.405022 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:29:49.629375 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m10:29:49.630068 [debug] [Thread-10 ]: On model.project_dbt.Cuadro1_number_of_AIS_PSUs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_number_of_AIS_PSUs`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPES')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        OR (
          ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  WHERE USER_TOKEN <>'NA'
    );
  
[0m10:29:50.130320 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m10:29:50.139418 [debug] [Thread-5 (]: On model.project_dbt.Cuadro9_Credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro9_Credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
  ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
  ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >=  TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <  TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    );
  
[0m10:29:50.235553 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836cff4070>]}
[0m10:29:50.237361 [info ] [Thread-4 (]: 4 of 88 OK created sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [[32mCREATE TABLE (27.0 rows, 11.5 GiB processed)[0m in 11.55s]
[0m10:29:50.238672 [debug] [Thread-4 (]: Finished running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:29:50.239099 [debug] [Thread-4 (]: Began running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:29:50.239504 [info ] [Thread-4 (]: 27 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [RUN]
[0m10:29:50.239886 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS, now model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts)
[0m10:29:50.240293 [debug] [Thread-4 (]: Began compiling node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:29:50.245127 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m10:29:50.245718 [debug] [Thread-4 (]: Began executing node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:29:50.248926 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:29:50.461043 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e54916b9-93e6-4465-81d9-6ea3a0210789&page=queryresults
[0m10:29:50.651979 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c338070>]}
[0m10:29:50.653640 [info ] [Thread-13 ]: 24 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ...... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 5.43s]
[0m10:29:50.655625 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuadro1_accounts
[0m10:29:50.657462 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuardro4_PIS
[0m10:29:50.659499 [info ] [Thread-13 ]: 28 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_PIS ............... [RUN]
[0m10:29:50.660654 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_accounts, now model.project_dbt.Cuardro4_PIS)
[0m10:29:50.661681 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuardro4_PIS
[0m10:29:50.677008 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_PIS"
[0m10:29:50.677994 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuardro4_PIS
[0m10:29:50.682797 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:29:50.776605 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:81eac44d-0b2d-4290-82d5-07f999f26083&page=queryresults
[0m10:29:50.829386 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m10:29:50.831416 [debug] [Thread-4 (]: On model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro1_number_of_AISPs_accessing_UPP_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
c.consent_iban,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  on c.T_DIM_KEY = cc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='ES'
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  and c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:29:51.285239 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_PIS"
[0m10:29:51.286959 [debug] [Thread-13 ]: On model.project_dbt.Cuardro4_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IT.INBOUND_TRANSACTION_CURRENCY_CODE as trx_currency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  as counterparty_country,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
      ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
      ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
      ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
      ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
      ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
      ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
      ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
      ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE  FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND ( APP.APPLICATION_NAME = 'PAY-PXG-BANQUPES'
          OR (
            APP.APPLICATION_NAME = 'PAY-PXG-OCS'
            AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  = 'ES'
            AND substr( credacc.BANK_ACCOUNT_NUMBER,5,4)= '6918'
            )
        )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1,2
    );
  
[0m10:29:51.422107 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e05eb90>]}
[0m10:29:51.424768 [info ] [Thread-14 ]: 14 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 12.72s]
[0m10:29:51.428639 [debug] [Thread-14 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:29:51.431079 [debug] [Thread-14 ]: Began running node model.project_dbt.Cuardro4_credit_transers_received
[0m10:29:51.436018 [info ] [Thread-14 ]: 29 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [RUN]
[0m10:29:51.437369 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI, now model.project_dbt.Cuardro4_credit_transers_received)
[0m10:29:51.438423 [debug] [Thread-14 ]: Began compiling node model.project_dbt.Cuardro4_credit_transers_received
[0m10:29:51.451159 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m10:29:51.452167 [debug] [Thread-14 ]: Began executing node model.project_dbt.Cuardro4_credit_transers_received
[0m10:29:51.455716 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:29:51.705810 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:aa5add9f-f160-488a-affa-7c62005a6085&page=queryresults
[0m10:29:52.045433 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m10:29:52.047247 [debug] [Thread-14 ]: On model.project_dbt.Cuardro4_credit_transers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  count(*)  as inbound_ibis_payments_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS inbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE (FAT.TRANSACTION_DIRECTION = "INBOUND")
    AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
    AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
    AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1
  ORDER BY 1
    );
  
[0m10:29:52.148517 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:00109277-4786-43db-a2aa-35bff598d94b&page=queryresults
[0m10:29:52.300322 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e05ead0>]}
[0m10:29:52.302055 [info ] [Thread-15 ]: 15 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 13.60s]
[0m10:29:52.303649 [debug] [Thread-15 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:29:52.304914 [debug] [Thread-15 ]: Began running node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:29:52.306407 [info ] [Thread-15 ]: 30 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [RUN]
[0m10:29:52.307424 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU, now model.project_dbt.Cuardro4_credit_transers_sent)
[0m10:29:52.308442 [debug] [Thread-15 ]: Began compiling node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:29:52.317975 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m10:29:52.318602 [debug] [Thread-15 ]: Began executing node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:29:52.322898 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:29:52.325943 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dcb0b50>]}
[0m10:29:52.326561 [info ] [Thread-6 (]: 6 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [[32mCREATE TABLE (1.0 rows, 21.8 GiB processed)[0m in 13.64s]
[0m10:29:52.327116 [debug] [Thread-6 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:29:52.327500 [debug] [Thread-6 (]: Began running node model.project_dbt.KMS_C
[0m10:29:52.327947 [info ] [Thread-6 (]: 31 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C ...................... [RUN]
[0m10:29:52.328269 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN, now model.project_dbt.KMS_C)
[0m10:29:52.328565 [debug] [Thread-6 (]: Began compiling node model.project_dbt.KMS_C
[0m10:29:52.334172 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.KMS_C"
[0m10:29:52.334706 [debug] [Thread-6 (]: Began executing node model.project_dbt.KMS_C
[0m10:29:52.337545 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:29:52.415586 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dcb0d90>]}
[0m10:29:52.417315 [info ] [Thread-16 ]: 16 of 88 OK created sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [[32mCREATE TABLE (31.0 rows, 46.7 GiB processed)[0m in 13.71s]
[0m10:29:52.418908 [debug] [Thread-16 ]: Finished running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:29:52.420109 [debug] [Thread-16 ]: Began running node model.project_dbt.KMS_C_non_euro_transactions
[0m10:29:52.421520 [info ] [Thread-16 ]: 32 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [RUN]
[0m10:29:52.422983 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo, now model.project_dbt.KMS_C_non_euro_transactions)
[0m10:29:52.424142 [debug] [Thread-16 ]: Began compiling node model.project_dbt.KMS_C_non_euro_transactions
[0m10:29:52.432488 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m10:29:52.433079 [debug] [Thread-16 ]: Began executing node model.project_dbt.KMS_C_non_euro_transactions
[0m10:29:52.435833 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:29:52.677756 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836da9b820>]}
[0m10:29:52.679562 [info ] [Thread-8 (]: 8 of 88 OK created sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS  [[32mCREATE TABLE (1.0 rows, 27.4 GiB processed)[0m in 13.99s]
[0m10:29:52.681224 [debug] [Thread-8 (]: Finished running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:29:52.682438 [debug] [Thread-8 (]: Began running node model.project_dbt.KMS_MRA
[0m10:29:52.683757 [info ] [Thread-8 (]: 33 of 88 START sql incremental model dev_dm_pst3_LV.KMS_MRA .................... [RUN]
[0m10:29:52.685227 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.58746_PAYMENT_INITIATIONS, now model.project_dbt.KMS_MRA)
[0m10:29:52.686446 [debug] [Thread-8 (]: Began compiling node model.project_dbt.KMS_MRA
[0m10:29:52.695008 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.KMS_MRA"
[0m10:29:52.695571 [debug] [Thread-8 (]: Began executing node model.project_dbt.KMS_MRA
[0m10:29:52.698121 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:29:52.881718 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:967ca61c-bc0e-4738-81f5-122c44372b17&page=queryresults
[0m10:29:52.945805 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.KMS_C"
[0m10:29:52.947614 [debug] [Thread-6 (]: On model.project_dbt.KMS_C: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
group by 1
    );
  
[0m10:29:52.955911 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m10:29:52.957457 [debug] [Thread-15 ]: On model.project_dbt.Cuardro4_credit_transers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN '211 Manual entry'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP','OCS','H2H' ) THEN '212 Electronic entry'
  END EntryMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS') THEN '2122 single '
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '2121 Batch entry'
  END BatchMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'NoSCA - 212333 Trusted Beneficiaries'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'NoSCA - 212335 secure processes'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      else 'check the query'
  END SCAIndicator,
  count (*) as outbound_ibis_payments_trx_count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE(FAT.TRANSACTION_DIRECTION = "OUTBOUND")
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m10:29:53.062144 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m10:29:53.063873 [debug] [Thread-16 ]: On model.project_dbt.KMS_C_non_euro_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C_non_euro_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_non_EUR_transactions,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_CURRENCY <> 'EUR'
AND TRANSACTION_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND TRANSACTION_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:29:53.398459 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.KMS_MRA"
[0m10:29:53.400164 [debug] [Thread-8 (]: On model.project_dbt.KMS_MRA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_MRA`
      
    
    

    OPTIONS()
    as (
      SELECT
  BA.BANK_ACCOUNT_NUMBER as large_biller_account,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_CURRENT` AS M
left JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON M.T_D_MRA_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
WHERE M.T_D_MRA_BANK_ACCOUNT_DIM_KEY is not null
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND MERCHANT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND MERCHANT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:29:53.736948 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d02c5f4b-2370-4f6f-90fb-40c422d104fc&page=queryresults
[0m10:29:53.769318 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7c93cd8f-cee1-41a1-bf9e-a1fc222c0ab9&page=queryresults
[0m10:29:54.008089 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:62ffa1c9-fe87-4dd9-96e7-8759803c86a9&page=queryresults
[0m10:29:54.009622 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1b1eec64-9eb2-4f20-b96e-605e2e834de6&page=queryresults
[0m10:29:54.537168 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e05dd20>]}
[0m10:29:54.539937 [info ] [Thread-4 (]: 27 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 4.30s]
[0m10:29:54.543983 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c364100>]}
[0m10:29:54.545966 [debug] [Thread-4 (]: Finished running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:29:54.547681 [info ] [Thread-9 (]: 22 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [[32mCREATE TABLE (44.4k rows, 14.9 GiB processed)[0m in 10.12s]
[0m10:29:54.549542 [debug] [Thread-4 (]: Began running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:29:54.551603 [debug] [Thread-9 (]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:29:54.553056 [info ] [Thread-4 (]: 34 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [RUN]
[0m10:29:54.554364 [debug] [Thread-9 (]: Began running node model.project_dbt.KMS_P17_PIS
[0m10:29:54.555483 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts, now model.project_dbt.KMS_P11_Outgoing_transactions)
[0m10:29:54.557035 [info ] [Thread-9 (]: 35 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ................ [RUN]
[0m10:29:54.558271 [debug] [Thread-4 (]: Began compiling node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:29:54.559401 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP, now model.project_dbt.KMS_P17_PIS)
[0m10:29:54.572327 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m10:29:54.572938 [debug] [Thread-9 (]: Began compiling node model.project_dbt.KMS_P17_PIS
[0m10:29:54.584151 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.KMS_P17_PIS"
[0m10:29:54.584679 [debug] [Thread-4 (]: Began executing node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:29:54.587393 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:29:54.587838 [debug] [Thread-9 (]: Began executing node model.project_dbt.KMS_P17_PIS
[0m10:29:54.592893 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:29:55.238166 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m10:29:55.241367 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.KMS_P17_PIS"
[0m10:29:55.243259 [debug] [Thread-9 (]: On model.project_dbt.KMS_P17_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P17_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLV'
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
 GROUP BY 1, 2, 3

UNION ALL

SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX72'
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 1,2 DESC
    );
  
[0m10:29:55.244713 [debug] [Thread-4 (]: On model.project_dbt.KMS_P11_Outgoing_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P11_Outgoing_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  group by 1
    );
  
[0m10:29:56.264654 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a8ad7879-155f-407f-a9e2-2705e3f73ff4&page=queryresults
[0m10:29:56.273900 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:809f4652-abd6-4cc8-b6e6-a624acbe4a24&page=queryresults
[0m10:29:56.769399 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e278820>]}
[0m10:29:56.773369 [info ] [Thread-12 ]: 23 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [[32mCREATE TABLE (8.0 rows, 11.0 GiB processed)[0m in 11.62s]
[0m10:29:56.775566 [debug] [Thread-12 ]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:29:56.776839 [debug] [Thread-12 ]: Began running node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:29:56.778421 [info ] [Thread-12 ]: 36 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [RUN]
[0m10:29:56.785407 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo, now model.project_dbt.KMS_P21_Inbound_transactions)
[0m10:29:56.786706 [debug] [Thread-12 ]: Began compiling node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:29:56.798721 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m10:29:56.799613 [debug] [Thread-12 ]: Began executing node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:29:56.802314 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:29:57.200028 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c783f70>]}
[0m10:29:57.500622 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m10:29:57.506105 [debug] [Thread-12 ]: On model.project_dbt.KMS_P21_Inbound_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P21_Inbound_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
   d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
   COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS inbound_ibis_payments_trx_count,
   COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS inbound_ibis_payment_amount_sum_in_EUR,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   '2024S1' AS PERIOD,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
 INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
 WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
     AND FAT.TRANSACTION_TYPE = 'REGULAR'
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
     AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
     AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
     AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
 group by 1
 order by 1
    );
  
[0m10:29:57.913279 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e418f40>]}
[0m10:29:58.307562 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5a0a5615-b4d0-498f-ba1b-04a01872b6d7&page=queryresults
[0m10:29:58.719680 [info ] [Thread-1 (]: 18 of 88 OK created sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [[32mCREATE TABLE (9.0 rows, 23.4 GiB processed)[0m in 14.49s]
[0m10:29:58.722759 [info ] [Thread-10 ]: 25 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs  [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 9.01s]
[0m10:29:58.724834 [debug] [Thread-1 (]: Finished running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:29:58.726945 [debug] [Thread-10 ]: Finished running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:29:58.731667 [debug] [Thread-1 (]: Began running node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:29:58.733404 [debug] [Thread-10 ]: Began running node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:29:58.735026 [info ] [Thread-1 (]: 37 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS ...... [RUN]
[0m10:29:58.736901 [info ] [Thread-10 ]: 38 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts . [RUN]
[0m10:29:58.738182 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo, now model.project_dbt.KMS_P6a_number_of_AIS)
[0m10:29:58.739324 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_number_of_AIS_PSUs, now model.project_dbt.KMS_P7a_number_of_accounts)
[0m10:29:58.740817 [debug] [Thread-1 (]: Began compiling node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:29:58.742181 [debug] [Thread-10 ]: Began compiling node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:29:58.756360 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m10:29:58.760658 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m10:29:58.761716 [debug] [Thread-1 (]: Began executing node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:29:58.765621 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:29:58.767339 [debug] [Thread-10 ]: Began executing node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:29:58.769780 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:29:59.437140 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m10:29:59.438638 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m10:29:59.439628 [debug] [Thread-1 (]: On model.project_dbt.KMS_P6a_number_of_AIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P6a_number_of_AIS`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPLV')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND ( ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    '2024S1' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m10:29:59.440188 [debug] [Thread-10 ]: On model.project_dbt.KMS_P7a_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P7a_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND (
      IACC.ACCOUNT_STATUS = 'OPEN'
      OR (
        IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
      )
    )
  AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:30:00.369232 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b075bdf9-89db-4d9e-be6f-8d297c3a0afa&page=queryresults
[0m10:30:00.479751 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:85a0199a-9d22-4934-97a4-042b595ce7d0&page=queryresults
[0m10:30:00.874106 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c155660>]}
[0m10:30:00.881705 [info ] [Thread-2 (]: 17 of 88 OK created sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [[32mCREATE TABLE (3.0 rows, 44.7 GiB processed)[0m in 18.27s]
[0m10:30:00.884112 [debug] [Thread-2 (]: Finished running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:30:00.888990 [debug] [Thread-2 (]: Began running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:30:00.890522 [info ] [Thread-2 (]: 39 of 88 START sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [RUN]
[0m10:30:00.891667 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo, now model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP)
[0m10:30:00.892959 [debug] [Thread-2 (]: Began compiling node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:30:00.904183 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m10:30:00.905240 [debug] [Thread-2 (]: Began executing node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:30:00.909522 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:30:01.385042 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e0af940>]}
[0m10:30:01.386899 [info ] [Thread-5 (]: 26 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [[32mCREATE TABLE (1.0 rows, 10.9 GiB processed)[0m in 12.00s]
[0m10:30:01.388666 [debug] [Thread-5 (]: Finished running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:30:01.390042 [debug] [Thread-5 (]: Began running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:30:01.391782 [info ] [Thread-5 (]: 40 of 88 START sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [RUN]
[0m10:30:01.393026 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro9_Credit_transfers_sent, now model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS)
[0m10:30:01.394213 [debug] [Thread-5 (]: Began compiling node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:30:01.400315 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m10:30:01.404053 [debug] [Thread-5 (]: Began executing node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:30:01.408527 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:30:01.491279 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m10:30:01.493452 [debug] [Thread-2 (]: On model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`NC1_Number_of_payment_accounts_accessed_by_UPP`
      
    
    

    OPTIONS()
    as (
      WITH pre AS (
  SELECT
    'DE' AS country,
    ac.USER_TOKEN,
    count(*),
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS pa
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE a.APPLICATION_NAME = 'PAY-PXG-BANQUPDE'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
      TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      OR
      (
      TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      )
    )
  GROUP BY 1,2
)
SELECT
  country ,
  count(distinct USER_TOKEN) as unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM PRE
GROUP BY 1
    );
  
[0m10:30:01.822379 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c75ac50>]}
[0m10:30:01.824117 [info ] [Thread-11 ]: 20 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [[32mCREATE TABLE (30.0 rows, 33.0 GiB processed)[0m in 18.04s]
[0m10:30:01.825785 [debug] [Thread-11 ]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:30:01.827031 [debug] [Thread-11 ]: Began running node model.project_dbt.PAY_CPCA
[0m10:30:01.828680 [info ] [Thread-11 ]: 41 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCA ................... [RUN]
[0m10:30:01.829820 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE, now model.project_dbt.PAY_CPCA)
[0m10:30:01.830980 [debug] [Thread-11 ]: Began compiling node model.project_dbt.PAY_CPCA
[0m10:30:01.848502 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.PAY_CPCA"
[0m10:30:01.849251 [debug] [Thread-11 ]: Began executing node model.project_dbt.PAY_CPCA
[0m10:30:01.852705 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:30:02.031771 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m10:30:02.033447 [debug] [Thread-5 (]: On model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS`
      
    
    

    OPTIONS()
    as (
      SELECT
    LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
    c.consent_iban,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
    c.CONSENT_STATUS = 'VALID'
    AND left(c.consent_iban,2) = 'BE'
    AND c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:30:02.418775 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:106e61c7-b36c-4e65-8203-012991c2b1b1&page=queryresults
[0m10:30:02.472470 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.PAY_CPCA"
[0m10:30:02.475140 [debug] [Thread-11 ]: On model.project_dbt.PAY_CPCA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCA`
      
    
    

    OPTIONS()
    as (
      WITH count_NContAISPS_last_six_months AS(
  SELECT
    row_number() over () as IDReg,
    'Y' as Ot,     -- PXG perspective
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasASPSP,
    'BE' as PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 as NContAISPM,                                             -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPS,       -- Number of accounts with consent in last 6 months
    0 as NPedInUt,                                               -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 as NPedSInUt,                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' --PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  AND fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -6 MONTH)
  )
  -- Created before the end of the reporting period AND still active or status last changed within 6 months before the reporting period
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM_previous_month AS(
  SELECT
    row_number() over () as IDReg,
   'Y' as Ot,     -- PXG perspective
   LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
   substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
   'PSDBE-NBB-0649860804' as AISP,
   'BE' as PasASPSP,
   'BE' as PasAISP,
   '' AS LEIASPSP,
   '5493000RZ2KSLKCYNN98' AS LEIAISP,
   '1' AS ModAc,
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPM,       -- Number of accounts with consent in month
    0 as NContAISPS,                                             -- Number of accounts with consent in last 6 months (numbers were in previous part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NPedInUt,         -- Assuming one access per day
    4 * count(distinct bad.BANK_ACCOUNT_NUMBER) * extract(DAY FROM LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)))  as NPedSInUt,     -- 4 * Number of days in month * number of accounts with consent in month
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' -- PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)
  )
  -- Created before the end of the reporting period and (is still active or status last changed before the start of the reporting period)
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    COUNT(*) AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    0 AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt,                                         -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    -- c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))
    -- AND (c.CONSENT_STATUS = 'VALID'
    --   OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >=  DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)
    --   ) -- ==> geen consent_status_at in DWH ook niet in DL
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
),
count_NContAISPS AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    COUNT(*) AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    --  c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))
    -- AND (acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    --   or DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:01.846559', 'Etc/UTC'))), INTERVAL -6 MONTH)
    --   ) ==> no consent status at?
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
)
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPS_last_six_months
  UNION ALL
  SELECT * FROM count_NContAISPM_previous_month
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPM
  UNION ALL
  SELECT * FROM count_NContAISPS
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m10:30:02.623244 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dcb6a70>]}
[0m10:30:02.625035 [info ] [Thread-16 ]: 32 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [[32mCREATE TABLE (1.0 rows, 10.7 GiB processed)[0m in 10.20s]
[0m10:30:02.626708 [debug] [Thread-16 ]: Finished running node model.project_dbt.KMS_C_non_euro_transactions
[0m10:30:02.627945 [debug] [Thread-16 ]: Began running node model.project_dbt.PAY_CPCL
[0m10:30:02.629419 [info ] [Thread-16 ]: 42 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCL ................... [RUN]
[0m10:30:02.631132 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C_non_euro_transactions, now model.project_dbt.PAY_CPCL)
[0m10:30:02.632436 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PAY_CPCL
[0m10:30:02.641471 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PAY_CPCL"
[0m10:30:02.641970 [debug] [Thread-16 ]: Began executing node model.project_dbt.PAY_CPCL
[0m10:30:02.644679 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:30:02.700881 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dad6e30>]}
[0m10:30:02.702589 [info ] [Thread-6 (]: 31 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C ................. [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 10.37s]
[0m10:30:02.704228 [debug] [Thread-6 (]: Finished running node model.project_dbt.KMS_C
[0m10:30:02.705451 [debug] [Thread-6 (]: Began running node model.project_dbt.PAY_CPMC
[0m10:30:02.706883 [info ] [Thread-6 (]: 43 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPMC ................... [RUN]
[0m10:30:02.708204 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C, now model.project_dbt.PAY_CPMC)
[0m10:30:02.708978 [debug] [Thread-6 (]: Began compiling node model.project_dbt.PAY_CPMC
[0m10:30:02.716489 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.PAY_CPMC"
[0m10:30:02.717079 [debug] [Thread-6 (]: Began executing node model.project_dbt.PAY_CPMC
[0m10:30:02.719479 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:30:02.895588 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:176f4a15-8994-407d-abfc-b99ff3cba4ad&page=queryresults
[0m10:30:03.243392 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PAY_CPCL"
[0m10:30:03.244110 [debug] [Thread-16 ]: On model.project_dbt.PAY_CPCL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCL`
      
    
    

    OPTIONS()
    as (
      SELECT
    "Y" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:02.640891', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasCl,
    COUNT(DISTINCT acic.USER_TOKEN) as NCl,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` as acic
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` AS pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` AS fp
        ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` AS aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
WHERE
    -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- Replace previous premise with thise for test with BE data
    and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
    AND acic.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:02.640891', 'Etc/UTC'))
    AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:02.640891', 'Etc/UTC'))
GROUP BY 1,3,4,5,7,8
    );
  
[0m10:30:03.341706 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.PAY_CPMC"
[0m10:30:03.343777 [debug] [Thread-6 (]: On model.project_dbt.PAY_CPMC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPMC`
      
    
    

    OPTIONS()
    as (
      WITH operation_types AS (
    (select 'ICDT' as family, 'ESCT' as subfamily, '22' as TipOper) union all
    (select 'MCOP' as family, 'OTHR' as subfamily, '27' as TipOper) union all
    (select 'MDOP' as family, 'OTHR' as subfamily, '28' as TipOper) union all
    (select 'RCDT' as family, 'ESCT' as subfamily, '21' as TipOper) union all
    (select 'RCDT' as family, 'RRTN' as subfamily, '21' as TipOper) union all
    (select 'RDDT' as family, 'ESDD' as subfamily, '22' as TipOper) union all
    (select 'RDDT' as family, 'OODD' as subfamily, '22' as TipOper)
)
SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:02.716089', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    ifnull(t.TipOper, 'NA') AS TipOper,
    count(1) as Quant,
    sum(am.MOVEMENT_AMOUNT) as Mont,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS` as am
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT` AS ia
    ON am.T_D_IBIS_ACCOUNT_DIM_KEY = ia.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bad
        ON ia.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
LEFT JOIN operation_types t
    ON t.family = am.MOVEMENT_FAMILY
    AND t.subfamily = am.MOVEMENT_SUBFAMILY
WHERE
    left(bad.BANK_ACCOUNT_NUMBER,2) = 'BE'
    AND am.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:02.716089', 'Etc/UTC'))
    AND am.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:02.716089', 'Etc/UTC'))
GROUP BY 1,3,4,5,8,9
    );
  
[0m10:30:03.510920 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:dee338f9-a51d-4c25-9f0d-c82474569890&page=queryresults
[0m10:30:03.721960 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c244400>]}
[0m10:30:03.725917 [info ] [Thread-1 (]: 37 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS . [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 4.98s]
[0m10:30:03.727922 [debug] [Thread-1 (]: Finished running node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:30:03.729139 [debug] [Thread-1 (]: Began running node model.project_dbt.PAY_CPNC
[0m10:30:03.730523 [info ] [Thread-1 (]: 44 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPNC ................... [RUN]
[0m10:30:03.731013 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P6a_number_of_AIS, now model.project_dbt.PAY_CPNC)
[0m10:30:03.731349 [debug] [Thread-1 (]: Began compiling node model.project_dbt.PAY_CPNC
[0m10:30:03.737817 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.PAY_CPNC"
[0m10:30:03.738293 [debug] [Thread-1 (]: Began executing node model.project_dbt.PAY_CPNC
[0m10:30:03.740592 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:30:03.875285 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e648700>]}
[0m10:30:03.877031 [info ] [Thread-15 ]: 30 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [[32mCREATE TABLE (0.0 rows, 15.6 GiB processed)[0m in 11.57s]
[0m10:30:03.878661 [debug] [Thread-15 ]: Finished running node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:30:03.879876 [debug] [Thread-15 ]: Began running node model.project_dbt.PAY_TROP_5845_CMD
[0m10:30:03.881568 [info ] [Thread-15 ]: 45 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD .......... [RUN]
[0m10:30:03.882807 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_sent, now model.project_dbt.PAY_TROP_5845_CMD)
[0m10:30:03.884019 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PAY_TROP_5845_CMD
[0m10:30:03.892523 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m10:30:03.893413 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b5d49c0c-b7fb-47b7-ae8c-fa9707aadec5&page=queryresults
[0m10:30:03.894807 [debug] [Thread-15 ]: Began executing node model.project_dbt.PAY_TROP_5845_CMD
[0m10:30:03.899980 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:30:03.990205 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:528fa6ac-560b-41cd-8a71-0f3b88678bb8&page=queryresults
[0m10:30:04.323655 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.PAY_CPNC"
[0m10:30:04.325555 [debug] [Thread-1 (]: On model.project_dbt.PAY_CPNC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPNC`
      
    
    

    OPTIONS()
    as (
      SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:30:03.737454', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    "5493000RZ2KSLKCYNN98" AS LEIASPSP,
    "N.E." AS `If`,
    "2" AS TipCont,
    "" AS DepOvTr,
    le.ENTERPRISE_ADDRESS_COUNTRY as PasTit,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS CPos,
    pa.PAYMENT_ACCOUNT_CURRENCY AS Div,
    "Y" AS ContrOB,
    count(1) as NCont,
    count(1) as NContAOn,
    0 AS NContAISPM,
    0 AS SaldoME,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` as iac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED` AS pa
    ON iac.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
    AND LEFT(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` AS lep
        ON lep.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` AS le
    ON le.T_DIM_KEY = lep.T_D_LEGAL_ENTITY_DIM_KEY
WHERE
    (
        pa.PAYMENT_ACCOUNT_STATUS = 'ACTIVE'
        OR(
            pa.PAYMENT_ACCOUNT_STATUS != 'ACTIVE'
            AND pa.PAYMENT_ACCOUNT_UPDATED_AT >= TIMESTAMP('2024-10-01 10:30:03.737454')
        )
    )
    AND left(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
    AND pa.PAYMENT_ACCOUNT_CREATED_AT <= TIMESTAMP('2024-10-31 10:30:03.737454')
GROUP BY 1,3,4,5,6,7,8,9,10,11,12,15,16,17,18
    );
  
[0m10:30:04.453772 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c7eff70>]}
[0m10:30:04.455472 [info ] [Thread-7 (]: 19 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 21.03s]
[0m10:30:04.457280 [debug] [Thread-7 (]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:30:04.458609 [debug] [Thread-7 (]: Began running node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:30:04.460203 [info ] [Thread-7 (]: 46 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS ......... [RUN]
[0m10:30:04.461272 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE, now model.project_dbt.PAY_TROP_5845_IBIS)
[0m10:30:04.462472 [debug] [Thread-7 (]: Began compiling node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:30:04.473590 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m10:30:04.474240 [debug] [Thread-7 (]: Began executing node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:30:04.477061 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:30:04.492128 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m10:30:04.493031 [debug] [Thread-15 ]: On model.project_dbt.PAY_TROP_5845_CMD: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD`
      
    
    

    OPTIONS()
    as (
      SELECT
    pa.PAYMENT_ACCOUNT_NUMBER AS identifier,
    le.ENTERPRISE_ADDRESS_NUMBER AS enterprise_number,
    le.ENTERPRISE_LEGAL_FORM AS legal_form,
    le.ENTERPRISE_ADDRESS_COUNTRY AS country,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS postal_code,
FROM(
  WITH current_table AS (
  SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
)  AS pa
LEFT JOIN(
select *,
row_number() over(partition by T_D_PAYMENT_ACCOUNT_DIM_KEY order by T_INGESTION_TIMESTAMP desc) as rn
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES_DECRYPTED`
)  lepar
    ON pa.T_DIM_KEY = lepar.T_D_PAYMENT_ACCOUNT_DIM_KEY AND lepar.T_FACT_KEY != 0
    and rn = 1
LEFT JOIN(
  WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED`
  )
  SELECT * EXCEPT(rn)
  FROM current_table
  WHERE rn = 1
)  AS le
    ON lepar.T_D_LEGAL_ENTITY_DIM_KEY = le.T_DIM_KEY AND le.T_DIM_KEY <> 0
WHERE pa.T_DIM_KEY <> 0 AND pa.PAYMENT_ACCOUNT_COUNTRY = 'BE'
    AND pa.T_SOURCE = 'P1_PCMD'
    );
  
[0m10:30:04.557426 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c7f98d0>]}
[0m10:30:04.559255 [info ] [Thread-4 (]: 34 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 10.00s]
[0m10:30:04.560840 [debug] [Thread-4 (]: Finished running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:30:04.562000 [debug] [Thread-4 (]: Began running node model.project_dbt.PAY_TROP_5845_PIS
[0m10:30:04.563398 [info ] [Thread-4 (]: 47 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS .......... [RUN]
[0m10:30:04.565185 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P11_Outgoing_transactions, now model.project_dbt.PAY_TROP_5845_PIS)
[0m10:30:04.566630 [debug] [Thread-4 (]: Began compiling node model.project_dbt.PAY_TROP_5845_PIS
[0m10:30:04.577777 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m10:30:04.578620 [debug] [Thread-4 (]: Began executing node model.project_dbt.PAY_TROP_5845_PIS
[0m10:30:04.583860 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:30:05.071097 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m10:30:05.073259 [debug] [Thread-7 (]: On model.project_dbt.PAY_TROP_5845_IBIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS`
      
    
    

    OPTIONS()
    as (
      WITH outbound as (
  SELECT
  'O' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ord,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
  '' AS PayID,
  baBA.BANK_ACCOUNT_BIC AS BICOrd,
  baCB.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '5493000RZ2KSLKCYNN98' AS LEIOrd,
  '' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  CASE
    WHEN fat.TRANSACTION_CHANNEL = 'OTHER' THEN'8'
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS') THEN'4'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'6'
    ELSE 'check the query'
  END AS TipCan,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER','TPP','OCS') THEN'2'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'1'
    ELSE 'check the query'
  END AS FormEnv,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','H2H') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER') THEN'N'
    ELSE 'check the query'
  END AS OperElet,

  'Y' AS OperRem,
  'Y' AS OperECom,
  'N' AS IniPISP,
  '1' AS ModAc,
  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') THEN'N'
    ELSE 'check the query'
  END AS SCA,

  case
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') then ''
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') then '5'
    ELSE 'check the query'
  END AS MnonSCA,

  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "OUTBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND fat.TRANSACTION_CHANNEL <> 'CARDS'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
),
inbound as (
  SELECT
  'B' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ord,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ben,
  '' AS PayID,
  baCB.BANK_ACCOUNT_BIC AS BICOrd,
  baBA.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '' AS LEIOrd,
  '5493000RZ2KSLKCYNN98' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  '' AS TipCan,
  '' AS FormEnv,
  '' AS OperElet,
  '' AS OperRem,
  'N' AS OperECom,
  '' AS IniPISP,
  '' AS ModAc,
  '' AS SCA,
  '' AS MnonSCA,
  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "INBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
)
SELECT * FROM outbound
UNION ALL
SELECT * FROM inbound
    );
  
[0m10:30:05.162533 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7aeaddeb-1588-438a-8fad-f2c63c1ca3ea&page=queryresults
[0m10:30:05.198468 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c1573a0>]}
[0m10:30:05.200059 [info ] [Thread-13 ]: 28 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_PIS .......... [[32mCREATE TABLE (0.0 rows, 27.5 GiB processed)[0m in 14.54s]
[0m10:30:05.201697 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuardro4_PIS
[0m10:30:05.202947 [debug] [Thread-13 ]: Began running node model.project_dbt.PAY_TRRT_5845
[0m10:30:05.204430 [info ] [Thread-13 ]: 48 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 .............. [RUN]
[0m10:30:05.206008 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_PIS, now model.project_dbt.PAY_TRRT_5845)
[0m10:30:05.206966 [debug] [Thread-13 ]: Began compiling node model.project_dbt.PAY_TRRT_5845
[0m10:30:05.220966 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.PAY_TRRT_5845"
[0m10:30:05.221593 [debug] [Thread-13 ]: Began executing node model.project_dbt.PAY_TRRT_5845
[0m10:30:05.224818 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:30:05.235095 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d0b2607c-f2d6-4381-94d6-1ec2ef0ceebf&page=queryresults
[0m10:30:05.337214 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m10:30:05.339469 [debug] [Thread-4 (]: On model.project_dbt.PAY_TROP_5845_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    'I' AS Ot,
    '' AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE ='BE', substr(deb.BANK_ACCOUNT_NUMBER, 5,4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE  ='BE', substr(cred.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
    pi.T_SOURCE_PK_ID  AS PayID,
    deb.BANK_ACCOUNT_NUMBER  as debtor_account_identifier,
    cred.BANK_ACCOUNT_NUMBER as creditor_account_identifier ,
    '' AS BICOrd,
    '' AS BICBen,
    '' AS BICSen,
    '' AS BICRec,
    fi.FINANCIAL_INSTITUTION_COUNTRY AS PasOrd,
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
    '' as LEIOrd,
    '' as LEIBen,
    '28' as Sch,
    '' as Pro,
    cast(null as DATE) as DatLiq,
    date(pi.PAYMENT_INITIATION_CREATED_AT) as DtPISP,
    '' AS TsOrd,
    '' AS TsBen,
    '1' AS TipTR,
    it.INBOUND_TRANSACTION_CURRENCY_CODE as Div,
    it.INBOUND_TRANSACTION_AMOUNT as Mont,
    it.INBOUND_TRANSACTION_AMOUNT as MontOrg,
    '4' as TipCan,
    '2' as FormEnv,
    'Y' as OperElet,
    'Y' as OperRem,
    'Y' as OperECom,
    'N' as IniPISP,
    '1' as ModAc,
    'N' as SCA,
    '10' as MnonSCA,
    'N.E.' as SI,
    '' as PasmC,
    '' as PasnC,
    '' as CPosm,
    '' AS TipDoc,
    '' AS NumDoc,
    '' AS LEIC,
    '' AS ENI,
    '' AS InfUltBen,
    '' AS InfUltOrd,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` AS ip
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON ip.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED`
    AS it ON ip.T_DIM_KEY=it.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO_DECRYPTED`
    AS dit ON dit.T_DIM_KEY=it.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS`
    AS pi ON ip.T_DIM_KEY=pi.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
    AS app ON ip.T_D_APPLICATION_DIM_KEY = app.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS deb ON deb.T_DIM_KEY=ip.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS cred ON cred.T_DIM_KEY=it.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY

WHERE pi.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
        app.APPLICATION_NAME IN ('PAY-PXG-COMMUNITY')
        OR
            (
                app.APPLICATION_NAME IN ('PAY-PXG-OCS')
                AND (cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
                AND substr(cred.BANK_ACCOUNT_NUMBER,5,3) = '504'    )
            )
        )
    --  AND (
    --     app.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    --     OR (
    --         app.APPLICATION_NAME = 'PAY-PXG-OCS'
    --         AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    --         AND substr(cred.BANK_ACCOUNT_NUMBER,5,4) = '5845'
    --         )
    --     )-- creditor account is a PANX PT account
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:30:05.615429 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c20fcd0>]}
[0m10:30:05.618687 [info ] [Thread-5 (]: 40 of 88 OK created sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 4.22s]
[0m10:30:05.620437 [debug] [Thread-5 (]: Finished running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:30:05.621595 [debug] [Thread-5 (]: Began running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:30:05.623163 [info ] [Thread-5 (]: 49 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS ....... [RUN]
[0m10:30:05.624281 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS, now model.project_dbt.PCP_ALBATROS_CMD_OCS)
[0m10:30:05.625302 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:30:05.636151 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m10:30:05.636784 [debug] [Thread-5 (]: Began executing node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:30:05.639720 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:30:05.827621 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.PAY_TRRT_5845"
[0m10:30:05.829729 [debug] [Thread-13 ]: On model.project_dbt.PAY_TRRT_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TRRT_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
    'O' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    AND ftr.transaction_type = 'RETURN'
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
    AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type IN ('RETURN')
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
--UNMATCHED TRANSACTIONS
UNION ALL
SELECT
    'O' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND DEB.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND utr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` CRED
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = CRED.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` DEB
    ON DEB.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'INBOUND'
    AND CRED.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
    );
  
[0m10:30:05.976815 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a4912cb0-8823-46ce-ac54-ddab304e515f&page=queryresults
[0m10:30:06.298088 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m10:30:06.303134 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9ef1c733-4c09-4651-a49f-c58a0d79ad16&page=queryresults
[0m10:30:06.304784 [debug] [Thread-5 (]: On model.project_dbt.PCP_ALBATROS_CMD_OCS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS`
      
    
    

    OPTIONS()
    as (
      WITH ALB AS (
SELECT
    '73f02cef-1f20-446a-b66f-5368c222a58e' AS companyid_tobeexcluded,
    'VigorPlus Holding B.V.' AS legal_name,
    'COLLECTOR_NL_FULL' AS product_name,
    'NL' AS to_be_reported_in_country
UNION ALL
SELECT '46d24da8-952f-44e3-b880-f1edd2a7e5a2', 'SIA EZ', 'COLLECTOR_LV_FULL', 'LV' UNION ALL
SELECT '0df4ade3-3e72-48d9-8897-e7439551a8ca', 'BLOX USINAGE PLASTIQUES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0f8c4fd2-72b2-4261-8599-223bcb67c711', 'LOTHESA', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '12144ea2-9a8a-49dd-b01f-0bdbb8189db5', 'MPG CONSEIL EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1840ea14-f726-448b-a716-e92f5009d322', 'FID SUD AGEN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1b12d30c-1820-400a-86eb-15601492979e', 'QUENETTE STEVE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1c72dfa2-b07e-455f-a00c-2fd64784f9c2', 'CIE EUROP GESTION EXPERTISES COMPTABLES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '23e4432f-43ed-4bf6-ab30-29f9d5a6f102', 'D.B.D.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '26801b29-16ed-4330-b180-3d4fb997aa6d', 'BAT EVENT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '38c5e0bc-d122-4783-872c-e2cdbbef0ece', 'LAMY EXPERTS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '497c6deb-a48b-464a-9318-02cf543ba323', 'FID SUD MONTAUBAN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5c5225a4-08a4-4052-b712-74bfe7a99da8', 'SDRD', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5e05cabb-e5bd-42e7-a50c-df17fb04f3c7', 'KOMO MARCHE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '634b1ae4-8dca-46f4-ae17-ef28f87e91af', 'CABINET CONCEPT EXPERT - CCE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '698f1c97-3d15-4a42-9914-e9513a8fe723', 'EXPERTS TEAM', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '6f216187-3566-4097-92e8-9de30f59bb19', 'ABAQUE CONSULTING', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '01dd8d49-de77-4311-bac3-c7a8c74b4275', 'EN SA MEMOIRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '768e77cd-7de9-4369-a7ba-b0b04db3ab67', 'OLIVER AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '791f2d5e-338f-4f82-9519-85a28c163884', 'MVT CONSEILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '99053b0d-3e81-4972-a491-bd34beb026a6', 'N.D.EX.CO.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'a9feb33b-db68-4020-a5f3-279123565354', 'SALAS-GORDO & COELHO', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'c45758bd-85b4-4f61-accc-ee180364a60b', 'NICOL & ASSOCIES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'cd8e4416-da0c-4a12-9934-78618f0694b3', 'IN FINE EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e196486d-0014-4931-b183-f32c190897d8', 'MALHERBE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e2a66866-98c4-4ef0-a67d-637e58273603', 'BENAUW HUBERT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e7f0ba81-6c3f-4b3d-9bf5-4d42dc88d56f', 'F2AB AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e9708122-4491-4930-bdd7-d70e50415d2f', 'BEY MANUTENTION', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'f10e6a0f-67e4-4662-83b7-7faba187e157', 'GARDILLE JEAN-PIERRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fb77318d-18f5-43d2-a202-512943c4f92b', 'SOGAREX', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fbe51ec9-8cb7-4825-be45-594886d67fac', 'CHESNEAU CHRISTIAN ET FILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fcb01b27-09c9-42c3-befa-3950b3150b1f', 'LOZANGE IT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '733045f3-c626-49a3-aad6-a514f19ad0e0', 'QINTENS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0567d2fa-6eca-4422-8570-ff714ccd8aa4', 'D-DALE', 'COLLECTOR_FR_FULL', 'FR'
),
CMD as (
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_OCS_ACTIVE = true
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

UNION ALL
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_SOURCE = 'ALBATROS'
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

ORDER BY 2
),
souce_table as(
SELECT  CMD.* FROM CMD
UNION ALL
SELECT
    ALB.companyid_tobeexcluded,
    ALB.legal_name,
    ALB.to_be_reported_in_country
FROM ALB
ORDER BY 2
)
SELECT
*,
""  AS Period,
TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
CURRENT_TIMESTAMP AS load_timestamp,
FROM souce_table
    );
  
[0m10:30:06.708801 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e379fdb7-c59e-4413-b7f3-acdae7c6d9d3&page=queryresults
[0m10:30:07.118613 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836df299f0>]}
[0m10:30:07.120274 [info ] [Thread-16 ]: 42 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCL .............. [[32mCREATE TABLE (1.0 rows, 3.4 GiB processed)[0m in 4.49s]
[0m10:30:07.120807 [debug] [Thread-16 ]: Finished running node model.project_dbt.PAY_CPCL
[0m10:30:07.121203 [debug] [Thread-16 ]: Began running node model.project_dbt.PCP_ATM
[0m10:30:07.121660 [info ] [Thread-16 ]: 50 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ATM .................... [RUN]
[0m10:30:07.122019 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCL, now model.project_dbt.PCP_ATM)
[0m10:30:07.122372 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PCP_ATM
[0m10:30:07.128341 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PCP_ATM"
[0m10:30:07.128881 [debug] [Thread-16 ]: Began executing node model.project_dbt.PCP_ATM
[0m10:30:07.132222 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:30:07.153060 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:be75113a-2d84-4aeb-bd9c-4fbd85737f1e&page=queryresults
[0m10:30:07.752054 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PCP_ATM"
[0m10:30:07.753767 [debug] [Thread-16 ]: On model.project_dbt.PCP_ATM: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ATM`
      
    
    

    OPTIONS()
    as (
      SELECT
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS Counterpart_area,
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS POS_location,
  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL AS remote_non_remote_initiation,
  COUNT(*) AS number_of_transactions,
  SUM(FCT.card_transaction_cleared_amount) + SUM(FCT.card_transaction_refunded_amount) AS total_sum,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
WHERE
FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM'
AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
-- AND FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
-- AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m10:30:08.114474 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c1d9240>]}
[0m10:30:08.116167 [info ] [Thread-2 (]: 39 of 88 OK created sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 7.22s]
[0m10:30:08.117910 [debug] [Thread-2 (]: Finished running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:30:08.119144 [debug] [Thread-2 (]: Began running node model.project_dbt.PCP_POS_ONLINE
[0m10:30:08.120476 [info ] [Thread-2 (]: 51 of 88 START sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ............. [RUN]
[0m10:30:08.121558 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP, now model.project_dbt.PCP_POS_ONLINE)
[0m10:30:08.122615 [debug] [Thread-2 (]: Began compiling node model.project_dbt.PCP_POS_ONLINE
[0m10:30:08.133806 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.PCP_POS_ONLINE"
[0m10:30:08.134455 [debug] [Thread-2 (]: Began executing node model.project_dbt.PCP_POS_ONLINE
[0m10:30:08.137323 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:30:08.171894 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfd7760>]}
[0m10:30:08.173519 [info ] [Thread-14 ]: 29 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 16.73s]
[0m10:30:08.175099 [debug] [Thread-14 ]: Finished running node model.project_dbt.Cuardro4_credit_transers_received
[0m10:30:08.176027 [debug] [Thread-14 ]: Began running node model.project_dbt.PCT_IDEAL
[0m10:30:08.177155 [info ] [Thread-14 ]: 52 of 88 START sql incremental model dev_dm_pst3_BE.PCT_IDEAL .................. [RUN]
[0m10:30:08.177941 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_received, now model.project_dbt.PCT_IDEAL)
[0m10:30:08.178718 [debug] [Thread-14 ]: Began compiling node model.project_dbt.PCT_IDEAL
[0m10:30:08.186684 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.PCT_IDEAL"
[0m10:30:08.187625 [debug] [Thread-14 ]: Began executing node model.project_dbt.PCT_IDEAL
[0m10:30:08.190938 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:30:08.651949 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:331c3e22-5cdc-4e2a-aba0-7d5e3759cbc4&page=queryresults
[0m10:30:08.685120 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c790df0>]}
[0m10:30:08.685704 [info ] [Thread-1 (]: 44 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPNC .............. [[32mCREATE TABLE (274.0 rows, 1.4 GiB processed)[0m in 4.95s]
[0m10:30:08.686210 [debug] [Thread-1 (]: Finished running node model.project_dbt.PAY_CPNC
[0m10:30:08.686585 [debug] [Thread-1 (]: Began running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:30:08.687131 [info ] [Thread-1 (]: 53 of 88 START sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP ...... [RUN]
[0m10:30:08.687523 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPNC, now model.project_dbt.PCT_INITIATED_BY_PISP)
[0m10:30:08.687954 [debug] [Thread-1 (]: Began compiling node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:30:08.701218 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m10:30:08.702030 [debug] [Thread-1 (]: Began executing node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:30:08.705636 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:30:08.747335 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.PCP_POS_ONLINE"
[0m10:30:08.749828 [debug] [Thread-2 (]: On model.project_dbt.PCP_POS_ONLINE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_POS_ONLINE`
      
    
    

    OPTIONS()
    as (
      with pre as (
 SELECT
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as Counterpart_area,
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as POS_location,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'non-remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'non-remote'
     ELSE 'check the query' end as remote_non_remote_initiation,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESSFUL'
           then 'SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS  in('UNAVAILABLE', 'THREEDS_REQUESTER_SCA_EXEMPTION')
           or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
               AND FCT.CARD_TRANSACTION_PIN_PRESENT is true
               then 'SCA is used'
   END AS SCA_used,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESS'
           then 'N/A'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT'
           then  'Recurring payment'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'MERCHANT_INITIATED_TRANSACTION'
           then  'Merchant initiated transaction (MIT)'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'TRANSACTION_RISK_ANALYSIS'
           then  'Transaction risk analysis'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'SECURE_CORPORATE_PAYMENT'
           then  'Secure corporate payment processes AND protocols'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           then  'Others'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE =  'CHIP_CONTACTLESS'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'Contactless low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT  is true then 'N/A'
     END AS SCA_Exemption_reason,
     count(*) as number_of_transactions	,
     sum (FCT.card_transaction_cleared_amount) + sum(FCT.card_transaction_refunded_amount) as total_sum,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
 WHERE FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND FTE.TRANSACTION_EVENT_TYPE in ('authorization','refund.authorization')
     AND FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
     AND DTE.TRANSACTION_EVENT_STATUS = 'COMPLETED'
     AND FCT.CARD_TRANSACTION_PAYMENT_CHANNEL <> 'ATM'
     AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
     group by 1,2,3,4,5
 ),
 NBB_onegate as (
       SELECT 'low value' AS sca_reason, 201 AS sca_reason_code
       UNION ALL
       SELECT 'Contactless low value', 202
       UNION ALL
       SELECT 'Trusted beneficiaries', 204
       UNION ALL
       SELECT 'Recurring Payment', 205
       UNION ALL
       SELECT 'Unattended terminal for transport fares or parking fees', 206
       UNION ALL
       SELECT 'Secure corporate payment processes and protocols', 207
       UNION ALL
       SELECT 'Transaction risk analysis', 208
       UNION ALL
       SELECT 'Merchant initiated transaction (MIT)', 209
       UNION ALL
       SELECT 'Others', 210
       UNION ALL
       SELECT 'N/A', 100
 )
 SELECT
   IF(pre.Counterpart_area = 'BE','W2',
         IF(map_area.code is null,'G1', pre.Counterpart_area)) AS Counterpart_area_GEO3,
   IF(pre.POS_location = 'BE','W2',
         IF(map_location.code is null,'G1', pre.POS_location)) AS POS_location_GEO3,
   'CPO' as Transaction_type,
   '2000' as Initiation_channel,
   if (pre.remote_non_remote_initiation = 'non-remote', 'NR', 'R') AS remoteness,
   'PCS_ALL' as Scheme,
   '11' as Card_function,
   '_Z' as Card_function_irrelevant,
   NBB_onegate.sca_reason_code as SCA,
   '_X' as SCA_irrelevant,
   '_Z'as Fraud_type_irrelevant,
   pre.number_of_transactions,
   pre.total_sum,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   ""  AS Period,
 FROM pre
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_area
   ON map_area.code = pre.Counterpart_area
   AND map_area.type = 'Geographical area'
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_location
   ON map_location.code = pre.POS_location
   AND map_location.type = 'Geographical area'
 LEFT JOIN NBB_onegate on  NBB_onegate.sca_reason = pre.SCA_Exemption_reason
    );
  
[0m10:30:08.762692 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f59450>]}
[0m10:30:08.764384 [info ] [Thread-15 ]: 45 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD ..... [[32mCREATE TABLE (518.0 rows, 1.4 GiB processed)[0m in 4.88s]
[0m10:30:08.765991 [debug] [Thread-15 ]: Finished running node model.project_dbt.PAY_TROP_5845_CMD
[0m10:30:08.767207 [debug] [Thread-15 ]: Began running node model.project_dbt.PCT_OUTBOUND
[0m10:30:08.768940 [info ] [Thread-15 ]: 54 of 88 START sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND ............... [RUN]
[0m10:30:08.770068 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_CMD, now model.project_dbt.PCT_OUTBOUND)
[0m10:30:08.771286 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PCT_OUTBOUND
[0m10:30:08.781704 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PCT_OUTBOUND"
[0m10:30:08.782412 [debug] [Thread-15 ]: Began executing node model.project_dbt.PCT_OUTBOUND
[0m10:30:08.785989 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:30:08.802035 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.PCT_IDEAL"
[0m10:30:08.803103 [debug] [Thread-14 ]: On model.project_dbt.PCT_IDEAL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_IDEAL`
      
    
    

    OPTIONS()
    as (
      SELECT
  COALESCE( nullif( d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY, 'NA'), left(dl_trans_pro.value,2))  AS PAYER_COUNTRY,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  COUNT(DISTINCT f_payment_items.T_FACT_KEY) AS VOLUME,
  ROUND(SUM(f_payment_items.PAYMENT_ITEM_AMOUNT)) AS AMOUNT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS`
    AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS`
    AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS`   AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED`
    AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED`
    AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN (
SELECT
  transaction_id,
  key,
  AEAD.DECRYPT_STRING(k0.KEYSET, value, TO_HEX(_flycs_metadata_keyset_0)) value,
  from `pj-bu-dw-dl-prod`.`prd_datalake_P1_PSTA`.`dwh_transaction_properties_current`
  left join `pj-bu-dw-ks-prod`.`prd_keysets`.`merged` k0
  on lower(k0.SOURCE) = "p1_psta_dwh_transaction_properties"
  and _flycs_metadata_keyset_0 = k0.HASH_ID
  WHERE key = "PAYER_ACCOUNT_ID"
) as dl_trans_pro
 on cast (dl_trans_pro.transaction_id as string) = d_payment_transaction_info.T_SOURCE_PK_ID
WHERE d_merchants.MERCHANT_COUNTRY  IS NOT NULL
    and d_payment_products.PRODUCT_CODE = "IDEAL_COLLECT"
    and d_payment_transaction_info.payment_transaction_cutoff_at >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))   -- start of reporting period
    and d_payment_transaction_info.payment_transaction_cutoff_at <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   -- end of reporting period
GROUP BY
    1,
    2
    );
  
[0m10:30:09.065717 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c244490>]}
[0m10:30:09.067411 [info ] [Thread-10 ]: 38 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 10.33s]
[0m10:30:09.069099 [debug] [Thread-10 ]: Finished running node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:30:09.070423 [debug] [Thread-10 ]: Began running node model.project_dbt.PIS
[0m10:30:09.072297 [info ] [Thread-10 ]: 55 of 88 START sql incremental model dev_dm_pst3_BE.PIS ........................ [RUN]
[0m10:30:09.073511 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P7a_number_of_accounts, now model.project_dbt.PIS)
[0m10:30:09.074557 [debug] [Thread-10 ]: Began compiling node model.project_dbt.PIS
[0m10:30:09.088829 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.PIS"
[0m10:30:09.089570 [debug] [Thread-10 ]: Began executing node model.project_dbt.PIS
[0m10:30:09.092256 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:30:09.348820 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m10:30:09.350689 [debug] [Thread-1 (]: On model.project_dbt.PCT_INITIATED_BY_PISP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_INITIATED_BY_PISP`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS', 'H2H') THEN 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID = '1' then 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID <> '1' then 'PISP'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END INITIATIONCHANNEL,
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END SCAINDICATOR,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
    ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
    ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
    ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
    ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ASPSP_PAYMENT_INITIATION` PI
    ON PI.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` TPP
  ON TPP.T_DIM_KEY = PI.T_D_ASPSP_PAYMENT_INITIATIONS_INFO_DIM_KEY
  WHERE
    f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
     AND (
           d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
           AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
      AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
      AND  f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
group by 1,2,3
    );
  
[0m10:30:09.380012 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PCT_OUTBOUND"
[0m10:30:09.381864 [debug] [Thread-15 ]: On model.project_dbt.PCT_OUTBOUND: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_OUTBOUND`
      
    
    

    OPTIONS()
    as (
      SELECT
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'Electronic'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END INITIATIONCHANNEL,
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END SCAINDICATOR,
    d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
    COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
    COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
    AND f_account_transactions.TRANSACTION_CHANNEL <> 'CARDS'
    AND f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'BG', 'LT', 'PL', 'RO', 'HR')
GROUP BY 1, 2, 3
    );
  
[0m10:30:09.674638 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8a623517-9c4c-4afe-af71-57aedae26ef6&page=queryresults
[0m10:30:09.683214 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.PIS"
[0m10:30:09.684657 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bf6c09ca-1b9f-40ed-a11a-4bf2b88dc885&page=queryresults
[0m10:30:09.688417 [debug] [Thread-10 ]: On model.project_dbt.PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PIS`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = 'PAY-PXG-COMMUNITY'
        OR APP.APPLICATION_NAME = 'PAY-PXG-GOCOMPTA'
        OR (
            APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
            AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = "FR"
                AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'))
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLT'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPBG'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPHR'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPRO')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      ""  AS Period,
      TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,8) = '50339900')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'EE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,2) = '72')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '6918')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '36330')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '39816')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'PT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '5845')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'SK' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '9955')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'RO' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.* EXCEPT(PERIOD),
      country,
      PERIOD,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m10:30:10.090179 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e204b20>]}
[0m10:30:10.092705 [info ] [Thread-8 (]: 33 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_MRA ............... [[32mCREATE TABLE (0.0 rows, 10.3 GiB processed)[0m in 17.40s]
[0m10:30:10.094571 [debug] [Thread-8 (]: Finished running node model.project_dbt.KMS_MRA
[0m10:30:10.096017 [debug] [Thread-8 (]: Began running node model.project_dbt.PI_FINAL_QUERY
[0m10:30:10.097658 [info ] [Thread-8 (]: 56 of 88 START sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ............. [RUN]
[0m10:30:10.101527 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_MRA, now model.project_dbt.PI_FINAL_QUERY)
[0m10:30:10.102744 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PI_FINAL_QUERY
[0m10:30:10.120598 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PI_FINAL_QUERY"
[0m10:30:10.123854 [debug] [Thread-8 (]: Began executing node model.project_dbt.PI_FINAL_QUERY
[0m10:30:10.126667 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:30:10.180633 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:75f9814f-5aa2-46c5-8b7f-f79aab7c35de&page=queryresults
[0m10:30:10.283773 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:34e6af54-2c20-4122-8315-e03690bb2d11&page=queryresults
[0m10:30:10.539709 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f73850>]}
[0m10:30:10.541473 [info ] [Thread-5 (]: 49 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS .. [[32mCREATE TABLE (63.0 rows, 1.5 GiB processed)[0m in 4.92s]
[0m10:30:10.543127 [debug] [Thread-5 (]: Finished running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:30:10.544479 [debug] [Thread-5 (]: Began running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:30:10.545902 [info ] [Thread-5 (]: 57 of 88 START sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [RUN]
[0m10:30:10.547233 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ALBATROS_CMD_OCS, now model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS)
[0m10:30:10.548424 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:30:10.643741 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:6ad82d7c-07f2-491c-ad3d-591096617ae2&page=queryresults
[0m10:30:10.661373 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m10:30:10.662423 [debug] [Thread-5 (]: Began executing node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:30:10.665087 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:30:10.726527 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PI_FINAL_QUERY"
[0m10:30:10.728310 [debug] [Thread-8 (]: On model.project_dbt.PI_FINAL_QUERY: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_FINAL_QUERY`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  fi.FINANCIAL_INSTITUTION_COUNTRY as CountryOfAISP,
  count(*) AS number_of_consents,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd on acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
  fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND (
    (
    TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
    OR
    (
    TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
  )
GROUP BY 1,2
    );
  
[0m10:30:11.317339 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m10:30:11.319507 [debug] [Thread-5 (]: On model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_NUMBER_OF_PAYMENT_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) AS d_ibis_account_count_ibis_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  CAST(NULL AS TIMESTAMP) AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC')) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
    ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
WHERE
    ibis.ACCOUNT_TYPE  in ('PAYMENT')
    AND ibis.ACCOUNT_IS_CUSTOMER_ACCOUNT IS TRUE
    AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'LT', 'RO', 'HR', 'BG')
    AND (
        ibis.ACCOUNT_STATUS = 'OPEN'
        OR ( ibis.ACCOUNT_STATUS = 'CLOSED'
           AND TIMESTAMP(ibis.ACCOUNT_UPDATED_AT) > TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
         )
        )
    -- Anca & Kris noticed that the for 269 accounts, the account_update_timestamp does not reflect the last_update_date of IBISv2 accounts table. Mail sent to Kathleen 25/08/23
    -- the v2 query gave 67 accounts less for 2023 S1 due to this difference
    AND TIMESTAMP(ibis.ACCOUNT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:30:11.573229 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1f96ec24-5b61-4170-a635-c9775281da06&page=queryresults
[0m10:30:11.865699 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367b68040>]}
[0m10:30:11.867344 [info ] [Thread-16 ]: 50 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ATM ............... [[32mCREATE TABLE (7.0 rows, 1.3 GiB processed)[0m in 4.74s]
[0m10:30:11.868893 [debug] [Thread-16 ]: Finished running node model.project_dbt.PCP_ATM
[0m10:30:11.870184 [debug] [Thread-16 ]: Began running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:30:11.872312 [info ] [Thread-16 ]: 58 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [RUN]
[0m10:30:11.873330 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ATM, now model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN)
[0m10:30:11.874353 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:30:11.885141 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m10:30:11.886036 [debug] [Thread-16 ]: Began executing node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:30:11.889110 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:30:11.914692 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:775b2d5a-ef8f-4cb4-a122-bda397f53123&page=queryresults
[0m10:30:12.188902 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f58850>]}
[0m10:30:12.190623 [info ] [Thread-9 (]: 35 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ........... [[32mCREATE TABLE (2.0 rows, 38.5 GiB processed)[0m in 17.63s]
[0m10:30:12.192004 [debug] [Thread-9 (]: Finished running node model.project_dbt.KMS_P17_PIS
[0m10:30:12.192363 [debug] [Thread-9 (]: Began running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:30:12.192791 [info ] [Thread-9 (]: 59 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING . [RUN]
[0m10:30:12.193187 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P17_PIS, now model.project_dbt.PI_PXG_APPLICATION_MAPPING)
[0m10:30:12.193499 [debug] [Thread-9 (]: Began compiling node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:30:12.200082 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m10:30:12.200645 [debug] [Thread-9 (]: Began executing node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:30:12.203041 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:30:12.513039 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m10:30:12.514889 [debug] [Thread-16 ]: On model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_AIS_JeF_with_BE_IBIS_IBAN`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  aa.APPLICATION_ACCOUNT_NAME Application_account_name,
  aa.T_SOURCE_PK_ID as Application_account_id ,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) AS Period_begin_date,
  CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd
  ON acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
    a.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
AND fi.FINANCIAL_INSTITUTION_COUNTRY = 'BE'
AND fi.FINANCIAL_INSTITUTION_CODE = 'IBIS'
AND (
  ac.ACCESS_CONSENT_STATUS = 'ACTIVE'
  OR (
    ac.ACCESS_CONSENT_STATUS = 'OBSOLETE'
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  ) --==> always start of the period
)
    );
  
[0m10:30:12.818429 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m10:30:12.821157 [debug] [Thread-9 (]: On model.project_dbt.PI_PXG_APPLICATION_MAPPING: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_APPLICATION_MAPPING`
      
    
    

    OPTIONS()
    as (
      SELECT
    distinct ap.APPLICATION_NAME AS APPLICATION_NAME,
    -- ap.APPLICATION_CREATED_AT AS CREATION_DATETIME,
    -- ao.APPLICATION_OWNER_NAME AS APPLICATION_OWNER_NAME,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    CAST(NULL AS TIMESTAMP) AS Period_begin_date,
    CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM (
    WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
) AS ap
LEFT  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED` AS ao
    ON ap.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON ap.t_dim_key = aa.T_D_APPLICATION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT` AS ci
    ON aa.T_DIM_KEY= ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
    AS pa on pa.T_DIM_KEY= ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
-- WHERE ap.APPLICATION_NAME <>"NA"
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) --pt winter time
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:30:13.361817 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7283677577f0>]}
[0m10:30:13.362646 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:ee882afa-6fcf-46d5-8678-76f7528ed5b0&page=queryresults
[0m10:30:13.364705 [info ] [Thread-2 (]: 51 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ........ [[32mCREATE TABLE (23.0 rows, 1.3 GiB processed)[0m in 5.24s]
[0m10:30:13.366490 [debug] [Thread-2 (]: Finished running node model.project_dbt.PCP_POS_ONLINE
[0m10:30:13.367232 [debug] [Thread-2 (]: Began running node model.project_dbt.SCA_MAPPING_TABLE
[0m10:30:13.367882 [info ] [Thread-2 (]: 60 of 88 START sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE .......... [RUN]
[0m10:30:13.368275 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_POS_ONLINE, now model.project_dbt.SCA_MAPPING_TABLE)
[0m10:30:13.368667 [debug] [Thread-2 (]: Began compiling node model.project_dbt.SCA_MAPPING_TABLE
[0m10:30:13.372577 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m10:30:13.373318 [debug] [Thread-2 (]: Began executing node model.project_dbt.SCA_MAPPING_TABLE
[0m10:30:13.376146 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:30:13.749149 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c007bc4b-c29f-41dc-92fc-f99f22057a28&page=queryresults
[0m10:30:13.981914 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m10:30:13.983615 [debug] [Thread-2 (]: On model.project_dbt.SCA_MAPPING_TABLE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE`
      
    
    

    OPTIONS()
    as (
      SELECT
  "full-auth" AS SCA_RESULT,
  "SCA used" AS SCA_REASON,
UNION ALL
SELECT
  "attempt" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  "non-authenticated" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  NULL AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
    );
  
[0m10:30:14.283860 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e12b130>]}
[0m10:30:14.285804 [info ] [Thread-12 ]: 36 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 17.50s]
[0m10:30:14.287532 [debug] [Thread-12 ]: Finished running node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:30:14.288937 [debug] [Thread-12 ]: Began running node model.project_dbt.T0202_credit_transfers
[0m10:30:14.290238 [info ] [Thread-12 ]: 61 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers ..... [RUN]
[0m10:30:14.291378 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P21_Inbound_transactions, now model.project_dbt.T0202_credit_transfers)
[0m10:30:14.292378 [debug] [Thread-12 ]: Began compiling node model.project_dbt.T0202_credit_transfers
[0m10:30:14.302556 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers"
[0m10:30:14.303225 [debug] [Thread-12 ]: Began executing node model.project_dbt.T0202_credit_transfers
[0m10:30:14.307128 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:30:14.525100 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:6c63191f-169f-44fd-9d69-94c25d8bc5b7&page=queryresults
[0m10:30:14.905533 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers"
[0m10:30:14.908741 [debug] [Thread-12 ]: On model.project_dbt.T0202_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'GB' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'CH' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' THEN 'Domestic'
      ELSE DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE
  END AS payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
      WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'Electronically'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS initiationChannel,
  'remote' as remoteness,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
      WHEN FAT.TRANSACTION_CHANNEL = 'TPP' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS SCAIndicator,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,

FROM
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
    ON DCA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE
    FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND DIAT.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m10:30:15.513036 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:436e7a81-126d-46da-80da-27d910ef0541&page=queryresults
[0m10:30:16.436585 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e017ee0>]}
[0m10:30:16.441803 [info ] [Thread-6 (]: 43 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPMC .............. [[32mCREATE TABLE (3.0 rows, 10.2 GiB processed)[0m in 13.73s]
[0m10:30:16.443843 [debug] [Thread-6 (]: Finished running node model.project_dbt.PAY_CPMC
[0m10:30:16.445089 [debug] [Thread-6 (]: Began running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:30:16.447011 [info ] [Thread-6 (]: 62 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [RUN]
[0m10:30:16.448187 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPMC, now model.project_dbt.T0202_credit_transfers_TPP_check)
[0m10:30:16.449499 [debug] [Thread-6 (]: Began compiling node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:30:16.454778 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m10:30:16.455241 [debug] [Thread-6 (]: Began executing node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:30:16.457529 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:30:16.878672 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dcb5270>]}
[0m10:30:16.880388 [info ] [Thread-2 (]: 60 of 88 OK created sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE ..... [[32mCREATE TABLE (4.0 rows, 0 processed)[0m in 3.51s]
[0m10:30:16.881099 [debug] [Thread-2 (]: Finished running node model.project_dbt.SCA_MAPPING_TABLE
[0m10:30:16.881471 [debug] [Thread-2 (]: Began running node model.project_dbt.T0401_misc
[0m10:30:16.882022 [info ] [Thread-2 (]: 63 of 88 START sql incremental model dev_dm_pst3_NL.T0401_misc ................. [RUN]
[0m10:30:16.882465 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.SCA_MAPPING_TABLE, now model.project_dbt.T0401_misc)
[0m10:30:16.882790 [debug] [Thread-2 (]: Began compiling node model.project_dbt.T0401_misc
[0m10:30:16.889915 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.T0401_misc"
[0m10:30:16.891943 [debug] [Thread-2 (]: Began executing node model.project_dbt.T0401_misc
[0m10:30:16.895634 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:30:17.072826 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m10:30:17.074938 [debug] [Thread-6 (]: On model.project_dbt.T0202_credit_transfers_TPP_check: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers_TPP_check`
      
    
    

    OPTIONS()
    as (
      select
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
inner join  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  on C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
where D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND C.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND C.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:30:17.476333 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.T0401_misc"
[0m10:30:17.478040 [debug] [Thread-2 (]: On model.project_dbt.T0401_misc: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_misc`
      
    
    

    OPTIONS()
    as (
      SELECT
  FAM.MOVEMENT_FAMILY as bank_family,
  FAM.MOVEMENT_SUBFAMILY as bank_subfamily,
  count(*) as count,
  COALESCE(SUM(FAM.MOVEMENT_AMOUNT), 0) as amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS_DECRYPTED` AS FAM
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
  ON FAM.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
  ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
  ON DCA.T_DIM_KEY = FAM.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE DIAT.ACCOUNT_TYPE = 'PAYMENT'
  AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND FAM.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND FAM.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m10:30:17.837172 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5b5b0f0c-5627-422c-8b2a-5bb8c33930a2&page=queryresults
[0m10:30:18.232741 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f5a2f0>]}
[0m10:30:18.234560 [info ] [Thread-9 (]: 59 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING  [[32mCREATE TABLE (62.0 rows, 6.1 GiB processed)[0m in 6.04s]
[0m10:30:18.236331 [debug] [Thread-9 (]: Finished running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:30:18.237567 [debug] [Thread-9 (]: Began running node model.project_dbt.T0401_nr_of_accounts
[0m10:30:18.238932 [info ] [Thread-9 (]: 64 of 88 START sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts ....... [RUN]
[0m10:30:18.240333 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_APPLICATION_MAPPING, now model.project_dbt.T0401_nr_of_accounts)
[0m10:30:18.241548 [debug] [Thread-9 (]: Began compiling node model.project_dbt.T0401_nr_of_accounts
[0m10:30:18.249317 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.T0401_nr_of_accounts"
[0m10:30:18.249967 [debug] [Thread-9 (]: Began executing node model.project_dbt.T0401_nr_of_accounts
[0m10:30:18.252626 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:30:18.340830 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d5017903-ac94-4166-a010-60ef67f5e106&page=queryresults
[0m10:30:18.853396 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.T0401_nr_of_accounts"
[0m10:30:18.854500 [debug] [Thread-9 (]: On model.project_dbt.T0401_nr_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_nr_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) nr_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2023Y' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
      )
  )
  and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    );
  
[0m10:30:19.018161 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dcb5a50>]}
[0m10:30:19.019842 [info ] [Thread-16 ]: 58 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [[32mCREATE TABLE (37.0 rows, 12.5 GiB processed)[0m in 7.14s]
[0m10:30:19.021478 [debug] [Thread-16 ]: Finished running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:30:19.022705 [debug] [Thread-16 ]: Began running node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:30:19.024158 [info ] [Thread-16 ]: 65 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ........ [RUN]
[0m10:30:19.025155 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN, now model.project_dbt.T0402_AIS_ASPSP_API)
[0m10:30:19.026135 [debug] [Thread-16 ]: Began compiling node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:30:19.035447 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m10:30:19.036118 [debug] [Thread-16 ]: Began executing node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:30:19.040468 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:30:19.057259 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c069bd0>]}
[0m10:30:19.058386 [info ] [Thread-11 ]: 41 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCA .............. [[32mCREATE TABLE (11.3k rows, 29.5 GiB processed)[0m in 17.23s]
[0m10:30:19.059839 [debug] [Thread-11 ]: Finished running node model.project_dbt.PAY_CPCA
[0m10:30:19.060873 [debug] [Thread-11 ]: Began running node model.project_dbt.T0402_AIS_PXG
[0m10:30:19.062183 [info ] [Thread-11 ]: 66 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG .............. [RUN]
[0m10:30:19.063646 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCA, now model.project_dbt.T0402_AIS_PXG)
[0m10:30:19.065068 [debug] [Thread-11 ]: Began compiling node model.project_dbt.T0402_AIS_PXG
[0m10:30:19.074599 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.T0402_AIS_PXG"
[0m10:30:19.075193 [debug] [Thread-11 ]: Began executing node model.project_dbt.T0402_AIS_PXG
[0m10:30:19.078282 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:30:19.648389 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m10:30:19.650301 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3dab4351-49ec-43c4-a2b9-0e9d9626e543&page=queryresults
[0m10:30:19.653745 [debug] [Thread-16 ]: On model.project_dbt.T0402_AIS_ASPSP_API: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_ASPSP_API`
      
    
    

    OPTIONS()
    as (
      select
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  c.consent_iban,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) = 'NL'
  and c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:30:19.680639 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.T0402_AIS_PXG"
[0m10:30:19.682522 [debug] [Thread-11 ]: On model.project_dbt.T0402_AIS_PXG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_PXG`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'NL' as CountryofAISP,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPNL')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
      AND (
          (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
          )
          OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
              )
      )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m10:30:19.779690 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836de5db40>]}
[0m10:30:19.876862 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728366d8f910>]}
[0m10:30:20.291895 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f686a232-967b-4e5e-b345-3e2ca88e752a&page=queryresults
[0m10:30:20.410728 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367b88880>]}
[0m10:30:20.433517 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:16438885-d241-474e-9152-ab40caff6703&page=queryresults
[0m10:30:20.839950 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c790df0>]}
[0m10:30:21.075533 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfc7d60>]}
[0m10:30:21.276171 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367b137c0>]}
[0m10:30:21.438726 [info ] [Thread-7 (]: 46 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS .... [[32mCREATE TABLE (0.0 rows, 47.5 GiB processed)[0m in 15.32s]
[0m10:30:21.442592 [debug] [Thread-7 (]: Finished running node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:30:21.440006 [info ] [Thread-8 (]: 56 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ........ [[32mCREATE TABLE (62.0 rows, 9.6 GiB processed)[0m in 9.78s]
[0m10:30:21.444381 [debug] [Thread-7 (]: Began running node model.project_dbt.V1110_payment_initiation_services
[0m10:30:21.441557 [info ] [Thread-5 (]: 57 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 9.86s]
[0m10:30:21.443806 [info ] [Thread-1 (]: 53 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP . [[32mCREATE TABLE (10.0 rows, 15.6 GiB processed)[0m in 12.15s]
[0m10:30:21.447180 [debug] [Thread-8 (]: Finished running node model.project_dbt.PI_FINAL_QUERY
[0m10:30:21.445467 [info ] [Thread-6 (]: 62 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 4.63s]
[0m10:30:21.446288 [info ] [Thread-4 (]: 47 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS ..... [[32mCREATE TABLE (4.0 rows, 34.7 GiB processed)[0m in 16.71s]
[0m10:30:21.448741 [info ] [Thread-7 (]: 67 of 88 START sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [RUN]
[0m10:30:21.450207 [debug] [Thread-5 (]: Finished running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:30:21.451245 [debug] [Thread-1 (]: Finished running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:30:21.451985 [debug] [Thread-8 (]: Began running node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:30:21.452987 [debug] [Thread-6 (]: Finished running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:30:21.453853 [debug] [Thread-4 (]: Finished running node model.project_dbt.PAY_TROP_5845_PIS
[0m10:30:21.454535 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_IBIS, now model.project_dbt.V1110_payment_initiation_services)
[0m10:30:21.455200 [debug] [Thread-5 (]: Began running node model.project_dbt.V121_customer_credit_transfers_received
[0m10:30:21.456240 [debug] [Thread-1 (]: Began running node model.project_dbt.V1220_stock_of_accounts
[0m10:30:21.457065 [info ] [Thread-8 (]: 68 of 88 START sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [RUN]
[0m10:30:21.457563 [debug] [Thread-6 (]: Began running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:30:21.458056 [debug] [Thread-4 (]: Began running node model.project_dbt.V1230_number_of_accounts
[0m10:30:21.458505 [debug] [Thread-7 (]: Began compiling node model.project_dbt.V1110_payment_initiation_services
[0m10:30:21.459164 [info ] [Thread-5 (]: 69 of 88 START sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [RUN]
[0m10:30:21.459647 [info ] [Thread-1 (]: 70 of 88 START sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts .... [RUN]
[0m10:30:21.460027 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_FINAL_QUERY, now model.project_dbt.V120_customer_credit_transfers_sent)
[0m10:30:21.460479 [info ] [Thread-6 (]: 71 of 88 START sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [RUN]
[0m10:30:21.460915 [info ] [Thread-4 (]: 72 of 88 START sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts ... [RUN]
[0m10:30:21.472921 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.V1110_payment_initiation_services"
[0m10:30:21.473614 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS, now model.project_dbt.V121_customer_credit_transfers_received)
[0m10:30:21.474092 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_INITIATED_BY_PISP, now model.project_dbt.V1220_stock_of_accounts)
[0m10:30:21.474628 [debug] [Thread-8 (]: Began compiling node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:30:21.475110 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers_TPP_check, now model.project_dbt.V1222_stock_of_accessed_accounts)
[0m10:30:21.475468 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_PIS, now model.project_dbt.V1230_number_of_accounts)
[0m10:30:21.475949 [debug] [Thread-5 (]: Began compiling node model.project_dbt.V121_customer_credit_transfers_received
[0m10:30:21.476407 [debug] [Thread-1 (]: Began compiling node model.project_dbt.V1220_stock_of_accounts
[0m10:30:21.482432 [debug] [Thread-7 (]: Began executing node model.project_dbt.V1110_payment_initiation_services
[0m10:30:21.485405 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m10:30:21.485987 [debug] [Thread-6 (]: Began compiling node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:30:21.486451 [debug] [Thread-4 (]: Began compiling node model.project_dbt.V1230_number_of_accounts
[0m10:30:21.493263 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m10:30:21.497434 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.V1220_stock_of_accounts"
[0m10:30:21.501937 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:30:21.508485 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m10:30:21.509001 [debug] [Thread-8 (]: Began executing node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:30:21.516366 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.V1230_number_of_accounts"
[0m10:30:21.517415 [debug] [Thread-5 (]: Began executing node model.project_dbt.V121_customer_credit_transfers_received
[0m10:30:21.518220 [debug] [Thread-1 (]: Began executing node model.project_dbt.V1220_stock_of_accounts
[0m10:30:21.520153 [debug] [Thread-6 (]: Began executing node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:30:21.523725 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:30:21.526389 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:30:21.529031 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:30:21.529563 [debug] [Thread-4 (]: Began executing node model.project_dbt.V1230_number_of_accounts
[0m10:30:21.533386 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:30:21.540171 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:30:21.668115 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e648700>]}
[0m10:30:21.669670 [info ] [Thread-15 ]: 54 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND .......... [[32mCREATE TABLE (26.0 rows, 15.6 GiB processed)[0m in 12.90s]
[0m10:30:21.670929 [debug] [Thread-15 ]: Finished running node model.project_dbt.PCT_OUTBOUND
[0m10:30:21.672031 [debug] [Thread-15 ]: Began running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:30:21.673486 [info ] [Thread-15 ]: 73 of 88 START sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [RUN]
[0m10:30:21.673997 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_OUTBOUND, now model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP)
[0m10:30:21.674443 [debug] [Thread-15 ]: Began compiling node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:30:21.681989 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m10:30:21.682808 [debug] [Thread-15 ]: Began executing node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:30:21.685841 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:30:22.108541 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.V1110_payment_initiation_services"
[0m10:30:22.110005 [debug] [Thread-7 (]: On model.project_dbt.V1110_payment_initiation_services: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1110_payment_initiation_services`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = '	PAY-PXG-BANQUPLU')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.472033', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.472033', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.472033', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.472033', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.*,
      country,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      CAST ("" AS STRING) AS Period,
      TIMESTAMP(DATETIME( '2024-10-01 10:30:21.472033', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-10-31 10:30:21.472033', 'Etc/UTC'))  AS Period_end_date,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m10:30:22.124229 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m10:30:22.125201 [debug] [Thread-8 (]: On model.project_dbt.V120_customer_credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V120_customer_credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
  else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  COUNT(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.484473', 'Etc/UTC'))  -- +01 for winter time, +02 for summer time
  -- AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.484473', 'Etc/UTC')) -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.484473', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time

GROUP BY 1,2,3,4,5,6,7,8,9,10

UNION ALL

SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
    else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.484473', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.484473', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
GROUP BY 1,2,3,4,5,6,7,8,9,10
ORDER BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m10:30:22.140319 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m10:30:22.142219 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m10:30:22.142831 [debug] [Thread-5 (]: On model.project_dbt.V121_customer_credit_transfers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V121_customer_credit_transfers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedamount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.492689', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.492689', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4

UNION ALL

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.492689', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.492689', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4
    );
  
[0m10:30:22.143639 [debug] [Thread-6 (]: On model.project_dbt.V1222_stock_of_accessed_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1222_stock_of_accessed_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'AISP' as PSPType,
    fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
    'VOLU' as Metric,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
      AND (
            ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.507931', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:30:21.507931', 'Etc/UTC'))
          )
          OR (
            ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.507931', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 10:30:21.507931', 'Etc/UTC'))
              )
  GROUP BY
  1,2,3,4
  )
  SELECT
    'AISP' as PSPType,
    Countryofcustomerresidence as  countryOfASPSP,
    'LU' as countryOfAISP,
    'VOLU' as Metric,
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  group by 1,2,3
union all


SELECT
  'APSP' as PSPType,
  'LU' countryOfASPSP,
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  'VOLU' as Metric,
  COUNT(*) AS Numberofaccounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='LU'
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  and  c.CONSENT_CREATED_AT <  TIMESTAMP(DATETIME( '2024-10-31 10:30:21.507931', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.507931', 'Etc/UTC'))
group by 1,2,3
    );
  
[0m10:30:22.145295 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.V1230_number_of_accounts"
[0m10:30:22.146228 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.V1220_stock_of_accounts"
[0m10:30:22.147696 [debug] [Thread-4 (]: On model.project_dbt.V1230_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1230_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
   SELECT
     'AISP' as PSPType,
     fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
     'VOLU' as Metric,
     ac.USER_TOKEN,
     COUNT(*) AS number_of_consents,
   FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
     ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
    inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
     ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
   ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
     ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
     ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
     ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
   WHERE
       a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
       AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
       AND (
           (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.514928', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:30:21.514928', 'Etc/UTC'))
           )
           OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.514928', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 10:30:21.514928', 'Etc/UTC'))
               )
       )
   GROUP BY
   1,2,3,4
   )
   SELECT
     'AISP' as PSPType,
     Countryofcustomerresidence,
     'VOLU' as Metric,
     COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
   FROM obsolete_and_active_consents_count_in_reporting_period
   group by 1,2,3
    );
  
[0m10:30:22.149260 [debug] [Thread-1 (]: On model.project_dbt.V1220_stock_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1220_stock_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  'PMAC' as AccountType,
  case
    when ACCOUNT_USAGE in ('CARE','CARE_EXPENSE','ESTATE') then 'HSNP' -- Households and NPISHs
    when ACCOUNT_USAGE is null then 'CORP' -- Non-financial corporations
    else 'check the query'
  end as Customer_Category,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
and BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
and IACC.ACCOUNT_STATUS = 'OPEN'
or (
  IACC.ACCOUNT_STATUS = 'CLOSED'
  and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-10-01 10:30:21.496921', 'Etc/UTC'))
  )
and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:30:21.496921', 'Etc/UTC'))
group by 1,2
    );
  
[0m10:30:22.296512 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m10:30:22.298491 [debug] [Thread-15 ]: On model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V130_direct_debits_reporting_as_creditors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.680572', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.680572', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8

union all

SELECT
  'CORP' as customerCategory,
   IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:21.680572', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:21.680572', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m10:30:22.702713 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e05ffa0>]}
[0m10:30:22.704469 [info ] [Thread-14 ]: 52 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_IDEAL ............. [[32mCREATE TABLE (6.0 rows, 1.4 TiB processed)[0m in 14.52s]
[0m10:30:22.706506 [debug] [Thread-14 ]: Finished running node model.project_dbt.PCT_IDEAL
[0m10:30:22.708435 [debug] [Thread-14 ]: Began running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:30:22.710441 [info ] [Thread-14 ]: 74 of 88 START sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [RUN]
[0m10:30:22.711502 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_IDEAL, now model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP)
[0m10:30:22.712554 [debug] [Thread-14 ]: Began compiling node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:30:22.725237 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m10:30:22.725947 [debug] [Thread-14 ]: Began executing node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:30:22.728734 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:30:22.963253 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f7945192-e06e-4ea8-b203-c5a7f121e89c&page=queryresults
[0m10:30:22.988207 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:01a26904-8752-4288-bbc5-8f40f468a9bc&page=queryresults
[0m10:30:22.989669 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:fe676221-b182-4a71-b9e1-0f6870014fe9&page=queryresults
[0m10:30:23.036773 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5a9976ec-1f6d-4086-bb3e-25d24b34c2e3&page=queryresults
[0m10:30:23.048064 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8d81cdb3-613d-465c-8859-a9401cfb20d2&page=queryresults
[0m10:30:23.065342 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:681055df-6f49-42f6-b693-9bb801c916f7&page=queryresults
[0m10:30:23.146453 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e5c6a255-d4a0-43ba-a0c0-0659a70be8a1&page=queryresults
[0m10:30:23.322995 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m10:30:23.326296 [debug] [Thread-14 ]: On model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V131_direct_debits_reporting_as_debtors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:22.724601', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:22.724601', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    'SEPA' as paymentScheme,
    "Electronic file/batch" AS initiationChannel ,
    '' as consent,
    '' as fraudType,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:22.724601', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:22.724601', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m10:30:23.556571 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c377e20>]}
[0m10:30:23.557892 [info ] [Thread-16 ]: 65 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ... [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 4.53s]
[0m10:30:23.558386 [debug] [Thread-16 ]: Finished running node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:30:23.558756 [debug] [Thread-16 ]: Began running node model.project_dbt.V140_SEPA_R_transactions
[0m10:30:23.559163 [info ] [Thread-16 ]: 75 of 88 START sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions ... [RUN]
[0m10:30:23.559587 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_ASPSP_API, now model.project_dbt.V140_SEPA_R_transactions)
[0m10:30:23.559974 [debug] [Thread-16 ]: Began compiling node model.project_dbt.V140_SEPA_R_transactions
[0m10:30:23.568107 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.V140_SEPA_R_transactions"
[0m10:30:23.568701 [debug] [Thread-16 ]: Began executing node model.project_dbt.V140_SEPA_R_transactions
[0m10:30:23.571200 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:30:23.740210 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836df6e560>]}
[0m10:30:23.741026 [info ] [Thread-9 (]: 64 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts .. [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 5.50s]
[0m10:30:23.741575 [debug] [Thread-9 (]: Finished running node model.project_dbt.T0401_nr_of_accounts
[0m10:30:23.741949 [debug] [Thread-9 (]: Began running node model.project_dbt.V142_intermediated_payment_transactions
[0m10:30:23.742349 [info ] [Thread-9 (]: 76 of 88 START sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [RUN]
[0m10:30:23.742761 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_nr_of_accounts, now model.project_dbt.V142_intermediated_payment_transactions)
[0m10:30:23.743166 [debug] [Thread-9 (]: Began compiling node model.project_dbt.V142_intermediated_payment_transactions
[0m10:30:23.756285 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m10:30:23.756895 [debug] [Thread-9 (]: Began executing node model.project_dbt.V142_intermediated_payment_transactions
[0m10:30:23.759494 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:30:23.807159 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7283926ef7f0>]}
[0m10:30:23.808900 [info ] [Thread-11 ]: 66 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG ......... [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 4.74s]
[0m10:30:23.810533 [debug] [Thread-11 ]: Finished running node model.project_dbt.T0402_AIS_PXG
[0m10:30:23.811766 [debug] [Thread-11 ]: Began running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:30:23.813326 [info ] [Thread-11 ]: 77 of 88 START sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [RUN]
[0m10:30:23.814362 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_PXG, now model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs)
[0m10:30:23.815428 [debug] [Thread-11 ]: Began compiling node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:30:23.827606 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m10:30:23.828240 [debug] [Thread-11 ]: Began executing node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:30:23.833146 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:30:24.171431 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.V140_SEPA_R_transactions"
[0m10:30:24.173584 [debug] [Thread-16 ]: On model.project_dbt.V140_SEPA_R_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V140_SEPA_R_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
     'SEPA' as paymentScheme,
   case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
        when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
        end RoleofReporting,
   'CORP' as customerCategory,
   case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
        or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
              else 'PSPN'
         end settlementChannel,
  'SEPA Credit Transfer' as R_TransactionType,
     case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end creditorPspCountry,
     case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end debtorPspCountry,
     ftr.transaction_currency as currency,
     'VOLU' as metric,
     count(*) as reportedAmount,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.567477', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.567477', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8

  union all

  SELECT
        'SEPA' as paymentScheme,
      case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
            when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
            end RoleofReporting,
      'CORP' as customerCategory,
      case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
            or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
                  else 'PSPN'
            end settlementChannel,
      'SEPA Credit Transfer' as R_TransactionType,
        case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end creditorPspCountry,
        case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end debtorPspCountry,
        ftr.transaction_currency as currency,
        'VALE' as metric,
        SUM(ftr.TRANSACTION_AMOUNT) as reportedAmount,
        CURRENT_TIMESTAMP AS Load_timestamp,
        ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.567477', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.567477', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8
  order by 1,2,3,4,5,6,7,8
    );
  
[0m10:30:24.177927 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:cce4fb15-367d-4fdd-ad66-5273c5d89777&page=queryresults
[0m10:30:24.362153 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m10:30:24.364528 [debug] [Thread-9 (]: On model.project_dbt.V142_intermediated_payment_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V142_intermediated_payment_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  'CPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  d_payment_transaction_info.payment_transaction_payer_country   as debtorPSPs,
  'LU' as CreditorPSPs,
  d_payment_transaction_info.payment_transaction_currency_code as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE != 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.755164', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.755164', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  group by 1,2,3,4,5,6,7,8
union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as RoleofReporting,
  'PSPN' as Settlementchannel,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'LU', d_payment_transaction_info.payment_transaction_payer_country)   as debtorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_payer_country, 'LU') as CreditorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_currency_code,  d_payment_transaction_info.payment_transaction_currency_code) as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.755164', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.755164', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT

  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
    REFUND.payment_transaction_payer_country as CreditorPSPs,
    REFUND.payment_transaction_currency_code as currency,
    'Volu' as Metric,
    count(*) as ReportedAmount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
      AS d_payment_item_info
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
  T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
  WHERE
      f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
      AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
      AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.755164', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.755164', 'Etc/UTC')) -- like timez
    group by 1,2,3,4,5,6,7,8
    union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
  REFUND.payment_transaction_payer_country as CreditorPSPs,
  REFUND.payment_transaction_currency_code as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.755164', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:23.755164', 'Etc/UTC')) -- like timez
  group by 1,2,3,4,5,6,7,8
    );
  
[0m10:30:24.437298 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m10:30:24.439762 [debug] [Thread-11 ]: On model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V150_card_transactions_with_cards_issued_by resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VOLU' as metric,
  count(*) AS ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND  CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.826876', 'Etc/UTC'))
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 10:30:23.826876', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

UNION ALL

SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VALE' as metric,
  sum (coalesce(FCT.CARD_TRANSACTION_CLEARED_AMOUNT ,0)) + sum(coalesce(CARD_TRANSACTION_REFUNDED_AMOUNT,0)) as total_sum,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND   CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 10:30:23.826876', 'Etc/UTC'))
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 10:30:23.826876', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
    );
  
[0m10:30:24.831006 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:27fbeb9a-341c-49d0-bcb8-c928321b9596&page=queryresults
[0m10:30:25.255043 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d315fac2-e094-4538-895c-ba8e47f889f3&page=queryresults
[0m10:30:25.349126 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:ecc8effd-f501-4670-82a5-347a5556a4e3&page=queryresults
[0m10:30:25.718182 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfc4370>]}
[0m10:30:25.718984 [info ] [Thread-12 ]: 61 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers  [[32mCREATE TABLE (12.0 rows, 15.6 GiB processed)[0m in 11.43s]
[0m10:30:25.719528 [debug] [Thread-12 ]: Finished running node model.project_dbt.T0202_credit_transfers
[0m10:30:25.719916 [debug] [Thread-12 ]: Began running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:30:25.720470 [info ] [Thread-12 ]: 78 of 88 START sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [RUN]
[0m10:30:25.721413 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers, now model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs)
[0m10:30:25.721794 [debug] [Thread-12 ]: Began compiling node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:30:25.727498 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m10:30:25.728924 [debug] [Thread-12 ]: Began executing node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:30:25.733887 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:30:26.370605 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m10:30:26.372396 [debug] [Thread-12 ]: On model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V152_card_transactions_acquired_by_resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CRCA' as PaymentCardType,
  case when f_payment_transactions.card_network = 'MASTERCARD' then 'MSTR'
    when f_payment_transactions.card_network = 'VISA' then 'VISA'
    else 'OTHER' END PaymentCardScheme,
  'ECOM' as TerminalType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as OperationType,
  'RMTR' as InitiationChannel,
  'REM1' as InitiationsubChannel,
  'MITR' as SCA,
  'NOAP' as FraudType,
  d_merchants.MERCHANT_COUNTRY AS CountryofIssuer,
  d_merchants.MERCHANT_COUNTRY AS  CountryofTerminal,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED` AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items
  ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants
  ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions
  ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info
  ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products
  ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
  AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:30:25.727032', 'Etc/UTC'))
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:30:25.727032', 'Etc/UTC'))
  GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
    );
  
[0m10:30:26.492161 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367b7af20>]}
[0m10:30:26.493904 [info ] [Thread-6 (]: 71 of 88 OK created sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [[32mCREATE TABLE (8.0 rows, 7.1 GiB processed)[0m in 5.02s]
[0m10:30:26.495521 [debug] [Thread-6 (]: Finished running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:30:26.496728 [debug] [Thread-6 (]: Began running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:30:26.498026 [info ] [Thread-6 (]: 79 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [RUN]
[0m10:30:26.499198 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1222_stock_of_accessed_accounts, now model.project_dbt.ZVS41_Inbound_credit_transfers)
[0m10:30:26.500206 [debug] [Thread-6 (]: Began compiling node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:30:26.510334 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m10:30:26.510932 [debug] [Thread-6 (]: Began executing node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:30:26.514113 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:30:27.133551 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m10:30:27.135159 [debug] [Thread-6 (]: On model.project_dbt.ZVS41_Inbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Inbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYER_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'INBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1
ORDER BY 1
    );
  
[0m10:30:27.189418 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c3d9750>]}
[0m10:30:27.191074 [info ] [Thread-4 (]: 72 of 88 OK created sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts  [[32mCREATE TABLE (0.0 rows, 5.9 GiB processed)[0m in 5.71s]
[0m10:30:27.192641 [debug] [Thread-4 (]: Finished running node model.project_dbt.V1230_number_of_accounts
[0m10:30:27.193803 [debug] [Thread-4 (]: Began running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:30:27.195056 [info ] [Thread-4 (]: 80 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [RUN]
[0m10:30:27.196304 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1230_number_of_accounts, now model.project_dbt.ZVS41_Outbound_credit_transfers)
[0m10:30:27.197473 [debug] [Thread-4 (]: Began compiling node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:30:27.206951 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m10:30:27.207603 [debug] [Thread-4 (]: Began executing node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:30:27.212016 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:30:27.245905 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e052d0bd-55cc-4fe5-82c3-4a7692207d56&page=queryresults
[0m10:30:27.722701 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9405e0ca-f1ca-44ce-a66a-cc300174115c&page=queryresults
[0m10:30:27.832760 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m10:30:27.834514 [debug] [Thread-4 (]: On model.project_dbt.ZVS41_Outbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Outbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'PCT.4 Manual entry'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'PCT.2 Electronic entry'
  END EntryMode,
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS') THEN 'PCT.22 Single entry'
    WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'PCT.21 Batch entry'
  END Batchmode,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1, 2, 3
    );
  
[0m10:30:28.422112 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:96bcb47e-5ce3-4daf-81a3-956ca09d8f95&page=queryresults
[0m10:30:28.938346 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c3dac20>]}
[0m10:30:28.940243 [info ] [Thread-2 (]: 63 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_misc ............ [[32mCREATE TABLE (11.0 rows, 10.9 GiB processed)[0m in 12.06s]
[0m10:30:28.948513 [debug] [Thread-2 (]: Finished running node model.project_dbt.T0401_misc
[0m10:30:28.950563 [debug] [Thread-2 (]: Began running node model.project_dbt.ZVS9_PCT
[0m10:30:28.951855 [info ] [Thread-2 (]: 81 of 88 START sql incremental model dev_dm_pst3_DE.ZVS9_PCT ................... [RUN]
[0m10:30:28.955969 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_misc, now model.project_dbt.ZVS9_PCT)
[0m10:30:28.956820 [debug] [Thread-2 (]: Began compiling node model.project_dbt.ZVS9_PCT
[0m10:30:28.965909 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.ZVS9_PCT"
[0m10:30:28.966509 [debug] [Thread-2 (]: Began executing node model.project_dbt.ZVS9_PCT
[0m10:30:28.969046 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:30:29.442708 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e0ad4e0>]}
[0m10:30:29.444516 [info ] [Thread-11 ]: 77 of 88 OK created sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [[32mCREATE TABLE (0.0 rows, 2.7 GiB processed)[0m in 5.63s]
[0m10:30:29.446228 [debug] [Thread-11 ]: Finished running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:30:29.449844 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e2a4040>]}
[0m10:30:29.451634 [debug] [Thread-11 ]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:30:29.454325 [info ] [Thread-13 ]: 48 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 ......... [[32mCREATE TABLE (0.0 rows, 89.2 GiB processed)[0m in 24.24s]
[0m10:30:29.455941 [info ] [Thread-11 ]: 82 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [RUN]
[0m10:30:29.457635 [debug] [Thread-13 ]: Finished running node model.project_dbt.PAY_TRRT_5845
[0m10:30:29.458731 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals)
[0m10:30:29.460296 [debug] [Thread-13 ]: Began running node model.project_dbt.PCP
[0m10:30:29.461607 [debug] [Thread-11 ]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:30:29.463158 [info ] [Thread-13 ]: 83 of 88 START sql incremental model dev_dm_pst3_BE.PCP ........................ [RUN]
[0m10:30:29.474990 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m10:30:29.475739 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TRRT_5845, now model.project_dbt.PCP)
[0m10:30:29.476323 [debug] [Thread-13 ]: Began compiling node model.project_dbt.PCP
[0m10:30:29.488103 [debug] [Thread-11 ]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:30:29.489901 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.PCP"
[0m10:30:29.493074 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:30:29.494744 [debug] [Thread-13 ]: Began executing node model.project_dbt.PCP
[0m10:30:29.497652 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:30:29.550040 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.ZVS9_PCT"
[0m10:30:29.551741 [debug] [Thread-2 (]: On model.project_dbt.ZVS9_PCT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS9_PCT`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE (FAT.TRANSACTION_DIRECTION = 'OUTBOUND')
  AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
  AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
  AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
  AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL not in ('DASHBOARD', 'OTHER','CARDS')
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1
ORDER BY 1 ASC
    );
  
[0m10:30:30.158345 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.PCP"
[0m10:30:30.161202 [debug] [Thread-13 ]: On model.project_dbt.PCP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP`
      
    
    

    OPTIONS()
    as (
      with source as(
SELECT
  d_payment_products.PRODUCT_CODE AS PRODUCT,
  d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY  AS PAYERCOUNTRY,
  d_merchants.MERCHANT_COUNTRY  AS MERCHANTCOUNTRY,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'VISA' THEN 'Visa'
    END AS PCP_TYPE,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
    END AS SINGLEWIP,
    d_payment_transaction_info.T_SOURCE_PK_UUID  AS  TRANSACTION_PUBLIC_IDENTIFIER,
    f_payment_transactions.CARD_COUNTRY  AS CARD_COUNTRY,
    f_payment_transactions.CARD_NETWORK_AUTHORIZATION_CODE  AS NETWORK_CODE,
    f_payment_transactions.SCA_RESULT  AS SCA_RESULT,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN
      IF(f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT','non-SCA used: reason is merchant initiated transaction (MIT)','SCA used')
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF (f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD', 'non-SCA used: reason is merchant initiated transaction (MIT)',map.SCA_REASON )
    END AS SCA_REASON,
  f_payment_transactions.MASTERCARD_PRODUCT_ID  AS LICENSEDPRODUCTID,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_CODE AS PRODUCTCATEGORYCODE,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION  AS  PRODUCTCATEGORYDESCRIPTION,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Debit'
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF(
        f_payment_transactions.CARD_NETWORK = 'MASTERCARD', --condition
        --true ('MASTERCARD')
        IF(f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION = 'Prepaid',
          'Debit',
          f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION
          ),
        --false (!='MASTERCARD')
        IF(
            f_payment_transactions.CARD_NETWORK = 'VISA',
            IF( f_payment_transactions.CARD_FUNDING_SOURCE = 'Prepaid',
              'Debit',
              F_Payment_transactions.CARD_FUNDING_SOURCE
            ),
            'NA'
          )
          )
    ELSE 'NA'
    END AS CARDFUNCTION,
  f_payment_transactions.CARD_FUNDING_SOURCE  AS ACCOUNTFUNDINGSOURCE,
  d_merchants.T_SOURCE_PK_UUID AS MERCHANT_PUBLIC_IDENTIFIER,
  f_payment_items.PAYMENT_ITEM_AMOUNT  AS AMOUNT,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  f_payment_transactions.CARD_NETWORK,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE` AS map  ON f_payment_transactions.SCA_RESULT = map.SCA_RESULT
WHERE (d_merchants.MERCHANT_COUNTRY ) IS NOT NULL
    AND d_payment_products.PRODUCT_CODE IN ('BANCONTACT_COLLECT', 'SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
),
exeption_records as(
SELECT
  PRODUCT,
  PAYERCOUNTRY,
  MERCHANTCOUNTRY,
  PCP_TYPE,
  SINGLEWIP,
  TRANSACTION_PUBLIC_IDENTIFIER,
  CARD_COUNTRY,
  NETWORK_CODE,
  SCA_RESULT,
  SCA_REASON,
  LICENSEDPRODUCTID,
  PRODUCTCATEGORYCODE,
  PRODUCTCATEGORYDESCRIPTION,
  "Credit" AS CARDFUNCTION,
  ACCOUNTFUNDINGSOURCE,
  MERCHANT_PUBLIC_IDENTIFIER,
  AMOUNT,
  CURRENCY,
  CARD_NETWORK,
  LOAD_TIMESTAMP,
  Period,
  Period_begin_date,
  Period_end_date,
FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
),
execpted_records as(
SELECT * FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER NOT IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
)
SELECT * FROM exeption_records
UNION ALL
SELECT * FROM execpted_records
    );
  
[0m10:30:30.275379 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m10:30:30.277110 [debug] [Thread-11 ]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
      
    
    

    OPTIONS()
    as (
      SELECT
    payee_psp_country,
    outbound_ibis_payments_trx_count,
    outbound_ibis_payments_amount_sum_in_EUR,
    SUM(outbound_ibis_payments_trx_count) OVER(PARTITION BY period) AS total_outbound_ibis_payments_trx_count,
    SUM(outbound_ibis_payments_amount_sum_in_EUR) OVER(PARTITION BY period) AS total_outbound_ibis_payments_amount_sum_in_EUR,
    load_timestamp,
    period
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
    );
  
[0m10:30:30.352003 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:234d8fed-1736-43ad-9d22-c12985547ab0&page=queryresults
[0m10:30:30.905074 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4fcf39ff-4354-4a2d-a176-4db940d92721&page=queryresults
[0m10:30:31.040386 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2dfe46a6-717e-41e5-8603-5a48908d0021&page=queryresults
[0m10:30:31.901548 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836cf76f80>]}
[0m10:30:31.903438 [info ] [Thread-10 ]: 55 of 88 OK created sql incremental model dev_dm_pst3_BE.PIS ................... [[32mCREATE TABLE (20.0 rows, 44.7 GiB processed)[0m in 22.83s]
[0m10:30:31.905063 [debug] [Thread-10 ]: Finished running node model.project_dbt.PIS
[0m10:30:31.906163 [debug] [Thread-10 ]: Began running node model.project_dbt.PAY_TROP_5845
[0m10:30:31.907281 [info ] [Thread-10 ]: 84 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 .............. [RUN]
[0m10:30:31.908205 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.PIS, now model.project_dbt.PAY_TROP_5845)
[0m10:30:31.908912 [debug] [Thread-10 ]: Began compiling node model.project_dbt.PAY_TROP_5845
[0m10:30:31.916409 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845"
[0m10:30:31.917611 [debug] [Thread-10 ]: Began executing node model.project_dbt.PAY_TROP_5845
[0m10:30:31.920569 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:30:32.522072 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845"
[0m10:30:32.523961 [debug] [Thread-10 ]: On model.project_dbt.PAY_TROP_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
  -- COALESCE(cmd_deb.identifier,cmd_cre.identifier) AS payment_account_number,
  -- COALESCE(cmd_deb.enterprise_number,cmd_cre.enterprise_number) AS enterprise_number,
  -- COALESCE(cmd_deb.legal_form,cmd_cre.legal_form) AS legal_form,
  -- COALESCE(cmd_deb.country,cmd_cre.country) AS country,
  -- COALESCE(cmd_deb.postal_code,cmd_cre.postal_code) AS postal_code,
  bis.Ot,
  bis.Ref,
  bis.ORef,
  bis.debtor_account_identifier,
  bis.creditor_account_identifier,
  bis.Ord,
  bis.Ben,
  bis.PayID,
  bis.BICOrd,
  bis.BICBen,
  bis.BICSen,
  bis.BICRec,
  bis.PasOrd,
  bis.PasBen,
  bis.LEIOrd,
  bis.LEIBen,
  bis.Sch,
  bis.Pro,
  bis.DtLiq,
  bis.DtPISP,
  bis.TsOrd,
  bis.TsBen,
  bis.TipTR,
  bis.Div,
  bis.Mont,
  bis.MontOrg,
  bis.TipCan,
  bis.FormEnv,
  bis.OperElet,
  bis.OperRem,
  bis.OperECom,
  bis.IniPISP,
  bis.ModAc,
  bis.SCA,
  bis.MnonSCA,
  bis.SI,
  bis.PasmC,
  bis.PasnC,
  bis.CPosm,
  bis.TipDoc,
  bis.NumDoc,
  bis.LEIC,
  bis.ENI,
  bis.InfUltBen,
  bis.InfUltOrd,
  bis.Period,
  bis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS` AS bis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_deb
--   ON bis.debtor_account_identifier = cmd_deb.identifier
--   AND bis.Ot = 'O'
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--   ON bis.creditor_account_identifier = cmd_cre.identifier
--   AND bis.Ot = 'B'
UNION ALL
SELECT
  -- cmd_cre.identifier as payment_account_number,
  -- cmd_cre.enterprise_number,
  -- cmd_cre.legal_form,
  -- cmd_cre.country,
  -- cmd_cre.postal_code,
  pis.Ot,
  pis.Ref,
  pis.ORef,
  pis.debtor_account_identifier,
  pis.creditor_account_identifier,
  pis.Ord,
  pis.Ben,
  pis.PayID,
  pis.BICOrd,
  pis.BICBen,
  pis.BICSen,
  pis.BICRec,
  pis.PasOrd,
  pis.PasBen,
  pis.LEIOrd,
  pis.LEIBen,
  pis.Sch,
  pis.Pro,
  NULL AS DtLiq,
  pis.DtPISP,
  pis.TsOrd,
  pis.TsBen,
  pis.TipTR,
  pis.Div,
  pis.Mont,
  pis.MontOrg,
  pis.TipCan,
  pis.FormEnv,
  pis.OperElet,
  pis.OperRem,
  pis.OperECom,
  pis.IniPISP,
  pis.ModAc,
  pis.SCA,
  pis.MnonSCA,
  pis.SI,
  pis.PasmC,
  pis.PasnC,
  pis.CPosm,
  pis.TipDoc,
  pis.NumDoc,
  pis.LEIC,
  pis.ENI,
  pis.InfUltBen,
  pis.InfUltOrd,
  pis.Period,
  pis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS` AS pis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--  ON pis.creditor_account_identifier = cmd_cre.identifier
    );
  
[0m10:30:33.045537 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c2e3ab08-b94c-480f-94d5-ef122c6415c3&page=queryresults
[0m10:30:33.292529 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c200820>]}
[0m10:30:33.293308 [info ] [Thread-11 ]: 82 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [[32mCREATE TABLE (8.0 rows, 304.0 Bytes processed)[0m in 3.83s]
[0m10:30:33.293954 [debug] [Thread-11 ]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:30:33.294600 [debug] [Thread-11 ]: Began running node model.project_dbt.Cross_join
[0m10:30:33.295115 [info ] [Thread-11 ]: 85 of 88 START sql incremental model dev_dm_pst3_FR.Cross_join ................. [RUN]
[0m10:30:33.295582 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals, now model.project_dbt.Cross_join)
[0m10:30:33.296020 [debug] [Thread-11 ]: Began compiling node model.project_dbt.Cross_join
[0m10:30:33.302513 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.Cross_join"
[0m10:30:33.303071 [debug] [Thread-11 ]: Began executing node model.project_dbt.Cross_join
[0m10:30:33.305601 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:30:33.687839 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f0bf10>]}
[0m10:30:33.689499 [info ] [Thread-7 (]: 67 of 88 OK created sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [[32mCREATE TABLE (7.0 rows, 38.5 GiB processed)[0m in 12.23s]
[0m10:30:33.691264 [debug] [Thread-7 (]: Finished running node model.project_dbt.V1110_payment_initiation_services
[0m10:30:33.888392 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.Cross_join"
[0m10:30:33.889351 [debug] [Thread-11 ]: On model.project_dbt.Cross_join: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Cross_join`
      
    
    

    OPTIONS()
    as (
      WITH type AS (
  SELECT
    'agMoyPaiTypeOpeCanalTransactZoneGeo' AS axe,
    'VIREMENT' AS moyenPaiementtype,
    'VIR_EMIS' AS Operationtype,
    'ELECTRONIQUE' AS canaltype,
    'DISTANCE' AS typeTransaction,
    'axe1'  AS alias
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeo', 'VIREMENT', 'VIR_EMIS', 'ELECTRONIQUE', 'PROXIMITE', 'axe1'
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc', 'CARTE', 'CARTE_EMIS', 'ELECTRONIQUE', 'DISTANCE', 'axe2'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'PRELEVEM', 'PRELEVEM_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'MON_ELEC', 'PAIEMT_ME_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'CHEQ', 'CHEQ_RECU', 'NA', 'NA', 'axe3'
),
final as (
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    mcc.Coded as MCC_code
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe = 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc' and typeTransaction = 'DISTANCE'
  UNION ALL
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    NULL as MCC_code,
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe <> 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc'
)
SELECT
axe,
alias,
moyenPaiementtype,
Operationtype,
canaltype,
typeTransaction,
'5493004MX17L5E8MUB29' AS LEI,
payee_psp_country,
COALESCE(outbound_ibis_payments_trx_count, 0) AS outbound_ibis_payments_trx_count,
COALESCE(outbound_ibis_payments_amount_sum_in_EUR, 0) AS outbound_ibis_payments_amount_sum_in_EUR,
COALESCE(total_outbound_ibis_payments_trx_count, 0) AS total_outbound_ibis_payments_trx_count,
COALESCE(total_outbound_ibis_payments_amount_sum_in_EUR, 0) AS total_outbound_ibis_payments_amount_sum_in_EUR,
load_timestamp,
period,
FROM final
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
ON payee_psp_country = country_code
    );
  
[0m10:30:33.954351 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dab8820>]}
[0m10:30:33.955721 [info ] [Thread-1 (]: 70 of 88 OK created sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts  [[32mCREATE TABLE (2.0 rows, 4.1 GiB processed)[0m in 12.48s]
[0m10:30:33.956246 [debug] [Thread-1 (]: Finished running node model.project_dbt.V1220_stock_of_accounts
[0m10:30:34.457824 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:3ea06553-a290-4641-8223-1a7a55fa40cf&page=queryresults
[0m10:30:34.930800 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f08970>]}
[0m10:30:34.932486 [info ] [Thread-5 (]: 69 of 88 OK created sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 13.46s]
[0m10:30:34.934145 [debug] [Thread-5 (]: Finished running node model.project_dbt.V121_customer_credit_transfers_received
[0m10:30:35.491525 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e1df790>]}
[0m10:30:35.493279 [info ] [Thread-10 ]: 84 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 ......... [[32mCREATE TABLE (4.0 rows, 802.0 Bytes processed)[0m in 3.58s]
[0m10:30:35.494947 [debug] [Thread-10 ]: Finished running node model.project_dbt.PAY_TROP_5845
[0m10:30:35.566988 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e2bc1c0>]}
[0m10:30:35.568653 [info ] [Thread-8 (]: 68 of 88 OK created sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [[32mCREATE TABLE (0.0 rows, 55.9 GiB processed)[0m in 14.11s]
[0m10:30:35.570356 [debug] [Thread-8 (]: Finished running node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:30:35.610165 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e207700>]}
[0m10:30:35.611817 [info ] [Thread-14 ]: 74 of 88 OK created sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 12.90s]
[0m10:30:35.613419 [debug] [Thread-14 ]: Finished running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:30:35.916564 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836e204ee0>]}
[0m10:30:35.917215 [info ] [Thread-6 (]: 79 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 9.42s]
[0m10:30:35.917752 [debug] [Thread-6 (]: Finished running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:30:36.830813 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfbe830>]}
[0m10:30:36.833059 [info ] [Thread-15 ]: 73 of 88 OK created sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 15.16s]
[0m10:30:36.834884 [debug] [Thread-15 ]: Finished running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:30:37.145039 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfbcc70>]}
[0m10:30:37.146742 [info ] [Thread-4 (]: 80 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 9.95s]
[0m10:30:37.148831 [debug] [Thread-4 (]: Finished running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:30:37.483880 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836771bf40>]}
[0m10:30:37.485625 [info ] [Thread-11 ]: 85 of 88 OK created sql incremental model dev_dm_pst3_FR.Cross_join ............ [[32mCREATE TABLE (489.0k rows, 1.4 KiB processed)[0m in 4.19s]
[0m10:30:37.487549 [debug] [Thread-11 ]: Finished running node model.project_dbt.Cross_join
[0m10:30:39.792226 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c3f7ca0>]}
[0m10:30:39.793344 [info ] [Thread-2 (]: 81 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS9_PCT .............. [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 10.84s]
[0m10:30:39.793904 [debug] [Thread-2 (]: Finished running node model.project_dbt.ZVS9_PCT
[0m10:30:39.893646 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367719390>]}
[0m10:30:40.807947 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367f0ae90>]}
[0m10:30:41.716646 [info ] [Thread-12 ]: 78 of 88 OK created sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [[32mCREATE TABLE (0.0 rows, 30.0 GiB processed)[0m in 14.17s]
[0m10:30:41.718312 [info ] [Thread-16 ]: 75 of 88 OK created sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 17.25s]
[0m10:30:41.721007 [debug] [Thread-12 ]: Finished running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:30:41.722609 [debug] [Thread-16 ]: Finished running node model.project_dbt.V140_SEPA_R_transactions
[0m10:30:56.476054 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c3a5b10>]}
[0m10:30:56.477827 [info ] [Thread-13 ]: 83 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP ................... [[32mCREATE TABLE (998.3k rows, 84.9 GiB processed)[0m in 27.00s]
[0m10:30:56.479580 [debug] [Thread-13 ]: Finished running node model.project_dbt.PCP
[0m10:30:56.481403 [debug] [Thread-7 (]: Began running node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:30:56.482956 [info ] [Thread-7 (]: 86 of 88 START sql incremental model dev_dm_pst3_BE.PCP_MERCHANT_ACCT_TRX ...... [RUN]
[0m10:30:56.484111 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1110_payment_initiation_services, now model.project_dbt.PCP_MERCHANT_ACCT_TRX)
[0m10:30:56.485282 [debug] [Thread-7 (]: Began compiling node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:30:56.491843 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m10:30:56.492388 [debug] [Thread-7 (]: Began executing node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:30:56.494827 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:30:57.130739 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m10:30:57.132595 [debug] [Thread-7 (]: On model.project_dbt.PCP_MERCHANT_ACCT_TRX: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX`
      
    
    

    OPTIONS()
    as (
      WITH pre AS(
  SELECT
      pcp.PRODUCT,
      pcp.TRANSACTION_PUBLIC_IDENTIFIER,
      pcp.PAYERCOUNTRY,
      pcp.MERCHANTCOUNTRY,
      pcp.AMOUNT,
      pcp.CURRENCY,
      pcp.MERCHANT_PUBLIC_IDENTIFIER,
      IF(ocs.companyid_tobeexcluded IS NULL, "BE", ocs.to_be_reported_in_country) AS TO_BE_REPORTED_IN_COUNTRY,
      CASE
          WHEN pcp.PRODUCT = 'BANCONTACT_COLLECT' THEN pcp.PAYERCOUNTRY
          WHEN pcp.CARD_NETWORK = 'MASTERCARD' THEN pcp.CARD_COUNTRY
          WHEN pcp.CARD_NETWORK = 'VISA' THEN pcp.CARD_COUNTRY
          ELSE "no match"
      END AS COUNTERPARTY_AREA,
      pcp.MERCHANTCOUNTRY AS POS_LOCATION,
      pcp.CARDFUNCTION,
      pcp.singleWIP AS WIP_TRANSACTION,
      Case
        WHEN PCP.PRODUCT = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND PCP.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND pcp.CARD_NETWORK = 'VISA' THEN 'Visa'
      END AS CARD_NETWORK,
      pcp.SCA_REASON,
      '2000' AS INTTN_CHNNL,
      'R' AS RMT_INTTN,
      'PCS_ALL' AS PYMNT_SCHM,
      '_Z' AS FRD_TYP,
      pcp.LOAD_TIMESTAMP,
      pcp.PERIOD,
      pcp.Period_begin_date,
      pcp.Period_end_date,
  FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP` AS pcp
  LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS` as ocs
    ON ocs.companyid_tobeexcluded = pcp.TRANSACTION_PUBLIC_IDENTIFIER
  ),
  code as(
  SELECT pre.*,
   IF(pre.TO_BE_REPORTED_IN_COUNTRY = pre.COUNTERPARTY_AREA,
        'W2',
        pre.COUNTERPARTY_AREA) AS AREA_CODE,
    IF( pre.TO_BE_REPORTED_IN_COUNTRY = pre.POS_LOCATION,
        'W2',
        pre.POS_LOCATION) AS LOCATION_CODE,
    CASE pre.CARDFUNCTION
      WHEN 'Debit' THEN '11'
      WHEN 'Credit' THEN '13'
      WHEN 'Deferred Debit' THEN '12'
      ELSE '_Z'
    END AS CRD_FNCTN,
  FROM pre
)
SELECT
   code.*EXCEPT(AREA_CODE,LOCATION_CODE,LOAD_TIMESTAMP,PERIOD),
  COALESCE(pst3_cp.CODE, 'Extra EEA')  AS COUNT_AREA,
  COALESCE(pst3_pos.CODE, 'Extra EEA') AS TRMNL_LCTN,
  pst3_sca.CODE AS SCA,
  LOAD_TIMESTAMP,
  PERIOD,
FROM code
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_cp
    ON code.AREA_CODE = pst3_cp.CODE
    AND pst3_cp.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_pos
    ON code.LOCATION_CODE = pst3_pos.CODE
    AND pst3_pos.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_sca
    ON code.SCA_REASON = pst3_sca.name
    AND pst3_sca.TYPE = 'Strong customer authentication (SCA)'
    );
  
[0m10:30:57.752170 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e3a063e5-da9f-43ec-b17e-a04aadba4195&page=queryresults
[0m10:31:00.060278 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dfbe2f0>]}
[0m10:31:00.062053 [info ] [Thread-9 (]: 76 of 88 OK created sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [[32mCREATE TABLE (0.0 rows, 170.9 GiB processed)[0m in 36.32s]
[0m10:31:00.063672 [debug] [Thread-9 (]: Finished running node model.project_dbt.V142_intermediated_payment_transactions
[0m10:31:06.409198 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728367b2c730>]}
[0m10:31:06.410974 [info ] [Thread-7 (]: 86 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_MERCHANT_ACCT_TRX . [[32mCREATE TABLE (998.3k rows, 187.6 MiB processed)[0m in 9.93s]
[0m10:31:06.411811 [debug] [Thread-7 (]: Finished running node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:31:06.412434 [debug] [Thread-5 (]: Began running node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m10:31:06.412815 [debug] [Thread-10 ]: Began running node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m10:31:06.413317 [info ] [Thread-5 (]: 87 of 88 START sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_CARD ...... [RUN]
[0m10:31:06.413785 [info ] [Thread-10 ]: 88 of 88 START sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_SCA ....... [RUN]
[0m10:31:06.414210 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.V121_customer_credit_transfers_received, now model.project_dbt.PCP_BREAKDOWN_BY_CARD)
[0m10:31:06.414502 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845, now model.project_dbt.PCP_BREAKDOWN_BY_SCA)
[0m10:31:06.415015 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m10:31:06.415588 [debug] [Thread-10 ]: Began compiling node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m10:31:06.425520 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PCP_BREAKDOWN_BY_CARD"
[0m10:31:06.432573 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.PCP_BREAKDOWN_BY_SCA"
[0m10:31:06.434743 [debug] [Thread-5 (]: Began executing node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m10:31:06.440635 [debug] [Thread-10 ]: Began executing node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m10:31:06.443191 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:31:06.444088 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:31:07.132504 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PCP_BREAKDOWN_BY_CARD"
[0m10:31:07.135198 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.PCP_BREAKDOWN_BY_SCA"
[0m10:31:07.136991 [debug] [Thread-5 (]: On model.project_dbt.PCP_BREAKDOWN_BY_CARD: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_BREAKDOWN_BY_CARD`
      
    
    

    OPTIONS()
    as (
      SELECT
    ma.COUNT_AREA,
    ma.TRMNL_LCTN,
    ma.INTTN_CHNNL,
    ma.RMT_INTTN,
    ma.PYMNT_SCHM,
    ma.CRD_FNCTN AS CRD_FCTN,
    ma.FRD_TYP,
    COUNT(ma.TRANSACTION_PUBLIC_IDENTIFIER) AS COUNT_OF_TRANSACTION_PUBLIC_IDENTIFIER,
    SUM(ma.AMOUNT) AS SUM_OF_AMOUNT,
    ma.Period,
    ma.Period_begin_date,
    ma.Period_end_date,
    ma.LOAD_TIMESTAMP,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX` as ma
GROUP BY 1,2,3,4,5,6,7,10,11,12,13
    );
  
[0m10:31:07.140492 [debug] [Thread-10 ]: On model.project_dbt.PCP_BREAKDOWN_BY_SCA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_BREAKDOWN_BY_SCA`
      
    
    

    OPTIONS()
    as (
      SELECT
    ma.COUNT_AREA,
    ma.TRMNL_LCTN,
    ma.INTTN_CHNNL,
    ma.RMT_INTTN,
    ma.PYMNT_SCHM,
    ma.SCA,
    ma.FRD_TYP,
    COUNT(ma.TRANSACTION_PUBLIC_IDENTIFIER) AS COUNT_OF_TRANSACTION_PUBLIC_IDENTIFIER,
    SUM(ma.AMOUNT) AS SUM_OF_AMOUNT,
    ma.Period,
    ma.Period_begin_date,
    ma.Period_end_date,
    ma.LOAD_TIMESTAMP,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX` as ma
GROUP BY 1,2,3,4,5,6,7,10,11,12,13
    );
  
[0m10:31:07.667751 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bc418cb8-d97f-4b10-9cd2-cf51830b11a2&page=queryresults
[0m10:31:07.719377 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:03d60b41-1e14-442e-a5e8-00664c61bcc0&page=queryresults
[0m10:31:10.186913 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836dc285b0>]}
[0m10:31:10.188647 [info ] [Thread-5 (]: 87 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_CARD . [[32mCREATE TABLE (113.0 rows, 115.1 MiB processed)[0m in 3.77s]
[0m10:31:10.190258 [debug] [Thread-5 (]: Finished running node model.project_dbt.PCP_BREAKDOWN_BY_CARD
[0m10:31:10.607193 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42fc2e2f-aad9-46b5-9ac6-71044a83c448', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72836c7e8ee0>]}
[0m10:31:10.608932 [info ] [Thread-10 ]: 88 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_BREAKDOWN_BY_SCA .. [[32mCREATE TABLE (73.0 rows, 116.1 MiB processed)[0m in 4.19s]
[0m10:31:10.610619 [debug] [Thread-10 ]: Finished running node model.project_dbt.PCP_BREAKDOWN_BY_SCA
[0m10:32:06.376671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed410781c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed3f556e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed3f50eef0>]}


============================== 10:32:06.386183 | bc46e989-2a4c-4092-b577-09299f4f6abc ==============================
[0m10:32:06.386183 [info ] [MainThread]: Running with dbt=1.8.7
[0m10:32:06.386673 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/home/hkhnhan/BTX/btx_dwh_transformations/dbt/logs', 'profiles_dir': '/home/hkhnhan/BTX//btx_dwh_transformations/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug --config-dir', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:32:06.392021 [info ] [MainThread]: To view your profiles.yml file, run:

xdg-open /home/hkhnhan/BTX//btx_dwh_transformations/dbt
[0m10:32:06.392716 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 0.049139485, "process_user_time": 0.7453, "process_kernel_time": 0.045261, "process_mem_max_rss": "87872", "process_in_blocks": "2568", "process_out_blocks": "8"}
[0m10:32:06.393208 [debug] [MainThread]: Command `dbt debug` succeeded at 10:32:06.393140 after 0.05 seconds
[0m10:32:06.393517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed410781c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed3f556e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73ed3f50eb60>]}
[0m10:32:06.393856 [debug] [MainThread]: Flushing usage events
[0m10:32:36.261086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d6987842b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d696f0b100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d696f0b400>]}


============================== 10:32:36.262973 | bcd22217-83a5-4580-9bab-a25b949ae071 ==============================
[0m10:32:36.262973 [info ] [MainThread]: Running with dbt=1.8.7
[0m10:32:36.263518 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/home/hkhnhan/BTX//btx_dwh_transformations/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/home/hkhnhan/BTX/btx_dwh_transformations/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --full-refresh --select PST3', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:32:36.810506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d696f0bdc0>]}
[0m10:32:36.846984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d698a13f10>]}
[0m10:32:36.847539 [info ] [MainThread]: Registered adapter: bigquery=1.8.2
[0m10:32:36.860143 [debug] [MainThread]: checksum: 4af21dafb485259c48497ac86b711ddb1982f3d0f1c0ca4e09356de488b753c0, vars: {}, profile: , target: , version: 1.8.7
[0m10:32:36.992829 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:32:36.993225 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:32:36.994401 [warn ] [MainThread]: [[33mWARNING[0m]: Found spaces in the name of
`model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs`
[0m10:32:36.994819 [warn ] [MainThread]: [[33mWARNING[0m]: Spaces found in 1 resource name(s). This is deprecated, and
may lead to errors when using dbt. For more information: https://docs.getdbt.com
/reference/global-configs/legacy-behaviors#require_resource_names_without_spaces
Run again with `--debug` to see them all.
[0m10:32:36.995138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d6788af730>]}
[0m10:32:37.005557 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.project_dbt.STRH.mart
[0m10:32:37.094819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d6786afd90>]}
[0m10:32:37.249089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d678af61a0>]}
[0m10:32:37.249608 [info ] [MainThread]: Found 185 models, 126 sources, 613 macros
[0m10:32:37.249963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bcd22217-83a5-4580-9bab-a25b949ae071', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d698679f00>]}
[0m10:32:37.255909 [info ] [MainThread]: 
[0m10:32:37.256418 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:32:37.264045 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.264523 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.264867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.265412 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.265802 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.266354 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.266704 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.267090 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.267760 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.268155 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.268570 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.269385 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.270002 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:32:37.273425 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.271298 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.271965 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.272366 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:32:37.270642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:22.226711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc40d7c220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc407308b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc3f502c80>]}


============================== 10:33:22.228561 | d9c7fc01-cd37-4861-82f5-2369ca3da9b0 ==============================
[0m10:33:22.228561 [info ] [MainThread]: Running with dbt=1.8.7
[0m10:33:22.229027 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/home/hkhnhan/BTX/btx_dwh_transformations/dbt/logs', 'profiles_dir': '/home/hkhnhan/BTX//btx_dwh_transformations/dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --full-refresh --select PST3', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:33:22.755789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21284fa0>]}
[0m10:33:22.791491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc40763bb0>]}
[0m10:33:22.792017 [info ] [MainThread]: Registered adapter: bigquery=1.8.2
[0m10:33:22.806574 [debug] [MainThread]: checksum: 4af21dafb485259c48497ac86b711ddb1982f3d0f1c0ca4e09356de488b753c0, vars: {}, profile: , target: , version: 1.8.7
[0m10:33:22.937488 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:33:22.937895 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:33:22.939080 [warn ] [MainThread]: [[33mWARNING[0m]: Found spaces in the name of
`model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs`
[0m10:33:22.939501 [warn ] [MainThread]: [[33mWARNING[0m]: Spaces found in 1 resource name(s). This is deprecated, and
may lead to errors when using dbt. For more information: https://docs.getdbt.com
/reference/global-configs/legacy-behaviors#require_resource_names_without_spaces
Run again with `--debug` to see them all.
[0m10:33:22.939952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20eab190>]}
[0m10:33:22.950903 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.project_dbt.STRH.mart
[0m10:33:23.039261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20cb6260>]}
[0m10:33:23.193601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210f0bb0>]}
[0m10:33:23.194172 [info ] [MainThread]: Found 185 models, 126 sources, 613 macros
[0m10:33:23.194551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc40b95210>]}
[0m10:33:23.201319 [info ] [MainThread]: 
[0m10:33:23.201781 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:33:23.208996 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.209450 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.209935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.210376 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.210691 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.211518 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.212395 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.213320 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.213699 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.214275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.214742 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.215171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.215491 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.216146 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx'
[0m10:33:23.216980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.217508 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.218579 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:23.219629 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:25.614027 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dl_h3_hehe)
[0m10:33:25.614548 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.614892 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_FR)
[0m10:33:25.616345 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_PT)
[0m10:33:25.616830 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_LU)
[0m10:33:25.617183 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.617796 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk)
[0m10:33:25.618539 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.618996 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_staging_view_cmd)
[0m10:33:25.619318 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.619719 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_BE)
[0m10:33:25.620834 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dl_h3_hklc)
[0m10:33:25.621198 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.621557 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx, now list_pj-bu-dw-data-sbx_dev_dm_pst3_NL)
[0m10:33:25.622770 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.623084 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_ES'
[0m10:33:25.623599 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dwh_view_cmd'
[0m10:33:25.624709 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_LV'
[0m10:33:25.625005 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.625462 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_DE'
[0m10:33:25.625934 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_pj-bu-dw-data-sbx_dev_dm_pst3_IT'
[0m10:33:25.626231 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.627271 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:33:25.628218 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:25.628529 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:25.628822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:25.629875 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:25.630209 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:33:26.273839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc212da230>]}
[0m10:33:26.274460 [info ] [MainThread]: Concurrency: 16 threads (target='dev')
[0m10:33:26.274851 [info ] [MainThread]: 
[0m10:33:26.278193 [debug] [Thread-1 (]: Began running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:33:26.278680 [debug] [Thread-2 (]: Began running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:33:26.279204 [info ] [Thread-1 (]: 1 of 88 START sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ........ [RUN]
[0m10:33:26.279664 [debug] [Thread-3 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:33:26.280078 [info ] [Thread-2 (]: 2 of 88 START sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS . [RUN]
[0m10:33:26.280521 [debug] [Thread-4 (]: Began running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:33:26.280977 [debug] [Thread-5 (]: Began running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:33:26.281532 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dwh_view_cmd, now model.project_dbt.52505_NR_OF_ACCOUNTS)
[0m10:33:26.282167 [debug] [Thread-6 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:33:26.282906 [debug] [Thread-7 (]: Began running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:33:26.283461 [debug] [Thread-8 (]: Began running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:33:26.283963 [info ] [Thread-3 (]: 3 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS  [RUN]
[0m10:33:26.284395 [debug] [Thread-9 (]: Began running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:33:26.284808 [debug] [Thread-10 ]: Began running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:33:26.285098 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_IT, now model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS)
[0m10:33:26.285497 [debug] [Thread-11 ]: Began running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:33:26.285928 [debug] [Thread-12 ]: Began running node model.project_dbt.A1_Number_of_payment_accounts
[0m10:33:26.286287 [debug] [Thread-13 ]: Began running node model.project_dbt.Banque_en_ligne
[0m10:33:26.287009 [debug] [Thread-14 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:33:26.287430 [debug] [Thread-15 ]: Began running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:33:26.286740 [info ] [Thread-4 (]: 4 of 88 START sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [RUN]
[0m10:33:26.288220 [debug] [Thread-16 ]: Began running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:33:26.287951 [info ] [Thread-5 (]: 5 of 88 START sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [RUN]
[0m10:33:26.288662 [debug] [Thread-1 (]: Began compiling node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:33:26.289079 [info ] [Thread-6 (]: 6 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [RUN]
[0m10:33:26.289549 [info ] [Thread-7 (]: 7 of 88 START sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [RUN]
[0m10:33:26.290023 [info ] [Thread-8 (]: 8 of 88 START sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS ... [RUN]
[0m10:33:26.290384 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hklc, now model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS)
[0m10:33:26.290841 [info ] [Thread-9 (]: 9 of 88 START sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT . [RUN]
[0m10:33:26.291286 [info ] [Thread-10 ]: 10 of 88 START sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [RUN]
[0m10:33:26.291678 [debug] [Thread-2 (]: Began compiling node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:33:26.292074 [info ] [Thread-11 ]: 11 of 88 START sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [RUN]
[0m10:33:26.292606 [info ] [Thread-12 ]: 12 of 88 START sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [RUN]
[0m10:33:26.293214 [info ] [Thread-13 ]: 13 of 88 START sql incremental model dev_dm_pst3_FR.Banque_en_ligne ............ [RUN]
[0m10:33:26.293881 [info ] [Thread-14 ]: 14 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [RUN]
[0m10:33:26.294411 [info ] [Thread-15 ]: 15 of 88 START sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [RUN]
[0m10:33:26.294840 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_FR, now model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS)
[0m10:33:26.295483 [info ] [Thread-16 ]: 16 of 88 START sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [RUN]
[0m10:33:26.296031 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h1_hkvk, now model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS)
[0m10:33:26.323120 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_staging_view_cmd, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN)
[0m10:33:26.329143 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m10:33:26.329591 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_BE, now model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK)
[0m10:33:26.329951 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LU, now model.project_dbt.58746_PAYMENT_INITIATIONS)
[0m10:33:26.330393 [debug] [Thread-3 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:33:26.330709 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dl_h3_hehe, now model.project_dbt.58788_AIS_USERS_AND_ACCOUNT)
[0m10:33:26.331079 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_PT, now model.project_dbt.58789_AIS_USERS_AND_ACCOUNT)
[0m10:33:26.397482 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_NL, now model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs)
[0m10:33:26.398245 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_ES, now model.project_dbt.A1_Number_of_payment_accounts)
[0m10:33:26.401493 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m10:33:26.401886 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_LV, now model.project_dbt.Banque_en_ligne)
[0m10:33:26.402337 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly list_pj-bu-dw-data-sbx_dev_dm_pst3_DE, now model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI)
[0m10:33:26.402797 [debug] [Thread-15 ]: Acquiring new bigquery connection 'model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU'
[0m10:33:26.403220 [debug] [Thread-4 (]: Began compiling node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:33:26.403662 [debug] [Thread-16 ]: Acquiring new bigquery connection 'model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo'
[0m10:33:26.404077 [debug] [Thread-5 (]: Began compiling node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:33:26.404536 [debug] [Thread-6 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:33:26.405106 [debug] [Thread-7 (]: Began compiling node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:33:26.405582 [debug] [Thread-8 (]: Began compiling node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:33:26.405954 [debug] [Thread-1 (]: Began executing node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:33:26.411307 [debug] [Thread-3 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m10:33:26.411709 [debug] [Thread-9 (]: Began compiling node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:33:26.412176 [debug] [Thread-10 ]: Began compiling node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:33:26.412573 [debug] [Thread-11 ]: Began compiling node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:33:26.412999 [debug] [Thread-12 ]: Began compiling node model.project_dbt.A1_Number_of_payment_accounts
[0m10:33:26.413511 [debug] [Thread-2 (]: Began executing node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:33:26.413905 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Banque_en_ligne
[0m10:33:26.414315 [debug] [Thread-14 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:33:26.414698 [debug] [Thread-15 ]: Began compiling node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:33:26.420297 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m10:33:26.420749 [debug] [Thread-16 ]: Began compiling node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:33:26.426339 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m10:33:26.430636 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m10:33:26.435325 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m10:33:26.444221 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m10:33:26.475313 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m10:33:26.478168 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:33:26.482624 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m10:33:26.486462 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m10:33:26.487002 [debug] [Thread-3 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS
[0m10:33:26.490399 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m10:33:26.492665 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:33:26.496035 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Banque_en_ligne"
[0m10:33:26.499788 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m10:33:26.504110 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m10:33:26.504781 [debug] [Thread-4 (]: Began executing node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:33:26.509230 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m10:33:26.509933 [debug] [Thread-5 (]: Began executing node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:33:26.510394 [debug] [Thread-6 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:33:26.510960 [debug] [Thread-7 (]: Began executing node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:33:26.511492 [debug] [Thread-8 (]: Began executing node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:33:26.511958 [debug] [Thread-9 (]: Began executing node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:33:26.513561 [debug] [Thread-11 ]: Began executing node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:33:26.515898 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m10:33:26.516257 [debug] [Thread-10 ]: Began executing node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:33:26.517809 [debug] [Thread-12 ]: Began executing node model.project_dbt.A1_Number_of_payment_accounts
[0m10:33:26.518246 [debug] [Thread-13 ]: Began executing node model.project_dbt.Banque_en_ligne
[0m10:33:26.518693 [debug] [Thread-14 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:33:26.521010 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:33:26.521405 [debug] [Thread-15 ]: Began executing node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:33:26.523622 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:33:26.523996 [debug] [Thread-16 ]: Began executing node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:33:26.526050 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:33:26.528649 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:33:26.530994 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:33:26.533780 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:33:26.536417 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:33:26.539785 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:33:26.543197 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:33:26.546754 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:33:26.551438 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:33:26.557871 [debug] [Thread-15 ]: Opening a new connection, currently in state init
[0m10:33:26.564906 [debug] [Thread-16 ]: Opening a new connection, currently in state init
[0m10:33:27.141455 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS"
[0m10:33:27.142578 [debug] [Thread-3 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS"
[0m10:33:27.143790 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.52505_NR_OF_ACCOUNTS"
[0m10:33:27.144275 [debug] [Thread-2 (]: On model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52525_FLOW_OF_NEW_CONTRACTS`
      
    
    

    OPTIONS()
    as (
      select
  count(*) AS number_of_new_contracts,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
WHERE
  iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND iacc.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m10:33:27.144827 [debug] [Thread-3 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_RECEIVED_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as (
  SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
  case when FAB.BALANCE_AMOUNT < 12500 then '66'
        when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
        when FAB.BALANCE_AMOUNT > 50000 then '89'
  end balance_class,
  FAT.TRANSACTION_AMOUNT AS amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
    on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
      AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND  FAB.BALANCE_DATE = (
        SELECT max(max.BALANCE_DATE)
        FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
        JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
          ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
        )
  ),
cmd as (
  SELECT
        P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
        L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
        L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
        --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
    WHERE
            LPR.ROLE = 'ACCOUNT_HOLDER'
      -- AND  ba.main is true ==> to add by CMD team (dragos)
      and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
)
SELECT * FROM credit_transfers
inner join cmd
on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m10:33:27.146944 [debug] [Thread-1 (]: On model.project_dbt.52505_NR_OF_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`52505_NR_OF_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
    IF(FAB.BALANCE_AMOUNT <= 100,'small balance', 'big balance') AS balance_size,
    iacc.account_currency,
    count(*) AS amount,
    ceil(sum (FAB.BALANCE_AMOUNT)) as booked_balance,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
WHERE
      iacc.ACCOUNT_TYPE = "PAYMENT"
  AND  iacc.ACCOUNT_COUNTRY_CODE = 'IT'
  AND  (
    iacc.ACCOUNT_STATUS = 'OPEN'
    OR (
      iacc.ACCOUNT_STATUS = 'CLOSED'
      AND iacc.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  )
  AND iacc.ACCOUNT_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND FAB.BALANCE_DATE = (
      SELECT max(BALANCE_DATE)
      FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
      JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT`  a
        ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
        WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  )
group by 1,2
    );
  
[0m10:33:27.172984 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK"
[0m10:33:27.176330 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.58746_PAYMENT_INITIATIONS"
[0m10:33:27.178806 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS"
[0m10:33:27.184832 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN"
[0m10:33:27.185319 [debug] [Thread-7 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK`
      
    
    

    OPTIONS()
    as (
      SELECT
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  ON C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
WHERE D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND D.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND D.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    );
  
[0m10:33:27.186172 [debug] [Thread-8 (]: On model.project_dbt.58746_PAYMENT_INITIATIONS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58746_PAYMENT_INITIATIONS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IF(credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '1','2') as residency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE as counterparty_country,
  IF(IT.INBOUND_TRANSACTION_CURRENCY_CODE = 'EUR', '1','2') as currencyType,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
      APP.APPLICATION_NAME = 'PAY-PXG-BANQUPIT'
      OR (
          APP.APPLICATION_NAME = 'PAY-PXG-OCS'
          AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
          AND substr( credacc.BANK_ACCOUNT_NUMBER,5,5)= '36330'
         )
      )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m10:33:27.187594 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI"
[0m10:33:27.188471 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS"
[0m10:33:27.189313 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.58788_AIS_USERS_AND_ACCOUNT"
[0m10:33:27.190205 [debug] [Thread-6 (]: On model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'report in 58726 02&04'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'report in 58726 22&24'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'report in 58726 26&28'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      ELSE 'check the query'
  END metricToBeReported,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'N/A'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then '413'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '415'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
  END SCAIndicator,
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  '396' as pisp,
  IF(SUBSTR(CBA.BANK_ACCOUNT_NUMBER,5,5) = '36330' and CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT', '398','396') AS scheme,
  count(*) AS count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as Amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB on FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  group by 1,2,3,4,5
    );
  
[0m10:33:27.191713 [debug] [Thread-4 (]: On model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS`
      
    
    

    OPTIONS()
    as (
      WITH credit_transfers as
  (
  SELECT
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'WITH TRADITIONAL MODES'
        WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'WITH AUTOMATED MODES'
    END Entrymode,
    CASE
        WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER', 'TPP','OCS') THEN 'Single entry'
        WHEN FAT.TRANSACTION_CHANNEL in ('H2H') THEN 'Batch entry'
    END BatchMode,
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    case when FAB.BALANCE_AMOUNT < 12500 then '66'
          when FAB.BALANCE_AMOUNT between 12500 and 50000 then '67'
          when FAB.BALANCE_AMOUNT > 50000 then '89'
    end balance_class,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

    FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
      ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
      ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
      ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
    LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
      ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
    JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` FAB
      ON FAB.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
    WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
      AND FAT.TRANSACTION_TYPE = 'REGULAR'
      AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND IA.ACCOUNT_TYPE = 'PAYMENT'
      AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
      AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('IT')
      AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
      AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      AND  FAB.BALANCE_DATE =
      (
          SELECT max(max.BALANCE_DATE)
          FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_BALANCE` max
          JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` a
            ON max.T_D_IBIS_ACCOUNT_DIM_KEY = a.T_DIM_KEY
          WHERE TIMESTAMP(max.BALANCE_DATE) <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
      )
  ),
  cmd as (
    SELECT
          P.T_SOURCE_PK_ID as account_Master_Data_Id_4lookup_cmd,
          L.ENTERPRISE_COUNTRY_OF_INCORPORATION,
          L.ENTERPRISE_PROVINCE_OF_INCORPORATION,
          --ba.code as ""NACEcodeToBeMappedToSettore"" ==> to add by CMD team (dragos)
      FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_CURRENT` P
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` LPR
      on LPR.T_D_PAYMENT_ACCOUNT_DIM_KEY = P.T_DIM_KEY
      inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` L
      on LPR.T_D_LEGAL_ENTITY_DIM_KEY = L.T_DIM_KEY
      WHERE
              LPR.ROLE = 'ACCOUNT_HOLDER'
        -- AND  ba.main is true ==> to add by CMD team (dragos)
        and L.ENTERPRISE_COUNTRY_OF_INCORPORATION = 'IT'
  )
  SELECT * FROM credit_transfers
  inner join cmd
  on credit_transfers.account_master_data_id_4lookup = cmd.account_Master_Data_Id_4lookup_cmd
    );
  
[0m10:33:27.193516 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo"
[0m10:33:27.195166 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Banque_en_ligne"
[0m10:33:27.196143 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.A1_Number_of_payment_accounts"
[0m10:33:27.196948 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.58789_AIS_USERS_AND_ACCOUNT"
[0m10:33:27.197767 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs"
[0m10:33:27.198332 [debug] [Thread-14 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type  = 'REGULAR'
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
  ORDER BY payee_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:33:27.198898 [debug] [Thread-5 (]: On model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58724_CREDIT_TRANSFERS_SINGLE_BASIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
    IA.ACCOUNT_MASTER_DATA_ID as account_master_data_id_4lookup,
    FAT.TRANSACTION_AMOUNT AS amount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

  WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT'
    AND FAT.TRANSACTION_CHANNEL not in ('H2H')
    );
  
[0m10:33:27.199311 [debug] [Thread-9 (]: On model.project_dbt.58788_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58788_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
SELECT
  '86' as CountryOfAISP,
  ac.USER_TOKEN,
  COUNT(*) AS number_of_consents,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
 inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
        OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
GROUP BY
            CountryOfAISP,
            ac.USER_TOKEN
)
SELECT
CountryOfAISP,
COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
FROM obsolete_and_active_consents_count_in_reporting_period
GROUP BY CountryOfAISP
order by CountryOfAISP asc
    );
  
[0m10:33:27.201414 [debug] [Thread-13 ]: On model.project_dbt.Banque_en_ligne: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Banque_en_ligne`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT( distinct ibis.ACCOUNT_MASTER_DATA_ID) AS count,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON bank.T_DIM_KEY = ibis.T_D_BANK_ACCOUNT_DIM_KEY
WHERE ibis.ACCOUNT_TYPE = "PAYMENT"
AND (ibis.ACCOUNT_STATUS = 'OPEN'
  OR
    (
      ibis.ACCOUNT_STATUS = 'CLOSED'
      AND ibis.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
)
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')))
AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND ibis.ACCOUNT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
-- as timezone('UTC', to_timestamp('2023-06-30 UTC+02', 'YYYY-MM-DD "UTC"TZH') + interval '1 day')
    );
  
[0m10:33:27.201896 [debug] [Thread-16 ]: On model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  case WHEN ftr.TRANSACTION_CHANNEL IN ('TPP') THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN ftr.TRANSACTION_CHANNEL IN ('OCS') AND ftr.TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
    WHEN ftr.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN ftr.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
    END SCAIndicator,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(ftr.TRANSACTION_DATE_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:33:27.202406 [debug] [Thread-12 ]: On model.project_dbt.A1_Number_of_payment_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A1_Number_of_payment_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) as Count,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      )
    )
  and IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:33:27.202863 [debug] [Thread-10 ]: On model.project_dbt.58789_AIS_USERS_AND_ACCOUNT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_IT`.`58789_AIS_USERS_AND_ACCOUNT`
      
    
    

    OPTIONS()
    as (
      SELECT
  '86' as CountryOfAISP,
  pa.T_SOURCE_PK_ID as account_id,
  COUNT(*) AS number_of_consents,
  COUNT(DISTINCT pa.T_SOURCE_PK_ID) AS unique_accounts_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
  ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
  ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
  ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
  ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
  ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
WHERE a.APPLICATION_NAME in ('PAY-PXG-BANQUPIT')
  AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
  AND (
    (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    )
    OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
  )
GROUP BY account_id
    );
  
[0m10:33:27.204738 [debug] [Thread-11 ]: On model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`A11_Number_of_payment_accounts_accessed_by_AISPs`
      
    
    

    OPTIONS()
    as (
      SELECT *,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` t
WHERE t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
AND SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
AND T_LOAD_TIMESTAMP is not null
    );
  
[0m10:33:27.227279 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU"
[0m10:33:27.228899 [debug] [Thread-15 ]: On model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
SELECT
  deb.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
  COUNT(*) AS inbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS inbound_ibis_payments_amount_sum_in_EUR,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
  AND ftr.transaction_type  = 'REGULAR'
GROUP BY deb.FINANCIAL_INSTITUTION_COUNTRY_CODE
ORDER BY payer_psp_country ASC
)
SELECT
   c.code,
  DM.*,
  (SELECT SUM(inbound_ibis_payments_trx_count) FROM DM WHERE payer_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(inbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payer_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payer_psp_country
    );
  
[0m10:33:27.714630 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:0691f238-9b92-4236-b634-e772f58ff1dd&page=queryresults
[0m10:33:27.734025 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:6b53b741-c325-4a78-8b55-ba1a1e37251a&page=queryresults
[0m10:33:28.035869 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:84d6ff2c-f44d-49dd-821b-58616338a397&page=queryresults
[0m10:33:28.042349 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:07be6d90-0fd5-46a2-b78c-2bbb1df3ce41&page=queryresults
[0m10:33:28.046950 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:11b59c3c-18e4-455a-9182-2b22b803bc85&page=queryresults
[0m10:33:28.049630 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b89345ef-e53b-4f5b-8b8d-71b7431888a5&page=queryresults
[0m10:33:28.052026 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e38aec9c-f119-4f99-b527-d1dc7a13d4ab&page=queryresults
[0m10:33:28.053945 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c33e19d2-d34e-4e6b-abfc-da3084a4f0cc&page=queryresults
[0m10:33:28.054510 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8bd3dc71-c500-4e03-ac6a-23dab678f25e&page=queryresults
[0m10:33:28.054986 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:30a886e8-dd86-4946-987a-1f3677625158&page=queryresults
[0m10:33:28.056663 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:f5e1cc25-52e8-4f40-bf1d-55dc43f5c461&page=queryresults
[0m10:33:28.065288 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:b930fdb4-5a92-4d2e-b924-cae7d1c17fe2&page=queryresults
[0m10:33:28.067407 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7d5bb56e-7698-488e-a3a8-f82e1e212361&page=queryresults
[0m10:33:28.068538 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:299e66f0-6508-4d67-b028-71108c5224a8&page=queryresults
[0m10:33:28.070519 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1fd24130-c4c3-44c1-b835-29f2e99aac1e&page=queryresults
[0m10:33:28.077947 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a62b897b-2c42-4344-85db-f2036edcb3cf&page=queryresults
[0m10:33:29.913587 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2047c4c0>]}
[0m10:33:29.914180 [info ] [Thread-2 (]: 2 of 88 OK created sql incremental model dev_dm_pst3_IT.52525_FLOW_OF_NEW_CONTRACTS  [[32mCREATE TABLE (1.0 rows, 87.2 KiB processed)[0m in 3.63s]
[0m10:33:29.914711 [debug] [Thread-2 (]: Finished running node model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS
[0m10:33:29.915126 [debug] [Thread-2 (]: Began running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:33:29.915516 [info ] [Thread-2 (]: 17 of 88 START sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [RUN]
[0m10:33:29.915992 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.52525_FLOW_OF_NEW_CONTRACTS, now model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo)
[0m10:33:29.916421 [debug] [Thread-2 (]: Began compiling node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:33:29.923615 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m10:33:29.924215 [debug] [Thread-2 (]: Began executing node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:33:29.931085 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:33:30.295399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2047c070>]}
[0m10:33:30.297049 [info ] [Thread-1 (]: 1 of 88 OK created sql incremental model dev_dm_pst3_IT.52505_NR_OF_ACCOUNTS ... [[32mCREATE TABLE (2.0 rows, 59.7 MiB processed)[0m in 4.01s]
[0m10:33:30.298641 [debug] [Thread-1 (]: Finished running node model.project_dbt.52505_NR_OF_ACCOUNTS
[0m10:33:30.299874 [debug] [Thread-1 (]: Began running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:33:30.301455 [info ] [Thread-1 (]: 18 of 88 START sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [RUN]
[0m10:33:30.302575 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.52505_NR_OF_ACCOUNTS, now model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo)
[0m10:33:30.303617 [debug] [Thread-1 (]: Began compiling node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:33:30.313583 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m10:33:30.314221 [debug] [Thread-1 (]: Began executing node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:33:30.317117 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:33:30.532408 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo"
[0m10:33:30.534486 [debug] [Thread-2 (]: On model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
     'Banqup applications' as TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
     AND APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
     AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
          AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'
          )
     AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3

UNION ALL

SELECT
     'OCS application' AS TYPEOFOAPPLICATION,
     IF(IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY = 'NA', credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE, IT.INBOUND_TRANSACTION_CREDITOR_COUNTRY) AS COUNTERPARTY_COUNTRY,
     IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
     COUNT(*)  AS SUCCESS_TRX_COUNT,
     SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
     ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
     ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
     ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
     ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
     ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
     ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
     ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
     ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
AND FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 4 DESC
    );
  
[0m10:33:30.892255 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2101d930>]}
[0m10:33:30.898732 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc205c2410>]}
[0m10:33:30.900639 [info ] [Thread-7 (]: 7 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 4.56s]
[0m10:33:30.902554 [info ] [Thread-11 ]: 11 of 88 OK created sql incremental model dev_dm_pst3_DE.A11_Number_of_payment_accounts_accessed_by_AISPs  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 4.50s]
[0m10:33:30.904745 [debug] [Thread-7 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK
[0m10:33:30.907726 [debug] [Thread-11 ]: Finished running node model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs
[0m10:33:30.909631 [debug] [Thread-7 (]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:33:30.911078 [debug] [Thread-11 ]: Began running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:33:30.912714 [info ] [Thread-7 (]: 19 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [RUN]
[0m10:33:30.914191 [info ] [Thread-11 ]: 20 of 88 START sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [RUN]
[0m10:33:30.915267 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN_TPPCHECK, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE)
[0m10:33:30.915657 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.A11_Number_of_payment_accounts_accessed_by_AISPs, now model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE)
[0m10:33:30.916084 [debug] [Thread-7 (]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:33:30.916534 [debug] [Thread-11 ]: Began compiling node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:33:30.924720 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m10:33:30.929629 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m10:33:30.930305 [debug] [Thread-7 (]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:33:30.930742 [debug] [Thread-11 ]: Began executing node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:33:30.933744 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:33:30.937357 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:33:30.943326 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo"
[0m10:33:30.944053 [debug] [Thread-1 (]: On model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C7_agMoyPaiTypeOpeSystZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
  case WHEN  SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) = SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN 'ON-US'
    WHEN SUBSTR(deb.BANK_ACCOUNT_NUMBER,5,5) <> SUBSTR(cred.BANK_ACCOUNT_NUMBER,5,5) THEN'OFF-US'
    ELSE 'not_mapped'
    END AS typeSysteme,
  cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
  AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.transaction_type  = 'REGULAR'
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m10:33:31.339658 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2047d600>]}
[0m10:33:31.341404 [info ] [Thread-10 ]: 10 of 88 OK created sql incremental model dev_dm_pst3_IT.58789_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (2.0 rows, 5.0 GiB processed)[0m in 5.01s]
[0m10:33:31.343188 [debug] [Thread-10 ]: Finished running node model.project_dbt.58789_AIS_USERS_AND_ACCOUNT
[0m10:33:31.344425 [debug] [Thread-10 ]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:33:31.345796 [info ] [Thread-10 ]: 21 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [RUN]
[0m10:33:31.347044 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.58789_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG)
[0m10:33:31.348122 [debug] [Thread-10 ]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:33:31.358644 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m10:33:31.359461 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:468fea31-fbf0-47a2-9bf2-7e1dfd3616cf&page=queryresults
[0m10:33:31.360929 [debug] [Thread-10 ]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:33:31.363714 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:33:31.542134 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE"
[0m10:33:31.545107 [debug] [Thread-7 (]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
  DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL NOT IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:33:31.547841 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE"
[0m10:33:31.551727 [debug] [Thread-11 ]: On model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE`
      
    
    

    OPTIONS()
    as (
      WITH country_codes AS (
SELECT *
FROM UNNEST (['FR','DE','AT','BE','BG','CY','HR','DK','ES','EE','FI','GR','HU','IE','IS','IT','LV','LI','LT','LU','MT','NO','NL','PL','PT','CZ','RO','SK','SI','SE']) as code
),
DM as (
  SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    ROUND(COALESCE(SUM(ftr.TRANSACTION_AMOUNT), 0.00), 2) AS outbound_ibis_payments_amount_sum_in_EUR,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
    AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE =  'FR'
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
  WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND ftr.transaction_type  = 'REGULAR'
    AND ftr.TRANSACTION_CHANNEL IN ('DASHBOARD','ADMIN', 'OTHER', 'CARDS')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'

  GROUP BY 1
  ORDER BY 1
)
SELECT
  c.code,
  DM.*,
  (SELECT SUM(outbound_ibis_payments_trx_count) FROM DM WHERE payee_psp_country != 'FR') as total_trx_count_without_FR,
  (SELECT SUM(outbound_ibis_payments_amount_sum_in_EUR) FROM DM WHERE payee_psp_country != 'FR') as total_amount_sum_without_FR,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM DM
FULL OUTER JOIN country_codes as c on c.code = DM.payee_psp_country
    );
  
[0m10:33:31.712798 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc202092d0>]}
[0m10:33:31.714604 [info ] [Thread-9 (]: 9 of 88 OK created sql incremental model dev_dm_pst3_IT.58788_AIS_USERS_AND_ACCOUNT  [[32mCREATE TABLE (1.0 rows, 5.0 GiB processed)[0m in 5.38s]
[0m10:33:31.716410 [debug] [Thread-9 (]: Finished running node model.project_dbt.58788_AIS_USERS_AND_ACCOUNT
[0m10:33:31.717655 [debug] [Thread-9 (]: Began running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:33:31.719120 [info ] [Thread-9 (]: 22 of 88 START sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [RUN]
[0m10:33:31.720355 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.58788_AIS_USERS_AND_ACCOUNT, now model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP)
[0m10:33:31.721466 [debug] [Thread-9 (]: Began compiling node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:33:31.731285 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m10:33:31.731778 [debug] [Thread-9 (]: Began executing node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:33:31.734230 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:33:31.751925 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2746d314-c99f-4dfc-80bf-ae413e1fa70e&page=queryresults
[0m10:33:31.967496 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG"
[0m10:33:31.969185 [debug] [Thread-10 ]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG`
      
    
    

    OPTIONS()
    as (
      SELECT
     COUNT(distinct c.consent_iban) AS COUNT,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
FROM
     `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
          ON c.T_DIM_KEY = cc.T_DIM_KEY
     INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
          ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
     c.CONSENT_STATUS = 'VALID'
     AND LEFT(c.consent_iban, 2) = 'FR'
     AND c.CONSENT_TRANSACTION_ACCESS_ALLOWED IS TRUE
     AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     --AND  t.T_SOURCE_PK_ID <> '1'
     AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:33:32.316079 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP"
[0m10:33:32.317992 [debug] [Thread-9 (]: On model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
     d_access_consent_info.USER_EMAIL AS user_token,
     COUNT(DISTINCT(d_access_consent_info.USER_EMAIL)) OVER(PARTITION BY d_access_consent_info.USER_EMAIL) unique_users_count_in_period,
     COUNT(DISTINCT(d_access_consent_info.T_BUS_KEY)) OVER(PARTITION BY d_access_consent_info.T_BUS_KEY) number_of_consents,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS d_pxg_payment_account
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS d_financial_platforms
     ON d_pxg_payment_account.T_D_FINANCIAL_PLATFORM_DIM_KEY=d_financial_platforms.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS d_financial_institutions
     ON d_financial_institutions.T_DIM_KEY = d_financial_platforms.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` AS d_access_consent_info
     ON d_pxg_payment_account.T_DIM_KEY=d_access_consent_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS d_contract_info
     ON d_pxg_payment_account.T_DIM_KEY=d_contract_info.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS d_application_account_info
     ON d_contract_info.T_D_APPLICATION_ACCOUNT_DIM_KEY=d_application_account_info.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS d_applications
     ON d_application_account_info.T_D_APPLICATION_DIM_KEY = d_applications.T_DIM_KEY
WHERE  (
     d_applications.APPLICATION_NAME  = 'PAY-PXG-JEFACTURE'
     -- AND d_application_account_info.T_SOURCE_PK_ID not in ('8856', '4545', '4571', '5170', '5188', '5244', '5275', '5301',
     --                                                        '5343', '5411', '5422', '5443', '5495', '5511', '5560', '5593',
     --                                                        '5628', '5651', '5652', '5653', '5654', '5655', '5657', '5658',
     --                                                        '5659', '5660', '5661', '5662', '6315', '6354', '6745', '6922',
     --                                                        '6960', '7175', '7222', '7386', '7428', '7582', '7666', '7753', '7768'
     --                                                        )
     )
     AND d_financial_institutions.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
     AND
     (
          (
          d_access_consent_info.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     OR
          (
          d_access_consent_info.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND d_access_consent_info.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
     )
    );
  
[0m10:33:32.327941 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:817af0b9-d1c0-4ea4-a17e-05ed89c9c7f5&page=queryresults
[0m10:33:32.508432 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21127c10>]}
[0m10:33:32.512559 [info ] [Thread-12 ]: 12 of 88 OK created sql incremental model dev_dm_pst3_DE.A1_Number_of_payment_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.11s]
[0m10:33:32.514740 [debug] [Thread-12 ]: Finished running node model.project_dbt.A1_Number_of_payment_accounts
[0m10:33:32.516476 [debug] [Thread-12 ]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:33:32.518202 [info ] [Thread-12 ]: 23 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [RUN]
[0m10:33:32.519111 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.A1_Number_of_payment_accounts, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo)
[0m10:33:32.519543 [debug] [Thread-12 ]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:33:32.530110 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m10:33:32.530943 [debug] [Thread-12 ]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:33:32.535449 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:33:32.572712 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc202fbfa0>]}
[0m10:33:32.574427 [info ] [Thread-13 ]: 13 of 88 OK created sql incremental model dev_dm_pst3_FR.Banque_en_ligne ....... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 6.17s]
[0m10:33:32.576248 [debug] [Thread-13 ]: Finished running node model.project_dbt.Banque_en_ligne
[0m10:33:32.577471 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuadro1_accounts
[0m10:33:32.579026 [info ] [Thread-13 ]: 24 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ........... [RUN]
[0m10:33:32.580024 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Banque_en_ligne, now model.project_dbt.Cuadro1_accounts)
[0m10:33:32.580943 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuadro1_accounts
[0m10:33:32.588034 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_accounts"
[0m10:33:32.588744 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuadro1_accounts
[0m10:33:32.592622 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:33:32.639605 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5228f221-6ab2-4184-a03e-b7739053b354&page=queryresults
[0m10:33:32.745574 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e1682281-52c1-417e-b3d5-20335f1a9424&page=queryresults
[0m10:33:33.145477 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo"
[0m10:33:33.151735 [debug] [Thread-12 ]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
      
    
    

    OPTIONS()
    as (
      SELECT
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payee_psp_country,
    COUNT(*) AS outbound_ibis_payments_trx_count,
    round(SUM(ftr.TRANSACTION_AMOUNT)) AS outbound_ibis_payments_amount_sum_in_EUR,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
  ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
  ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR'
  AND iacc.ACCOUNT_TYPE = "PAYMENT"
  AND ftr.transaction_type  = 'REGULAR'
  AND ftr.TRANSACTION_CHANNEL not IN ('DASHBOARD', 'OTHER', 'CARDS')
  AND dtr.TRANSACTION_STATUS  IN ('SETTLED', 'RETURNED')
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
group by cred.FINANCIAL_INSTITUTION_COUNTRY_CODE
order by payee_psp_country ASC
    );
  
[0m10:33:33.166762 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4019c45d-d6f1-48f0-8371-73a5cd305564&page=queryresults
[0m10:33:33.210200 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_accounts"
[0m10:33:33.211730 [debug] [Thread-13 ]: On model.project_dbt.Cuadro1_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) AS number_of_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
 ON IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    )
    AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  )
    );
  
[0m10:33:33.761766 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:89d33026-d0c2-4915-a661-0acc5ec227c3&page=queryresults
[0m10:33:33.833616 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bcc6091f-484f-4ae3-87a1-e54deac1e117&page=queryresults
[0m10:33:35.443011 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2013b5e0>]}
[0m10:33:35.444715 [info ] [Thread-10 ]: 21 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG  [[32mCREATE TABLE (1.0 rows, 1.2 GiB processed)[0m in 4.10s]
[0m10:33:35.445306 [debug] [Thread-10 ]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG
[0m10:33:35.445718 [debug] [Thread-10 ]: Began running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:33:35.446251 [info ] [Thread-10 ]: 25 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs . [RUN]
[0m10:33:35.446742 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG, now model.project_dbt.Cuadro1_number_of_AIS_PSUs)
[0m10:33:35.447139 [debug] [Thread-10 ]: Began compiling node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:33:35.453968 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m10:33:35.454523 [debug] [Thread-10 ]: Began executing node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:33:35.459259 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:33:36.112165 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.Cuadro1_number_of_AIS_PSUs"
[0m10:33:36.114021 [debug] [Thread-10 ]: On model.project_dbt.Cuadro1_number_of_AIS_PSUs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro1_number_of_AIS_PSUs`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPES')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND (
        ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
        AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        OR (
          ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  WHERE USER_TOKEN <>'NA'
    );
  
[0m10:33:36.130413 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210716f0>]}
[0m10:33:36.132226 [info ] [Thread-5 (]: 5 of 88 OK created sql incremental model dev_dm_pst3_IT.58724_CREDIT_TRANSFERS_SINGLE_BASIS  [[32mCREATE TABLE (27.0 rows, 11.0 GiB processed)[0m in 9.83s]
[0m10:33:36.133870 [debug] [Thread-5 (]: Finished running node model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS
[0m10:33:36.135088 [debug] [Thread-5 (]: Began running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:33:36.136424 [info ] [Thread-5 (]: 26 of 88 START sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [RUN]
[0m10:33:36.137575 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.58724_CREDIT_TRANSFERS_SINGLE_BASIS, now model.project_dbt.Cuadro9_Credit_transfers_sent)
[0m10:33:36.138620 [debug] [Thread-5 (]: Began compiling node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:33:36.148423 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m10:33:36.149027 [debug] [Thread-5 (]: Began executing node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:33:36.151891 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:33:36.766638 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.Cuadro9_Credit_transfers_sent"
[0m10:33:36.768486 [debug] [Thread-5 (]: On model.project_dbt.Cuadro9_Credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuadro9_Credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
  ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
  ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >=  TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <  TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    );
  
[0m10:33:36.923871 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d4c3fcbc-4587-4926-97fa-8dbcc345ff6e&page=queryresults
[0m10:33:37.399385 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bfdc6b47-8cc1-4c22-a19b-5f48e943e5f4&page=queryresults
[0m10:33:37.954630 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20471e40>]}
[0m10:33:37.955823 [info ] [Thread-13 ]: 24 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_accounts ...... [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 5.37s]
[0m10:33:37.956410 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuadro1_accounts
[0m10:33:37.956860 [debug] [Thread-13 ]: Began running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:33:37.958095 [info ] [Thread-13 ]: 27 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [RUN]
[0m10:33:37.958737 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_accounts, now model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts)
[0m10:33:37.959190 [debug] [Thread-13 ]: Began compiling node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:33:37.963941 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m10:33:37.964724 [debug] [Thread-13 ]: Began executing node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:33:37.967488 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:33:38.593441 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts"
[0m10:33:38.595176 [debug] [Thread-13 ]: On model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro1_number_of_AISPs_accessing_UPP_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
c.consent_iban,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  on c.T_DIM_KEY = cc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='ES'
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  and c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:33:39.276796 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2106f430>]}
[0m10:33:39.278653 [info ] [Thread-4 (]: 4 of 88 OK created sql incremental model dev_dm_pst3_IT.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS  [[32mCREATE TABLE (27.0 rows, 11.5 GiB processed)[0m in 12.98s]
[0m10:33:39.280357 [debug] [Thread-4 (]: Finished running node model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS
[0m10:33:39.281598 [debug] [Thread-4 (]: Began running node model.project_dbt.Cuardro4_PIS
[0m10:33:39.283088 [info ] [Thread-4 (]: 28 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_PIS ............... [RUN]
[0m10:33:39.284098 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.58550_CREDIT_TRANSFERS_SENT_BY_UPP_CUSTOMERS, now model.project_dbt.Cuardro4_PIS)
[0m10:33:39.284877 [debug] [Thread-4 (]: Began compiling node model.project_dbt.Cuardro4_PIS
[0m10:33:39.293440 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.Cuardro4_PIS"
[0m10:33:39.294001 [debug] [Thread-4 (]: Began executing node model.project_dbt.Cuardro4_PIS
[0m10:33:39.296543 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:33:39.472045 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:4bb51863-0fb1-4808-acd1-5728c511abb2&page=queryresults
[0m10:33:39.929003 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.Cuardro4_PIS"
[0m10:33:39.930749 [debug] [Thread-4 (]: On model.project_dbt.Cuardro4_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  IT.INBOUND_TRANSACTION_CURRENCY_CODE as trx_currency,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  as counterparty_country,
  count(*)  AS success_trx_count,
  sum(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` as IP
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` FP
      ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` FI
      ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` as IT
      ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` as DIT
      ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS_CURRENT` as PI
      ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` as APP
      ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
      ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
      ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
  WHERE  FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND ( APP.APPLICATION_NAME = 'PAY-PXG-BANQUPES'
          OR (
            APP.APPLICATION_NAME = 'PAY-PXG-OCS'
            AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE  = 'ES'
            AND substr( credacc.BANK_ACCOUNT_NUMBER,5,4)= '6918'
            )
        )
    AND DIT.INBOUND_TRANSACTION_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DIT.INBOUND_TRANSACTION_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1,2
    );
  
[0m10:33:40.228174 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2082e230>]}
[0m10:33:40.230017 [info ] [Thread-10 ]: 25 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro1_number_of_AIS_PSUs  [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 4.78s]
[0m10:33:40.231741 [debug] [Thread-10 ]: Finished running node model.project_dbt.Cuadro1_number_of_AIS_PSUs
[0m10:33:40.233055 [debug] [Thread-10 ]: Began running node model.project_dbt.Cuardro4_credit_transers_received
[0m10:33:40.234887 [info ] [Thread-10 ]: 29 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [RUN]
[0m10:33:40.236047 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro1_number_of_AIS_PSUs, now model.project_dbt.Cuardro4_credit_transers_received)
[0m10:33:40.237031 [debug] [Thread-10 ]: Began compiling node model.project_dbt.Cuardro4_credit_transers_received
[0m10:33:40.244606 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m10:33:40.245169 [debug] [Thread-10 ]: Began executing node model.project_dbt.Cuardro4_credit_transers_received
[0m10:33:40.247496 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:33:40.367261 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1b55f040>]}
[0m10:33:40.369306 [info ] [Thread-8 (]: 8 of 88 OK created sql incremental model dev_dm_pst3_IT.58746_PAYMENT_INITIATIONS  [[32mCREATE TABLE (1.0 rows, 27.4 GiB processed)[0m in 14.04s]
[0m10:33:40.370978 [debug] [Thread-8 (]: Finished running node model.project_dbt.58746_PAYMENT_INITIATIONS
[0m10:33:40.372209 [debug] [Thread-8 (]: Began running node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:33:40.377307 [info ] [Thread-8 (]: 30 of 88 START sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [RUN]
[0m10:33:40.378941 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.58746_PAYMENT_INITIATIONS, now model.project_dbt.Cuardro4_credit_transers_sent)
[0m10:33:40.379869 [debug] [Thread-8 (]: Began compiling node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:33:40.466137 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m10:33:40.466719 [debug] [Thread-8 (]: Began executing node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:33:40.468999 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:33:40.658880 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc203bbf10>]}
[0m10:33:40.660643 [info ] [Thread-14 ]: 14 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 14.26s]
[0m10:33:40.664581 [debug] [Thread-14 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI
[0m10:33:40.665827 [debug] [Thread-14 ]: Began running node model.project_dbt.KMS_C
[0m10:33:40.667212 [info ] [Thread-14 ]: 31 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C ...................... [RUN]
[0m10:33:40.668633 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_EMI, now model.project_dbt.KMS_C)
[0m10:33:40.669759 [debug] [Thread-14 ]: Began compiling node model.project_dbt.KMS_C
[0m10:33:40.679070 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.KMS_C"
[0m10:33:40.679697 [debug] [Thread-14 ]: Began executing node model.project_dbt.KMS_C
[0m10:33:40.682547 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:33:40.727229 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:ca7f64d2-4aa0-4df0-961e-10903ca14f31&page=queryresults
[0m10:33:40.814603 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc202aff10>]}
[0m10:33:40.816301 [info ] [Thread-6 (]: 6 of 88 OK created sql incremental model dev_dm_pst3_IT.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN  [[32mCREATE TABLE (1.0 rows, 21.8 GiB processed)[0m in 14.49s]
[0m10:33:40.817924 [debug] [Thread-6 (]: Finished running node model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN
[0m10:33:40.819141 [debug] [Thread-6 (]: Began running node model.project_dbt.KMS_C_non_euro_transactions
[0m10:33:40.820623 [info ] [Thread-6 (]: 32 of 88 START sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [RUN]
[0m10:33:40.821788 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.58726_CREDIT_TRANSFERS_WITH_SCA_BREAKDOWN, now model.project_dbt.KMS_C_non_euro_transactions)
[0m10:33:40.822875 [debug] [Thread-6 (]: Began compiling node model.project_dbt.KMS_C_non_euro_transactions
[0m10:33:40.833100 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m10:33:40.833756 [debug] [Thread-6 (]: Began executing node model.project_dbt.KMS_C_non_euro_transactions
[0m10:33:40.838337 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:33:40.859569 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_received"
[0m10:33:40.861127 [debug] [Thread-10 ]: On model.project_dbt.Cuardro4_credit_transers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payer_PSP_country,
  count(*)  as inbound_ibis_payments_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS inbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
    ON IA.T_D_BANK_ACCOUNT_DIM_KEY = CBA.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE (FAT.TRANSACTION_DIRECTION = "INBOUND")
    AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
    AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
    AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  GROUP BY 1
  ORDER BY 1
    );
  
[0m10:33:41.049273 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.Cuardro4_credit_transers_sent"
[0m10:33:41.050985 [debug] [Thread-8 (]: On model.project_dbt.Cuardro4_credit_transers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_ES`.`Cuardro4_credit_transers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE  as payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN '211 Manual entry'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP','OCS','H2H' ) THEN '212 Electronic entry'
  END EntryMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP', 'OCS') THEN '2122 single '
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then '2121 Batch entry'
  END BatchMode,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' then 'NoSCA - 212333 Trusted Beneficiaries'
      WHEN FAT.TRANSACTION_CHANNEL in ('OCS') and FAT.TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' then 'NoSCA - 212335 secure processes'
      WHEN FAT.TRANSACTION_CHANNEL is null then 'not applicable - return'
      else 'check the query'
  END SCAIndicator,
  count (*) as outbound_ibis_payments_trx_count,
  sum (round(FAT.TRANSACTION_AMOUNT)) as outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE(FAT.TRANSACTION_DIRECTION = "OUTBOUND")
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND IA.ACCOUNT_TYPE = 'PAYMENT'
    AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
    AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m10:33:41.270357 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.KMS_C"
[0m10:33:41.272107 [debug] [Thread-14 ]: On model.project_dbt.KMS_C: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
group by 1
    );
  
[0m10:33:41.539364 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.KMS_C_non_euro_transactions"
[0m10:33:41.543028 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210461d0>]}
[0m10:33:41.544608 [info ] [Thread-15 ]: 15 of 88 OK created sql incremental model dev_dm_pst3_FR.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 15.14s]
[0m10:33:41.546274 [debug] [Thread-15 ]: Finished running node model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU
[0m10:33:41.547519 [debug] [Thread-15 ]: Began running node model.project_dbt.KMS_MRA
[0m10:33:41.549042 [info ] [Thread-15 ]: 33 of 88 START sql incremental model dev_dm_pst3_LV.KMS_MRA .................... [RUN]
[0m10:33:41.550505 [debug] [Thread-6 (]: On model.project_dbt.KMS_C_non_euro_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_C_non_euro_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_non_EUR_transactions,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_CURRENCY <> 'EUR'
AND TRANSACTION_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
AND TRANSACTION_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:33:41.551784 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.C4_agMoyPaiTypeOpeZoneGeo_VIR_RECU, now model.project_dbt.KMS_MRA)
[0m10:33:41.555442 [debug] [Thread-15 ]: Began compiling node model.project_dbt.KMS_MRA
[0m10:33:41.565638 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.KMS_MRA"
[0m10:33:41.568523 [debug] [Thread-15 ]: Began executing node model.project_dbt.KMS_MRA
[0m10:33:41.571764 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:33:41.631707 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:abc9842f-a6e1-47cd-b266-bf544bdf7dd3&page=queryresults
[0m10:33:41.704897 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20683e80>]}
[0m10:33:41.706807 [info ] [Thread-16 ]: 16 of 88 OK created sql incremental model dev_dm_pst3_FR.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo  [[32mCREATE TABLE (31.0 rows, 46.7 GiB processed)[0m in 15.30s]
[0m10:33:41.708554 [debug] [Thread-16 ]: Finished running node model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo
[0m10:33:41.709749 [debug] [Thread-16 ]: Began running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:33:41.711354 [info ] [Thread-16 ]: 34 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [RUN]
[0m10:33:41.712451 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.C6B_agMoyPaiTypeOpeCanalTransactSchemaFctAuthZoneGeo, now model.project_dbt.KMS_P11_Outgoing_transactions)
[0m10:33:41.713494 [debug] [Thread-16 ]: Began compiling node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:33:41.722497 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m10:33:41.723579 [debug] [Thread-16 ]: Began executing node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:33:41.727657 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:33:41.863451 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:24294606-b957-4788-9e96-ebd618f5c54a&page=queryresults
[0m10:33:42.149939 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bd3d2cb1-2abc-42b4-8192-8f4a978b3656&page=queryresults
[0m10:33:42.191760 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.KMS_MRA"
[0m10:33:42.192775 [debug] [Thread-15 ]: On model.project_dbt.KMS_MRA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_MRA`
      
    
    

    OPTIONS()
    as (
      SELECT
  BA.BANK_ACCOUNT_NUMBER as large_biller_account,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_CURRENT` AS M
left JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON M.T_D_MRA_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
WHERE M.T_D_MRA_BANK_ACCOUNT_DIM_KEY is not null
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND MERCHANT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND MERCHANT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:33:42.236213 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:decb63f4-3954-4e43-b557-b25a389381a8&page=queryresults
[0m10:33:42.329158 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.KMS_P11_Outgoing_transactions"
[0m10:33:42.330976 [debug] [Thread-16 ]: On model.project_dbt.KMS_P11_Outgoing_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P11_Outgoing_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  count(*) as outbound_ibis_paymennts_trx_count,
  sum(FAT.TRANSACTION_AMOUNT) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE FAT.TRANSACTION_DIRECTION = "OUTBOUND"
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND IA.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL <> 'CARDS'
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  group by 1
    );
  
[0m10:33:42.384133 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21073f10>]}
[0m10:33:42.385783 [info ] [Thread-13 ]: 27 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro1_number_of_AISPs_accessing_UPP_accounts  [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 4.43s]
[0m10:33:42.387558 [debug] [Thread-13 ]: Finished running node model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts
[0m10:33:42.389458 [debug] [Thread-13 ]: Began running node model.project_dbt.KMS_P17_PIS
[0m10:33:42.391714 [info ] [Thread-13 ]: 35 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ................ [RUN]
[0m10:33:42.392927 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro1_number_of_AISPs_accessing_UPP_accounts, now model.project_dbt.KMS_P17_PIS)
[0m10:33:42.393991 [debug] [Thread-13 ]: Began compiling node model.project_dbt.KMS_P17_PIS
[0m10:33:42.405729 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.KMS_P17_PIS"
[0m10:33:42.406586 [debug] [Thread-13 ]: Began executing node model.project_dbt.KMS_P17_PIS
[0m10:33:42.410666 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:33:42.777119 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:71a8a0fb-a753-4d18-bc94-3dd05c95cf44&page=queryresults
[0m10:33:42.889600 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21072080>]}
[0m10:33:42.891279 [info ] [Thread-7 (]: 19 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE  [[32mCREATE TABLE (31.0 rows, 33.0 GiB processed)[0m in 11.97s]
[0m10:33:42.892983 [debug] [Thread-7 (]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE
[0m10:33:42.895252 [debug] [Thread-7 (]: Began running node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:33:42.896917 [info ] [Thread-7 (]: 36 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [RUN]
[0m10:33:42.901584 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_ELECTRONIQUE, now model.project_dbt.KMS_P21_Inbound_transactions)
[0m10:33:42.902759 [debug] [Thread-7 (]: Began compiling node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:33:42.909179 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8b705989-c40c-4ab4-a442-4392441db9bb&page=queryresults
[0m10:33:42.914804 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m10:33:42.916974 [debug] [Thread-7 (]: Began executing node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:33:42.920813 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:33:43.004166 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.KMS_P17_PIS"
[0m10:33:43.006131 [debug] [Thread-13 ]: On model.project_dbt.KMS_P17_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P17_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLV'
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
 GROUP BY 1, 2, 3

UNION ALL

SELECT
  'Banqup applications' as TypeOfApplication,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS counterparty_country,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS currency,
  COUNT(*)  AS success_trx_count,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS success_trx_summed_value,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX72'
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

GROUP BY 1, 2, 3
ORDER BY 1,2 DESC
    );
  
[0m10:33:43.538635 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.KMS_P21_Inbound_transactions"
[0m10:33:43.539926 [debug] [Thread-7 (]: On model.project_dbt.KMS_P21_Inbound_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P21_Inbound_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
   d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS payer_psp_country,
   COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS inbound_ibis_payments_trx_count,
   COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS inbound_ibis_payment_amount_sum_in_EUR,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   '2024S1' AS PERIOD,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
 INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
 WHERE FAT.TRANSACTION_DIRECTION = "INBOUND"
     AND FAT.TRANSACTION_TYPE = 'REGULAR'
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
     AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
     AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
     AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
 group by 1
 order by 1
    );
  
[0m10:33:43.793839 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf2b010>]}
[0m10:33:43.795613 [info ] [Thread-9 (]: 22 of 88 OK created sql incremental model dev_dm_pst3_FR.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP  [[32mCREATE TABLE (44.4k rows, 14.9 GiB processed)[0m in 12.07s]
[0m10:33:43.800019 [debug] [Thread-9 (]: Finished running node model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP
[0m10:33:43.801282 [debug] [Thread-9 (]: Began running node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:33:43.803116 [info ] [Thread-9 (]: 37 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS ...... [RUN]
[0m10:33:43.804213 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.CPTE_PAIEMT_CONSULT_VIA_SERV_TIERS_AGREG_PSP, now model.project_dbt.KMS_P6a_number_of_AIS)
[0m10:33:43.805290 [debug] [Thread-9 (]: Began compiling node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:33:43.817358 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m10:33:43.818526 [debug] [Thread-9 (]: Began executing node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:33:43.820984 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:33:43.844083 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:d745f504-72b5-4e29-bc9c-e22b4a0d84c7&page=queryresults
[0m10:33:44.142060 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:60540908-98c6-469f-8869-ab241bca9593&page=queryresults
[0m10:33:44.415643 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.KMS_P6a_number_of_AIS"
[0m10:33:44.417359 [debug] [Thread-9 (]: On model.project_dbt.KMS_P6a_number_of_AIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P6a_number_of_AIS`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
    a.APPLICATION_NAME in ('PAY-PXG-BANQUPLV')
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
    AND ( ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
          AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
          OR (ac.ACCESS_CONSENT_STATUS_AT > TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
            )
    )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    '2024S1' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m10:33:44.862451 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2109d780>]}
[0m10:33:45.407923 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:892af272-944c-4f6d-84fd-6459000db6a1&page=queryresults
[0m10:33:45.717858 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210233a0>]}
[0m10:33:45.763475 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bfb6a40>]}
[0m10:33:45.823781 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc200a6290>]}
[0m10:33:46.350299 [info ] [Thread-12 ]: 23 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo  [[32mCREATE TABLE (8.0 rows, 11.0 GiB processed)[0m in 12.34s]
[0m10:33:46.352155 [debug] [Thread-12 ]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo
[0m10:33:46.351670 [info ] [Thread-1 (]: 18 of 88 OK created sql incremental model dev_dm_pst3_FR.C7_agMoyPaiTypeOpeSystZoneGeo  [[32mCREATE TABLE (9.0 rows, 23.4 GiB processed)[0m in 15.42s]
[0m10:33:46.353096 [debug] [Thread-12 ]: Began running node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:33:46.352597 [info ] [Thread-5 (]: 26 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuadro9_Credit_transfers_sent  [[32mCREATE TABLE (1.0 rows, 10.9 GiB processed)[0m in 9.63s]
[0m10:33:46.353630 [info ] [Thread-11 ]: 20 of 88 OK created sql incremental model dev_dm_pst3_FR.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE  [[32mCREATE TABLE (30.0 rows, 33.0 GiB processed)[0m in 14.91s]
[0m10:33:46.355280 [debug] [Thread-1 (]: Finished running node model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo
[0m10:33:46.356653 [info ] [Thread-12 ]: 38 of 88 START sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts . [RUN]
[0m10:33:46.358366 [debug] [Thread-5 (]: Finished running node model.project_dbt.Cuadro9_Credit_transfers_sent
[0m10:33:46.360185 [debug] [Thread-11 ]: Finished running node model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE
[0m10:33:46.361586 [debug] [Thread-1 (]: Began running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:33:46.362892 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo, now model.project_dbt.KMS_P7a_number_of_accounts)
[0m10:33:46.364383 [debug] [Thread-5 (]: Began running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:33:46.365977 [debug] [Thread-11 ]: Began running node model.project_dbt.PAY_CPCA
[0m10:33:46.367612 [info ] [Thread-1 (]: 39 of 88 START sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [RUN]
[0m10:33:46.368918 [debug] [Thread-12 ]: Began compiling node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:33:46.370535 [info ] [Thread-5 (]: 40 of 88 START sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [RUN]
[0m10:33:46.372222 [info ] [Thread-11 ]: 41 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCA ................... [RUN]
[0m10:33:46.373789 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.C7_agMoyPaiTypeOpeSystZoneGeo, now model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP)
[0m10:33:46.388204 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m10:33:46.388986 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuadro9_Credit_transfers_sent, now model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS)
[0m10:33:46.389679 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.C8_agMoyPaiTypeOpeCanalTypeCanalZoneGeo_NON_ELECTRONIQUE, now model.project_dbt.PAY_CPCA)
[0m10:33:46.390612 [debug] [Thread-1 (]: Began compiling node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:33:46.391575 [debug] [Thread-5 (]: Began compiling node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:33:46.392304 [debug] [Thread-11 ]: Began compiling node model.project_dbt.PAY_CPCA
[0m10:33:46.392825 [debug] [Thread-12 ]: Began executing node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:33:46.400345 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m10:33:46.406713 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m10:33:46.417937 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.PAY_CPCA"
[0m10:33:46.420056 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:33:46.420764 [debug] [Thread-5 (]: Began executing node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:33:46.422043 [debug] [Thread-1 (]: Began executing node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:33:46.422431 [debug] [Thread-11 ]: Began executing node model.project_dbt.PAY_CPCA
[0m10:33:46.424791 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:33:46.427728 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:33:46.429849 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:33:47.071221 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.PAY_CPCA"
[0m10:33:47.074276 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP"
[0m10:33:47.077090 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.KMS_P7a_number_of_accounts"
[0m10:33:47.079602 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS"
[0m10:33:47.081905 [debug] [Thread-11 ]: On model.project_dbt.PAY_CPCA: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCA`
      
    
    

    OPTIONS()
    as (
      WITH count_NContAISPS_last_six_months AS(
  SELECT
    row_number() over () as IDReg,
    'Y' as Ot,     -- PXG perspective
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasASPSP,
    'BE' as PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 as NContAISPM,                                             -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPS,       -- Number of accounts with consent in last 6 months
    0 as NPedInUt,                                               -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 as NPedSInUt,                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' --PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  AND fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -6 MONTH)
  )
  -- Created before the end of the reporting period AND still active or status last changed within 6 months before the reporting period
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM_previous_month AS(
  SELECT
    row_number() over () as IDReg,
   'Y' as Ot,     -- PXG perspective
   LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
   substr(bad.BANK_ACCOUNT_NUMBER,5,4) as ASPSP,
   'PSDBE-NBB-0649860804' as AISP,
   'BE' as PasASPSP,
   'BE' as PasAISP,
   '' AS LEIASPSP,
   '5493000RZ2KSLKCYNN98' AS LEIAISP,
   '1' AS ModAc,
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NContAISPM,       -- Number of accounts with consent in month
    0 as NContAISPS,                                             -- Number of accounts with consent in last 6 months (numbers were in previous part of the union)
    count(distinct bad.BANK_ACCOUNT_NUMBER) as NPedInUt,         -- Assuming one access per day
    4 * count(distinct bad.BANK_ACCOUNT_NUMBER) * extract(DAY FROM LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)))  as NPedSInUt,     -- 4 * Number of days in month * number of accounts with consent in month
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` acic
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` bad
    ON pac.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` fp
    ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
  WHERE
  -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT' -- PT
  ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- BE data
  and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
  AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))
  AND (
    acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)
  )
  -- Created before the end of the reporting period and (is still active or status last changed before the start of the reporting period)
  GROUP BY DtRef, bad.BANK_ACCOUNT_NUMBER
),
count_NContAISPM AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    COUNT(*) AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    0 AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt,                                         -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    -- c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))
    -- AND (c.CONSENT_STATUS = 'VALID'
    --   OR DATE(acic.ACCESS_CONSENT_STATUS_AT) >=  DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)
    --   ) -- ==> geen consent_status_at in DWH ook niet in DL
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
),
count_NContAISPS AS(
  SELECT
    ROW_NUMBER() OVER () AS IDReg,
    'X' AS Ot,
    -- PXG perspective
    LAST_DAY(DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -1 MONTH)) AS DtRef,
    '5845' AS ASPSP,
    REPLACE (t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER, '.', '') as AISP,
    'BE' AS PasASPSP,
    'BE' AS PasAISP,
    '' AS LEIASPSP,
    '5493000RZ2KSLKCYNN98' AS LEIAISP,
    '1' AS ModAc,
    0 AS NContAISPM,
    -- Number of accounts with consent within reporting month (numbers are in next part of the union)
    COUNT(*) AS NContAISPS,
    -- Number of accounts with consent in last 6 months
    0 AS NPedInUt,
    -- Number of access to account initiated by user within reporting month (numbers are in next part of the union)
    0 AS NPedSInUt                                               -- Number of automatic access to account within reporting month (numbers are in next part of the union)
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
  ON c.T_DIM_KEY = cc.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
  ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
  WHERE
    --  c.CONSENT_STATUS = 'VALID'
    LEFT(c.consent_iban,2) ='BE'
    AND c.CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))
    -- AND (acic.ACCESS_CONSENT_STATUS = 'ACTIVE'
    --   or DATE(acic.ACCESS_CONSENT_STATUS_AT) >= DATE_ADD(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:46.415798', 'Etc/UTC'))), INTERVAL -6 MONTH)
    --   ) ==> no consent status at?
    AND t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  GROUP BY DtRef, t.SERVICE_PROVIDER_PSP_AUTHORISATION_NUMBER
)
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPS_last_six_months
  UNION ALL
  SELECT * FROM count_NContAISPM_previous_month
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT
  Ot,IDReg,DtRef,ASPSP,AISP, PasASPSP,
  PasAISP, LEIASPSP, LEIAISP, ModAc,
  sum(NContAISPM) as NContAISPM,
  sum(NContAISPS) as NContAISPS,
  sum(NPedInUt) as NPedInUt,
  sum(NPedSInUt) as NPedSInUt,
  ""  AS Period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM (
  SELECT * FROM count_NContAISPM
  UNION ALL
  SELECT * FROM count_NContAISPS
)
-- This must still be unioned with data from the ASPSP API for TPPs other than UP (second perspective)
GROUP BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m10:33:47.084603 [debug] [Thread-1 (]: On model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`NC1_Number_of_payment_accounts_accessed_by_UPP`
      
    
    

    OPTIONS()
    as (
      WITH pre AS (
  SELECT
    'DE' AS country,
    ac.USER_TOKEN,
    count(*),
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED` AS pa
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE a.APPLICATION_NAME = 'PAY-PXG-BANQUPDE'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
      TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      OR
      (
      TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
      AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
      )
    )
  GROUP BY 1,2
)
SELECT
  country ,
  count(distinct USER_TOKEN) as unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM PRE
GROUP BY 1
    );
  
[0m10:33:47.088603 [debug] [Thread-12 ]: On model.project_dbt.KMS_P7a_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LV`.`KMS_P7a_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  count(*) as number_of_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV'
  AND (
      IACC.ACCOUNT_STATUS = 'OPEN'
      OR (
        IACC.ACCOUNT_STATUS = 'CLOSED'
        AND IACC.ACCOUNT_UPDATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
      )
    )
  AND IACC.ACCOUNT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:33:47.089899 [debug] [Thread-5 (]: On model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS`
      
    
    

    OPTIONS()
    as (
      SELECT
    LEFT(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
    c.consent_iban,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc
    ON c.T_DIM_KEY = cc.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t
    ON c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
WHERE
    c.CONSENT_STATUS = 'VALID'
    AND left(c.consent_iban,2) = 'BE'
    AND c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:33:47.783830 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8b56e562-2805-46e6-bed2-d91a8facd91a&page=queryresults
[0m10:33:47.929739 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:09f050fb-a231-48e9-9a2c-111380acca26&page=queryresults
[0m10:33:47.946067 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2070f373-3c8e-4ff3-974a-01629bd45af5&page=queryresults
[0m10:33:47.947650 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e118199d-ee33-4f77-96eb-e87c01871746&page=queryresults
[0m10:33:48.931059 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf2afe0>]}
[0m10:33:48.932679 [info ] [Thread-9 (]: 37 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P6a_number_of_AIS . [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 5.13s]
[0m10:33:48.933205 [debug] [Thread-9 (]: Finished running node model.project_dbt.KMS_P6a_number_of_AIS
[0m10:33:48.933604 [debug] [Thread-9 (]: Began running node model.project_dbt.PAY_CPCL
[0m10:33:48.934014 [info ] [Thread-9 (]: 42 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPCL ................... [RUN]
[0m10:33:48.934397 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P6a_number_of_AIS, now model.project_dbt.PAY_CPCL)
[0m10:33:48.934703 [debug] [Thread-9 (]: Began compiling node model.project_dbt.PAY_CPCL
[0m10:33:48.939992 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.PAY_CPCL"
[0m10:33:48.940511 [debug] [Thread-9 (]: Began executing node model.project_dbt.PAY_CPCL
[0m10:33:48.943754 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:33:49.546161 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.PAY_CPCL"
[0m10:33:49.548226 [debug] [Thread-9 (]: On model.project_dbt.PAY_CPCL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPCL`
      
    
    

    OPTIONS()
    as (
      SELECT
    "Y" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:48.939239', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    'PSDBE-NBB-0649860804' as AISP,
    'BE' as PasCl,
    COUNT(DISTINCT acic.USER_TOKEN) as NCl,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` as acic
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT` AS pac
    ON pac.T_DIM_KEY = acic.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS` AS fp
        ON pac.T_D_FINANCIAL_PLATFORM_DIM_KEY = fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
    ON fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY = fi.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS ci
    ON ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY = pac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO` AS aai
    ON aai.T_DIM_KEY = ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS ad
    ON ad.T_DIM_KEY = aai.T_D_APPLICATION_DIM_KEY
WHERE
    -- ad.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    ad.APPLICATION_NAME in ('PAY-PXG-COMMUNITY', 'PAY-PXG-GOCOMPTA', 'PAY-PXG-MAGIC4BUSINESS', 'PAY-PXG-YOURSMINC', 'PAY-PXG-MIJNBOEKHOUDER')  -- Replace previous premise with thise for test with BE data
    and fi.FINANCIAL_INSTITUTION_CODE != 'IBIS'
    AND acic.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:33:48.939239', 'Etc/UTC'))
    AND acic.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:33:48.939239', 'Etc/UTC'))
GROUP BY 1,3,4,5,7,8
    );
  
[0m10:33:49.758924 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2106e5c0>]}
[0m10:33:49.760618 [info ] [Thread-6 (]: 32 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C_non_euro_transactions  [[32mCREATE TABLE (1.0 rows, 10.7 GiB processed)[0m in 8.94s]
[0m10:33:49.762351 [debug] [Thread-6 (]: Finished running node model.project_dbt.KMS_C_non_euro_transactions
[0m10:33:49.763537 [debug] [Thread-6 (]: Began running node model.project_dbt.PAY_CPMC
[0m10:33:49.765118 [info ] [Thread-6 (]: 43 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPMC ................... [RUN]
[0m10:33:49.766200 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C_non_euro_transactions, now model.project_dbt.PAY_CPMC)
[0m10:33:49.767233 [debug] [Thread-6 (]: Began compiling node model.project_dbt.PAY_CPMC
[0m10:33:49.776366 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.PAY_CPMC"
[0m10:33:49.777034 [debug] [Thread-6 (]: Began executing node model.project_dbt.PAY_CPMC
[0m10:33:49.779743 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:33:50.118843 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:6d68be09-519d-4d4f-a8ec-6eb5f3ec8c01&page=queryresults
[0m10:33:50.276730 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20132dd0>]}
[0m10:33:50.278385 [info ] [Thread-14 ]: 31 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_C ................. [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 9.61s]
[0m10:33:50.280024 [debug] [Thread-14 ]: Finished running node model.project_dbt.KMS_C
[0m10:33:50.281202 [debug] [Thread-14 ]: Began running node model.project_dbt.PAY_CPNC
[0m10:33:50.282708 [info ] [Thread-14 ]: 44 of 88 START sql incremental model dev_dm_pst3_PT.PAY_CPNC ................... [RUN]
[0m10:33:50.283831 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_C, now model.project_dbt.PAY_CPNC)
[0m10:33:50.284867 [debug] [Thread-14 ]: Began compiling node model.project_dbt.PAY_CPNC
[0m10:33:50.298301 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.PAY_CPNC"
[0m10:33:50.299558 [debug] [Thread-14 ]: Began executing node model.project_dbt.PAY_CPNC
[0m10:33:50.304097 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:33:50.368897 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.PAY_CPMC"
[0m10:33:50.370593 [debug] [Thread-6 (]: On model.project_dbt.PAY_CPMC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPMC`
      
    
    

    OPTIONS()
    as (
      WITH operation_types AS (
    (select 'ICDT' as family, 'ESCT' as subfamily, '22' as TipOper) union all
    (select 'MCOP' as family, 'OTHR' as subfamily, '27' as TipOper) union all
    (select 'MDOP' as family, 'OTHR' as subfamily, '28' as TipOper) union all
    (select 'RCDT' as family, 'ESCT' as subfamily, '21' as TipOper) union all
    (select 'RCDT' as family, 'RRTN' as subfamily, '21' as TipOper) union all
    (select 'RDDT' as family, 'ESDD' as subfamily, '22' as TipOper) union all
    (select 'RDDT' as family, 'OODD' as subfamily, '22' as TipOper)
)
SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:49.775907', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    ifnull(t.TipOper, 'NA') AS TipOper,
    count(1) as Quant,
    sum(am.MOVEMENT_AMOUNT) as Mont,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS` as am
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT` AS ia
    ON am.T_D_IBIS_ACCOUNT_DIM_KEY = ia.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bad
        ON ia.T_D_BANK_ACCOUNT_DIM_KEY = bad.T_DIM_KEY
LEFT JOIN operation_types t
    ON t.family = am.MOVEMENT_FAMILY
    AND t.subfamily = am.MOVEMENT_SUBFAMILY
WHERE
    left(bad.BANK_ACCOUNT_NUMBER,2) = 'BE'
    AND am.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:33:49.775907', 'Etc/UTC'))
    AND am.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:33:49.775907', 'Etc/UTC'))
GROUP BY 1,3,4,5,8,9
    );
  
[0m10:33:50.623007 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20263d60>]}
[0m10:33:50.623593 [info ] [Thread-8 (]: 30 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_sent  [[32mCREATE TABLE (0.0 rows, 15.6 GiB processed)[0m in 10.24s]
[0m10:33:50.624112 [debug] [Thread-8 (]: Finished running node model.project_dbt.Cuardro4_credit_transers_sent
[0m10:33:50.624512 [debug] [Thread-8 (]: Began running node model.project_dbt.PAY_TROP_5845_CMD
[0m10:33:50.625054 [info ] [Thread-8 (]: 45 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD .......... [RUN]
[0m10:33:50.625409 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_sent, now model.project_dbt.PAY_TROP_5845_CMD)
[0m10:33:50.625736 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PAY_TROP_5845_CMD
[0m10:33:50.632544 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m10:33:50.633153 [debug] [Thread-8 (]: Began executing node model.project_dbt.PAY_TROP_5845_CMD
[0m10:33:50.635590 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:33:50.862263 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bfb6a40>]}
[0m10:33:50.863953 [info ] [Thread-5 (]: 40 of 88 OK created sql incremental model dev_dm_pst3_BE.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS  [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 4.47s]
[0m10:33:50.864536 [debug] [Thread-5 (]: Finished running node model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS
[0m10:33:50.865082 [debug] [Thread-5 (]: Began running node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:33:50.865651 [info ] [Thread-5 (]: 46 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS ......... [RUN]
[0m10:33:50.866195 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.NUMBER_OF_PAYMENT_ACCOUNTS_ACCESSED_BY_AISPS, now model.project_dbt.PAY_TROP_5845_IBIS)
[0m10:33:50.866773 [debug] [Thread-5 (]: Began compiling node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:33:50.874458 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m10:33:50.875064 [debug] [Thread-5 (]: Began executing node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:33:50.877935 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:33:50.903198 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.PAY_CPNC"
[0m10:33:50.904729 [debug] [Thread-14 ]: On model.project_dbt.PAY_CPNC: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_CPNC`
      
    
    

    OPTIONS()
    as (
      SELECT
    "X" AS Ot,
    row_number() over () as IDReg,
    LAST_DAY(date_add(DATE(TIMESTAMP(DATETIME( '2024-10-01 10:33:50.297425', 'Etc/UTC'))), INTERVAL -1 MONTH)) as DtRef,
    "5845" AS ASPSP,
    "5493000RZ2KSLKCYNN98" AS LEIASPSP,
    "N.E." AS `If`,
    "2" AS TipCont,
    "" AS DepOvTr,
    le.ENTERPRISE_ADDRESS_COUNTRY as PasTit,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS CPos,
    pa.PAYMENT_ACCOUNT_CURRENCY AS Div,
    "Y" AS ContrOB,
    count(1) as NCont,
    count(1) as NContAOn,
    0 AS NContAISPM,
    0 AS SaldoME,
    ""  AS Period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` as iac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED` AS pa
    ON iac.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
    AND LEFT(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES` AS lep
        ON lep.T_D_PAYMENT_ACCOUNT_DIM_KEY = pa.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` AS le
    ON le.T_DIM_KEY = lep.T_D_LEGAL_ENTITY_DIM_KEY
WHERE
    (
        pa.PAYMENT_ACCOUNT_STATUS = 'ACTIVE'
        OR(
            pa.PAYMENT_ACCOUNT_STATUS != 'ACTIVE'
            AND pa.PAYMENT_ACCOUNT_UPDATED_AT >= TIMESTAMP('2024-10-01 10:33:50.297425')
        )
    )
    AND left(pa.PAYMENT_ACCOUNT_NUMBER,2) = 'BE'
    AND pa.PAYMENT_ACCOUNT_CREATED_AT <= TIMESTAMP('2024-10-31 10:33:50.297425')
GROUP BY 1,3,4,5,6,7,8,9,10,11,12,15,16,17,18
    );
  
[0m10:33:51.251184 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_CMD"
[0m10:33:51.252976 [debug] [Thread-8 (]: On model.project_dbt.PAY_TROP_5845_CMD: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD`
      
    
    

    OPTIONS()
    as (
      SELECT
    pa.PAYMENT_ACCOUNT_NUMBER AS identifier,
    le.ENTERPRISE_ADDRESS_NUMBER AS enterprise_number,
    le.ENTERPRISE_LEGAL_FORM AS legal_form,
    le.ENTERPRISE_ADDRESS_COUNTRY AS country,
    le.ENTERPRISE_ADDRESS_POSTAL_CODE AS postal_code,
FROM(
  WITH current_table AS (
  SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ACCOUNT_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
)  AS pa
LEFT JOIN(
select *,
row_number() over(partition by T_D_PAYMENT_ACCOUNT_DIM_KEY order by T_INGESTION_TIMESTAMP desc) as rn
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_LEGAL_ENTITY_PAYMENT_ACCOUNT_ROLES_DECRYPTED`
)  lepar
    ON pa.T_DIM_KEY = lepar.T_D_PAYMENT_ACCOUNT_DIM_KEY AND lepar.T_FACT_KEY != 0
    and rn = 1
LEFT JOIN(
  WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED`
  )
  SELECT * EXCEPT(rn)
  FROM current_table
  WHERE rn = 1
)  AS le
    ON lepar.T_D_LEGAL_ENTITY_DIM_KEY = le.T_DIM_KEY AND le.T_DIM_KEY <> 0
WHERE pa.T_DIM_KEY <> 0 AND pa.PAYMENT_ACCOUNT_COUNTRY = 'BE'
    AND pa.T_SOURCE = 'P1_PCMD'
    );
  
[0m10:33:51.299638 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a015a217-dc62-4a5d-89b7-28e0b35a37f0&page=queryresults
[0m10:33:51.317342 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf2b460>]}
[0m10:33:51.319084 [info ] [Thread-10 ]: 29 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_credit_transers_received  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 11.08s]
[0m10:33:51.320742 [debug] [Thread-10 ]: Finished running node model.project_dbt.Cuardro4_credit_transers_received
[0m10:33:51.321967 [debug] [Thread-10 ]: Began running node model.project_dbt.PAY_TROP_5845_PIS
[0m10:33:51.323256 [info ] [Thread-10 ]: 47 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS .......... [RUN]
[0m10:33:51.324748 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_credit_transers_received, now model.project_dbt.PAY_TROP_5845_PIS)
[0m10:33:51.326118 [debug] [Thread-10 ]: Began compiling node model.project_dbt.PAY_TROP_5845_PIS
[0m10:33:51.336550 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m10:33:51.337076 [debug] [Thread-10 ]: Began executing node model.project_dbt.PAY_TROP_5845_PIS
[0m10:33:51.340785 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:33:51.496385 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_IBIS"
[0m10:33:51.498757 [debug] [Thread-5 (]: On model.project_dbt.PAY_TROP_5845_IBIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS`
      
    
    

    OPTIONS()
    as (
      WITH outbound as (
  SELECT
  'O' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ord,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
  '' AS PayID,
  baBA.BANK_ACCOUNT_BIC AS BICOrd,
  baCB.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '5493000RZ2KSLKCYNN98' AS LEIOrd,
  '' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  CASE
    WHEN fat.TRANSACTION_CHANNEL = 'OTHER' THEN'8'
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS') THEN'4'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'6'
    ELSE 'check the query'
  END AS TipCan,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER','TPP','OCS') THEN'2'
    WHEN fat.TRANSACTION_CHANNEL = 'H2H' THEN'1'
    ELSE 'check the query'
  END AS FormEnv,

  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','H2H') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('OTHER') THEN'N'
    ELSE 'check the query'
  END AS OperElet,

  'Y' AS OperRem,
  'Y' AS OperECom,
  'N' AS IniPISP,
  '1' AS ModAc,
  CASE
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') THEN'Y'
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') THEN'N'
    ELSE 'check the query'
  END AS SCA,

  case
    WHEN fat.TRANSACTION_CHANNEL IN ('TPP','OCS','OTHER') then ''
    WHEN fat.TRANSACTION_CHANNEL IN ('H2H') then '5'
    ELSE 'check the query'
  END AS MnonSCA,

  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "OUTBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND fat.TRANSACTION_CHANNEL <> 'CARDS'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
),
inbound as (
  SELECT
  'B' AS Ot,
  fat.T_SOURCE_PK_ID AS Ref,
  '' AS ORef,
  baBA.BANK_ACCOUNT_NUMBER as debtor_account_identifier ,
  baCB.BANK_ACCOUNT_NUMBER as creditor_account_identifier,
  IF(left(baCB.BANK_ACCOUNT_NUMBER,2)='BE', substr(baCB.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ord,
  substr(baBA.BANK_ACCOUNT_NUMBER,5,4) AS Ben,
  '' AS PayID,
  baCB.BANK_ACCOUNT_BIC AS BICOrd,
  baBA.BANK_ACCOUNT_BIC AS BICBen,
  '' AS BICSen,
  '' AS BICRec,
  baCB.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasOrd,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
  '' AS LEIOrd,
  '5493000RZ2KSLKCYNN98' AS LEIBen,
  '4' AS Sch,
  IF(baCB.BANK_ACCOUNT_BIC = 'PANXPTP2','3','9') AS Pro,
  date(ats.TRANSACTION_BOOKING_DATE_AT) AS DtLiq,
  cast(null as date) AS DtPISP,
  '' AS TsOrd,
  '' AS TsBen,
  '1' AS TipTR,
  fat.TRANSACTION_CURRENCY AS Div,
  fat.TRANSACTION_AMOUNT AS Mont,
  fat.TRANSACTION_AMOUNT AS MontOrg,
  '' AS TipCan,
  '' AS FormEnv,
  '' AS OperElet,
  '' AS OperRem,
  'N' AS OperECom,
  '' AS IniPISP,
  '' AS ModAc,
  '' AS SCA,
  '' AS MnonSCA,
  'N.E.' AS SI,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasmC,
  baBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasnC,
  '' AS CPosm,
  '' AS TipDoc,
  '' AS NumDoc,
  '' AS LEIC,
  'N' AS ENI,
  '' AS InfUltBen,
  '' AS InfUltOrd,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as fat
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` ibis
  ON fat.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baBA
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = baBA.T_DIM_KEY
  -- AND baBA.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as baCB
  ON baCB.T_DIM_KEY = fat.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  -- AND baCB.T_SOURCE_TABLE = "READ_DWH_TRANSACTIONS"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_DECRYPTED` AS ats
  ON fat.T_D_ACCOUNT_TRANSACTION_DIM_KEY = ats.T_DIM_KEY

WHERE fat.TRANSACTION_DIRECTION = "INBOUND"
  AND baBA.Financial_institution_country_code = 'BE'
  AND (fat.TRANSACTION_TYPE ) = 'REGULAR'
  AND (ats.TRANSACTION_STATUS ) IN ('RETURNED', 'SETTLED')
  AND (ibis.ACCOUNT_TYPE ) = 'PAYMENT'
  AND fat.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
  AND TIMESTAMP(ats.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
)
SELECT * FROM outbound
UNION ALL
SELECT * FROM inbound
    );
  
[0m10:33:51.737065 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:5cf482e4-f267-429b-adb8-311baa53eab6&page=queryresults
[0m10:33:51.948061 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845_PIS"
[0m10:33:51.950028 [debug] [Thread-10 ]: On model.project_dbt.PAY_TROP_5845_PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS`
      
    
    

    OPTIONS()
    as (
      SELECT
    'I' AS Ot,
    '' AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE ='BE', substr(deb.BANK_ACCOUNT_NUMBER, 5,4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE  ='BE', substr(cred.BANK_ACCOUNT_NUMBER,5,4), '9999') AS Ben,
    pi.T_SOURCE_PK_ID  AS PayID,
    deb.BANK_ACCOUNT_NUMBER  as debtor_account_identifier,
    cred.BANK_ACCOUNT_NUMBER as creditor_account_identifier ,
    '' AS BICOrd,
    '' AS BICBen,
    '' AS BICSen,
    '' AS BICRec,
    fi.FINANCIAL_INSTITUTION_COUNTRY AS PasOrd,
    cred.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PasBen,
    '' as LEIOrd,
    '' as LEIBen,
    '28' as Sch,
    '' as Pro,
    cast(null as DATE) as DatLiq,
    date(pi.PAYMENT_INITIATION_CREATED_AT) as DtPISP,
    '' AS TsOrd,
    '' AS TsBen,
    '1' AS TipTR,
    it.INBOUND_TRANSACTION_CURRENCY_CODE as Div,
    it.INBOUND_TRANSACTION_AMOUNT as Mont,
    it.INBOUND_TRANSACTION_AMOUNT as MontOrg,
    '4' as TipCan,
    '2' as FormEnv,
    'Y' as OperElet,
    'Y' as OperRem,
    'Y' as OperECom,
    'N' as IniPISP,
    '1' as ModAc,
    'N' as SCA,
    '10' as MnonSCA,
    'N.E.' as SI,
    '' as PasmC,
    '' as PasnC,
    '' as CPosm,
    '' AS TipDoc,
    '' AS NumDoc,
    '' AS LEIC,
    '' AS ENI,
    '' AS InfUltBen,
    '' AS InfUltOrd,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_DECRYPTED` AS ip
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON ip.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED`
    AS it ON ip.T_DIM_KEY=it.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO_DECRYPTED`
    AS dit ON dit.T_DIM_KEY=it.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS`
    AS pi ON ip.T_DIM_KEY=pi.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
    AS app ON ip.T_D_APPLICATION_DIM_KEY = app.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS deb ON deb.T_DIM_KEY=ip.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED`
    AS cred ON cred.T_DIM_KEY=it.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY

WHERE pi.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
    AND (
        app.APPLICATION_NAME IN ('PAY-PXG-COMMUNITY')
        OR
            (
                app.APPLICATION_NAME IN ('PAY-PXG-OCS')
                AND (cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
                AND substr(cred.BANK_ACCOUNT_NUMBER,5,3) = '504'    )
            )
        )
    --  AND (
    --     app.APPLICATION_NAME = 'PAY-PXG-BANQUPPT'
    --     OR (
    --         app.APPLICATION_NAME = 'PAY-PXG-OCS'
    --         AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    --         AND substr(cred.BANK_ACCOUNT_NUMBER,5,4) = '5845'
    --         )
    --     )-- creditor account is a PANX PT account
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dit.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:33:52.045294 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:deb7f4ff-ca95-4655-8b88-f98641536d68&page=queryresults
[0m10:33:52.284234 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf8db40>]}
[0m10:33:52.285976 [info ] [Thread-1 (]: 39 of 88 OK created sql incremental model dev_dm_pst3_DE.NC1_Number_of_payment_accounts_accessed_by_UPP  [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 5.91s]
[0m10:33:52.287698 [debug] [Thread-1 (]: Finished running node model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP
[0m10:33:52.288933 [debug] [Thread-1 (]: Began running node model.project_dbt.PAY_TRRT_5845
[0m10:33:52.290267 [info ] [Thread-1 (]: 48 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 .............. [RUN]
[0m10:33:52.291683 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.NC1_Number_of_payment_accounts_accessed_by_UPP, now model.project_dbt.PAY_TRRT_5845)
[0m10:33:52.293390 [debug] [Thread-1 (]: Began compiling node model.project_dbt.PAY_TRRT_5845
[0m10:33:52.309070 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.PAY_TRRT_5845"
[0m10:33:52.309710 [debug] [Thread-1 (]: Began executing node model.project_dbt.PAY_TRRT_5845
[0m10:33:52.312250 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:33:52.351223 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c8d1d8fa-abf5-42b0-8da4-bbb0355f40c0&page=queryresults
[0m10:33:52.553652 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc202184c0>]}
[0m10:33:52.555374 [info ] [Thread-2 (]: 17 of 88 OK created sql incremental model dev_dm_pst3_FR.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo  [[32mCREATE TABLE (3.0 rows, 44.7 GiB processed)[0m in 22.64s]
[0m10:33:52.557037 [debug] [Thread-2 (]: Finished running node model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo
[0m10:33:52.558224 [debug] [Thread-2 (]: Began running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:33:52.559492 [info ] [Thread-2 (]: 49 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS ....... [RUN]
[0m10:33:52.560900 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.C6_agMoyPaiTypeOpeCanalTransactAuthZoneGeo, now model.project_dbt.PCP_ALBATROS_CMD_OCS)
[0m10:33:52.562096 [debug] [Thread-2 (]: Began compiling node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:33:52.572998 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m10:33:52.573581 [debug] [Thread-2 (]: Began executing node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:33:52.577270 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:33:52.620024 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc204857b0>]}
[0m10:33:52.621617 [info ] [Thread-16 ]: 34 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P11_Outgoing_transactions  [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 10.91s]
[0m10:33:52.623234 [debug] [Thread-16 ]: Finished running node model.project_dbt.KMS_P11_Outgoing_transactions
[0m10:33:52.624549 [debug] [Thread-16 ]: Began running node model.project_dbt.PCP_ATM
[0m10:33:52.626022 [info ] [Thread-16 ]: 50 of 88 START sql incremental model dev_dm_pst3_BE.PCP_ATM .................... [RUN]
[0m10:33:52.627305 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P11_Outgoing_transactions, now model.project_dbt.PCP_ATM)
[0m10:33:52.628761 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PCP_ATM
[0m10:33:52.637747 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PCP_ATM"
[0m10:33:52.638323 [debug] [Thread-16 ]: Began executing node model.project_dbt.PCP_ATM
[0m10:33:52.640930 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:33:52.747113 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:2318c4ee-81e2-40d1-a7b9-e8c0f7874d62&page=queryresults
[0m10:33:52.918239 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.PAY_TRRT_5845"
[0m10:33:52.920835 [debug] [Thread-1 (]: On model.project_dbt.PAY_TRRT_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TRRT_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
    'O' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
    AND ftr.transaction_type = 'RETURN'
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND ftr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    ftr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(dtr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` iacc
    ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = iacc.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON iacc.T_D_BANK_ACCOUNT_DIM_KEY = cred.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON deb.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
    ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE ftr.TRANSACTION_DIRECTION = 'INBOUND'
    AND cred.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND iacc.ACCOUNT_TYPE = 'PAYMENT'
    AND ftr.transaction_type IN ('RETURN')
    AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(dtr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
--UNMATCHED TRANSACTIONS
UNION ALL
SELECT
    'O' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` deb
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = deb.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` cred
    ON cred.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND DEB.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND utr.TRANSACTION_CHANNEL <> 'CARDS'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
UNION ALL
SELECT
    'B' AS Ot,
    utr.T_SOURCE_PK_ID AS Ref,
    '' AS ORef,
    IF(deb.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE',SUBSTR(deb.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ord,
    IF(cred.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE', SUBSTR(cred.BANK_ACCOUNT_NUMBER, 5, 4), '9999') AS Ben,
    '' AS PayID,
    deb.BANK_ACCOUNT_BIC AS BICOrd,
    cred.BANK_ACCOUNT_BIC AS BICBen,
    '' AS MotrTransSCT,
    '' AS MotrTransInst,
    '' AS MotrTransTns,
    '' AS MotrTransTgtSwift,
    DATE(utr.TRANSACTION_BOOKING_DATE_AT) AS DtLiqRtrans,
    '4' AS TiprTransTRF,
    ""  AS Period,
    CURRENT_TIMESTAMP AS load_timestamp,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_UNMATCHED_ACCOUNT_TRANSACTIONS` utr
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` CRED
    ON utr.T_D_MISSING_BANK_ACCOUNT_DIM_KEY = CRED.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` DEB
    ON DEB.T_DIM_KEY = utr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
-- LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` dtr
--     ON utr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
WHERE utr.TRANSACTION_DIRECTION = 'INBOUND'
    AND CRED.FINANCIAL_INSTITUTION_COUNTRY_CODE in ('BE')
    AND utr.transaction_type = 'RETURN'
    AND utr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
    AND utr.TRANSACTION_BANK_FAMILY = 'RCDT'
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) >= TIMESTAMP(DATETIME( '2024-10-06', 'Etc/UTC')) --pt winter time
    AND TIMESTAMP(utr.TRANSACTION_BOOKING_DATE_AT) <= TIMESTAMP(DATETIME( '2024-10-07', 'Etc/UTC'))   --pt winter time
    );
  
[0m10:33:53.034371 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1ab28dc0>]}
[0m10:33:53.035802 [info ] [Thread-7 (]: 36 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P21_Inbound_transactions  [[32mCREATE TABLE (1.0 rows, 11.0 GiB processed)[0m in 10.13s]
[0m10:33:53.037175 [debug] [Thread-7 (]: Finished running node model.project_dbt.KMS_P21_Inbound_transactions
[0m10:33:53.037984 [debug] [Thread-7 (]: Began running node model.project_dbt.PCP_POS_ONLINE
[0m10:33:53.039001 [info ] [Thread-7 (]: 51 of 88 START sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ............. [RUN]
[0m10:33:53.039787 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P21_Inbound_transactions, now model.project_dbt.PCP_POS_ONLINE)
[0m10:33:53.040450 [debug] [Thread-7 (]: Began compiling node model.project_dbt.PCP_POS_ONLINE
[0m10:33:53.050783 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.PCP_POS_ONLINE"
[0m10:33:53.051412 [debug] [Thread-7 (]: Began executing node model.project_dbt.PCP_POS_ONLINE
[0m10:33:53.054757 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:33:53.194616 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.PCP_ALBATROS_CMD_OCS"
[0m10:33:53.196768 [debug] [Thread-2 (]: On model.project_dbt.PCP_ALBATROS_CMD_OCS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS`
      
    
    

    OPTIONS()
    as (
      WITH ALB AS (
SELECT
    '73f02cef-1f20-446a-b66f-5368c222a58e' AS companyid_tobeexcluded,
    'VigorPlus Holding B.V.' AS legal_name,
    'COLLECTOR_NL_FULL' AS product_name,
    'NL' AS to_be_reported_in_country
UNION ALL
SELECT '46d24da8-952f-44e3-b880-f1edd2a7e5a2', 'SIA EZ', 'COLLECTOR_LV_FULL', 'LV' UNION ALL
SELECT '0df4ade3-3e72-48d9-8897-e7439551a8ca', 'BLOX USINAGE PLASTIQUES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0f8c4fd2-72b2-4261-8599-223bcb67c711', 'LOTHESA', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '12144ea2-9a8a-49dd-b01f-0bdbb8189db5', 'MPG CONSEIL EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1840ea14-f726-448b-a716-e92f5009d322', 'FID SUD AGEN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1b12d30c-1820-400a-86eb-15601492979e', 'QUENETTE STEVE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '1c72dfa2-b07e-455f-a00c-2fd64784f9c2', 'CIE EUROP GESTION EXPERTISES COMPTABLES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '23e4432f-43ed-4bf6-ab30-29f9d5a6f102', 'D.B.D.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '26801b29-16ed-4330-b180-3d4fb997aa6d', 'BAT EVENT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '38c5e0bc-d122-4783-872c-e2cdbbef0ece', 'LAMY EXPERTS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '497c6deb-a48b-464a-9318-02cf543ba323', 'FID SUD MONTAUBAN', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5c5225a4-08a4-4052-b712-74bfe7a99da8', 'SDRD', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '5e05cabb-e5bd-42e7-a50c-df17fb04f3c7', 'KOMO MARCHE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '634b1ae4-8dca-46f4-ae17-ef28f87e91af', 'CABINET CONCEPT EXPERT - CCE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '698f1c97-3d15-4a42-9914-e9513a8fe723', 'EXPERTS TEAM', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '6f216187-3566-4097-92e8-9de30f59bb19', 'ABAQUE CONSULTING', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '01dd8d49-de77-4311-bac3-c7a8c74b4275', 'EN SA MEMOIRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '768e77cd-7de9-4369-a7ba-b0b04db3ab67', 'OLIVER AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '791f2d5e-338f-4f82-9519-85a28c163884', 'MVT CONSEILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '99053b0d-3e81-4972-a491-bd34beb026a6', 'N.D.EX.CO.', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'a9feb33b-db68-4020-a5f3-279123565354', 'SALAS-GORDO & COELHO', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'c45758bd-85b4-4f61-accc-ee180364a60b', 'NICOL & ASSOCIES', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'cd8e4416-da0c-4a12-9934-78618f0694b3', 'IN FINE EXPERTISE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e196486d-0014-4931-b183-f32c190897d8', 'MALHERBE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e2a66866-98c4-4ef0-a67d-637e58273603', 'BENAUW HUBERT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e7f0ba81-6c3f-4b3d-9bf5-4d42dc88d56f', 'F2AB AUDIT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'e9708122-4491-4930-bdd7-d70e50415d2f', 'BEY MANUTENTION', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'f10e6a0f-67e4-4662-83b7-7faba187e157', 'GARDILLE JEAN-PIERRE', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fb77318d-18f5-43d2-a202-512943c4f92b', 'SOGAREX', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fbe51ec9-8cb7-4825-be45-594886d67fac', 'CHESNEAU CHRISTIAN ET FILS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT 'fcb01b27-09c9-42c3-befa-3950b3150b1f', 'LOZANGE IT', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '733045f3-c626-49a3-aad6-a514f19ad0e0', 'QINTENS', 'COLLECTOR_FR_FULL', 'FR' UNION ALL
SELECT '0567d2fa-6eca-4422-8570-ff714ccd8aa4', 'D-DALE', 'COLLECTOR_FR_FULL', 'FR'
),
CMD as (
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_OCS_ACTIVE = true
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

UNION ALL
SELECT
    D.T_SOURCE_PK_ID as companyid_tobeexcluded,
    D.ENTERPRISE_LEGAL_NAME as legal_name,
    D.ENTERPRISE_COUNTRY_OF_INCORPORATION as to_be_reported_in_country
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_CURRENT` C
LEFT JOIN  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_LEGAL_ENTITY_DECRYPTED` D  ON C.T_SOURCE_PK_ID = D.T_SOURCE_PK_ID
WHERE D.ENTERPRISE_SOURCE = 'ALBATROS'
    AND D.ENTERPRISE_KYC_STATUS = 'APPROVED'
    AND D.ENTERPRISE_COUNTRY_OF_INCORPORATION not in ('BE','LT', 'RO', 'BG', 'HR')
    AND C.ENTERPRISE_UPDATED_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND C.ENTERPRISE_UPDATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))

ORDER BY 2
),
souce_table as(
SELECT  CMD.* FROM CMD
UNION ALL
SELECT
    ALB.companyid_tobeexcluded,
    ALB.legal_name,
    ALB.to_be_reported_in_country
FROM ALB
ORDER BY 2
)
SELECT
*,
""  AS Period,
TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
CURRENT_TIMESTAMP AS load_timestamp,
FROM souce_table
    );
  
[0m10:33:53.245088 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PCP_ATM"
[0m10:33:53.246890 [debug] [Thread-16 ]: On model.project_dbt.PCP_ATM: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ATM`
      
    
    

    OPTIONS()
    as (
      SELECT
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS Counterpart_area,
  FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE AS POS_location,
  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL AS remote_non_remote_initiation,
  COUNT(*) AS number_of_transactions,
  SUM(FCT.card_transaction_cleared_amount) + SUM(FCT.card_transaction_refunded_amount) AS total_sum,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
WHERE
FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM'
AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
-- AND FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
-- AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2,3
    );
  
[0m10:33:53.733059 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2082f1c0>]}
[0m10:33:53.735720 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.PCP_POS_ONLINE"
[0m10:33:53.737483 [info ] [Thread-9 (]: 42 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCL .............. [[32mCREATE TABLE (1.0 rows, 3.4 GiB processed)[0m in 4.80s]
[0m10:33:53.739893 [debug] [Thread-9 (]: Finished running node model.project_dbt.PAY_CPCL
[0m10:33:53.741295 [debug] [Thread-9 (]: Began running node model.project_dbt.PCT_IDEAL
[0m10:33:53.746514 [debug] [Thread-7 (]: On model.project_dbt.PCP_POS_ONLINE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_POS_ONLINE`
      
    
    

    OPTIONS()
    as (
      with pre as (
 SELECT
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as Counterpart_area,
   FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE as POS_location,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'non-remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'remote'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'non-remote'
     ELSE 'check the query' end as remote_non_remote_initiation,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESSFUL'
           then 'SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS  in('UNAVAILABLE', 'THREEDS_REQUESTER_SCA_EXEMPTION')
           or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'non-SCA is used'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
               AND FCT.CARD_TRANSACTION_PIN_PRESENT is true
               then 'SCA is used'
   END AS SCA_used,
   CASE
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'SUCCESS'
           then 'N/A'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS =  'EXEMPTED'
           then 'low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT'
           then  'Recurring payment'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'MERCHANT_INITIATED_TRANSACTION'
           then  'Merchant initiated transaction (MIT)'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'TRANSACTION_RISK_ANALYSIS'
           then  'Transaction risk analysis'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'SECURE_CORPORATE_PAYMENT'
           then  'Secure corporate payment processes AND protocols'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'
           AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS IN('UNAVAILABLE' ,'THREEDS_REQUESTER_SCA_EXEMPTION')
           then  'Others'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE =  'CHIP_CONTACTLESS'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT is false
           then 'Contactless low value'
     WHEN  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER'
           AND FCT.CARD_TRANSACTION_PIN_PRESENT  is true then 'N/A'
     END AS SCA_Exemption_reason,
     count(*) as number_of_transactions	,
     sum (FCT.card_transaction_cleared_amount) + sum(FCT.card_transaction_refunded_amount) as total_sum,
 FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_DIM_KEY = C.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
 LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
 WHERE FCT.CARD_TRANSACTION_USER_TIME >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
     AND FCT.CARD_TRANSACTION_USER_TIME <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
     AND FTE.TRANSACTION_EVENT_TYPE in ('authorization','refund.authorization')
     AND FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
     AND DTE.TRANSACTION_EVENT_STATUS = 'COMPLETED'
     AND FCT.CARD_TRANSACTION_PAYMENT_CHANNEL <> 'ATM'
     AND CP.CARD_PRODUCT_CARD_COUNTRY = 'BE'
     group by 1,2,3,4,5
 ),
 NBB_onegate as (
       SELECT 'low value' AS sca_reason, 201 AS sca_reason_code
       UNION ALL
       SELECT 'Contactless low value', 202
       UNION ALL
       SELECT 'Trusted beneficiaries', 204
       UNION ALL
       SELECT 'Recurring Payment', 205
       UNION ALL
       SELECT 'Unattended terminal for transport fares or parking fees', 206
       UNION ALL
       SELECT 'Secure corporate payment processes and protocols', 207
       UNION ALL
       SELECT 'Transaction risk analysis', 208
       UNION ALL
       SELECT 'Merchant initiated transaction (MIT)', 209
       UNION ALL
       SELECT 'Others', 210
       UNION ALL
       SELECT 'N/A', 100
 )
 SELECT
   IF(pre.Counterpart_area = 'BE','W2',
         IF(map_area.code is null,'G1', pre.Counterpart_area)) AS Counterpart_area_GEO3,
   IF(pre.POS_location = 'BE','W2',
         IF(map_location.code is null,'G1', pre.POS_location)) AS POS_location_GEO3,
   'CPO' as Transaction_type,
   '2000' as Initiation_channel,
   if (pre.remote_non_remote_initiation = 'non-remote', 'NR', 'R') AS remoteness,
   'PCS_ALL' as Scheme,
   '11' as Card_function,
   '_Z' as Card_function_irrelevant,
   NBB_onegate.sca_reason_code as SCA,
   '_X' as SCA_irrelevant,
   '_Z'as Fraud_type_irrelevant,
   pre.number_of_transactions,
   pre.total_sum,
   CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
   ""  AS Period,
 FROM pre
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_area
   ON map_area.code = pre.Counterpart_area
   AND map_area.type = 'Geographical area'
 LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` map_location
   ON map_location.code = pre.POS_location
   AND map_location.type = 'Geographical area'
 LEFT JOIN NBB_onegate on  NBB_onegate.sca_reason = pre.SCA_Exemption_reason
    );
  
[0m10:33:53.744722 [info ] [Thread-9 (]: 52 of 88 START sql incremental model dev_dm_pst3_BE.PCT_IDEAL .................. [RUN]
[0m10:33:53.753789 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCL, now model.project_dbt.PCT_IDEAL)
[0m10:33:53.754882 [debug] [Thread-9 (]: Began compiling node model.project_dbt.PCT_IDEAL
[0m10:33:53.766560 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.PCT_IDEAL"
[0m10:33:53.767312 [debug] [Thread-9 (]: Began executing node model.project_dbt.PCT_IDEAL
[0m10:33:53.769762 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:33:53.780309 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:e77dfe74-1df3-484f-a08a-e9ff0441d888&page=queryresults
[0m10:33:54.047621 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:084fc11b-7627-4a1a-b03a-24e64e07c859&page=queryresults
[0m10:33:54.085061 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:bc1ff38a-829f-494a-86b9-2785f75b48ac&page=queryresults
[0m10:33:54.392465 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.PCT_IDEAL"
[0m10:33:54.394417 [debug] [Thread-9 (]: On model.project_dbt.PCT_IDEAL: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_IDEAL`
      
    
    

    OPTIONS()
    as (
      SELECT
  COALESCE( nullif( d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY, 'NA'), left(dl_trans_pro.value,2))  AS PAYER_COUNTRY,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  COUNT(DISTINCT f_payment_items.T_FACT_KEY) AS VOLUME,
  ROUND(SUM(f_payment_items.PAYMENT_ITEM_AMOUNT)) AS AMOUNT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS`
    AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS`
    AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS`   AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED`
    AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED`
    AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN (
SELECT
  transaction_id,
  key,
  AEAD.DECRYPT_STRING(k0.KEYSET, value, TO_HEX(_flycs_metadata_keyset_0)) value,
  from `pj-bu-dw-dl-prod`.`prd_datalake_P1_PSTA`.`dwh_transaction_properties_current`
  left join `pj-bu-dw-ks-prod`.`prd_keysets`.`merged` k0
  on lower(k0.SOURCE) = "p1_psta_dwh_transaction_properties"
  and _flycs_metadata_keyset_0 = k0.HASH_ID
  WHERE key = "PAYER_ACCOUNT_ID"
) as dl_trans_pro
 on cast (dl_trans_pro.transaction_id as string) = d_payment_transaction_info.T_SOURCE_PK_ID
WHERE d_merchants.MERCHANT_COUNTRY  IS NOT NULL
    and d_payment_products.PRODUCT_CODE = "IDEAL_COLLECT"
    and d_payment_transaction_info.payment_transaction_cutoff_at >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))   -- start of reporting period
    and d_payment_transaction_info.payment_transaction_cutoff_at <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   -- end of reporting period
GROUP BY
    1,
    2
    );
  
[0m10:33:54.590319 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c1ebc8c7-47c8-4699-acba-fcc1ea1e4c9d&page=queryresults
[0m10:33:54.976455 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210c4610>]}
[0m10:33:54.979064 [info ] [Thread-14 ]: 44 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPNC .............. [[32mCREATE TABLE (274.0 rows, 1.4 GiB processed)[0m in 4.69s]
[0m10:33:54.981003 [debug] [Thread-14 ]: Finished running node model.project_dbt.PAY_CPNC
[0m10:33:54.982221 [debug] [Thread-14 ]: Began running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:33:54.983719 [info ] [Thread-14 ]: 53 of 88 START sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP ...... [RUN]
[0m10:33:54.984872 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPNC, now model.project_dbt.PCT_INITIATED_BY_PISP)
[0m10:33:54.988444 [debug] [Thread-14 ]: Began compiling node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:33:55.000273 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m10:33:55.001001 [debug] [Thread-14 ]: Began executing node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:33:55.004708 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:33:55.067003 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210331f0>]}
[0m10:33:55.068746 [info ] [Thread-12 ]: 38 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P7a_number_of_accounts  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 8.70s]
[0m10:33:55.070510 [debug] [Thread-12 ]: Finished running node model.project_dbt.KMS_P7a_number_of_accounts
[0m10:33:55.071698 [debug] [Thread-12 ]: Began running node model.project_dbt.PCT_OUTBOUND
[0m10:33:55.072988 [info ] [Thread-12 ]: 54 of 88 START sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND ............... [RUN]
[0m10:33:55.074334 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P7a_number_of_accounts, now model.project_dbt.PCT_OUTBOUND)
[0m10:33:55.075505 [debug] [Thread-12 ]: Began compiling node model.project_dbt.PCT_OUTBOUND
[0m10:33:55.084473 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.PCT_OUTBOUND"
[0m10:33:55.084967 [debug] [Thread-12 ]: Began executing node model.project_dbt.PCT_OUTBOUND
[0m10:33:55.087446 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:33:55.265795 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a8fd8f9f-0baa-4bd9-8f9f-1cf2f2ca7cad&page=queryresults
[0m10:33:55.574946 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20110250>]}
[0m10:33:55.576587 [info ] [Thread-8 (]: 45 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_CMD ..... [[32mCREATE TABLE (518.0 rows, 1.4 GiB processed)[0m in 4.95s]
[0m10:33:55.578274 [debug] [Thread-8 (]: Finished running node model.project_dbt.PAY_TROP_5845_CMD
[0m10:33:55.579423 [debug] [Thread-8 (]: Began running node model.project_dbt.PIS
[0m10:33:55.580762 [info ] [Thread-8 (]: 55 of 88 START sql incremental model dev_dm_pst3_BE.PIS ........................ [RUN]
[0m10:33:55.581981 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_CMD, now model.project_dbt.PIS)
[0m10:33:55.582995 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PIS
[0m10:33:55.595321 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PIS"
[0m10:33:55.596014 [debug] [Thread-8 (]: Began executing node model.project_dbt.PIS
[0m10:33:55.598644 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:33:56.182669 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1b540a00>]}
[0m10:33:56.183277 [info ] [Thread-4 (]: 28 of 88 OK created sql incremental model dev_dm_pst3_ES.Cuardro4_PIS .......... [[32mCREATE TABLE (0.0 rows, 27.5 GiB processed)[0m in 16.90s]
[0m10:33:56.183791 [debug] [Thread-4 (]: Finished running node model.project_dbt.Cuardro4_PIS
[0m10:33:56.184173 [debug] [Thread-4 (]: Began running node model.project_dbt.PI_FINAL_QUERY
[0m10:33:56.184573 [info ] [Thread-4 (]: 56 of 88 START sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ............. [RUN]
[0m10:33:56.184950 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.Cuardro4_PIS, now model.project_dbt.PI_FINAL_QUERY)
[0m10:33:56.185431 [debug] [Thread-4 (]: Began compiling node model.project_dbt.PI_FINAL_QUERY
[0m10:33:56.193737 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.PI_FINAL_QUERY"
[0m10:33:56.195617 [debug] [Thread-4 (]: Began executing node model.project_dbt.PI_FINAL_QUERY
[0m10:33:56.198550 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:33:57.319020 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2006afb0>]}
[0m10:33:57.320756 [info ] [Thread-2 (]: 49 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ALBATROS_CMD_OCS .. [[32mCREATE TABLE (63.0 rows, 1.5 GiB processed)[0m in 4.76s]
[0m10:33:57.321643 [debug] [Thread-2 (]: Finished running node model.project_dbt.PCP_ALBATROS_CMD_OCS
[0m10:33:57.322032 [debug] [Thread-2 (]: Began running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:33:57.322434 [info ] [Thread-2 (]: 57 of 88 START sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [RUN]
[0m10:33:57.322807 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ALBATROS_CMD_OCS, now model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS)
[0m10:33:57.323116 [debug] [Thread-2 (]: Began compiling node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:33:57.328102 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m10:33:57.328615 [debug] [Thread-2 (]: Began executing node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:33:57.330988 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:33:57.634687 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210444f0>]}
[0m10:33:57.636350 [info ] [Thread-16 ]: 50 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_ATM ............... [[32mCREATE TABLE (7.0 rows, 1.3 GiB processed)[0m in 5.01s]
[0m10:33:57.637992 [debug] [Thread-16 ]: Finished running node model.project_dbt.PCP_ATM
[0m10:33:57.639247 [debug] [Thread-16 ]: Began running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:33:57.640867 [info ] [Thread-16 ]: 58 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [RUN]
[0m10:33:57.641932 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_ATM, now model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN)
[0m10:33:57.643076 [debug] [Thread-16 ]: Began compiling node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:33:57.652032 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m10:33:57.652565 [debug] [Thread-16 ]: Began executing node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:33:57.746086 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:33:58.443817 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc18dfa8c0>]}
[0m10:33:58.446702 [info ] [Thread-15 ]: 33 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_MRA ............... [[32mCREATE TABLE (0.0 rows, 10.3 GiB processed)[0m in 16.89s]
[0m10:33:58.450489 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc18dfa860>]}
[0m10:33:58.452368 [debug] [Thread-15 ]: Finished running node model.project_dbt.KMS_MRA
[0m10:33:58.454503 [info ] [Thread-7 (]: 51 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP_POS_ONLINE ........ [[32mCREATE TABLE (23.0 rows, 1.3 GiB processed)[0m in 5.41s]
[0m10:33:58.456272 [debug] [Thread-15 ]: Began running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:33:58.458387 [debug] [Thread-7 (]: Finished running node model.project_dbt.PCP_POS_ONLINE
[0m10:33:58.459705 [info ] [Thread-15 ]: 59 of 88 START sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING . [RUN]
[0m10:33:58.460985 [debug] [Thread-7 (]: Began running node model.project_dbt.SCA_MAPPING_TABLE
[0m10:33:58.461945 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_MRA, now model.project_dbt.PI_PXG_APPLICATION_MAPPING)
[0m10:33:58.463267 [info ] [Thread-7 (]: 60 of 88 START sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE .......... [RUN]
[0m10:33:58.464708 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:33:58.465613 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCP_POS_ONLINE, now model.project_dbt.SCA_MAPPING_TABLE)
[0m10:33:58.473523 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m10:33:58.474047 [debug] [Thread-7 (]: Began compiling node model.project_dbt.SCA_MAPPING_TABLE
[0m10:33:58.478253 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m10:33:58.478708 [debug] [Thread-15 ]: Began executing node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:33:58.480898 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:33:58.481218 [debug] [Thread-7 (]: Began executing node model.project_dbt.SCA_MAPPING_TABLE
[0m10:33:58.484234 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:34:00.437415 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc19734e20>]}
[0m10:34:00.439089 [info ] [Thread-13 ]: 35 of 88 OK created sql incremental model dev_dm_pst3_LV.KMS_P17_PIS ........... [[32mCREATE TABLE (2.0 rows, 38.5 GiB processed)[0m in 18.04s]
[0m10:34:00.440726 [debug] [Thread-13 ]: Finished running node model.project_dbt.KMS_P17_PIS
[0m10:34:00.441975 [debug] [Thread-13 ]: Began running node model.project_dbt.T0202_credit_transfers
[0m10:34:00.443276 [info ] [Thread-13 ]: 61 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers ..... [RUN]
[0m10:34:00.444666 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.KMS_P17_PIS, now model.project_dbt.T0202_credit_transfers)
[0m10:34:00.445775 [debug] [Thread-13 ]: Began compiling node model.project_dbt.T0202_credit_transfers
[0m10:34:00.455617 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers"
[0m10:34:00.456273 [debug] [Thread-13 ]: Began executing node model.project_dbt.T0202_credit_transfers
[0m10:34:00.460127 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:34:00.606217 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.PCT_INITIATED_BY_PISP"
[0m10:34:00.611154 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS"
[0m10:34:00.612563 [debug] [Thread-14 ]: On model.project_dbt.PCT_INITIATED_BY_PISP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_INITIATED_BY_PISP`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS', 'H2H') THEN 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID = '1' then 'Electronic'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') AND  TPP.T_SOURCE_PK_ID <> '1' then 'PISP'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END INITIATIONCHANNEL,
  CASE
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
    WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
    WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
    ELSE 'check the query'
  END SCAINDICATOR,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction
    ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account
    ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts
    ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts
    ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ASPSP_PAYMENT_INITIATION` PI
    ON PI.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` TPP
  ON TPP.T_DIM_KEY = PI.T_D_ASPSP_PAYMENT_INITIATIONS_INFO_DIM_KEY
  WHERE
    f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
     AND (
           d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
           AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
        )
      AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
      AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
      AND  f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
      AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'BE'
group by 1,2,3
    );
  
[0m10:34:00.616705 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.PCT_OUTBOUND"
[0m10:34:00.622781 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.SCA_MAPPING_TABLE"
[0m10:34:00.623759 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN"
[0m10:34:00.624281 [debug] [Thread-2 (]: On model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_NUMBER_OF_PAYMENT_ACCOUNTS`
      
    
    

    OPTIONS()
    as (
      SELECT
  COUNT(*) AS d_ibis_account_count_ibis_accounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  CAST(NULL AS TIMESTAMP) AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC')) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
    ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
WHERE
    ibis.ACCOUNT_TYPE  in ('PAYMENT')
    AND ibis.ACCOUNT_IS_CUSTOMER_ACCOUNT IS TRUE
    AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'LT', 'RO', 'HR', 'BG')
    AND (
        ibis.ACCOUNT_STATUS = 'OPEN'
        OR ( ibis.ACCOUNT_STATUS = 'CLOSED'
           AND TIMESTAMP(ibis.ACCOUNT_UPDATED_AT) > TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
         )
        )
    -- Anca & Kris noticed that the for 269 accounts, the account_update_timestamp does not reflect the last_update_date of IBISv2 accounts table. Mail sent to Kathleen 25/08/23
    -- the v2 query gave 67 accounts less for 2023 S1 due to this difference
    AND TIMESTAMP(ibis.ACCOUNT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:34:00.625385 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PI_PXG_APPLICATION_MAPPING"
[0m10:34:00.626226 [debug] [Thread-12 ]: On model.project_dbt.PCT_OUTBOUND: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCT_OUTBOUND`
      
    
    

    OPTIONS()
    as (
      SELECT
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP', 'OCS', 'H2H') THEN 'Electronic'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END INITIATIONCHANNEL,
    CASE
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('TPP') THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_CREDITOR_REFERENCE_VALUE like 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL in ('OCS') AND TRANSACTION_END_TO_END_ID like 'CAF%' THEN 'SCA'
        WHEN f_account_transactions.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
        WHEN f_account_transactions.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
        ELSE 'check the query'
    END SCAINDICATOR,
    d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
    COUNT(DISTINCT f_account_transactions.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
    COALESCE(SUM(f_account_transactions.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
    TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS f_account_transactions
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON f_account_transactions.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON f_account_transactions.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = f_account_transactions.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE f_account_transactions.TRANSACTION_DIRECTION = "OUTBOUND"
    AND f_account_transactions.TRANSACTION_TYPE = 'REGULAR'
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
    AND f_account_transactions.TRANSACTION_CHANNEL <> 'CARDS'
    AND f_account_transactions.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE IN ('BE', 'BG', 'LT', 'PL', 'RO', 'HR')
GROUP BY 1, 2, 3
    );
  
[0m10:34:00.627657 [debug] [Thread-16 ]: On model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_AIS_JeF_with_BE_IBIS_IBAN`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  aa.APPLICATION_ACCOUNT_NAME Application_account_name,
  aa.T_SOURCE_PK_ID as Application_account_id ,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) AS Period_begin_date,
  CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd
  ON acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
    a.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
AND fi.FINANCIAL_INSTITUTION_COUNTRY = 'BE'
AND fi.FINANCIAL_INSTITUTION_CODE = 'IBIS'
AND (
  ac.ACCESS_CONSENT_STATUS = 'ACTIVE'
  OR (
    ac.ACCESS_CONSENT_STATUS = 'OBSOLETE'
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  ) --==> always start of the period
)
    );
  
[0m10:34:00.628540 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.PI_FINAL_QUERY"
[0m10:34:00.628920 [debug] [Thread-7 (]: On model.project_dbt.SCA_MAPPING_TABLE: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE`
      
    
    

    OPTIONS()
    as (
      SELECT
  "full-auth" AS SCA_RESULT,
  "SCA used" AS SCA_REASON,
UNION ALL
SELECT
  "attempt" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  "non-authenticated" AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
UNION ALL
SELECT
  NULL AS SCA_RESULT,
  "non-SCA used: reason is others" AS SCA_REASON,
    );
  
[0m10:34:00.630153 [debug] [Thread-15 ]: On model.project_dbt.PI_PXG_APPLICATION_MAPPING: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_PXG_APPLICATION_MAPPING`
      
    
    

    OPTIONS()
    as (
      SELECT
    distinct ap.APPLICATION_NAME AS APPLICATION_NAME,
    -- ap.APPLICATION_CREATED_AT AS CREATION_DATETIME,
    -- ao.APPLICATION_OWNER_NAME AS APPLICATION_OWNER_NAME,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
    CAST(NULL AS TIMESTAMP) AS Period_begin_date,
    CAST(NULL AS TIMESTAMP) AS Period_end_date,
FROM (
    WITH current_table AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY T_BUS_KEY ORDER BY T_INGESTION_TIMESTAMP desc, T_LOAD_TIMESTAMP desc) AS rn
    FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
)
SELECT * EXCEPT(rn)
FROM current_table
WHERE rn = 1
) AS ap
LEFT  JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED` AS ao
    ON ap.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON ap.t_dim_key = aa.T_D_APPLICATION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT` AS ci
    ON aa.T_DIM_KEY= ci.T_D_APPLICATION_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
    AS pa on pa.T_DIM_KEY= ci.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
    AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
    AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
-- WHERE ap.APPLICATION_NAME <>"NA"
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC')) --pt winter time
    -- AND TIMESTAMP(ap.APPLICATION_UPDATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  --pt winter time
    );
  
[0m10:34:00.632871 [debug] [Thread-4 (]: On model.project_dbt.PI_FINAL_QUERY: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PI_FINAL_QUERY`
      
    
    

    OPTIONS()
    as (
      SELECT
  a.APPLICATION_NAME AS Application_name,
  fi.FINANCIAL_INSTITUTION_COUNTRY as CountryOfAISP,
  count(*) AS number_of_consents,
  ""  AS Period,
  CURRENT_TIMESTAMP AS load_timestamp,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_CURRENT` AS ac
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO_DECRYPTED` acd on acd.T_DIM_KEY = ac.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_DECRYPTED`
  AS pa ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED`
  AS fp ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS`
  AS fi ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO_CURRENT`
  AS c ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED`
  AS aa ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED`
  AS a ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_OWNERS_DECRYPTED`
  AS ao ON a.T_D_OWNER_DIM_KEY =  ao.T_DIM_KEY
WHERE
  fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND (
    (
    TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_STATUS_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
    OR
    (
    TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(ac.ACCESS_CONSENT_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time
    )
  )
GROUP BY 1,2
    );
  
[0m10:34:00.634398 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PIS"
[0m10:34:00.635168 [debug] [Thread-8 (]: On model.project_dbt.PIS: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PIS`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = 'PAY-PXG-COMMUNITY'
        OR APP.APPLICATION_NAME = 'PAY-PXG-GOCOMPTA'
        OR (
            APP.APPLICATION_NAME = 'PAY-PXG-JEFACTURE'
            AND (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = "FR"
                AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER ,5,3) = '504'))
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPLT'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPBG'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPHR'
        OR APP.APPLICATION_NAME = 'PAY-PXG-BANQUPRO')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      ""  AS Period,
      TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'FR' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '27933')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,8) = '50339900')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'EE' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,2) = '72')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'ES' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '6918')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'IT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '36330')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,5) = '39816')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LV' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'PT' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '5845')
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'SK' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = '9955')
  -- AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'RO' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,4) = 'PANX')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.* EXCEPT(PERIOD),
      country,
      PERIOD,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m10:34:01.102428 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers"
[0m10:34:01.104395 [debug] [Thread-13 ]: On model.project_dbt.T0202_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'GB' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'CH' THEN 'Extra-EEA'
      WHEN DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL' THEN 'Domestic'
      ELSE DCA.FINANCIAL_INSTITUTION_COUNTRY_CODE
  END AS payee_psp_country,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'Paper-based form'
      WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'Electronically'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS initiationChannel,
  'remote' as remoteness,
  CASE
      WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'not applicable'
      WHEN FAT.TRANSACTION_CHANNEL = 'TPP' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_CREDITOR_REFERENCE_VALUE LIKE 'REF.%/%/%' THEN 'Trusted Beneficiaries exemption'
      WHEN FAT.TRANSACTION_CHANNEL = 'OCS'
           AND TRANSACTION_END_TO_END_ID LIKE 'CAF%' THEN 'SCA'
      WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'secure corp process exemption'
      WHEN FAT.TRANSACTION_CHANNEL IS NULL THEN 'not applicable - return'
      ELSE 'check the query'
  END AS SCAIndicator,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,

FROM
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
    ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
    ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
    ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN
    `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
    ON DCA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY

WHERE
    FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
    AND FAT.TRANSACTION_TYPE = 'REGULAR'
    AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
    AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    AND DAT.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
    AND DIAT.ACCOUNT_TYPE = 'PAYMENT'
    AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
    AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
GROUP BY 1,2,3,4
ORDER BY 1,2,3,4
    );
  
[0m10:34:01.124318 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:76a8eecd-bba8-4509-a06b-8bd4aa7def83&page=queryresults
[0m10:34:01.186465 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:eb5043a4-08dc-4522-9cd5-2375cda864ec&page=queryresults
[0m10:34:01.413596 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:98ebf07e-4440-43be-9a4c-5a53ecee5877&page=queryresults
[0m10:34:01.445194 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:74049eb8-7fee-4a1e-8923-80f97de60a36&page=queryresults
[0m10:34:01.449896 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:eb11e2e4-deec-4f67-bbcd-d3d07e6ce078&page=queryresults
[0m10:34:01.450934 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:092370e4-ccd9-4dfd-8672-ec0ff87f094f&page=queryresults
[0m10:34:01.456942 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8c7e528e-1c12-491e-b27f-d026621525d9&page=queryresults
[0m10:34:01.547580 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:100b8564-f886-47ef-8bfb-00169dc6b18c&page=queryresults
[0m10:34:01.913005 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:62336a72-b87d-46a7-9b3a-1312def6cbeb&page=queryresults
[0m10:34:03.357439 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21087b50>]}
[0m10:34:03.359213 [info ] [Thread-7 (]: 60 of 88 OK created sql incremental model dev_dm_pst3_BE.SCA_MAPPING_TABLE ..... [[32mCREATE TABLE (4.0 rows, 0 processed)[0m in 4.89s]
[0m10:34:03.360777 [debug] [Thread-7 (]: Finished running node model.project_dbt.SCA_MAPPING_TABLE
[0m10:34:03.361209 [debug] [Thread-7 (]: Began running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:34:03.361780 [info ] [Thread-7 (]: 62 of 88 START sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [RUN]
[0m10:34:03.362210 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.SCA_MAPPING_TABLE, now model.project_dbt.T0202_credit_transfers_TPP_check)
[0m10:34:03.362547 [debug] [Thread-7 (]: Began compiling node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:34:03.366671 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m10:34:03.367184 [debug] [Thread-7 (]: Began executing node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:34:03.370379 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:34:03.959053 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.T0202_credit_transfers_TPP_check"
[0m10:34:03.960955 [debug] [Thread-7 (]: On model.project_dbt.T0202_credit_transfers_TPP_check: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0202_credit_transfers_TPP_check`
      
    
    

    OPTIONS()
    as (
      select
  D.T_SOURCE_PK_ID,
  D.T_SOURCE_PK_UUID,
  D.SERVICE_PROVIDER_VERSION ,
  D.SERVICE_PROVIDER_ACTIVE ,
  D.SERVICE_PROVIDER_PSP_AUTHORITY_ID ,
  D.SERVICE_PROVIDER_DISPLAY_NAME,
  D.SERVICE_PROVIDER_CREATED_AT,
  D.SERVICE_PROVIDER_UPDATED_AT,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_CURRENT` C
inner join  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP_DECRYPTED` D
  on C.T_SOURCE_PK_UUID = D.T_SOURCE_PK_UUID
where D.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  AND C.SERVICE_PROVIDER_CREATED_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND C.SERVICE_PROVIDER_CREATED_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
    );
  
[0m10:34:05.295571 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2106f850>]}
[0m10:34:05.297282 [info ] [Thread-6 (]: 43 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPMC .............. [[32mCREATE TABLE (3.0 rows, 10.2 GiB processed)[0m in 15.53s]
[0m10:34:05.298869 [debug] [Thread-6 (]: Finished running node model.project_dbt.PAY_CPMC
[0m10:34:05.300037 [debug] [Thread-6 (]: Began running node model.project_dbt.T0401_misc
[0m10:34:05.301260 [info ] [Thread-6 (]: 63 of 88 START sql incremental model dev_dm_pst3_NL.T0401_misc ................. [RUN]
[0m10:34:05.302486 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPMC, now model.project_dbt.T0401_misc)
[0m10:34:05.303674 [debug] [Thread-6 (]: Began compiling node model.project_dbt.T0401_misc
[0m10:34:05.313757 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.T0401_misc"
[0m10:34:05.314479 [debug] [Thread-6 (]: Began executing node model.project_dbt.T0401_misc
[0m10:34:05.317486 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:34:05.543154 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:495b15a7-1a71-4111-a5ae-9a9048554f85&page=queryresults
[0m10:34:06.217483 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20ea9b70>]}
[0m10:34:06.219249 [info ] [Thread-10 ]: 47 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_PIS ..... [[32mCREATE TABLE (4.0 rows, 34.7 GiB processed)[0m in 14.89s]
[0m10:34:06.221070 [debug] [Thread-10 ]: Finished running node model.project_dbt.PAY_TROP_5845_PIS
[0m10:34:06.222272 [debug] [Thread-10 ]: Began running node model.project_dbt.T0401_nr_of_accounts
[0m10:34:06.223733 [info ] [Thread-10 ]: 64 of 88 START sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts ....... [RUN]
[0m10:34:06.224754 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_PIS, now model.project_dbt.T0401_nr_of_accounts)
[0m10:34:06.225693 [debug] [Thread-10 ]: Began compiling node model.project_dbt.T0401_nr_of_accounts
[0m10:34:06.233862 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.T0401_nr_of_accounts"
[0m10:34:06.234460 [debug] [Thread-10 ]: Began executing node model.project_dbt.T0401_nr_of_accounts
[0m10:34:06.238014 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:34:06.329947 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.T0401_misc"
[0m10:34:06.331965 [debug] [Thread-6 (]: On model.project_dbt.T0401_misc: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_misc`
      
    
    

    OPTIONS()
    as (
      SELECT
  FAM.MOVEMENT_FAMILY as bank_family,
  FAM.MOVEMENT_SUBFAMILY as bank_subfamily,
  count(*) as count,
  COALESCE(SUM(FAM.MOVEMENT_AMOUNT), 0) as amount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_MOVEMENTS_DECRYPTED` AS FAM
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS DIAT
  ON FAM.T_D_IBIS_ACCOUNT_DIM_KEY = DIAT.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DBA
  ON DIAT.T_D_BANK_ACCOUNT_DIM_KEY = DBA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS DCA
  ON DCA.T_DIM_KEY = FAM.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE DIAT.ACCOUNT_TYPE = 'PAYMENT'
  AND DBA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND FAM.MOVEMENT_BOOKING_DATE_AT >= TIMESTAMP(DATETIME('2024-01-01', 'Etc/UTC'))
  AND FAM.MOVEMENT_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
GROUP BY 1,2
ORDER BY 1,2
    );
  
[0m10:34:08.091632 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc201edf90>]}
[0m10:34:08.093338 [info ] [Thread-5 (]: 46 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845_IBIS .... [[32mCREATE TABLE (0.0 rows, 47.5 GiB processed)[0m in 17.23s]
[0m10:34:08.094368 [debug] [Thread-5 (]: Finished running node model.project_dbt.PAY_TROP_5845_IBIS
[0m10:34:08.094732 [debug] [Thread-5 (]: Began running node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:34:08.095350 [info ] [Thread-5 (]: 65 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ........ [RUN]
[0m10:34:08.095708 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TROP_5845_IBIS, now model.project_dbt.T0402_AIS_ASPSP_API)
[0m10:34:08.096128 [debug] [Thread-5 (]: Began compiling node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:34:08.100769 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m10:34:08.101225 [debug] [Thread-5 (]: Began executing node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:34:08.103466 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:34:08.349511 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1abf30a0>]}
[0m10:34:08.351184 [info ] [Thread-15 ]: 59 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_APPLICATION_MAPPING  [[32mCREATE TABLE (62.0 rows, 6.1 GiB processed)[0m in 9.89s]
[0m10:34:08.352771 [debug] [Thread-15 ]: Finished running node model.project_dbt.PI_PXG_APPLICATION_MAPPING
[0m10:34:08.354001 [debug] [Thread-15 ]: Began running node model.project_dbt.T0402_AIS_PXG
[0m10:34:08.355642 [info ] [Thread-15 ]: 66 of 88 START sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG .............. [RUN]
[0m10:34:08.356759 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_APPLICATION_MAPPING, now model.project_dbt.T0402_AIS_PXG)
[0m10:34:08.357854 [debug] [Thread-15 ]: Began compiling node model.project_dbt.T0402_AIS_PXG
[0m10:34:08.367560 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.T0402_AIS_PXG"
[0m10:34:08.368074 [debug] [Thread-15 ]: Began executing node model.project_dbt.T0402_AIS_PXG
[0m10:34:08.370545 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:34:08.879524 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.T0401_nr_of_accounts"
[0m10:34:08.881218 [debug] [Thread-10 ]: On model.project_dbt.T0401_nr_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0401_nr_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
count(*) nr_accounts,
CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
'2023Y' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK
  on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
WHERE ACCOUNT_TYPE = 'PAYMENT'
  AND BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'NL'
  AND (
    IACC.ACCOUNT_STATUS = 'OPEN'
    OR (
      IACC.ACCOUNT_STATUS = 'CLOSED'
      and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
      )
  )
  and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
    );
  
[0m10:34:09.365385 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.T0402_AIS_PXG"
[0m10:34:09.367034 [debug] [Thread-15 ]: On model.project_dbt.T0402_AIS_PXG: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_PXG`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'NL' as CountryofAISP,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPNL')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
      AND (
          (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_CREATED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
          )
          OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
              AND ac.ACCESS_CONSENT_STATUS_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
              )
      )
  GROUP BY ac.USER_TOKEN
  )
  SELECT
  COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
  FROM obsolete_and_active_consents_count_in_reporting_period
    );
  
[0m10:34:09.549962 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:cb7a54c4-b75e-415b-858a-674fed7750a4&page=queryresults
[0m10:34:10.009337 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.T0402_AIS_ASPSP_API"
[0m10:34:10.011154 [debug] [Thread-5 (]: On model.project_dbt.T0402_AIS_ASPSP_API: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_NL`.`T0402_AIS_ASPSP_API`
      
    
    

    OPTIONS()
    as (
      select
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  c.consent_iban,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2023Y' AS PERIOD,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
    inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) = 'NL'
  and c.CONSENT_CREATED_AT >= TIMESTAMP(DATETIME('2023-01-01', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT <= TIMESTAMP(DATETIME( '2023-12-31', 'Etc/UTC'))
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
    );
  
[0m10:34:10.562986 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210d20b0>]}
[0m10:34:10.564884 [info ] [Thread-4 (]: 56 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_FINAL_QUERY ........ [[32mCREATE TABLE (62.0 rows, 9.6 GiB processed)[0m in 14.38s]
[0m10:34:10.567695 [debug] [Thread-4 (]: Finished running node model.project_dbt.PI_FINAL_QUERY
[0m10:34:10.568673 [debug] [Thread-4 (]: Began running node model.project_dbt.V1110_payment_initiation_services
[0m10:34:10.569502 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:62b9f478-3755-43f0-87e3-76a7a41635da&page=queryresults
[0m10:34:10.570264 [info ] [Thread-4 (]: 67 of 88 START sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [RUN]
[0m10:34:10.572465 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_FINAL_QUERY, now model.project_dbt.V1110_payment_initiation_services)
[0m10:34:10.573024 [debug] [Thread-4 (]: Began compiling node model.project_dbt.V1110_payment_initiation_services
[0m10:34:10.584091 [debug] [Thread-4 (]: Writing injected SQL for node "model.project_dbt.V1110_payment_initiation_services"
[0m10:34:10.584717 [debug] [Thread-4 (]: Began executing node model.project_dbt.V1110_payment_initiation_services
[0m10:34:10.588751 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m10:34:10.951225 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc197c6b00>]}
[0m10:34:10.974612 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:26334ea1-8119-4cce-bba6-7c9324c78758&page=queryresults
[0m10:34:11.342943 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc18dfb0d0>]}
[0m10:34:11.629357 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:54ff0351-f046-42f2-baac-dc2ae05b9267&page=queryresults
[0m10:34:12.065426 [debug] [Thread-4 (]: Writing runtime sql for node "model.project_dbt.V1110_payment_initiation_services"
[0m10:34:12.069946 [debug] [Thread-4 (]: On model.project_dbt.V1110_payment_initiation_services: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1110_payment_initiation_services`
      
    
    

    OPTIONS()
    as (
      with pre_source AS(
  SELECT
  'Banqup applications' as TYPEOFAPPLICATION,
  IT.INBOUND_TRANSACTION_CURRENCY_CODE  AS CURRENCY,
  credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
  COUNT(*)  AS SUCCESS_TRX_COUNT,
  SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY=IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY=PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY
WHERE FI.FINANCIAL_INSTITUTION_CODE  <> 'IBIS'
    AND PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
    AND (
        APP.APPLICATION_NAME  = '	PAY-PXG-BANQUPLU')
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 10:34:10.583240', 'Etc/UTC'))  --pt winter time
    AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 10:34:10.583240', 'Etc/UTC'))   --pt winter time


GROUP BY 1, 2, 3

UNION ALL

SELECT
      'OCS application' AS TYPEOFAPPLICATION,
      IT.INBOUND_TRANSACTION_CURRENCY_CODE AS CURRENCY,
      credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE AS COUNTERPARTY_COUNTRY,
      COUNT(*)  AS SUCCESS_TRX_COUNT,
      SUM(IT.INBOUND_TRANSACTION_AMOUNT) AS SUCCESS_TRX_SUMMED_VALUE,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_PAYMENT_INFO_CURRENT` AS IP
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS FP
    ON IP.T_D_FINANCIAL_PLATFORM_DIM_KEY=FP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS FI
    ON FI.T_DIM_KEY = FP.T_D_FINANCIAL_INSTITUTION_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_INBOUND_TRANSACTIONS_DECRYPTED` AS IT
    ON IP.T_DIM_KEY = IT.T_D_INBOUND_PAYMENT_INFO_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_INBOUND_TRANSACTION_INFO` AS DIT
    ON DIT.T_DIM_KEY = IT.T_D_INBOUND_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_INITIATIONS` AS PI
    ON IP.T_DIM_KEY = PI.T_D_INBOUND_PAYMENT_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS APP
    ON IP.T_D_APPLICATION_DIM_KEY = APP.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` debacc
    ON IP.T_D_DEBTOR_BANK_ACCOUNTS_DIM_KEY = debacc.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` credacc
    ON IT.T_D_CREDITOR_BANK_ACCOUNTS_DIM_KEY = credacc.T_DIM_KEY

WHERE
  PI.PAYMENT_INITIATION_STATUS = 'SUCCESSFUL'
  AND APP.APPLICATION_NAME  = 'PAY-PXG-OCS'
  AND FI.FINANCIAL_INSTITUTION_CODE <> 'IBIS'
  AND NOT (credacc.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU' AND  SUBSTR( credacc.BANK_ACCOUNT_NUMBER,5,3) = '625')
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) >= TIMESTAMP(DATETIME( '2024-10-01 10:34:10.583240', 'Etc/UTC'))  --pt winter time
  AND TIMESTAMP(DIT.INBOUND_TRANSACTION_CREATED_AT) <= TIMESTAMP(DATETIME( '2024-10-31 10:34:10.583240', 'Etc/UTC'))   --pt winter time

GROUP BY 1, 2, 3
ORDER BY 4 DESC
),
  country_mapping AS (
      SELECT 'Bulgaria' AS country, 'BG' AS code UNION ALL
      SELECT 'Croatia', 'HR' UNION ALL
      SELECT 'Cyprus', 'CY' UNION ALL
      SELECT 'Czechia', 'CZ' UNION ALL
      SELECT 'Denmark', 'DK' UNION ALL
      SELECT 'Estonia', 'EE' UNION ALL
      SELECT 'Finland', 'FI' UNION ALL
      SELECT 'France', 'FR' UNION ALL
      SELECT 'Germany', 'DE' UNION ALL
      SELECT 'Greece', 'GR' UNION ALL
      SELECT 'Hungary', 'HU' UNION ALL
      SELECT 'Ireland', 'IE' UNION ALL
      SELECT 'Italy', 'IT' UNION ALL
      SELECT 'Latvia', 'LV' UNION ALL
      SELECT 'Lithuania', 'LT' UNION ALL
      SELECT 'Luxembourg', 'LU' UNION ALL
      SELECT 'Malta', 'MT' UNION ALL
      SELECT 'Netherlands', 'NL' UNION ALL
      SELECT 'Poland', 'PL' UNION ALL
      SELECT 'Portugal', 'PT' UNION ALL
      SELECT 'Romania', 'RO' UNION ALL
      SELECT 'Slovakia', 'SK' UNION ALL
      SELECT 'Slovenia', 'SI' UNION ALL
      SELECT 'Spain', 'ES' UNION ALL
      SELECT 'Sweden', 'SE' UNION ALL
      SELECT 'Iceland', 'IS' UNION ALL
      SELECT 'Liechtenstein', 'LI' UNION ALL
      SELECT 'Norway', 'NO' UNION ALL
      SELECT 'Belgium', 'BE' UNION ALL
      SELECT 'Extra EEA', ''

  )
  SELECT
      pre_source.*,
      country,
      CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
      CAST ("" AS STRING) AS Period,
      TIMESTAMP(DATETIME( '2024-10-01 10:34:10.583240', 'Etc/UTC'))  AS Period_begin_date,
      TIMESTAMP(DATETIME( '2024-10-31 10:34:10.583240', 'Etc/UTC'))  AS Period_end_date,
  FROM pre_source
  LEFT JOIN country_mapping on country_mapping.code =pre_source.COUNTERPARTY_COUNTRY
    );
  
[0m10:34:12.203129 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf6f130>]}
[0m10:34:12.214710 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1976ff40>]}
[0m10:34:12.610085 [info ] [Thread-16 ]: 58 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN  [[32mCREATE TABLE (37.0 rows, 12.5 GiB processed)[0m in 13.31s]
[0m10:34:12.614150 [debug] [Thread-16 ]: Finished running node model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN
[0m10:34:12.615805 [info ] [Thread-7 (]: 62 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers_TPP_check  [[32mCREATE TABLE (0.0 rows, 893.5 MiB processed)[0m in 7.98s]
[0m10:34:12.617285 [debug] [Thread-16 ]: Began running node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:34:12.618803 [info ] [Thread-14 ]: 53 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_INITIATED_BY_PISP . [[32mCREATE TABLE (10.0 rows, 15.6 GiB processed)[0m in 17.22s]
[0m10:34:12.620437 [info ] [Thread-2 (]: 57 of 88 OK created sql incremental model dev_dm_pst3_BE.PI_NUMBER_OF_PAYMENT_ACCOUNTS  [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 14.89s]
[0m10:34:12.622468 [debug] [Thread-7 (]: Finished running node model.project_dbt.T0202_credit_transfers_TPP_check
[0m10:34:12.624061 [info ] [Thread-16 ]: 68 of 88 START sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [RUN]
[0m10:34:12.625887 [debug] [Thread-14 ]: Finished running node model.project_dbt.PCT_INITIATED_BY_PISP
[0m10:34:12.627475 [debug] [Thread-2 (]: Finished running node model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS
[0m10:34:12.628788 [debug] [Thread-7 (]: Began running node model.project_dbt.V121_customer_credit_transfers_received
[0m10:34:12.630022 [debug] [Thread-16 ]: Re-using an available connection from the pool (formerly model.project_dbt.PI_PXG_AIS_JeF_with_BE_IBIS_IBAN, now model.project_dbt.V120_customer_credit_transfers_sent)
[0m10:34:12.631474 [debug] [Thread-14 ]: Began running node model.project_dbt.V1220_stock_of_accounts
[0m10:34:12.633017 [debug] [Thread-2 (]: Began running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:34:12.634606 [info ] [Thread-7 (]: 69 of 88 START sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [RUN]
[0m10:34:12.635863 [debug] [Thread-16 ]: Began compiling node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:34:12.637289 [info ] [Thread-14 ]: 70 of 88 START sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts .... [RUN]
[0m10:34:12.638699 [info ] [Thread-2 (]: 71 of 88 START sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [RUN]
[0m10:34:12.640287 [debug] [Thread-7 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers_TPP_check, now model.project_dbt.V121_customer_credit_transfers_received)
[0m10:34:12.651544 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_INITIATED_BY_PISP, now model.project_dbt.V1220_stock_of_accounts)
[0m10:34:12.654744 [debug] [Thread-16 ]: Writing injected SQL for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m10:34:12.655509 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.PI_NUMBER_OF_PAYMENT_ACCOUNTS, now model.project_dbt.V1222_stock_of_accessed_accounts)
[0m10:34:12.656175 [debug] [Thread-7 (]: Began compiling node model.project_dbt.V121_customer_credit_transfers_received
[0m10:34:12.656711 [debug] [Thread-14 ]: Began compiling node model.project_dbt.V1220_stock_of_accounts
[0m10:34:12.657257 [debug] [Thread-2 (]: Began compiling node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:34:12.667046 [debug] [Thread-7 (]: Writing injected SQL for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m10:34:12.667768 [debug] [Thread-16 ]: Began executing node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:34:12.673665 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.V1220_stock_of_accounts"
[0m10:34:12.687586 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m10:34:12.691266 [debug] [Thread-16 ]: Opening a new connection, currently in state closed
[0m10:34:12.691882 [debug] [Thread-7 (]: Began executing node model.project_dbt.V121_customer_credit_transfers_received
[0m10:34:12.692663 [debug] [Thread-14 ]: Began executing node model.project_dbt.V1220_stock_of_accounts
[0m10:34:12.697328 [debug] [Thread-7 (]: Opening a new connection, currently in state closed
[0m10:34:12.698059 [debug] [Thread-2 (]: Began executing node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:34:12.704086 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:34:12.711709 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:34:12.897399 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1b5f3700>]}
[0m10:34:12.899420 [info ] [Thread-12 ]: 54 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_OUTBOUND .......... [[32mCREATE TABLE (26.0 rows, 15.6 GiB processed)[0m in 17.82s]
[0m10:34:12.901895 [debug] [Thread-12 ]: Finished running node model.project_dbt.PCT_OUTBOUND
[0m10:34:12.903188 [debug] [Thread-12 ]: Began running node model.project_dbt.V1230_number_of_accounts
[0m10:34:12.904690 [info ] [Thread-12 ]: 72 of 88 START sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts ... [RUN]
[0m10:34:12.905766 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_OUTBOUND, now model.project_dbt.V1230_number_of_accounts)
[0m10:34:12.906841 [debug] [Thread-12 ]: Began compiling node model.project_dbt.V1230_number_of_accounts
[0m10:34:12.920274 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.V1230_number_of_accounts"
[0m10:34:12.921118 [debug] [Thread-12 ]: Began executing node model.project_dbt.V1230_number_of_accounts
[0m10:34:12.925357 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:34:12.957814 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:419915fd-19e7-45ca-8882-10e71f091d0b&page=queryresults
[0m10:34:13.292126 [debug] [Thread-16 ]: Writing runtime sql for node "model.project_dbt.V120_customer_credit_transfers_sent"
[0m10:34:13.294252 [debug] [Thread-16 ]: On model.project_dbt.V120_customer_credit_transfers_sent: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V120_customer_credit_transfers_sent`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
  else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  COUNT(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.654049', 'Etc/UTC'))  -- +01 for winter time, +02 for summer time
  -- AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.654049', 'Etc/UTC')) -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:12.654049', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time

GROUP BY 1,2,3,4,5,6,7,8,9,10

UNION ALL

SELECT
  'CORP' AS customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'PAPR'
    when ftr.transaction_channel in ('OCS','TPP') then 'WEBB'
    when ftr.transaction_channel = 'H2H' then 'ELFB'
  end initiationChannel ,
  'REM1' as initiationSubchannel,
  'CUST' as initiatorType,
  case
    when ftr.transaction_channel in ('DASHBOARD','ADMIN') then 'NOAP'
    when ftr.transaction_channel in ('TPP') then 'SCA1'
    when ftr.transaction_channel in ('OCS') and ftr.transaction_creditor_reference_value like 'REF.%/%/%' then 'TRBN'
    when ftr.transaction_channel in ('OCS') and ftr.TRANSACTION_END_TO_END_ID like 'CAF%' then 'SCA1'
    when ftr.transaction_channel = 'H2H' then 'SECO'
    else 'check the query'
  end SCA,
  'NOAP' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE as creditorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS dtr
  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis
  ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS bank
  ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS counter
  ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND ftr.transaction_channel <> 'CARDS'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.654049', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:12.654049', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
GROUP BY 1,2,3,4,5,6,7,8,9,10
ORDER BY 1,2,3,4,5,6,7,8,9,10
    );
  
[0m10:34:13.308603 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.V1222_stock_of_accessed_accounts"
[0m10:34:13.310285 [debug] [Thread-7 (]: Writing runtime sql for node "model.project_dbt.V121_customer_credit_transfers_received"
[0m10:34:13.310867 [debug] [Thread-2 (]: On model.project_dbt.V1222_stock_of_accessed_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1222_stock_of_accessed_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
  SELECT
    'AISP' as PSPType,
    fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
    'VOLU' as Metric,
    ac.USER_TOKEN,
    COUNT(*) AS number_of_consents,
  FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
    ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
    ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
  ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
    ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
    ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
  inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
    ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
  WHERE
      a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
      AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
      AND (
            ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.686701', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:34:12.686701', 'Etc/UTC'))
          )
          OR (
            ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.686701', 'Etc/UTC'))
            AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 10:34:12.686701', 'Etc/UTC'))
              )
  GROUP BY
  1,2,3,4
  )
  SELECT
    'AISP' as PSPType,
    Countryofcustomerresidence as  countryOfASPSP,
    'LU' as countryOfAISP,
    'VOLU' as Metric,
    COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,
  FROM obsolete_and_active_consents_count_in_reporting_period
  group by 1,2,3
union all


SELECT
  'APSP' as PSPType,
  'LU' countryOfASPSP,
  left(t.SERVICE_PROVIDER_PSP_AUTHORITY_ID,2) countryOfAISP,
  'VOLU' as Metric,
  COUNT(*) AS Numberofaccounts,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
from `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` c
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_CONSENT_DECRYPTED` cc on c.T_DIM_KEY = cc.T_DIM_KEY
inner join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ASPSP_TPP` t on c.T_D_ASPSP_TPP_DIM_KEY = t.T_DIM_KEY
where
  c.CONSENT_STATUS = 'VALID'
  and left(c.consent_iban,2) ='LU'
  and  t.T_SOURCE_PK_UUID <> '93773d5d-00b9-422d-af5c-b90259cf50ee'
  and  c.CONSENT_CREATED_AT <  TIMESTAMP(DATETIME( '2024-10-31 10:34:12.686701', 'Etc/UTC'))
  and c.CONSENT_EXPIRED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.686701', 'Etc/UTC'))
group by 1,2,3
    );
  
[0m10:34:13.311817 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.V1220_stock_of_accounts"
[0m10:34:13.313059 [debug] [Thread-7 (]: On model.project_dbt.V121_customer_credit_transfers_received: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V121_customer_credit_transfers_received`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedamount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
  ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.666103', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:12.666103', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4

UNION ALL

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    sum (ftr.TRANSACTION_AMOUNT) as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.666103', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:12.666103', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4
    );
  
[0m10:34:13.314338 [debug] [Thread-14 ]: On model.project_dbt.V1220_stock_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1220_stock_of_accounts`
      
    
    

    OPTIONS()
    as (
      SELECT
  'PMAC' as AccountType,
  case
    when ACCOUNT_USAGE in ('CARE','CARE_EXPENSE','ESTATE') then 'HSNP' -- Households and NPISHs
    when ACCOUNT_USAGE is null then 'CORP' -- Non-financial corporations
    else 'check the query'
  end as Customer_Category,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` IACC
left join `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` BANK on IACC.T_D_BANK_ACCOUNT_DIM_KEY = BANK.T_DIM_KEY
where ACCOUNT_TYPE = 'PAYMENT'
and BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
and IACC.ACCOUNT_STATUS = 'OPEN'
or (
  IACC.ACCOUNT_STATUS = 'CLOSED'
  and IACC.ACCOUNT_UPDATED_AT > TIMESTAMP(DATETIME( '2024-10-01 10:34:12.673010', 'Etc/UTC'))
  )
and IACC.ACCOUNT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:34:12.673010', 'Etc/UTC'))
group by 1,2
    );
  
[0m10:34:13.482000 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc203d42b0>]}
[0m10:34:13.483634 [info ] [Thread-11 ]: 41 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_CPCA .............. [[32mCREATE TABLE (11.3k rows, 29.5 GiB processed)[0m in 27.09s]
[0m10:34:13.485285 [debug] [Thread-11 ]: Finished running node model.project_dbt.PAY_CPCA
[0m10:34:13.486531 [debug] [Thread-11 ]: Began running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:34:13.487783 [info ] [Thread-11 ]: 73 of 88 START sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [RUN]
[0m10:34:13.489138 [debug] [Thread-11 ]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_CPCA, now model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP)
[0m10:34:13.490139 [debug] [Thread-11 ]: Began compiling node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:34:13.499190 [debug] [Thread-11 ]: Writing injected SQL for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m10:34:13.499677 [debug] [Thread-11 ]: Began executing node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:34:13.502001 [debug] [Thread-11 ]: Opening a new connection, currently in state closed
[0m10:34:13.520318 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.V1230_number_of_accounts"
[0m10:34:13.521261 [debug] [Thread-12 ]: On model.project_dbt.V1230_number_of_accounts: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V1230_number_of_accounts`
      
    
    

    OPTIONS()
    as (
      WITH obsolete_and_active_consents_count_in_reporting_period AS (
   SELECT
     'AISP' as PSPType,
     fi.FINANCIAL_INSTITUTION_COUNTRY as Countryofcustomerresidence,
     'VOLU' as Metric,
     ac.USER_TOKEN,
     COUNT(*) AS number_of_consents,
   FROM  `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCESS_CONSENT_INFO` AS ac
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PXG_PAYMENT_ACCOUNT_CURRENT` AS pa
     ON pa.T_DIM_KEY=ac.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
    inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_PLATFORMS_DECRYPTED` AS fp
     ON pa.T_D_FINANCIAL_PLATFORM_DIM_KEY=fp.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_FINANCIAL_INSTITUTIONS` AS fi
   ON fi.T_DIM_KEY = fp.T_D_FINANCIAL_INSTITUTION_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CONTRACT_INFO` AS c
     ON pa.T_DIM_KEY=c.T_D_PXG_PAYMENT_ACCOUNT_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATION_ACCOUNT_INFO_DECRYPTED` AS aa
     ON c.T_D_APPLICATION_ACCOUNT_DIM_KEY=aa.T_DIM_KEY
   inner JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_APPLICATIONS_DECRYPTED` AS a
     ON aa.T_D_APPLICATION_DIM_KEY = a.T_DIM_KEY
   WHERE
       a.APPLICATION_NAME in ('PAY-PXG-BANQUPLU')
       AND fi.FINANCIAL_INSTITUTION_CODE <> 'IBIS' -- consents on UPP's own accounts are not counted
       AND (
           (ac.ACCESS_CONSENT_CREATED_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.919088', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_CREATED_AT < TIMESTAMP(DATETIME( '2024-10-31 10:34:12.919088', 'Etc/UTC'))
           )
           OR (ac.ACCESS_CONSENT_STATUS_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:12.919088', 'Etc/UTC'))
               AND ac.ACCESS_CONSENT_STATUS_AT < TIMESTAMP(DATETIME( '2024-10-31 10:34:12.919088', 'Etc/UTC'))
               )
       )
   GROUP BY
   1,2,3,4
   )
   SELECT
     'AISP' as PSPType,
     Countryofcustomerresidence,
     'VOLU' as Metric,
     COUNT(DISTINCT USER_TOKEN) AS unique_users_count_in_period,
     CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
     ""  AS Period,
   FROM obsolete_and_active_consents_count_in_reporting_period
   group by 1,2,3
    );
  
[0m10:34:13.732798 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2024a260>]}
[0m10:34:13.734518 [info ] [Thread-9 (]: 52 of 88 OK created sql incremental model dev_dm_pst3_BE.PCT_IDEAL ............. [[32mCREATE TABLE (6.0 rows, 1.4 TiB processed)[0m in 19.98s]
[0m10:34:13.736120 [debug] [Thread-9 (]: Finished running node model.project_dbt.PCT_IDEAL
[0m10:34:13.737279 [debug] [Thread-9 (]: Began running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:34:13.739444 [info ] [Thread-9 (]: 74 of 88 START sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [RUN]
[0m10:34:13.740696 [debug] [Thread-9 (]: Re-using an available connection from the pool (formerly model.project_dbt.PCT_IDEAL, now model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP)
[0m10:34:13.741886 [debug] [Thread-9 (]: Began compiling node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:34:13.753855 [debug] [Thread-9 (]: Writing injected SQL for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m10:34:13.754959 [debug] [Thread-9 (]: Began executing node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:34:13.759495 [debug] [Thread-9 (]: Opening a new connection, currently in state closed
[0m10:34:13.809153 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20403dc0>]}
[0m10:34:13.810374 [info ] [Thread-13 ]: 61 of 88 OK created sql incremental model dev_dm_pst3_NL.T0202_credit_transfers  [[32mCREATE TABLE (12.0 rows, 15.6 GiB processed)[0m in 13.36s]
[0m10:34:13.811919 [debug] [Thread-13 ]: Finished running node model.project_dbt.T0202_credit_transfers
[0m10:34:13.812926 [debug] [Thread-13 ]: Began running node model.project_dbt.V140_SEPA_R_transactions
[0m10:34:13.814174 [info ] [Thread-13 ]: 75 of 88 START sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions ... [RUN]
[0m10:34:13.814984 [debug] [Thread-13 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0202_credit_transfers, now model.project_dbt.V140_SEPA_R_transactions)
[0m10:34:13.815595 [debug] [Thread-13 ]: Began compiling node model.project_dbt.V140_SEPA_R_transactions
[0m10:34:13.825227 [debug] [Thread-13 ]: Writing injected SQL for node "model.project_dbt.V140_SEPA_R_transactions"
[0m10:34:13.825827 [debug] [Thread-13 ]: Began executing node model.project_dbt.V140_SEPA_R_transactions
[0m10:34:13.828422 [debug] [Thread-13 ]: Opening a new connection, currently in state closed
[0m10:34:13.911121 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c58fb5c6-ec54-4488-9872-3d8093668f69&page=queryresults
[0m10:34:14.116593 [debug] [Thread-11 ]: Writing runtime sql for node "model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP"
[0m10:34:14.117470 [debug] [Thread-11 ]: On model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V130_direct_debits_reporting_as_creditors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.498634', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.498634', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8

union all

SELECT
  'CORP' as customerCategory,
   IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VALE' as metric,
  SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "INBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND  ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('RCDD', 'PRDD', 'UPDD','RIMB')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.498634', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.498634', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m10:34:14.141089 [debug] [Thread-16 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9fee4b3a-e7ff-4dc5-b27f-7e03037ba7c5&page=queryresults
[0m10:34:14.143265 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:85917c2c-dbd4-4819-80eb-af7c5e06bca7&page=queryresults
[0m10:34:14.184483 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:7c3ae233-41ce-4850-b6de-ea8b0f072960&page=queryresults
[0m10:34:14.350868 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:1ce558ee-3629-4ca6-a639-007d441ad924&page=queryresults
[0m10:34:14.357900 [debug] [Thread-9 (]: Writing runtime sql for node "model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP"
[0m10:34:14.358686 [debug] [Thread-9 (]: On model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V131_direct_debits_reporting_as_debtors_PSP`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CORP' as customerCategory,
  IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
  'SEPA' as paymentScheme,
  "Electronic file/batch" AS initiationChannel ,
  '' as consent,
  '' as fraudType,
  counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
  ftr.transaction_currency as currency,
  'VOLU' as metric,
  count(*) as reportedAmount,
  CURRENT_TIMESTAMP AS Load_timestamp,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.752782', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.752782', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT
    'CORP' as customerCategory,
    IF(substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU', 'ONUS', 'PSPN') AS settlementChannel,
    'SEPA' as paymentScheme,
    "Electronic file/batch" AS initiationChannel ,
    '' as consent,
    '' as fraudType,
    counter.FINANCIAL_INSTITUTION_COUNTRY_CODE AS debtorPspCountry,
    ftr.transaction_currency as currency,
    'VALE' as metric,
    SUM(ftr.TRANSACTION_AMOUNT)  as reportedAmount,
    CURRENT_TIMESTAMP AS Load_timestamp,
    ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE
    ftr.TRANSACTION_DIRECTION = "OUTBOUND"
  AND ftr.TRANSACTION_TYPE = 'REGULAR'
  AND dtr.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
  AND ftr.TRANSACTION_BANK_FAMILY = 'RDDT'
  AND ftr.TRANSACTION_BANK_SUBFAMILY in ('ESDD', 'OODD', 'BBDD')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.752782', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.752782', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
order by 1,2,3,4,5,6,7,8
    );
  
[0m10:34:14.433663 [debug] [Thread-13 ]: Writing runtime sql for node "model.project_dbt.V140_SEPA_R_transactions"
[0m10:34:14.434721 [debug] [Thread-13 ]: On model.project_dbt.V140_SEPA_R_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V140_SEPA_R_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
     'SEPA' as paymentScheme,
   case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
        when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
        end RoleofReporting,
   'CORP' as customerCategory,
   case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
        or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
              else 'PSPN'
         end settlementChannel,
  'SEPA Credit Transfer' as R_TransactionType,
     case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end creditorPspCountry,
     case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
          when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
          end debtorPspCountry,
     ftr.transaction_currency as currency,
     'VOLU' as metric,
     count(*) as reportedAmount,
     CURRENT_TIMESTAMP AS Load_timestamp,
     ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.824572', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.824572', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8

  union all

  SELECT
        'SEPA' as paymentScheme,
      case when (ftr.TRANSACTION_DIRECTION = "INBOUND") then 'CPSP'
            when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then 'DPSP'
            end RoleofReporting,
      'CORP' as customerCategory,
      case when ( (ftr.TRANSACTION_DIRECTION = "INBOUND" and substr(bank.BANK_ACCOUNT_NUMBER,5,3) = substr(counter.BANK_ACCOUNT_NUMBER,5,3) and counter.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
            or (ftr.TRANSACTION_DIRECTION = "OUTBOUND" and substr(counter.BANK_ACCOUNT_NUMBER,5,3) = substr(bank.BANK_ACCOUNT_NUMBER,5,3) and bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')) then 'ONUS'
                  else 'PSPN'
            end settlementChannel,
      'SEPA Credit Transfer' as R_TransactionType,
        case when  (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end creditorPspCountry,
        case when (ftr.TRANSACTION_DIRECTION = "OUTBOUND") then BANK.FINANCIAL_INSTITUTION_COUNTRY_CODE
              when (ftr.TRANSACTION_DIRECTION = "INBOUND") then counter.FINANCIAL_INSTITUTION_COUNTRY_CODE
              end debtorPspCountry,
        ftr.transaction_currency as currency,
        'VALE' as metric,
        SUM(ftr.TRANSACTION_AMOUNT) as reportedAmount,
        CURRENT_TIMESTAMP AS Load_timestamp,
        ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` as ftr
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` as dtr  ON ftr.T_D_ACCOUNT_TRANSACTION_DIM_KEY = dtr.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS ibis ON ftr.T_D_IBIS_ACCOUNT_DIM_KEY = ibis.T_DIM_KEY
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as bank ON ibis.T_D_BANK_ACCOUNT_DIM_KEY = bank.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` as counter ON counter.T_DIM_KEY = ftr.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
  WHERE
      ibis.ACCOUNT_TYPE = 'PAYMENT'
  AND ftr.TRANSACTION_TYPE IN ('RETURN')
  AND dtr.TRANSACTION_STATUS IN ('SETTLED', 'RETURNED')
  AND dtr.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:13.824572', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
  AND dtr.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:13.824572', 'Etc/UTC'))  -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  AND ( bank.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU'
      or  COUNTER.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'LU')
  group by 1,2,3,4,5,6,7,8
  order by 1,2,3,4,5,6,7,8
    );
  
[0m10:34:15.028981 [debug] [Thread-11 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:8597b43a-6c86-4c38-a385-6fe1d5a48cc4&page=queryresults
[0m10:34:15.157536 [debug] [Thread-9 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:dbed530b-5647-4434-883e-0ca5c8a9801c&page=queryresults
[0m10:34:15.178528 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf1fd00>]}
[0m10:34:15.181065 [info ] [Thread-5 (]: 65 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_ASPSP_API ... [[32mCREATE TABLE (0.0 rows, 1.2 GiB processed)[0m in 7.08s]
[0m10:34:15.182684 [debug] [Thread-5 (]: Finished running node model.project_dbt.T0402_AIS_ASPSP_API
[0m10:34:15.183601 [debug] [Thread-5 (]: Began running node model.project_dbt.V142_intermediated_payment_transactions
[0m10:34:15.185493 [info ] [Thread-5 (]: 76 of 88 START sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [RUN]
[0m10:34:15.186639 [debug] [Thread-5 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_ASPSP_API, now model.project_dbt.V142_intermediated_payment_transactions)
[0m10:34:15.187229 [debug] [Thread-5 (]: Began compiling node model.project_dbt.V142_intermediated_payment_transactions
[0m10:34:15.203125 [debug] [Thread-5 (]: Writing injected SQL for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m10:34:15.203757 [debug] [Thread-5 (]: Began executing node model.project_dbt.V142_intermediated_payment_transactions
[0m10:34:15.210170 [debug] [Thread-5 (]: Opening a new connection, currently in state closed
[0m10:34:15.280259 [debug] [Thread-13 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:45bc4fa8-49de-46ac-b330-54cfd768f7a6&page=queryresults
[0m10:34:15.443102 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1b5ec3d0>]}
[0m10:34:15.444830 [info ] [Thread-15 ]: 66 of 88 OK created sql incremental model dev_dm_pst3_NL.T0402_AIS_PXG ......... [[32mCREATE TABLE (1.0 rows, 5.9 GiB processed)[0m in 7.09s]
[0m10:34:15.446503 [debug] [Thread-15 ]: Finished running node model.project_dbt.T0402_AIS_PXG
[0m10:34:15.447727 [debug] [Thread-15 ]: Began running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:34:15.449270 [info ] [Thread-15 ]: 77 of 88 START sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [RUN]
[0m10:34:15.450334 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0402_AIS_PXG, now model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs)
[0m10:34:15.451365 [debug] [Thread-15 ]: Began compiling node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:34:15.465783 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m10:34:15.466704 [debug] [Thread-15 ]: Began executing node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:34:15.469877 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:34:15.818057 [debug] [Thread-5 (]: Writing runtime sql for node "model.project_dbt.V142_intermediated_payment_transactions"
[0m10:34:15.820883 [debug] [Thread-5 (]: On model.project_dbt.V142_intermediated_payment_transactions: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V142_intermediated_payment_transactions`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  'CPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  d_payment_transaction_info.payment_transaction_payer_country   as debtorPSPs,
  'LU' as CreditorPSPs,
  d_payment_transaction_info.payment_transaction_currency_code as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE != 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.201787', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:15.201787', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
  group by 1,2,3,4,5,6,7,8
union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as RoleofReporting,
  'PSPN' as Settlementchannel,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'LU', d_payment_transaction_info.payment_transaction_payer_country)   as debtorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_payer_country, 'LU') as CreditorPSPs,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', REFUND.payment_transaction_currency_code,  d_payment_transaction_info.payment_transaction_currency_code) as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.201787', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:15.201787', 'Etc/UTC')) -- like timezone('UTC', to_timestamp('2023-12-31 UTC+01', 'YYYY-MM-DD ""UTC""TZH') + interval '1 day') -- +01 for winter time, +02 for summer time
group by 1,2,3,4,5,6,7,8
union all

SELECT

  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
    REFUND.payment_transaction_payer_country as CreditorPSPs,
    REFUND.payment_transaction_currency_code as currency,
    'Volu' as Metric,
    count(*) as ReportedAmount,
    CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
    ""  AS Period,

  FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
      AS d_payment_item_info
  INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
  T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
  LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
  WHERE
      f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
      AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
      AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.201787', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
      AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:15.201787', 'Etc/UTC')) -- like timez
    group by 1,2,3,4,5,6,7,8
    union all

SELECT
  'CUCT' as PaymentInstructionType,
  'PSPN' as CustomerType,
    'DPSP' as RoleofReporting,
  'PSPN' as Settlementchannel,
  'LU'  as debtorPSPs,
  REFUND.payment_transaction_payer_country as CreditorPSPs,
  REFUND.payment_transaction_currency_code as currency,
  'Vale' as Metric,
  sum ( f_payment_items.PAYMENT_ITEM_AMOUNT) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,

FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.
T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS REFUND ON REFUND.T_DIM_KEY = f_payment_transactions.REFUND_ORIGINAL_PAYMENT_TRANSACTION_DIM_KEY
WHERE
    f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND'
    AND (d_merchants.MERCHANT_COUNTRY )= 'LU'
    AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.201787', 'Etc/UTC'))   -- +01 for winter time, +02 for summer time
    AND REFUND.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:15.201787', 'Etc/UTC')) -- like timez
  group by 1,2,3,4,5,6,7,8
    );
  
[0m10:34:16.062753 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs"
[0m10:34:16.065283 [debug] [Thread-15 ]: On model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V150_card_transactions_with_cards_issued_by resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VOLU' as metric,
  count(*) AS ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND  CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.464893', 'Etc/UTC'))
AND  FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 10:34:15.464893', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

UNION ALL

SELECT
  'DECA' as Payment_Card_Type,
  'MSTR' as Payment_Card_Scheme,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ATM' then 'TATM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'OTHER' then 'EPOS'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'ECOM'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('MOTO' , 'MAIL') then 'MOTO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'OTHR'
      else 'check the query'
  end as Terminal_Type,
  case when FCT.CARD_TRANSACTION_TYPE = 'PURCHASE' AND FCT.CARD_TRANSACTION_MMC_CODE = '6011' then 'CADV'  -- merchant_category_code is best way to identify cash advances
      when FCT.CARD_TRANSACTION_TYPE  = 'PURCHASE' then 'SALE'
      when FCT.CARD_TRANSACTION_TYPE  = 'ATM_CASH_WITHDRAWAL' then 'ATMW'
      when FCT.CARD_TRANSACTION_TYPE  = 'REFUND' then 'RFND'
      when FCT.CARD_TRANSACTION_TYPE  = 'ORIGINAL_CREDIT_TRANSFER' then 'OTHC'
      else 'check the query'
  end as Operation_Type,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'RMTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' then 'CNFC'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'CNTR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL is null AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CNTR'
      else 'check the query' end as Initiation_Channel,
  case when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') then 'REM0'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' then 'REM1'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL IS NULL then 'REM0'
      else 'check the query'
    end as Initiation_subchannel,
  case when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'CHALLENGE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SUCCESSFUL' then 'SCA1'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND FCT.CARD_TRANSACTION_AUTHENTICATION_METHOD = 'FRICTIONLESS' AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'EXEMPTED' then 'RLOW'
      when  FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_ACQUIRER_EXEMPTION = 'RECURRING_PAYMENT' then 'RETR'
when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'MERCHANT_INITIATED_TRANSACTION' then 'MITR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'TRANSACTION_RISK_ANALYSIS' then 'RTRA'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE' AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) AND FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS = 'SECURE_CORPORATE_PAYMENT' then 'SECO'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL = 'ECOMMERCE'AND (FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS in ('UNAVAILABLE','THREEDS_REQUESTER_SCA_EXEMPTION') or FCT.CARD_TRANSACTION_AUTHENTICATION_STATUS is null) then 'OTHR'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PAN_ENTRY_MODE = 'CHIP_CONTACTLESS' AND FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'CLOW'
      when FCT.CARD_TRANSACTION_PAYMENT_CHANNEL in ('OTHER','ATM') AND FCT.CARD_TRANSACTION_PIN_PRESENT = true then 'SCA1'
      when FCT.CARD_TRANSACTION_PIN_PRESENT = false then 'OTHR'
      else 'check the query'
    end as SCA,
  'NOAP' as Fraud_Type,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_Acquirer,
  left(FCT.CARD_TRANSACTION_MERCHANT_COUNTRY_CODE,2) as Country_of_terminal,
  'VALE' as metric,
  sum (coalesce(FCT.CARD_TRANSACTION_CLEARED_AMOUNT ,0)) + sum(coalesce(CARD_TRANSACTION_REFUNDED_AMOUNT,0)) as total_sum,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_DECRYPTED`  FCT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD` C on FCT.T_D_CI_CARD_TRANSACTION_DIM_KEY = C.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION` DCT on DCT.T_DIM_KEY = FCT.T_D_CI_CARD_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_CI_CARD_TRANSACTION_EVENT` FTE on FTE.T_D_CI_CARD_TRANSACTION_DIM_KEY = DCT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_TRANSACTION_EVENT` DTE on FTE.T_D_CI_CARD_TRANSACTION_EVENT_DIM_KEY = DTE.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_CI_CARD_PRODUCT_DECRYPTED` CP on C.T_D_CI_CARD_PRODUCT_DIM_KEY = CP.T_DIM_KEY
where FCT.CARD_TRANSACTION_CLEARED_AMOUNT > 0
AND   CP.CARD_PRODUCT_CARD_COUNTRY = 'LU'
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME >= TIMESTAMP(DATETIME( '2024-10-01 10:34:15.464893', 'Etc/UTC'))
AND   FTE.TRANSACTION_EVENT_USER_TRANSACTION_TIME < TIMESTAMP(DATETIME( '2024-10-31 10:34:15.464893', 'Etc/UTC'))
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
    );
  
[0m10:34:16.763291 [debug] [Thread-5 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a1b5d05b-440c-466e-b73c-f3712f8efcf6&page=queryresults
[0m10:34:16.769070 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc205c2590>]}
[0m10:34:16.770669 [info ] [Thread-1 (]: 48 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TRRT_5845 ......... [[32mCREATE TABLE (0.0 rows, 89.2 GiB processed)[0m in 24.48s]
[0m10:34:16.772261 [debug] [Thread-1 (]: Finished running node model.project_dbt.PAY_TRRT_5845
[0m10:34:16.773507 [debug] [Thread-1 (]: Began running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:34:16.774976 [info ] [Thread-1 (]: 78 of 88 START sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [RUN]
[0m10:34:16.776012 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.project_dbt.PAY_TRRT_5845, now model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs)
[0m10:34:16.777026 [debug] [Thread-1 (]: Began compiling node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:34:16.786663 [debug] [Thread-1 (]: Writing injected SQL for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m10:34:16.787360 [debug] [Thread-1 (]: Began executing node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:34:16.790903 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:34:16.973349 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:cb177a45-28c7-4f93-95cb-d37e70e34723&page=queryresults
[0m10:34:17.397572 [debug] [Thread-1 (]: Writing runtime sql for node "model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs"
[0m10:34:17.399314 [debug] [Thread-1 (]: On model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_LU`.`V152_card_transactions_acquired_by_resident_PSPs`
      
    
    

    OPTIONS()
    as (
      SELECT
  'CRCA' as PaymentCardType,
  case when f_payment_transactions.card_network = 'MASTERCARD' then 'MSTR'
    when f_payment_transactions.card_network = 'VISA' then 'VISA'
    else 'OTHER' END PaymentCardScheme,
  'ECOM' as TerminalType,
  IF(f_payment_transactions.PAYMENT_TRANSACTION_TYPE = 'REFUND', 'DPSP', 'CPSP') as OperationType,
  'RMTR' as InitiationChannel,
  'REM1' as InitiationsubChannel,
  'MITR' as SCA,
  'NOAP' as FraudType,
  d_merchants.MERCHANT_COUNTRY AS CountryofIssuer,
  d_merchants.MERCHANT_COUNTRY AS  CountryofTerminal,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE as currency,
  'Volu' as Metric,
  count(*) as ReportedAmount,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED` AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items
  ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants
  ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions
  ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info
  ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products
  ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
WHERE (d_merchants.MERCHANT_COUNTRY )= 'LU'
  AND d_payment_products.PRODUCT_CODE IN ('SILVERFLOW_CARDS')
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-10-01 10:34:16.786058', 'Etc/UTC'))
  AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-10-31 10:34:16.786058', 'Etc/UTC'))
  GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
    );
  
[0m10:34:18.100360 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1a122530>]}
[0m10:34:18.107085 [info ] [Thread-10 ]: 64 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_nr_of_accounts .. [[32mCREATE TABLE (1.0 rows, 4.1 GiB processed)[0m in 11.88s]
[0m10:34:18.109388 [debug] [Thread-10 ]: Finished running node model.project_dbt.T0401_nr_of_accounts
[0m10:34:18.111310 [debug] [Thread-10 ]: Began running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:34:18.113497 [info ] [Thread-10 ]: 79 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [RUN]
[0m10:34:18.114714 [debug] [Thread-10 ]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_nr_of_accounts, now model.project_dbt.ZVS41_Inbound_credit_transfers)
[0m10:34:18.115679 [debug] [Thread-10 ]: Began compiling node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:34:18.125662 [debug] [Thread-10 ]: Writing injected SQL for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m10:34:18.126588 [debug] [Thread-10 ]: Began executing node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:34:18.129241 [debug] [Thread-10 ]: Opening a new connection, currently in state closed
[0m10:34:18.242526 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:eda1d1cb-c72d-4df5-b3ba-9c69a313dc60&page=queryresults
[0m10:34:18.608769 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1b5f3700>]}
[0m10:34:18.610493 [info ] [Thread-12 ]: 72 of 88 OK created sql incremental model dev_dm_pst3_LU.V1230_number_of_accounts  [[32mCREATE TABLE (0.0 rows, 5.9 GiB processed)[0m in 5.70s]
[0m10:34:18.616910 [debug] [Thread-12 ]: Finished running node model.project_dbt.V1230_number_of_accounts
[0m10:34:18.618349 [debug] [Thread-12 ]: Began running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:34:18.620011 [info ] [Thread-12 ]: 80 of 88 START sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [RUN]
[0m10:34:18.621755 [debug] [Thread-12 ]: Re-using an available connection from the pool (formerly model.project_dbt.V1230_number_of_accounts, now model.project_dbt.ZVS41_Outbound_credit_transfers)
[0m10:34:18.622903 [debug] [Thread-12 ]: Began compiling node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:34:18.631120 [debug] [Thread-12 ]: Writing injected SQL for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m10:34:18.632593 [debug] [Thread-12 ]: Began executing node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:34:18.635626 [debug] [Thread-12 ]: Opening a new connection, currently in state closed
[0m10:34:18.763359 [debug] [Thread-10 ]: Writing runtime sql for node "model.project_dbt.ZVS41_Inbound_credit_transfers"
[0m10:34:18.765181 [debug] [Thread-10 ]: On model.project_dbt.ZVS41_Inbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Inbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYER_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'INBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'RCDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1
ORDER BY 1
    );
  
[0m10:34:19.020401 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2128d060>]}
[0m10:34:19.022196 [info ] [Thread-2 (]: 71 of 88 OK created sql incremental model dev_dm_pst3_LU.V1222_stock_of_accessed_accounts  [[32mCREATE TABLE (8.0 rows, 7.1 GiB processed)[0m in 6.36s]
[0m10:34:19.023927 [debug] [Thread-2 (]: Finished running node model.project_dbt.V1222_stock_of_accessed_accounts
[0m10:34:19.025204 [debug] [Thread-2 (]: Began running node model.project_dbt.ZVS9_PCT
[0m10:34:19.026579 [info ] [Thread-2 (]: 81 of 88 START sql incremental model dev_dm_pst3_DE.ZVS9_PCT ................... [RUN]
[0m10:34:19.027821 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.project_dbt.V1222_stock_of_accessed_accounts, now model.project_dbt.ZVS9_PCT)
[0m10:34:19.028900 [debug] [Thread-2 (]: Began compiling node model.project_dbt.ZVS9_PCT
[0m10:34:19.038483 [debug] [Thread-2 (]: Writing injected SQL for node "model.project_dbt.ZVS9_PCT"
[0m10:34:19.039221 [debug] [Thread-2 (]: Began executing node model.project_dbt.ZVS9_PCT
[0m10:34:19.043753 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:34:19.260247 [debug] [Thread-12 ]: Writing runtime sql for node "model.project_dbt.ZVS41_Outbound_credit_transfers"
[0m10:34:19.261973 [debug] [Thread-12 ]: On model.project_dbt.ZVS41_Outbound_credit_transfers: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS41_Outbound_credit_transfers`
      
    
    

    OPTIONS()
    as (
      SELECT
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'PCT.4 Manual entry'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS', 'H2H') THEN 'PCT.2 Electronic entry'
  END EntryMode,
  CASE
    WHEN FAT.TRANSACTION_CHANNEL IN ('DASHBOARD', 'ADMIN', 'OTHER') THEN 'NA'
    WHEN FAT.TRANSACTION_CHANNEL IN ('TPP', 'OCS') THEN 'PCT.22 Single entry'
    WHEN FAT.TRANSACTION_CHANNEL = 'H2H' THEN 'PCT.21 Batch entry'
  END Batchmode,
  d_counterparty_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE AS PAYEE_PSP_COUNTRY,
  COUNT(DISTINCT FAT.T_SOURCE_PK_ID) AS OUTBOUND_IBIS_PAYMENTS_TRX_COUNT,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS OUTBOUND_IBIS_PAYMENTS_AMOUNT_SUM_IN_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024S1' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS d_account_transaction ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = d_account_transaction.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS d_ibis_account ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = d_ibis_account.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_bank_accounts ON d_ibis_account.T_D_BANK_ACCOUNT_DIM_KEY = d_bank_accounts.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS d_counterparty_bank_accounts ON d_counterparty_bank_accounts.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE FAT.TRANSACTION_DIRECTION = 'OUTBOUND'
  AND FAT.TRANSACTION_TYPE = 'REGULAR'
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
  AND d_account_transaction.TRANSACTION_STATUS IN ('RETURNED', 'SETTLED')
  AND d_ibis_account.ACCOUNT_TYPE = 'PAYMENT'
  AND FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND d_bank_accounts.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
GROUP BY 1, 2, 3
    );
  
[0m10:34:19.349534 [debug] [Thread-10 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:c19be9a1-15a0-4e67-bb5a-13ae1d8c9969&page=queryresults
[0m10:34:19.622974 [debug] [Thread-2 (]: Writing runtime sql for node "model.project_dbt.ZVS9_PCT"
[0m10:34:19.624987 [debug] [Thread-2 (]: On model.project_dbt.ZVS9_PCT: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_DE`.`ZVS9_PCT`
      
    
    

    OPTIONS()
    as (
      SELECT
  CBA.FINANCIAL_INSTITUTION_COUNTRY_CODE AS Payee_PSP_country,
  COUNT(*) AS outbound_ibis_payments_trx_count,
  COALESCE(SUM(FAT.TRANSACTION_AMOUNT), 0) AS outbound_ibis_payments_amount_sum_in_EUR,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  '2024Q3' AS PERIOD,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_ACCOUNT_TRANSACTIONS_DECRYPTED` AS FAT
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_ACCOUNT_TRANSACTION_CURRENT` AS DAT
  ON FAT.T_D_ACCOUNT_TRANSACTION_DIM_KEY = DAT.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_IBIS_ACCOUNT_CURRENT` AS IA
  ON FAT.T_D_IBIS_ACCOUNT_DIM_KEY = IA.T_DIM_KEY
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS BA
  ON IA.T_D_BANK_ACCOUNT_DIM_KEY = BA.T_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_BANK_ACCOUNTS_DECRYPTED` AS CBA
  ON CBA.T_DIM_KEY = FAT.T_COUNTERPARTY_BANK_ACCOUNT_DIM_KEY
WHERE (FAT.TRANSACTION_DIRECTION = 'OUTBOUND')
  AND(FAT.TRANSACTION_TYPE) = 'REGULAR'
  AND (DAT.TRANSACTION_STATUS) IN ('RETURNED', 'SETTLED')
  AND (IA.ACCOUNT_TYPE) = 'PAYMENT'
  AND  FAT.TRANSACTION_BANK_FAMILY = 'ICDT'
  AND FAT.TRANSACTION_CHANNEL not in ('DASHBOARD', 'OTHER','CARDS')
  AND BA.FINANCIAL_INSTITUTION_COUNTRY_CODE = 'DE'
  AND DAT.TRANSACTION_BOOKING_DATE_AT >= TIMESTAMP(DATETIME( '2024-07-01', 'Etc/UTC'))
  AND DAT.TRANSACTION_BOOKING_DATE_AT <= TIMESTAMP(DATETIME( '2024-09-30', 'Etc/UTC'))
GROUP BY 1
ORDER BY 1 ASC
    );
  
[0m10:34:19.750625 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc20ceb070>]}
[0m10:34:19.752432 [info ] [Thread-6 (]: 63 of 88 OK created sql incremental model dev_dm_pst3_NL.T0401_misc ............ [[32mCREATE TABLE (11.0 rows, 10.9 GiB processed)[0m in 14.45s]
[0m10:34:19.754116 [debug] [Thread-6 (]: Finished running node model.project_dbt.T0401_misc
[0m10:34:19.755412 [debug] [Thread-6 (]: Began running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:34:19.756996 [info ] [Thread-6 (]: 82 of 88 START sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [RUN]
[0m10:34:19.758092 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.T0401_misc, now model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals)
[0m10:34:19.759163 [debug] [Thread-6 (]: Began compiling node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:34:19.766343 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m10:34:19.767118 [debug] [Thread-6 (]: Began executing node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:34:19.769948 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:34:20.140904 [debug] [Thread-12 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:805e6082-3f78-4034-b30d-92e8b075e2ab&page=queryresults
[0m10:34:20.450400 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:80cd7c8f-3a00-496e-a11d-0f853dd619be&page=queryresults
[0m10:34:20.453164 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals"
[0m10:34:20.456690 [debug] [Thread-6 (]: On model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
      
    
    

    OPTIONS()
    as (
      SELECT
    payee_psp_country,
    outbound_ibis_payments_trx_count,
    outbound_ibis_payments_amount_sum_in_EUR,
    SUM(outbound_ibis_payments_trx_count) OVER(PARTITION BY period) AS total_outbound_ibis_payments_trx_count,
    SUM(outbound_ibis_payments_amount_sum_in_EUR) OVER(PARTITION BY period) AS total_outbound_ibis_payments_amount_sum_in_EUR,
    load_timestamp,
    period
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo`
    );
  
[0m10:34:20.515779 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf64250>]}
[0m10:34:20.517496 [info ] [Thread-15 ]: 77 of 88 OK created sql incremental model dev_dm_pst3_LU.V150_card_transactions_with_cards_issued_by resident_PSPs  [[32mCREATE TABLE (0.0 rows, 2.7 GiB processed)[0m in 5.07s]
[0m10:34:20.519197 [debug] [Thread-15 ]: Finished running node model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs
[0m10:34:20.520404 [debug] [Thread-15 ]: Began running node model.project_dbt.PCP
[0m10:34:20.521721 [info ] [Thread-15 ]: 83 of 88 START sql incremental model dev_dm_pst3_BE.PCP ........................ [RUN]
[0m10:34:20.524164 [debug] [Thread-15 ]: Re-using an available connection from the pool (formerly model.project_dbt.V150_card_transactions_with_cards_issued_by resident_PSPs, now model.project_dbt.PCP)
[0m10:34:20.525636 [debug] [Thread-15 ]: Began compiling node model.project_dbt.PCP
[0m10:34:20.536732 [debug] [Thread-15 ]: Writing injected SQL for node "model.project_dbt.PCP"
[0m10:34:20.540071 [debug] [Thread-15 ]: Began executing node model.project_dbt.PCP
[0m10:34:20.543611 [debug] [Thread-15 ]: Opening a new connection, currently in state closed
[0m10:34:21.008222 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:da5ea3b8-9fcc-4696-a2c8-6b12f100a849&page=queryresults
[0m10:34:21.144035 [debug] [Thread-15 ]: Writing runtime sql for node "model.project_dbt.PCP"
[0m10:34:21.145004 [debug] [Thread-15 ]: On model.project_dbt.PCP: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP`
      
    
    

    OPTIONS()
    as (
      with source as(
SELECT
  d_payment_products.PRODUCT_CODE AS PRODUCT,
  d_payment_transaction_info.PAYMENT_TRANSACTION_PAYER_COUNTRY  AS PAYERCOUNTRY,
  d_merchants.MERCHANT_COUNTRY  AS MERCHANTCOUNTRY,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.CARD_NETWORK = 'VISA' THEN 'Visa'
    END AS PCP_TYPE,
    CASE
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD' THEN 'WIP transaction'
        WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' AND f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'NONE' THEN 'single transaction'
    END AS SINGLEWIP,
    d_payment_transaction_info.T_SOURCE_PK_UUID  AS  TRANSACTION_PUBLIC_IDENTIFIER,
    f_payment_transactions.CARD_COUNTRY  AS CARD_COUNTRY,
    f_payment_transactions.CARD_NETWORK_AUTHORIZATION_CODE  AS NETWORK_CODE,
    f_payment_transactions.SCA_RESULT  AS SCA_RESULT,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN
      IF(f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'BANCONTACT','non-SCA used: reason is merchant initiated transaction (MIT)','SCA used')
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF (f_payment_transactions.PAYMENT_TRANSACTION_WIP_TYPE = 'CREDITCARD', 'non-SCA used: reason is merchant initiated transaction (MIT)',map.SCA_REASON )
    END AS SCA_REASON,
  f_payment_transactions.MASTERCARD_PRODUCT_ID  AS LICENSEDPRODUCTID,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_CODE AS PRODUCTCATEGORYCODE,
  f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION  AS  PRODUCTCATEGORYDESCRIPTION,
  CASE
    WHEN d_payment_products.PRODUCT_CODE = 'BANCONTACT_COLLECT' THEN 'Debit'
    WHEN d_payment_products.PRODUCT_CODE = 'SILVERFLOW_CARDS' THEN
      IF(
        f_payment_transactions.CARD_NETWORK = 'MASTERCARD', --condition
        --true ('MASTERCARD')
        IF(f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION = 'Prepaid',
          'Debit',
          f_payment_transactions.MASTERCARD_PRODUCT_CATEGORY_DESCRIPTION
          ),
        --false (!='MASTERCARD')
        IF(
            f_payment_transactions.CARD_NETWORK = 'VISA',
            IF( f_payment_transactions.CARD_FUNDING_SOURCE = 'Prepaid',
              'Debit',
              F_Payment_transactions.CARD_FUNDING_SOURCE
            ),
            'NA'
          )
          )
    ELSE 'NA'
    END AS CARDFUNCTION,
  f_payment_transactions.CARD_FUNDING_SOURCE  AS ACCOUNTFUNDINGSOURCE,
  d_merchants.T_SOURCE_PK_UUID AS MERCHANT_PUBLIC_IDENTIFIER,
  f_payment_items.PAYMENT_ITEM_AMOUNT  AS AMOUNT,
  d_payment_item_info.PAYMENT_ITEM_CURRENCY_CODE AS CURRENCY,
  f_payment_transactions.CARD_NETWORK,
  CURRENT_TIMESTAMP AS LOAD_TIMESTAMP,
  ""  AS Period,
  TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))  AS Period_begin_date,
  TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))  AS Period_end_date,
FROM `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_ITEM_INFO_DECRYPTED`
    AS d_payment_item_info
INNER JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_ITEMS` AS f_payment_items ON d_payment_item_info.T_DIM_KEY = f_payment_items.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_MERCHANTS_DECRYPTED` AS d_merchants ON f_payment_items.T_D_MERCHANT_DIM_KEY = d_merchants.T_DIM_KEY AND d_merchants.T_SOURCE = "P1_PBEE"
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`F_PAYMENT_TRANSACTIONS_DECRYPTED`  AS f_payment_transactions ON d_payment_item_info.T_DIM_KEY = f_payment_transactions.T_D_PAYMENT_ITEM_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_TRANSACTION_INFO_DECRYPTED` AS d_payment_transaction_info ON d_payment_transaction_info.T_DIM_KEY =f_payment_transactions.T_D_PAYMENT_TRANSACTION_INFO_DIM_KEY
LEFT JOIN `pj-bu-dw-dwh-prod`.`prd_data_warehouse_STRP`.`D_PAYMENT_PRODUCTS` AS d_payment_products ON f_payment_transactions.T_D_PRODUCT_DIM_KEY = d_payment_products.T_DIM_KEY
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`SCA_MAPPING_TABLE` AS map  ON f_payment_transactions.SCA_RESULT = map.SCA_RESULT
WHERE (d_merchants.MERCHANT_COUNTRY ) IS NOT NULL
    AND d_payment_products.PRODUCT_CODE IN ('BANCONTACT_COLLECT', 'SILVERFLOW_CARDS')
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT >= TIMESTAMP(DATETIME( '2024-01-01', 'Etc/UTC'))
    AND d_payment_transaction_info.PAYMENT_TRANSACTION_CUTOFF_AT <= TIMESTAMP(DATETIME( '2024-06-30', 'Etc/UTC'))
),
exeption_records as(
SELECT
  PRODUCT,
  PAYERCOUNTRY,
  MERCHANTCOUNTRY,
  PCP_TYPE,
  SINGLEWIP,
  TRANSACTION_PUBLIC_IDENTIFIER,
  CARD_COUNTRY,
  NETWORK_CODE,
  SCA_RESULT,
  SCA_REASON,
  LICENSEDPRODUCTID,
  PRODUCTCATEGORYCODE,
  PRODUCTCATEGORYDESCRIPTION,
  "Credit" AS CARDFUNCTION,
  ACCOUNTFUNDINGSOURCE,
  MERCHANT_PUBLIC_IDENTIFIER,
  AMOUNT,
  CURRENCY,
  CARD_NETWORK,
  LOAD_TIMESTAMP,
  Period,
  Period_begin_date,
  Period_end_date,
FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
),
execpted_records as(
SELECT * FROM source
WHERE TRANSACTION_PUBLIC_IDENTIFIER NOT IN ("9b15b583-8919-4c73-88bb-bac862fc6739","62457fa7-cd28-4655-856e-adbec2a1a90b", "b9f13a08-e187-4d3b-bc91-2f657dda85cc", "04b4f377-da01-4a1e-9aff-8541dd6d233b")
)
SELECT * FROM exeption_records
UNION ALL
SELECT * FROM execpted_records
    );
  
[0m10:34:21.987602 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1a12baf0>]}
[0m10:34:21.992744 [info ] [Thread-8 (]: 55 of 88 OK created sql incremental model dev_dm_pst3_BE.PIS ................... [[32mCREATE TABLE (20.0 rows, 44.7 GiB processed)[0m in 26.41s]
[0m10:34:21.994771 [debug] [Thread-8 (]: Finished running node model.project_dbt.PIS
[0m10:34:21.996027 [debug] [Thread-8 (]: Began running node model.project_dbt.PAY_TROP_5845
[0m10:34:21.997512 [info ] [Thread-8 (]: 84 of 88 START sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 .............. [RUN]
[0m10:34:21.998509 [debug] [Thread-8 (]: Re-using an available connection from the pool (formerly model.project_dbt.PIS, now model.project_dbt.PAY_TROP_5845)
[0m10:34:21.999498 [debug] [Thread-8 (]: Began compiling node model.project_dbt.PAY_TROP_5845
[0m10:34:22.008544 [debug] [Thread-8 (]: Writing injected SQL for node "model.project_dbt.PAY_TROP_5845"
[0m10:34:22.009344 [debug] [Thread-8 (]: Began executing node model.project_dbt.PAY_TROP_5845
[0m10:34:22.011925 [debug] [Thread-8 (]: Opening a new connection, currently in state closed
[0m10:34:22.104745 [debug] [Thread-15 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:9c8cf426-0b5c-4756-96b5-d253401b55f2&page=queryresults
[0m10:34:22.647211 [debug] [Thread-8 (]: Writing runtime sql for node "model.project_dbt.PAY_TROP_5845"
[0m10:34:22.649128 [debug] [Thread-8 (]: On model.project_dbt.PAY_TROP_5845: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845`
      
    
    

    OPTIONS()
    as (
      SELECT
  -- COALESCE(cmd_deb.identifier,cmd_cre.identifier) AS payment_account_number,
  -- COALESCE(cmd_deb.enterprise_number,cmd_cre.enterprise_number) AS enterprise_number,
  -- COALESCE(cmd_deb.legal_form,cmd_cre.legal_form) AS legal_form,
  -- COALESCE(cmd_deb.country,cmd_cre.country) AS country,
  -- COALESCE(cmd_deb.postal_code,cmd_cre.postal_code) AS postal_code,
  bis.Ot,
  bis.Ref,
  bis.ORef,
  bis.debtor_account_identifier,
  bis.creditor_account_identifier,
  bis.Ord,
  bis.Ben,
  bis.PayID,
  bis.BICOrd,
  bis.BICBen,
  bis.BICSen,
  bis.BICRec,
  bis.PasOrd,
  bis.PasBen,
  bis.LEIOrd,
  bis.LEIBen,
  bis.Sch,
  bis.Pro,
  bis.DtLiq,
  bis.DtPISP,
  bis.TsOrd,
  bis.TsBen,
  bis.TipTR,
  bis.Div,
  bis.Mont,
  bis.MontOrg,
  bis.TipCan,
  bis.FormEnv,
  bis.OperElet,
  bis.OperRem,
  bis.OperECom,
  bis.IniPISP,
  bis.ModAc,
  bis.SCA,
  bis.MnonSCA,
  bis.SI,
  bis.PasmC,
  bis.PasnC,
  bis.CPosm,
  bis.TipDoc,
  bis.NumDoc,
  bis.LEIC,
  bis.ENI,
  bis.InfUltBen,
  bis.InfUltOrd,
  bis.Period,
  bis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_IBIS` AS bis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_deb
--   ON bis.debtor_account_identifier = cmd_deb.identifier
--   AND bis.Ot = 'O'
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--   ON bis.creditor_account_identifier = cmd_cre.identifier
--   AND bis.Ot = 'B'
UNION ALL
SELECT
  -- cmd_cre.identifier as payment_account_number,
  -- cmd_cre.enterprise_number,
  -- cmd_cre.legal_form,
  -- cmd_cre.country,
  -- cmd_cre.postal_code,
  pis.Ot,
  pis.Ref,
  pis.ORef,
  pis.debtor_account_identifier,
  pis.creditor_account_identifier,
  pis.Ord,
  pis.Ben,
  pis.PayID,
  pis.BICOrd,
  pis.BICBen,
  pis.BICSen,
  pis.BICRec,
  pis.PasOrd,
  pis.PasBen,
  pis.LEIOrd,
  pis.LEIBen,
  pis.Sch,
  pis.Pro,
  NULL AS DtLiq,
  pis.DtPISP,
  pis.TsOrd,
  pis.TsBen,
  pis.TipTR,
  pis.Div,
  pis.Mont,
  pis.MontOrg,
  pis.TipCan,
  pis.FormEnv,
  pis.OperElet,
  pis.OperRem,
  pis.OperECom,
  pis.IniPISP,
  pis.ModAc,
  pis.SCA,
  pis.MnonSCA,
  pis.SI,
  pis.PasmC,
  pis.PasnC,
  pis.CPosm,
  pis.TipDoc,
  pis.NumDoc,
  pis.LEIC,
  pis.ENI,
  pis.InfUltBen,
  pis.InfUltOrd,
  pis.Period,
  pis.load_timestamp,
FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_PIS` AS pis
-- LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_PT`.`PAY_TROP_5845_CMD` as cmd_cre
--  ON pis.creditor_account_identifier = cmd_cre.identifier
    );
  
[0m10:34:22.824349 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2128f6a0>]}
[0m10:34:22.825646 [info ] [Thread-14 ]: 70 of 88 OK created sql incremental model dev_dm_pst3_LU.V1220_stock_of_accounts  [[32mCREATE TABLE (2.0 rows, 4.1 GiB processed)[0m in 10.17s]
[0m10:34:22.826471 [debug] [Thread-14 ]: Finished running node model.project_dbt.V1220_stock_of_accounts
[0m10:34:23.220373 [debug] [Thread-8 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:275b262a-8b7f-4b57-a3bc-bf2dc466dbaf&page=queryresults
[0m10:34:23.493555 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21051630>]}
[0m10:34:23.496976 [info ] [Thread-6 (]: 82 of 88 OK created sql incremental model dev_dm_pst3_FR.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals  [[32mCREATE TABLE (8.0 rows, 304.0 Bytes processed)[0m in 3.74s]
[0m10:34:23.498770 [debug] [Thread-6 (]: Finished running node model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals
[0m10:34:23.500438 [debug] [Thread-14 ]: Began running node model.project_dbt.Cross_join
[0m10:34:23.502249 [info ] [Thread-14 ]: 85 of 88 START sql incremental model dev_dm_pst3_FR.Cross_join ................. [RUN]
[0m10:34:23.504004 [debug] [Thread-14 ]: Re-using an available connection from the pool (formerly model.project_dbt.V1220_stock_of_accounts, now model.project_dbt.Cross_join)
[0m10:34:23.505283 [debug] [Thread-14 ]: Began compiling node model.project_dbt.Cross_join
[0m10:34:23.520780 [debug] [Thread-14 ]: Writing injected SQL for node "model.project_dbt.Cross_join"
[0m10:34:23.524249 [debug] [Thread-14 ]: Began executing node model.project_dbt.Cross_join
[0m10:34:23.537980 [debug] [Thread-14 ]: Opening a new connection, currently in state closed
[0m10:34:24.243228 [debug] [Thread-14 ]: Writing runtime sql for node "model.project_dbt.Cross_join"
[0m10:34:24.246001 [debug] [Thread-14 ]: On model.project_dbt.Cross_join: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`Cross_join`
      
    
    

    OPTIONS()
    as (
      WITH type AS (
  SELECT
    'agMoyPaiTypeOpeCanalTransactZoneGeo' AS axe,
    'VIREMENT' AS moyenPaiementtype,
    'VIR_EMIS' AS Operationtype,
    'ELECTRONIQUE' AS canaltype,
    'DISTANCE' AS typeTransaction,
    'axe1'  AS alias
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeo', 'VIREMENT', 'VIR_EMIS', 'ELECTRONIQUE', 'PROXIMITE', 'axe1'
  UNION all
  SELECT 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc', 'CARTE', 'CARTE_EMIS', 'ELECTRONIQUE', 'DISTANCE', 'axe2'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'PRELEVEM', 'PRELEVEM_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'MON_ELEC', 'PAIEMT_ME_EMIS', 'NA', 'NA', 'axe3'
  UNION all
  SELECT 'agMoyPaiTypeOpeZoneGeo', 'CHEQ', 'CHEQ_RECU', 'NA', 'NA', 'axe3'
),
final as (
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    mcc.Coded as MCC_code
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe = 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc' and typeTransaction = 'DISTANCE'
  UNION ALL
  SELECT
    axe,
    alias,
    moyenPaiementtype,
    Operationtype,
    canaltype,
    typeTransaction,
    ct.code as country_code,
    NULL as MCC_code,
  FROM `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`COUNTRIES` ct
  cross join type
  cross join `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_FR`.`MCC_CODES` mcc
  where type.axe <> 'agMoyPaiTypeOpeCanalTransactZoneGeoMcc'
)
SELECT
axe,
alias,
moyenPaiementtype,
Operationtype,
canaltype,
typeTransaction,
'5493004MX17L5E8MUB29' AS LEI,
payee_psp_country,
COALESCE(outbound_ibis_payments_trx_count, 0) AS outbound_ibis_payments_trx_count,
COALESCE(outbound_ibis_payments_amount_sum_in_EUR, 0) AS outbound_ibis_payments_amount_sum_in_EUR,
COALESCE(total_outbound_ibis_payments_trx_count, 0) AS total_outbound_ibis_payments_trx_count,
COALESCE(total_outbound_ibis_payments_amount_sum_in_EUR, 0) AS total_outbound_ibis_payments_amount_sum_in_EUR,
load_timestamp,
period,
FROM final
LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_FR`.`CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals`
ON payee_psp_country = country_code
    );
  
[0m10:34:24.818286 [debug] [Thread-14 ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:85b0691c-5198-4144-9ee7-fb9cadacb235&page=queryresults
[0m10:34:25.233898 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc203d5ba0>]}
[0m10:34:25.234990 [info ] [Thread-7 (]: 69 of 88 OK created sql incremental model dev_dm_pst3_LU.V121_customer_credit_transfers_received  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 12.59s]
[0m10:34:25.235677 [debug] [Thread-7 (]: Finished running node model.project_dbt.V121_customer_credit_transfers_received
[0m10:34:25.421770 [debug] [Thread-8 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1a12baf0>]}
[0m10:34:25.422463 [info ] [Thread-8 (]: 84 of 88 OK created sql incremental model dev_dm_pst3_PT.PAY_TROP_5845 ......... [[32mCREATE TABLE (4.0 rows, 802.0 Bytes processed)[0m in 3.42s]
[0m10:34:25.423006 [debug] [Thread-8 (]: Finished running node model.project_dbt.PAY_TROP_5845
[0m10:34:25.554689 [debug] [Thread-16 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21285780>]}
[0m10:34:25.556145 [info ] [Thread-16 ]: 68 of 88 OK created sql incremental model dev_dm_pst3_LU.V120_customer_credit_transfers_sent  [[32mCREATE TABLE (0.0 rows, 55.9 GiB processed)[0m in 12.92s]
[0m10:34:25.557513 [debug] [Thread-16 ]: Finished running node model.project_dbt.V120_customer_credit_transfers_sent
[0m10:34:27.537183 [debug] [Thread-10 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210155a0>]}
[0m10:34:27.542575 [info ] [Thread-10 ]: 79 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Inbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 9.42s]
[0m10:34:27.547851 [debug] [Thread-10 ]: Finished running node model.project_dbt.ZVS41_Inbound_credit_transfers
[0m10:34:28.421440 [debug] [Thread-14 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2128f820>]}
[0m10:34:28.426370 [info ] [Thread-14 ]: 85 of 88 OK created sql incremental model dev_dm_pst3_FR.Cross_join ............ [[32mCREATE TABLE (489.0k rows, 1.4 KiB processed)[0m in 4.92s]
[0m10:34:28.429712 [debug] [Thread-14 ]: Finished running node model.project_dbt.Cross_join
[0m10:34:28.845318 [debug] [Thread-11 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210b15d0>]}
[0m10:34:28.846047 [info ] [Thread-11 ]: 73 of 88 OK created sql incremental model dev_dm_pst3_LU.V130_direct_debits_reporting_as_creditors_PSP  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 15.36s]
[0m10:34:28.846621 [debug] [Thread-11 ]: Finished running node model.project_dbt.V130_direct_debits_reporting_as_creditors_PSP
[0m10:34:29.004321 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc2022e7d0>]}
[0m10:34:29.006133 [info ] [Thread-2 (]: 81 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS9_PCT .............. [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 9.98s]
[0m10:34:29.007811 [debug] [Thread-2 (]: Finished running node model.project_dbt.ZVS9_PCT
[0m10:34:30.083737 [debug] [Thread-13 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc200e4970>]}
[0m10:34:30.087280 [info ] [Thread-13 ]: 75 of 88 OK created sql incremental model dev_dm_pst3_LU.V140_SEPA_R_transactions  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 16.27s]
[0m10:34:30.088519 [debug] [Thread-13 ]: Finished running node model.project_dbt.V140_SEPA_R_transactions
[0m10:34:30.214458 [debug] [Thread-9 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf2afe0>]}
[0m10:34:30.218104 [info ] [Thread-9 (]: 74 of 88 OK created sql incremental model dev_dm_pst3_LU.V131_direct_debits_reporting_as_debtors_PSP  [[32mCREATE TABLE (0.0 rows, 46.7 GiB processed)[0m in 16.47s]
[0m10:34:30.221435 [debug] [Thread-9 (]: Finished running node model.project_dbt.V131_direct_debits_reporting_as_debtors_PSP
[0m10:34:31.212761 [debug] [Thread-12 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc18d90c40>]}
[0m10:34:31.214484 [info ] [Thread-12 ]: 80 of 88 OK created sql incremental model dev_dm_pst3_DE.ZVS41_Outbound_credit_transfers  [[32mCREATE TABLE (0.0 rows, 11.0 GiB processed)[0m in 12.59s]
[0m10:34:31.216545 [debug] [Thread-12 ]: Finished running node model.project_dbt.ZVS41_Outbound_credit_transfers
[0m10:34:36.092104 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1bf837f0>]}
[0m10:34:36.093802 [info ] [Thread-1 (]: 78 of 88 OK created sql incremental model dev_dm_pst3_LU.V152_card_transactions_acquired_by_resident_PSPs  [[32mCREATE TABLE (0.0 rows, 30.0 GiB processed)[0m in 19.32s]
[0m10:34:36.095447 [debug] [Thread-1 (]: Finished running node model.project_dbt.V152_card_transactions_acquired_by_resident_PSPs
[0m10:34:39.600531 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc210d20b0>]}
[0m10:34:41.338090 [info ] [Thread-4 (]: 67 of 88 OK created sql incremental model dev_dm_pst3_LU.V1110_payment_initiation_services  [[32mCREATE TABLE (7.0 rows, 38.5 GiB processed)[0m in 29.03s]
[0m10:34:41.339910 [debug] [Thread-4 (]: Finished running node model.project_dbt.V1110_payment_initiation_services
[0m10:34:51.067891 [debug] [Thread-15 ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc21086080>]}
[0m10:34:51.069869 [info ] [Thread-15 ]: 83 of 88 OK created sql incremental model dev_dm_pst3_BE.PCP ................... [[32mCREATE TABLE (998.3k rows, 84.9 GiB processed)[0m in 30.54s]
[0m10:34:51.071528 [debug] [Thread-15 ]: Finished running node model.project_dbt.PCP
[0m10:34:51.073283 [debug] [Thread-6 (]: Began running node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:34:51.074741 [info ] [Thread-6 (]: 86 of 88 START sql incremental model dev_dm_pst3_BE.PCP_MERCHANT_ACCT_TRX ...... [RUN]
[0m10:34:51.075766 [debug] [Thread-6 (]: Re-using an available connection from the pool (formerly model.project_dbt.CT1_agMoyPaiTypeOpeCanalTransactZoneGeo_totals, now model.project_dbt.PCP_MERCHANT_ACCT_TRX)
[0m10:34:51.076832 [debug] [Thread-6 (]: Began compiling node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:34:51.090648 [debug] [Thread-6 (]: Writing injected SQL for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m10:34:51.091877 [debug] [Thread-6 (]: Began executing node model.project_dbt.PCP_MERCHANT_ACCT_TRX
[0m10:34:51.099832 [debug] [Thread-6 (]: Opening a new connection, currently in state closed
[0m10:34:51.798562 [debug] [Thread-6 (]: Writing runtime sql for node "model.project_dbt.PCP_MERCHANT_ACCT_TRX"
[0m10:34:51.800809 [debug] [Thread-6 (]: On model.project_dbt.PCP_MERCHANT_ACCT_TRX: 
  
    

    create or replace table `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_MERCHANT_ACCT_TRX`
      
    
    

    OPTIONS()
    as (
      WITH pre AS(
  SELECT
      pcp.PRODUCT,
      pcp.TRANSACTION_PUBLIC_IDENTIFIER,
      pcp.PAYERCOUNTRY,
      pcp.MERCHANTCOUNTRY,
      pcp.AMOUNT,
      pcp.CURRENCY,
      pcp.MERCHANT_PUBLIC_IDENTIFIER,
      IF(ocs.companyid_tobeexcluded IS NULL, "BE", ocs.to_be_reported_in_country) AS TO_BE_REPORTED_IN_COUNTRY,
      CASE
          WHEN pcp.PRODUCT = 'BANCONTACT_COLLECT' THEN pcp.PAYERCOUNTRY
          WHEN pcp.CARD_NETWORK = 'MASTERCARD' THEN pcp.CARD_COUNTRY
          WHEN pcp.CARD_NETWORK = 'VISA' THEN pcp.CARD_COUNTRY
          ELSE "no match"
      END AS COUNTERPARTY_AREA,
      pcp.MERCHANTCOUNTRY AS POS_LOCATION,
      pcp.CARDFUNCTION,
      pcp.singleWIP AS WIP_TRANSACTION,
      Case
        WHEN PCP.PRODUCT = 'BANCONTACT_COLLECT' THEN 'Bancontact'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND PCP.CARD_NETWORK = 'MASTERCARD' THEN 'Mastercard'
        WHEN PCP.PRODUCT = 'SILVERFLOW_CARDS' AND pcp.CARD_NETWORK = 'VISA' THEN 'Visa'
      END AS CARD_NETWORK,
      pcp.SCA_REASON,
      '2000' AS INTTN_CHNNL,
      'R' AS RMT_INTTN,
      'PCS_ALL' AS PYMNT_SCHM,
      '_Z' AS FRD_TYP,
      pcp.LOAD_TIMESTAMP,
      pcp.PERIOD,
      pcp.Period_begin_date,
      pcp.Period_end_date,
  FROM `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP` AS pcp
  LEFT JOIN `pj-bu-dw-data-sbx`.`dev_dm_pst3_BE`.`PCP_ALBATROS_CMD_OCS` as ocs
    ON ocs.companyid_tobeexcluded = pcp.TRANSACTION_PUBLIC_IDENTIFIER
  ),
  code as(
  SELECT pre.*,
   IF(pre.TO_BE_REPORTED_IN_COUNTRY = pre.COUNTERPARTY_AREA,
        'W2',
        pre.COUNTERPARTY_AREA) AS AREA_CODE,
    IF( pre.TO_BE_REPORTED_IN_COUNTRY = pre.POS_LOCATION,
        'W2',
        pre.POS_LOCATION) AS LOCATION_CODE,
    CASE pre.CARDFUNCTION
      WHEN 'Debit' THEN '11'
      WHEN 'Credit' THEN '13'
      WHEN 'Deferred Debit' THEN '12'
      ELSE '_Z'
    END AS CRD_FNCTN,
  FROM pre
)
SELECT
   code.*EXCEPT(AREA_CODE,LOCATION_CODE,LOAD_TIMESTAMP,PERIOD),
  COALESCE(pst3_cp.CODE, 'Extra EEA')  AS COUNT_AREA,
  COALESCE(pst3_pos.CODE, 'Extra EEA') AS TRMNL_LCTN,
  pst3_sca.CODE AS SCA,
  LOAD_TIMESTAMP,
  PERIOD,
FROM code
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_cp
    ON code.AREA_CODE = pst3_cp.CODE
    AND pst3_cp.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_pos
    ON code.LOCATION_CODE = pst3_pos.CODE
    AND pst3_pos.TYPE = 'Geographical area'
LEFT JOIN `pj-bu-dw-dm-prod`.`prd_data_mart_PPST_BE`.`PST3_MAPPING` AS pst3_sca
    ON code.SCA_REASON = pst3_sca.name
    AND pst3_sca.TYPE = 'Strong customer authentication (SCA)'
    );
  
[0m10:34:52.410245 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=pj-bu-dw-data-sbx&j=bq:europe-west1:a0a00bf9-4d90-442b-a116-21f3921e107c&page=queryresults
[0m10:34:52.413770 [debug] [Thread-5 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd9c7fc01-cd37-4861-82f5-2369ca3da9b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78cc1ab5b550>]}
[0m10:34:52.418042 [info ] [Thread-5 (]: 76 of 88 OK created sql incremental model dev_dm_pst3_LU.V142_intermediated_payment_transactions  [[32mCREATE TABLE (0.0 rows, 170.9 GiB processed)[0m in 37.23s]
[0m10:34:52.420074 [debug] [Thread-5 (]: Finished running node model.project_dbt.V142_intermediated_payment_transactions
